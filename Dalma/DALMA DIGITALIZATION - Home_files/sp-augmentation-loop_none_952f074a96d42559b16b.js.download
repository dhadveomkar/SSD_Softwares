define("8567e4de-8cb3-406c-a31d-bcfd13c03eb8_2.4.27",["@microsoft/sp-core-library","@microsoft/sp-diagnostics","@microsoft/sp-http-base","@microsoft/sp-http"],(e,t,n,a)=>(()=>{var i={882:function(e,t){var n="undefined"!=typeof self?self:this,a=function(){function e(){this.fetch=!1,this.DOMException=n.DOMException}return e.prototype=n,new e}();!function(e){!function(t){var n="URLSearchParams"in e,a="Symbol"in e&&"iterator"in Symbol,i="FileReader"in e&&"Blob"in e&&function(){try{return new Blob,!0}catch(e){return!1}}(),r="FormData"in e,o="ArrayBuffer"in e;if(o)var s=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],c=ArrayBuffer.isView||function(e){return e&&s.indexOf(Object.prototype.toString.call(e))>-1};function d(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.^_`|~]/i.test(e))throw new TypeError("Invalid character in header field name");return e.toLowerCase()}function l(e){return"string"!=typeof e&&(e=String(e)),e}function u(e){var t={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return a&&(t[Symbol.iterator]=function(){return t}),t}function f(e){this.map={},e instanceof f?e.forEach(function(e,t){this.append(t,e)},this):Array.isArray(e)?e.forEach(function(e){this.append(e[0],e[1])},this):e&&Object.getOwnPropertyNames(e).forEach(function(t){this.append(t,e[t])},this)}function p(e){if(e.bodyUsed)return Promise.reject(new TypeError("Already read"));e.bodyUsed=!0}function m(e){return new Promise(function(t,n){e.onload=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function _(e){var t=new FileReader,n=m(t);return t.readAsArrayBuffer(e),n}function h(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function b(){return this.bodyUsed=!1,this._initBody=function(e){var t;this._bodyInit=e,e?"string"==typeof e?this._bodyText=e:i&&Blob.prototype.isPrototypeOf(e)?this._bodyBlob=e:r&&FormData.prototype.isPrototypeOf(e)?this._bodyFormData=e:n&&URLSearchParams.prototype.isPrototypeOf(e)?this._bodyText=e.toString():o&&i&&(t=e)&&DataView.prototype.isPrototypeOf(t)?(this._bodyArrayBuffer=h(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):o&&(ArrayBuffer.prototype.isPrototypeOf(e)||c(e))?this._bodyArrayBuffer=h(e):this._bodyText=e=Object.prototype.toString.call(e):this._bodyText="",this.headers.get("content-type")||("string"==typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):n&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},i&&(this.blob=function(){var e=p(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?p(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(_)}),this.text=function(){var e,t,n,a=p(this);if(a)return a;if(this._bodyBlob)return e=this._bodyBlob,n=m(t=new FileReader),t.readAsText(e),n;if(this._bodyArrayBuffer)return Promise.resolve(function(e){for(var t=new Uint8Array(e),n=new Array(t.length),a=0;a<t.length;a++)n[a]=String.fromCharCode(t[a]);return n.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},r&&(this.formData=function(){return this.text().then(y)}),this.json=function(){return this.text().then(JSON.parse)},this}f.prototype.append=function(e,t){e=d(e),t=l(t);var n=this.map[e];this.map[e]=n?n+", "+t:t},f.prototype.delete=function(e){delete this.map[d(e)]},f.prototype.get=function(e){return e=d(e),this.has(e)?this.map[e]:null},f.prototype.has=function(e){return this.map.hasOwnProperty(d(e))},f.prototype.set=function(e,t){this.map[d(e)]=l(t)},f.prototype.forEach=function(e,t){for(var n in this.map)this.map.hasOwnProperty(n)&&e.call(t,this.map[n],n,this)},f.prototype.keys=function(){var e=[];return this.forEach(function(t,n){e.push(n)}),u(e)},f.prototype.values=function(){var e=[];return this.forEach(function(t){e.push(t)}),u(e)},f.prototype.entries=function(){var e=[];return this.forEach(function(t,n){e.push([n,t])}),u(e)},a&&(f.prototype[Symbol.iterator]=f.prototype.entries);var g=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function v(e,t){var n,a,i=(t=t||{}).body;if(e instanceof v){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new f(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,i||null==e._bodyInit||(i=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"same-origin",!t.headers&&this.headers||(this.headers=new f(t.headers)),this.method=(a=(n=t.method||this.method||"GET").toUpperCase(),g.indexOf(a)>-1?a:n),this.mode=t.mode||this.mode||null,this.signal=t.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&i)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(i)}function y(e){var t=new FormData;return e.trim().split("&").forEach(function(e){if(e){var n=e.split("="),a=n.shift().replace(/\+/g," "),i=n.join("=").replace(/\+/g," ");t.append(decodeURIComponent(a),decodeURIComponent(i))}}),t}function S(e,t){t||(t={}),this.type="default",this.status=void 0===t.status?200:t.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in t?t.statusText:"OK",this.headers=new f(t.headers),this.url=t.url||"",this._initBody(e)}v.prototype.clone=function(){return new v(this,{body:this._bodyInit})},b.call(v.prototype),b.call(S.prototype),S.prototype.clone=function(){return new S(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new f(this.headers),url:this.url})},S.error=function(){var e=new S(null,{status:0,statusText:""});return e.type="error",e};var D=[301,302,303,307,308];S.redirect=function(e,t){if(-1===D.indexOf(t))throw new RangeError("Invalid status code");return new S(null,{status:t,headers:{location:e}})},t.DOMException=e.DOMException;try{new t.DOMException}catch(e){t.DOMException=function(e,t){this.message=e,this.name=t;var n=Error(e);this.stack=n.stack},t.DOMException.prototype=Object.create(Error.prototype),t.DOMException.prototype.constructor=t.DOMException}function I(e,n){return new Promise(function(a,r){var o=new v(e,n);if(o.signal&&o.signal.aborted)return r(new t.DOMException("Aborted","AbortError"));var s=new XMLHttpRequest;function c(){s.abort()}s.onload=function(){var e,t,n={status:s.status,statusText:s.statusText,headers:(e=s.getAllResponseHeaders()||"",t=new f,e.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(e){var n=e.split(":"),a=n.shift().trim();if(a){var i=n.join(":").trim();t.append(a,i)}}),t)};n.url="responseURL"in s?s.responseURL:n.headers.get("X-Request-URL");var i="response"in s?s.response:s.responseText;a(new S(i,n))},s.onerror=function(){r(new TypeError("Network request failed"))},s.ontimeout=function(){r(new TypeError("Network request failed"))},s.onabort=function(){r(new t.DOMException("Aborted","AbortError"))},s.open(o.method,o.url,!0),"include"===o.credentials?s.withCredentials=!0:"omit"===o.credentials&&(s.withCredentials=!1),"responseType"in s&&i&&(s.responseType="blob"),o.headers.forEach(function(e,t){s.setRequestHeader(t,e)}),o.signal&&(o.signal.addEventListener("abort",c),s.onreadystatechange=function(){4===s.readyState&&o.signal.removeEventListener("abort",c)}),s.send(void 0===o._bodyInit?null:o._bodyInit)})}I.polyfill=!0,e.fetch||(e.fetch=I,e.Headers=f,e.Request=v,e.Response=S),t.Headers=f,t.Request=v,t.Response=S,t.fetch=I,Object.defineProperty(t,"__esModule",{value:!0})}({})}(a),a.fetch.ponyfill=!0,delete a.fetch.polyfill;var i=a;(t=i.fetch).default=i.fetch,t.fetch=i.fetch,t.Headers=i.Headers,t.Request=i.Request,t.Response=i.Response,e.exports=t}
,22:e=>{"use strict";function t(e){if(this._capacity=a(e),this._length=0,this._front=0,n(e)){for(var t=e.length,i=0;i<t;++i)this[i]=e[i];this._length=t}}t.prototype.toArray=function(){for(var e=this._length,t=new Array(e),n=this._front,a=this._capacity,i=0;i<e;++i)t[i]=this[n+i&a-1];return t},t.prototype.push=function(e){var t=arguments.length,n=this._length;if(t>1){var a=this._capacity;if(n+t>a){for(var i=0;i<t;++i)this._checkCapacity(n+1),this[r=this._front+n&this._capacity-1]=arguments[i],n++,this._length=n;return n}var r=this._front;for(i=0;i<t;++i)this[r+n&a-1]=arguments[i],r++;return this._length=n+t,n+t}return 0===t?n:(this._checkCapacity(n+1),this[i=this._front+n&this._capacity-1]=e,this._length=n+1,n+1)},t.prototype.pop=function(){var e=this._length;if(0!==e){var t=this._front+e-1&this._capacity-1,n=this[t];return this[t]=void 0,this._length=e-1,n}},t.prototype.shift=function(){var e=this._length;if(0!==e){var t=this._front,n=this[t];return this[t]=void 0,this._front=t+1&this._capacity-1,this._length=e-1,n}},t.prototype.unshift=function(e){var t=this._length,n=arguments.length;if(n>1){if(t+n>(i=this._capacity)){for(var a=n-1;a>=0;a--){this._checkCapacity(t+1);var i=this._capacity;this[o=(this._front-1&i-1^i)-i]=arguments[a],t++,this._length=t,this._front=o}return t}var r=this._front;for(a=n-1;a>=0;a--){var o;this[o=(r-1&i-1^i)-i]=arguments[a],r=o}return this._front=r,this._length=t+n,t+n}return 0===n?t:(this._checkCapacity(t+1),i=this._capacity,this[a=(this._front-1&i-1^i)-i]=e,this._length=t+1,this._front=a,t+1)},t.prototype.peekBack=function(){var e=this._length;if(0!==e)return this[this._front+e-1&this._capacity-1]},t.prototype.peekFront=function(){if(0!==this._length)return this[this._front]},t.prototype.get=function(e){var t=e;if(t===(0|t)){var n=this._length;if(t<0&&(t+=n),!(t<0||t>=n))return this[this._front+t&this._capacity-1]}},t.prototype.isEmpty=function(){return 0===this._length},t.prototype.clear=function(){for(var e=this._length,t=this._front,n=this._capacity,a=0;a<e;++a)this[t+a&n-1]=void 0;this._length=0,this._front=0},t.prototype.toString=function(){return this.toArray().toString()},t.prototype.valueOf=t.prototype.toString,t.prototype.removeFront=t.prototype.shift,t.prototype.removeBack=t.prototype.pop,t.prototype.insertFront=t.prototype.unshift,t.prototype.insertBack=t.prototype.push,t.prototype.enqueue=t.prototype.push,t.prototype.dequeue=t.prototype.shift,t.prototype.toJSON=t.prototype.toArray,Object.defineProperty(t.prototype,"length",{get:function(){return this._length},set:function(){throw new RangeError("")}}),t.prototype._checkCapacity=function(e){this._capacity<e&&this._resizeTo(a(1.5*this._capacity+16))},t.prototype._resizeTo=function(e){var t=this._capacity;this._capacity=e;var n=this._front,a=this._length;n+a>t&&function(e,t,n,a,i){for(var r=0;r<i;++r)n[r+a]=e[r+0],e[r+0]=void 0}(this,0,this,t,n+a&t-1)};var n=Array.isArray;function a(e){if("number"!=typeof e){if(!n(e))return 16;e=e.length}return t=Math.min(Math.max(16,e),1073741824),t>>>=0,t-=1,t|=t>>1,t|=t>>2,t|=t>>4,1+((t|=t>>8)|t>>16);var t}e.exports=t}
,662:e=>{"use strict";var t=Object.prototype.hasOwnProperty,n="~";function a(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function r(e,t,a,r,o){if("function"!=typeof a)throw new TypeError("The listener must be a function");var s=new i(a,r||e,o),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],s]:e._events[c].push(s):(e._events[c]=s,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new a:delete e._events[t]}function s(){this._events=new a,this._eventsCount=0}Object.create&&(a.prototype=Object.create(null),(new a).__proto__||(n=!1)),s.prototype.eventNames=function(){var e,a,i=[];if(0===this._eventsCount)return i;for(a in e=this._events)t.call(e,a)&&i.push(n?a.slice(1):a);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},s.prototype.listeners=function(e){var t=n?n+e:e,a=this._events[t];if(!a)return[];if(a.fn)return[a.fn];for(var i=0,r=a.length,o=new Array(r);i<r;i++)o[i]=a[i].fn;return o},s.prototype.listenerCount=function(e){var t=n?n+e:e,a=this._events[t];return a?a.fn?1:a.length:0},s.prototype.emit=function(e,t,a,i,r,o){var s=n?n+e:e;if(!this._events[s])return!1;var c,d,l=this._events[s],u=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),u){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,a),!0;case 4:return l.fn.call(l.context,t,a,i),!0;case 5:return l.fn.call(l.context,t,a,i,r),!0;case 6:return l.fn.call(l.context,t,a,i,r,o),!0}for(d=1,c=new Array(u-1);d<u;d++)c[d-1]=arguments[d];l.fn.apply(l.context,c)}else{var f,p=l.length;for(d=0;d<p;d++)switch(l[d].once&&this.removeListener(e,l[d].fn,void 0,!0),u){case 1:l[d].fn.call(l[d].context);break;case 2:l[d].fn.call(l[d].context,t);break;case 3:l[d].fn.call(l[d].context,t,a);break;case 4:l[d].fn.call(l[d].context,t,a,i);break;default:if(!c)for(f=1,c=new Array(u-1);f<u;f++)c[f-1]=arguments[f];l[d].fn.apply(l[d].context,c)}}return!0},s.prototype.on=function(e,t,n){return r(this,e,t,n,!1)},s.prototype.once=function(e,t,n){return r(this,e,t,n,!0)},s.prototype.removeListener=function(e,t,a,i){var r=n?n+e:e;if(!this._events[r])return this;if(!t)return o(this,r),this;var s=this._events[r];if(s.fn)s.fn!==t||i&&!s.once||a&&s.context!==a||o(this,r);else{for(var c=0,d=[],l=s.length;c<l;c++)(s[c].fn!==t||i&&!s[c].once||a&&s[c].context!==a)&&d.push(s[c]);d.length?this._events[r]=1===d.length?d[0]:d:o(this,r)}return this},s.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&o(this,t)):(this._events=new a,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=n,s.EventEmitter=s,e.exports=s}
,513:e=>{"use strict";e.exports=function e(t,n){if(t===n)return!0;if(t&&n&&"object"==typeof t&&"object"==typeof n){if(t.constructor!==n.constructor)return!1;var a,i,r;if(Array.isArray(t)){if((a=t.length)!=n.length)return!1;for(i=a;0!=i--;)if(!e(t[i],n[i]))return!1;return!0}if(t.constructor===RegExp)return t.source===n.source&&t.flags===n.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===n.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===n.toString();if((a=(r=Object.keys(t)).length)!==Object.keys(n).length)return!1;for(i=a;0!=i--;)if(!Object.prototype.hasOwnProperty.call(n,r[i]))return!1;for(i=a;0!=i--;){var o=r[i];if(!e(t[o],n[o]))return!1}return!0}return t!=t&&n!=n}}
,832:function(e,t,n){!function(e){"use strict";function t(e){for(var t=0,n=Math.min(65536,e.length+1),a=new Uint16Array(n),i=[],r=0;;){var o=t<e.length;if(!o||r>=n-1){var s=a.subarray(0,r);if(i.push(String.fromCharCode.apply(null,s)),!o)return i.join("");e=e.subarray(t),t=0,r=0}var c=e[t++];if(0==(128&c))a[r++]=c;else if(192==(224&c)){var d=63&e[t++];a[r++]=(31&c)<<6|d}else if(224==(240&c)){d=63&e[t++];var l=63&e[t++];a[r++]=(31&c)<<12|d<<6|l}else if(240==(248&c)){var u=(7&c)<<18|(d=63&e[t++])<<12|(l=63&e[t++])<<6|63&e[t++];u>65535&&(u-=65536,a[r++]=u>>>10&1023|55296,u=56320|1023&u),a[r++]=u}}}var n="Failed to ",a=function(e,t,a){if(e)throw new Error("".concat(n).concat(t,": the '").concat(a,"' option is unsupported."))},i="function"==typeof Buffer&&Buffer.from,r=i?function(e){return Buffer.from(e)}:function(e){for(var t=0,n=e.length,a=0,i=Math.max(32,n+(n>>>1)+7),r=new Uint8Array(i>>>3<<3);t<n;){var o=e.charCodeAt(t++);if(o>=55296&&o<=56319){if(t<n){var s=e.charCodeAt(t);56320==(64512&s)&&(++t,o=((1023&o)<<10)+(1023&s)+65536)}if(o>=55296&&o<=56319)continue}if(a+4>r.length){i+=8,i=(i*=1+t/e.length*2)>>>3<<3;var c=new Uint8Array(i);c.set(r),r=c}if(0!=(4294967168&o)){if(0==(4294965248&o))r[a++]=o>>>6&31|192;else if(0==(4294901760&o))r[a++]=o>>>12&15|224,r[a++]=o>>>6&63|128;else{if(0!=(4292870144&o))continue;r[a++]=o>>>18&7|240,r[a++]=o>>>12&63|128,r[a++]=o>>>6&63|128}r[a++]=63&o|128}else r[a++]=o}return r.slice?r.slice(0,a):r.subarray(0,a)};function o(){this.encoding="utf-8"}o.prototype.encode=function(e,t){return a(t&&t.stream,"encode","stream"),r(e)};var s=!i&&"function"==typeof Blob&&"function"==typeof URL&&"function"==typeof URL.createObjectURL,c=["utf-8","utf8","unicode-1-1-utf-8"],d=t;i?d=function(e,t){return(e instanceof Buffer?e:Buffer.from(e.buffer,e.byteOffset,e.byteLength)).toString(t)}:s&&(d=function(e){try{return function(e){var t;try{var n=new Blob([e],{type:"text/plain;charset=UTF-8"});t=URL.createObjectURL(n);var a=new XMLHttpRequest;return a.open("GET",t,!1),a.send(),a.responseText}finally{t&&URL.revokeObjectURL(t)}}(e)}catch(n){return t(e)}});var l="construct 'TextDecoder'",u="".concat(n," ").concat(l,": the ");function f(e,t){if(a(t&&t.fatal,l,"fatal"),e=e||"utf-8",!(i?Buffer.isEncoding(e):-1!==c.indexOf(e.toLowerCase())))throw new RangeError("".concat(u," encoding label provided ('").concat(e,"') is invalid."));this.encoding=e,this.fatal=!1,this.ignoreBOM=!1}f.prototype.decode=function(e,t){var n;return a(t&&t.stream,"decode","stream"),n=e instanceof Uint8Array?e:e.buffer instanceof ArrayBuffer?new Uint8Array(e.buffer):new Uint8Array(e),d(n,this.encoding)},e.TextEncoder=e.TextEncoder||o,e.TextDecoder=e.TextDecoder||f}("undefined"!=typeof window?window:void 0!==n.g?n.g:this)}
,676:t=>{"use strict";t.exports=e},207:e=>{"use strict";e.exports=t},909:e=>{"use strict";e.exports=a},737:e=>{"use strict";e.exports=n},938:e=>{"use strict";e.exports={r:"2.37.158"}}
},r={};function o(e){var t=r[e];if(void 0!==t)return t.exports;var n=r[e]={exports:{}};return i[e].call(n.exports,n,n.exports,o),n.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};return(()=>{"use strict";o.r(s),o.d(s,{AddOperation:()=>f,AlWorkflowProxy:()=>Yd,Document:()=>zt,RecurrenceFrequency:()=>Ud,SMABrokenLinksSignal:()=>Dd,SharePointCopilotRPCFunctions:()=>Ld,SharepointCopilotRequest:()=>Jd,SharepointSMAExecutionStatus:()=>Ad,TextTile:()=>E,getRecommendedFiles:()=>il,searchFileEntity:()=>al});class e{constructor(t){e.assign(e,this,t)}static getTypeName(){return"AugLoop_Core_SchemaObject"}static getBaseTypes(){return[]}static getTypeNameFor(e){return e&&e.H_?e.H_.T_:void 0}static getBaseTypesFor(e){return e&&e.H_&&e.H_.B_&&Array.isArray(e.H_.B_)?e.H_.B_:[]}static getAllTypesFor(t){const n=e.getTypeNameFor(t);return n?[n,...e.getBaseTypesFor(t)]:[]}static matchesTypesFor(t,n){if(!Array.isArray(n)||0===n.length)return!0;const a=e.getTypeNameFor(t),i=e.getBaseTypesFor(t);for(const e of n){if(e===a)return!0;if(i.indexOf(e)>=0)return!0}return!1}static assign(e,t,n){if(n)for(const e of Object.keys(n))t[e]=n[e];return t.H_=e.H_,t}}e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()};class t{constructor(n){e.assign(t,this,n)}static getTypeName(){return"AugLoop_Chat_ChatsHolder"}static getBaseTypes(){return["AugLoop_Core_TileGroup"]}static typeGuard(n){return e.matchesTypesFor(n,[t.getTypeName()])}}t.H_={T_:t.getTypeName(),B_:t.getBaseTypes()};class n{constructor(t){e.assign(n,this,t)}static getTypeName(){return"AugLoop_Chat_Chat"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[n.getTypeName()])}}n.H_={T_:n.getTypeName(),B_:n.getBaseTypes()};class a{constructor(t){e.assign(a,this,t)}static getTypeName(){return"AugLoop_Chat_MessagesHolder"}static getBaseTypes(){return["AugLoop_Core_TileGroup"]}static typeGuard(t){return e.matchesTypesFor(t,[a.getTypeName()])}}a.H_={T_:a.getTypeName(),B_:a.getBaseTypes()};class i{constructor(t){e.assign(i,this,t)}static getTypeName(){return"AugLoop_Chat_ChatMessage"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[i.getTypeName()])}}i.H_={T_:i.getTypeName(),B_:i.getBaseTypes()};class r{constructor(t){e.assign(r,this,t)}static getTypeName(){return"AugLoop_Chat_TextChatMessage"}static getBaseTypes(){return["AugLoop_Chat_ChatMessage"]}static typeGuard(t){return e.matchesTypesFor(t,[r.getTypeName()])}}r.H_={T_:r.getTypeName(),B_:r.getBaseTypes()};class c{constructor(t){e.assign(c,this,t)}static getTypeName(){return"AugLoop_Core_ItemDelta"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[c.getTypeName()])}}c.H_={T_:c.getTypeName(),B_:c.getBaseTypes()};class d{constructor(t){e.assign(d,this,t)}static getTypeName(){return"AugLoop_Core_ItemChangesDelta"}static getBaseTypes(){return["AugLoop_Core_ItemDelta"]}static typeGuard(t){return e.matchesTypesFor(t,[d.getTypeName()])}}d.H_={T_:d.getTypeName(),B_:d.getBaseTypes()};class l{constructor(t){e.assign(l,this,t)}static getTypeName(){return"AugLoop_Core_Operation"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[l.getTypeName()])}}l.H_={T_:l.getTypeName(),B_:l.getBaseTypes()};class u{constructor(t){e.assign(u,this,t)}static getTypeName(){return"AugLoop_Core_OperationWithSiblingContext"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[u.getTypeName()])}}u.H_={T_:u.getTypeName(),B_:u.getBaseTypes()};class f{constructor(t){e.assign(f,this,t)}static getTypeName(){return"AugLoop_Core_AddOperation"}static getBaseTypes(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[f.getTypeName()])}}f.H_={T_:f.getTypeName(),B_:f.getBaseTypes()};class p{constructor(t){e.assign(p,this,t)}static getTypeName(){return"AugLoop_Core_MoveOperation"}static getBaseTypes(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[p.getTypeName()])}}p.H_={T_:p.getTypeName(),B_:p.getBaseTypes()};class m{constructor(t){e.assign(m,this,t)}static getTypeName(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[m.getTypeName()])}}m.H_={T_:m.getTypeName(),B_:m.getBaseTypes()};class _{constructor(t){e.assign(_,this,t)}static getTypeName(){return"AugLoop_Core_UpdateOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[_.getTypeName()])}}_.H_={T_:_.getTypeName(),B_:_.getBaseTypes()};class h{constructor(t){e.assign(h,this,t)}static getTypeName(){return"AugLoop_Core_DeleteOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[h.getTypeName()])}}h.H_={T_:h.getTypeName(),B_:h.getBaseTypes()};class b{constructor(t){e.assign(b,this,t)}static getTypeName(){return"AugLoop_Core_PurgeOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[b.getTypeName()])}}b.H_={T_:b.getTypeName(),B_:b.getBaseTypes()};class g{constructor(t){e.assign(g,this,t)}static getTypeName(){return"AugLoop_Core_PurgeSubtreeExceptTypesOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[g.getTypeName()])}}g.H_={T_:g.getTypeName(),B_:g.getBaseTypes()};class v{constructor(t){e.assign(v,this,t)}static getTypeName(){return"AugLoop_Core_PurgeByTypesOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[v.getTypeName()])}}v.H_={T_:v.getTypeName(),B_:v.getBaseTypes()};class y{constructor(t){e.assign(y,this,t)}static getTypeName(){return"AugLoop_Core_FocusOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[y.getTypeName()])}}y.H_={T_:y.getTypeName(),B_:y.getBaseTypes()};class S{constructor(t){e.assign(S,this,t)}static getTypeName(){return"AugLoop_Core_VisibilityOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[S.getTypeName()])}}S.H_={T_:S.getTypeName(),B_:S.getBaseTypes()};class D{constructor(t){e.assign(D,this,t)}static getTypeName(){return"AugLoop_Core_DeltaUpdateOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[D.getTypeName()])}}D.H_={T_:D.getTypeName(),B_:D.getBaseTypes()};class I{constructor(t){e.assign(I,this,t)}static getTypeName(){return"AugLoop_Core_MicroSyncOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[I.getTypeName()])}}I.H_={T_:I.getTypeName(),B_:I.getBaseTypes()};class x{constructor(t){e.assign(x,this,t)}static getTypeName(){return"AugLoop_Signals_SignalOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[x.getTypeName()])}}x.H_={T_:x.getTypeName(),B_:x.getBaseTypes()};class C{constructor(t){e.assign(C,this,t)}static getTypeName(){return"AugLoop_Core_CancelSignalTriggeredWorkflowExecutionOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[C.getTypeName()])}}function O(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}C.H_={T_:C.getTypeName(),B_:C.getBaseTypes()};class w{static create(e){const t=new w(e);return t.activateAnnotation(e.responseType).then(()=>t)}constructor(e){this.config=e,this.nextMessageId=0,this.responseCallbacks=new Map;const t=["session","chats"],n=O(),i="messages",r=[...t,n];this.messagesPath=[...r,i],this.config.session.submitOperations([new f({parentPath:t,items:[{id:n,body:e.chat}]}),new f({parentPath:r,items:[{id:i,body:new a}]})])}send(e,t){const n=""+this.nextMessageId++;this.responseCallbacks.set(n,t),this.config.session.submitOperations([new f({parentPath:this.messagesPath,items:[{id:n,body:e}]})])}close(){return this.config.session.releaseAnnotation(this.activatedAnnotationToken)}activateAnnotation(e){return this.config.session.activateAnnotation(e,{callback:e=>{if(f.typeGuard(e)&&this.isUnderSubtree(e.parentPath,this.messagesPath))for(const t of e.items){const n=e.parentPath[e.parentPath.length-1],a=this.responseCallbacks.get(n);a&&(a(t.body),this.responseCallbacks.delete(n))}}}).then(({token:e})=>{this.activatedAnnotationToken=e})}isUnderSubtree(e,t){if(e.length<t.length)return!1;for(let n=0;n<t.length;n++)if(e[n]!==t[n])return!1;return!0}}class E{constructor(t){e.assign(E,this,t)}static getTypeName(){return"AugLoop_Text_TextTile"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[E.getTypeName()])}}E.H_={T_:E.getTypeName(),B_:E.getBaseTypes()};class A{constructor(t){e.assign(A,this,t)}static getTypeName(){return"AugLoop_Text_FormattedTextTile"}static getBaseTypes(){return["AugLoop_Text_TextTile"]}static typeGuard(t){return e.matchesTypesFor(t,[A.getTypeName()])}}A.H_={T_:A.getTypeName(),B_:A.getBaseTypes()};class L{constructor(t){e.assign(L,this,t)}static getTypeName(){return"AugLoop_Text_InlineTile"}static getBaseTypes(){return["AugLoop_Text_TextTile"]}static typeGuard(t){return e.matchesTypesFor(t,[L.getTypeName()])}}L.H_={T_:L.getTypeName(),B_:L.getBaseTypes()};class k{constructor(t){e.assign(k,this,t)}static getTypeName(){return"AugLoop_Text_DynamicTextContext"}static getBaseTypes(){return["AugLoop_Core_DynamicContext"]}static typeGuard(t){return e.matchesTypesFor(t,[k.getTypeName()])}}k.H_={T_:k.getTypeName(),B_:k.getBaseTypes()};class M{constructor(t){e.assign(M,this,t)}static getTypeName(){return"AugLoop_Text_TaskTile"}static getBaseTypes(){return["AugLoop_Text_FormattedTextTile","AugLoop_Text_TextTile"]}static typeGuard(t){return e.matchesTypesFor(t,[M.getTypeName()])}}M.H_={T_:M.getTypeName(),B_:M.getBaseTypes()};class P{constructor(t){e.assign(P,this,t)}static getTypeName(){return"AugLoop_Text_PersonTile"}static getBaseTypes(){return["AugLoop_Text_InlineTile","AugLoop_Text_TextTile"]}static typeGuard(t){return e.matchesTypesFor(t,[P.getTypeName()])}}P.H_={T_:P.getTypeName(),B_:P.getBaseTypes()};class T{constructor(t){e.assign(T,this,t)}static getTypeName(){return"AugLoop_Text_DateTile"}static getBaseTypes(){return["AugLoop_Text_InlineTile","AugLoop_Text_TextTile"]}static typeGuard(t){return e.matchesTypesFor(t,[T.getTypeName()])}}T.H_={T_:T.getTypeName(),B_:T.getBaseTypes()};class U{constructor(t){e.assign(U,this,t)}static getTypeName(){return"AugLoop_Text_LinkTile"}static getBaseTypes(){return["AugLoop_Text_InlineTile","AugLoop_Text_TextTile"]}static typeGuard(t){return e.matchesTypesFor(t,[U.getTypeName()])}}U.H_={T_:U.getTypeName(),B_:U.getBaseTypes()};class F{constructor(t){e.assign(F,this,t)}static getTypeName(){return"AugLoop_Text_CommentTile"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[F.getTypeName()])}}F.H_={T_:F.getTypeName(),B_:F.getBaseTypes()};var H,R,N,B,j,V,z,G,K,W,q,Q,Y,J,X,Z,$=o(676),ee=o(207);class te{constructor(t){e.assign(te,this,t)}static getTypeName(){return"AugLoop_BasicChat_BasicChat"}static getBaseTypes(){return["AugLoop_Chat_Chat"]}static typeGuard(t){return e.matchesTypesFor(t,[te.getTypeName()])}}te.H_={T_:te.getTypeName(),B_:te.getBaseTypes()};class ne{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(ne,this,t)}static getTypeName(){return"AugLoop_BasicChat_BasicChatResponse"}static getBaseTypes(){return["AugLoop_GenerativeAi_TextChatResponse","AugLoop_Chat_ChatResponse","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[ne.getTypeName()])}}ne.H_={T_:ne.getTypeName(),B_:ne.getBaseTypes()},function(e){e[e.Success=0]="Success",e[e.OffensiveContentInput=1]="OffensiveContentInput",e[e.OffensiveContentOutput=2]="OffensiveContentOutput",e[e.EmptyResponse=3]="EmptyResponse",e[e.ErrorInExecution=4]="ErrorInExecution",e[e.ResourcesNotAvailable=5]="ResourcesNotAvailable",e[e.RaiUnsupportedLanguageInContentInput=6]="RaiUnsupportedLanguageInContentInput",e[e.RaiUnsupportedLanguageInContentOutput=7]="RaiUnsupportedLanguageInContentOutput",e[e.InputBlockedByDynamicGuardList=8]="InputBlockedByDynamicGuardList",e[e.OutputBlockedByDynamicGuardList=9]="OutputBlockedByDynamicGuardList",e[e.InputAttackDetected=10]="InputAttackDetected",e[e.OutputAttackDetected=11]="OutputAttackDetected",e[e.EnumValueNotInUse=12]="EnumValueNotInUse",e[e.PartialResult=13]="PartialResult",e[e.ModelContentFilter=14]="ModelContentFilter",e[e.Unknown=15]="Unknown",e[e.Overloaded=16]="Overloaded",e[e.Timeout=17]="Timeout",e[e.TooLargeRequest=18]="TooLargeRequest",e[e.BadRequest=19]="BadRequest",e[e.InternalServerError=20]="InternalServerError",e[e.UserNotAuthenticated=21]="UserNotAuthenticated",e[e.UserNotAuthorized=22]="UserNotAuthorized",e[e.UserThrottled=23]="UserThrottled",e[e.ScenarioThrottled=24]="ScenarioThrottled",e[e.InvalidFormatting=25]="InvalidFormatting",e[e.WorkflowQuotaLimitExceeded=26]="WorkflowQuotaLimitExceeded",e[e.UnsupportedRequirement=27]="UnsupportedRequirement",e[e.UrlPresentInInput=28]="UrlPresentInInput",e[e.DocumentUrlChangeDetected=29]="DocumentUrlChangeDetected",e[e.ExpectedError=30]="ExpectedError",e[e.BlockedByUserPrompt=31]="BlockedByUserPrompt",e[e.PromptDefinedError=32]="PromptDefinedError",e[e.FailedToGetFileContents=33]="FailedToGetFileContents",e[e.OutputBlockedByDynamicBlockList=34]="OutputBlockedByDynamicBlockList",e[e.ProtectedMaterial=35]="ProtectedMaterial",e[e.Skipped=36]="Skipped",e[e.DeferredRaiFailure=37]="DeferredRaiFailure",e[e.OutOfCredits=38]="OutOfCredits",e[e.InputGroundingAttackDetected=39]="InputGroundingAttackDetected",e[e.ToolCalls=40]="ToolCalls",e[e.UnknownSydneyError=41]="UnknownSydneyError",e[e.GenericSydneyError=42]="GenericSydneyError",e[e.HttpStatusCodeSydneyError=43]="HttpStatusCodeSydneyError",e[e.AuthenticationSydneyError=44]="AuthenticationSydneyError",e[e.DisengagedSydneyError=45]="DisengagedSydneyError",e[e.NotEnoughTranscript=46]="NotEnoughTranscript",e[e.NotFoundError=47]="NotFoundError",e[e.DlpPromptBlocked=48]="DlpPromptBlocked"}(H||(H={})),function(e){e.text="text",e.image="image"}(R||(R={})),function(e){e.System="system",e.User="user",e.Assistant="assistant",e.Tool="tool",e.Developer="developer"}(N||(N={})),function(e){e.text="text",e.image_url="image_url",e.input_audio="input_audio",e.file="file",e.refusal="refusal"}(B||(B={})),function(e){e.wav="wav",e.mp3="mp3"}(j||(j={})),function(e){e.Function="function"}(V||(V={})),function(e){e.NotStarted="NotStarted",e.Running="Running",e.Succeeded="Succeeded",e.Failed="Failed"}(z||(z={})),function(e){e.Preprocessing="preprocessing",e.Queued="queued",e.Processing="processing",e.Running="running",e.Cancelled="cancelled",e.Succeeded="succeeded",e.Failed="failed",e.Unknown="unknown"}(G||(G={}));class ae{constructor(t){e.assign(ae,this,t)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(t){return e.matchesTypesFor(t,[ae.getTypeName()])}}ae.H_={T_:ae.getTypeName(),B_:ae.getBaseTypes()};class ie{constructor(t){e.assign(ie,this,t)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiImageModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(t){return e.matchesTypesFor(t,[ie.getTypeName()])}}ie.H_={T_:ie.getTypeName(),B_:ie.getBaseTypes()};class re{constructor(t){e.assign(re,this,t)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiModelWithParametersConfigBase"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(t){return e.matchesTypesFor(t,[re.getTypeName()])}}re.H_={T_:re.getTypeName(),B_:re.getBaseTypes()};class oe{constructor(t){e.assign(oe,this,t)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiEmbeddingsModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(t){return e.matchesTypesFor(t,[oe.getTypeName()])}}oe.H_={T_:oe.getTypeName(),B_:oe.getBaseTypes()};class se{constructor(t){e.assign(se,this,t)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiTextModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiModelWithParametersConfigBase","AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(t){return e.matchesTypesFor(t,[se.getTypeName()])}}se.H_={T_:se.getTypeName(),B_:se.getBaseTypes()};class ce{constructor(t){e.assign(ce,this,t)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiMultiModalityModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiModelWithParametersConfigBase","AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(t){return e.matchesTypesFor(t,[ce.getTypeName()])}}ce.H_={T_:ce.getTypeName(),B_:ce.getBaseTypes()};class de{constructor(t){e.assign(de,this,t)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiChatModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiModelWithParametersConfigBase","AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(t){return e.matchesTypesFor(t,[de.getTypeName()])}}de.H_={T_:de.getTypeName(),B_:de.getBaseTypes()};class le{constructor(t){e.assign(le,this,t)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiMultiModalityChatModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiModelWithParametersConfigBase","AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(t){return e.matchesTypesFor(t,[le.getTypeName()])}}le.H_={T_:le.getTypeName(),B_:le.getBaseTypes()};class ue{constructor(t){e.assign(ue,this,t)}static getTypeName(){return"AugLoop_GenerativeAi_CognitiveApiMultiModalityChatModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiMultiModalityChatModelConfig","AugLoop_GenerativeAi_OpenAiModelWithParametersConfigBase","AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(t){return e.matchesTypesFor(t,[ue.getTypeName()])}}ue.H_={T_:ue.getTypeName(),B_:ue.getBaseTypes()};class fe{constructor(t){e.assign(fe,this,t)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiResponseModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiModelWithParametersConfigBase","AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(t){return e.matchesTypesFor(t,[fe.getTypeName()])}}fe.H_={T_:fe.getTypeName(),B_:fe.getBaseTypes()};class pe{constructor(t){e.assign(pe,this,t)}static getTypeName(){return"AugLoop_GenerativeAi_CognitiveApiResponseModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiResponseModelConfig","AugLoop_GenerativeAi_OpenAiModelWithParametersConfigBase","AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(t){return e.matchesTypesFor(t,[pe.getTypeName()])}}pe.H_={T_:pe.getTypeName(),B_:pe.getBaseTypes()},function(e){e[e.TextChatDavinci002=0]="TextChatDavinci002",e[e.TextDavinci001=1]="TextDavinci001",e[e.TextDavinci002=2]="TextDavinci002",e[e.TextDavinci003=3]="TextDavinci003",e[e.TextCurie001=4]="TextCurie001",e[e.TextBabbage001=5]="TextBabbage001",e[e.TextAda001=6]="TextAda001",e[e.CodeDavinci002=7]="CodeDavinci002",e[e.CodeCushman001=8]="CodeCushman001",e[e.Custom=9]="Custom",e[e.TextSimilarityAda001=10]="TextSimilarityAda001",e[e.TextSimilarityBabbage001=11]="TextSimilarityBabbage001",e[e.TextSimilarityCurie001=12]="TextSimilarityCurie001",e[e.TextSimilarityDavinci001=13]="TextSimilarityDavinci001",e[e.TextSearchAdaDoc001=14]="TextSearchAdaDoc001",e[e.TextSearchAdaQuery001=15]="TextSearchAdaQuery001",e[e.TextSearchBabbageDoc001=16]="TextSearchBabbageDoc001",e[e.TextSearchBabbageQuery001=17]="TextSearchBabbageQuery001",e[e.TextSearchCurieDoc001=18]="TextSearchCurieDoc001",e[e.TextSearchCurieQuery001=19]="TextSearchCurieQuery001",e[e.TextSearchDavinciDoc001=20]="TextSearchDavinciDoc001",e[e.TextSearchDavinciQuery001=21]="TextSearchDavinciQuery001",e[e.CodeSearchAdaCode001=22]="CodeSearchAdaCode001",e[e.CodeSearchAdaText001=23]="CodeSearchAdaText001",e[e.CodeSearchBabbageCode001=24]="CodeSearchBabbageCode001",e[e.CodeSearchBabbageText001=25]="CodeSearchBabbageText001",e[e.TextEmbeddingAda002=26]="TextEmbeddingAda002",e[e.Gpt35Turbo=27]="Gpt35Turbo",e[e.Gpt4_32k=28]="Gpt4_32k",e[e.Gpt4_0203=29]="Gpt4_0203",e[e.Gpt4_0314_4k=30]="Gpt4_0314_4k",e[e.Gpt4_0314_32k=31]="Gpt4_0314_32k",e[e.Gpt4_DV3_FP_Variant=32]="Gpt4_DV3_FP_Variant",e[e.Gpt4_DV3_FP=33]="Gpt4_DV3_FP",e[e.Gpt4_PPO_FP_Variant=34]="Gpt4_PPO_FP_Variant",e[e.Gpt4_PPO_FP=35]="Gpt4_PPO_FP",e[e.GptV=36]="GptV",e[e.Gpt35Turbo16k=37]="Gpt35Turbo16k",e[e.Gpt35TurboInstruct=38]="Gpt35TurboInstruct",e[e.Gpt4Turbo=39]="Gpt4Turbo",e[e.Gpt4=40]="Gpt4",e[e.Gpt4Turbo_0125=41]="Gpt4Turbo_0125",e[e.Gpt35Turbo_1106=42]="Gpt35Turbo_1106",e[e.Gpt35Turbo_0125=43]="Gpt35Turbo_0125",e[e.Gpt35Turbo_Deucalion=44]="Gpt35Turbo_Deucalion",e[e.Gpt4_0613=45]="Gpt4_0613",e[e.TextEmbedding3Small=46]="TextEmbedding3Small",e[e.TextEmbedding3Large=47]="TextEmbedding3Large",e[e.Gpt35Turbo_0613_EditorFineTuned_Japanese=48]="Gpt35Turbo_0613_EditorFineTuned_Japanese",e[e.TextEmbeddingAda002_Substrate=49]="TextEmbeddingAda002_Substrate",e[e.Gpt35Turbo_0125_AOAI=50]="Gpt35Turbo_0125_AOAI",e[e.Gpt4Turbo_0409=51]="Gpt4Turbo_0409",e[e.Gpt4o_0513=52]="Gpt4o_0513",e[e.Gpt4o_AOAI=53]="Gpt4o_AOAI",e[e.Gpt4o_Vision_0513=54]="Gpt4o_Vision_0513",e[e.Gpt4o_Mini=55]="Gpt4o_Mini",e[e.Gpt35Turbo_0125_EditorFineTuned_Japanese=56]="Gpt35Turbo_0125_EditorFineTuned_Japanese",e[e.Gpt4o_0806=57]="Gpt4o_0806",e[e.Gpt4o_Realtime=58]="Gpt4o_Realtime",e[e.GptO1=59]="GptO1",e[e.Dall_e_3=60]="Dall_e_3",e[e.Gpt4o_Canvas=61]="Gpt4o_Canvas",e[e.Gpt4o_Mini_PPT_V4_FT=62]="Gpt4o_Mini_PPT_V4_FT",e[e.Gpt4o_Mini_PPT_V3_FT=63]="Gpt4o_Mini_PPT_V3_FT",e[e.GptO1GA=64]="GptO1GA",e[e.Gpt4o_1120=65]="Gpt4o_1120",e[e.Deepseek_R1_Distill_Qwen_32b=66]="Deepseek_R1_Distill_Qwen_32b",e[e.Gpt_O3_Mini=67]="Gpt_O3_Mini",e[e.Gpt_O1_Mini=68]="Gpt_O1_Mini",e[e.Deepseek_R1_Full=69]="Deepseek_R1_Full",e[e.DeepResearch=70]="DeepResearch",e[e.DeepResearch_Thrall=71]="DeepResearch_Thrall",e[e.GptO1_AOAI=72]="GptO1_AOAI",e[e.GPT45_Preview=73]="GPT45_Preview",e[e.Gpt4o_Realtime_1217=74]="Gpt4o_Realtime_1217",e[e.Gpt4o_Mini_NLXFineTuned_Japanese=75]="Gpt4o_Mini_NLXFineTuned_Japanese",e[e.Diceberry=76]="Diceberry",e[e.Diceberry_01=77]="Diceberry_01",e[e.DevSolutionGenGPT4oMiniSwecFt=78]="DevSolutionGenGPT4oMiniSwecFt",e[e.GPT41=79]="GPT41",e[e.GPT41_LongCo_0414=80]="GPT41_LongCo_0414",e[e.GPT41_ShortCo_0414=81]="GPT41_ShortCo_0414",e[e.Gpt_O3=82]="Gpt_O3",e[e.Gpt_O4_Mini=83]="Gpt_O4_Mini",e[e.GPT41_Mini_0414=84]="GPT41_Mini_0414",e[e.GPT41_Nano_0414=85]="GPT41_Nano_0414",e[e.GPT41_AOAI=86]="GPT41_AOAI",e[e.SolutionGenGPT4oMiniAOAIFt=87]="SolutionGenGPT4oMiniAOAIFt",e[e.GPT4o_gg=88]="GPT4o_gg",e[e.Gpt4oMini_SolutionGenAP_Ft_V1=89]="Gpt4oMini_SolutionGenAP_Ft_V1",e[e.Sora=90]="Sora",e[e.SolutionGenGPT4oMiniAOAIFt_dogfood=91]="SolutionGenGPT4oMiniAOAIFt_dogfood",e[e.Gpt_O3_Pro=92]="Gpt_O3_Pro",e[e.Gpt4o_Realtime_0528=93]="Gpt4o_Realtime_0528",e[e.Gpt4o_chatgpt_imagegen_convo2im=94]="Gpt4o_chatgpt_imagegen_convo2im",e[e.Gpt5_Chat=95]="Gpt5_Chat",e[e.Gpt5_Reasoning=96]="Gpt5_Reasoning",e[e.Gpt5_Auto_Switcher=97]="Gpt5_Auto_Switcher",e[e.GPT5_Chat_202508_CAPI=98]="GPT5_Chat_202508_CAPI",e[e.Gpt5_Chat_Mini=99]="Gpt5_Chat_Mini",e[e.Gpt5_Mini=100]="Gpt5_Mini",e[e.Gpt5_Nano=101]="Gpt5_Nano",e[e.Gpt41_Mini_NLXFineTuned_Japanese=102]="Gpt41_Mini_NLXFineTuned_Japanese",e[e.GPT41_ShortCo_0414_Responses=103]="GPT41_ShortCo_0414_Responses",e[e.Gpt5_AOAI=104]="Gpt5_AOAI",e[e.GptModelRouter_AOAI=105]="GptModelRouter_AOAI",e[e.Phi2=10001]="Phi2",e[e.Mixtral_8x7b_Instruct_V01=10002]="Mixtral_8x7b_Instruct_V01",e[e.Mistral_7b_Instruct_V02=10003]="Mistral_7b_Instruct_V02",e[e.Mistral_7b_v01=10004]="Mistral_7b_v01",e[e.Phi3Mini=10005]="Phi3Mini",e[e.Phi3Medium=10006]="Phi3Medium",e[e.Phi3Small=10007]="Phi3Small",e[e.Phi3Vision=10008]="Phi3Vision",e[e.Phi3Small_PPT=10009]="Phi3Small_PPT",e[e.Phi3Vision_PPT=10010]="Phi3Vision_PPT",e[e.Phi35Mini=10011]="Phi35Mini",e[e.Phi35Moe=10012]="Phi35Moe",e[e.Phi3VisionImageAction=10013]="Phi3VisionImageAction",e[e.Phi4=10014]="Phi4",e[e.Phi4Mini=10015]="Phi4Mini",e[e.Phi4MultiModal=10016]="Phi4MultiModal",e[e.DevGPT4oMini01SwecMlFt=10017]="DevGPT4oMini01SwecMlFt",e[e.DevSwecMlSlot13Ft=10018]="DevSwecMlSlot13Ft",e[e.Phi3Small_Doc2PPT_FT=11e3]="Phi3Small_Doc2PPT_FT",e[e.SwecMlSlot11Ft=10019]="SwecMlSlot11Ft",e[e.GPT4oMini05SwecMlFt=10020]="GPT4oMini05SwecMlFt",e[e.DevSwecSlot13Ft=10021]="DevSwecSlot13Ft",e[e.DevGPT4oExcelAueMlFt=10022]="DevGPT4oExcelAueMlFt",e[e.Phi4_MM_PPTSummary_FT=10023]="Phi4_MM_PPTSummary_FT"}(K||(K={})),function(e){e.Function="function"}(W||(W={})),function(e){e.text="text",e.jsonObject="json_object"}(q||(q={})),function(e){e.content="content"}(Q||(Q={}));class me{constructor(t){e.assign(me,this,t)}static getTypeName(){return"AugLoop_AzureKeyPhrases_AzureKeyPhraseRequest"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[me.getTypeName()])}}me.H_={T_:me.getTypeName(),B_:me.getBaseTypes()};class _e{constructor(t){e.assign(_e,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_ExampleChat"}static getBaseTypes(){return["AugLoop_Chat_Chat"]}static typeGuard(t){return e.matchesTypesFor(t,[_e.getTypeName()])}}_e.H_={T_:_e.getTypeName(),B_:_e.getBaseTypes()};class he{constructor(t){e.assign(he,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_ExampleStructuredOutput"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[he.getTypeName()])}}he.H_={T_:he.getTypeName(),B_:he.getBaseTypes()};class be{constructor(t){e.assign(be,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_DocumentQuestionSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[be.getTypeName()])}}be.H_={T_:be.getTypeName(),B_:be.getBaseTypes()};class ge{constructor(t){e.assign(ge,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_FindMostRelevantTileSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[ge.getTypeName()])}}ge.H_={T_:ge.getTypeName(),B_:ge.getBaseTypes()};class ve{constructor(t){e.assign(ve,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_SentimentAnalysisSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[ve.getTypeName()])}}ve.H_={T_:ve.getTypeName(),B_:ve.getBaseTypes()};class ye{constructor(t){e.assign(ye,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_QuestionSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[ye.getTypeName()])}}ye.H_={T_:ye.getTypeName(),B_:ye.getBaseTypes()};class Se{constructor(t){e.assign(Se,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_DalleImageRequest"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Se.getTypeName()])}}Se.H_={T_:Se.getTypeName(),B_:Se.getBaseTypes()};class De{constructor(t){e.assign(De,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_MultiModalitySignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[De.getTypeName()])}}De.H_={T_:De.getTypeName(),B_:De.getBaseTypes()};class Ie{constructor(t){e.assign(Ie,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_CreateResponseSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Ie.getTypeName()])}}Ie.H_={T_:Ie.getTypeName(),B_:Ie.getBaseTypes()};class xe{constructor(t){e.assign(xe,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_CreateUnrestrictedSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[xe.getTypeName()])}}xe.H_={T_:xe.getTypeName(),B_:xe.getBaseTypes()};class Ce{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Ce,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_SentimentAnalysis"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Ce.getTypeName()])}}Ce.H_={T_:Ce.getTypeName(),B_:Ce.getBaseTypes()};class Oe{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Oe,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_AnswerToQuestionAboutDocument"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Oe.getTypeName()])}}Oe.H_={T_:Oe.getTypeName(),B_:Oe.getBaseTypes()};class we{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(we,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_AnswerToQuestion"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[we.getTypeName()])}}we.H_={T_:we.getTypeName(),B_:we.getBaseTypes()};class Ee{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Ee,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_RaiAnswerToQuestion"}static getBaseTypes(){return["AugLoop_ExampleGenerativeAi_AnswerToQuestion","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Ee.getTypeName()])}}Ee.H_={T_:Ee.getTypeName(),B_:Ee.getBaseTypes()};class Ae{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Ae,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_StreamedAnswerToQuestion"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Ae.getTypeName()])}}Ae.H_={T_:Ae.getTypeName(),B_:Ae.getBaseTypes()};class Le{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Le,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_MostRelevantTile"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Le.getTypeName()])}}Le.H_={T_:Le.getTypeName(),B_:Le.getBaseTypes()};class ke{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(ke,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_DalleImageResponse"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[ke.getTypeName()])}}ke.H_={T_:ke.getTypeName(),B_:ke.getBaseTypes()};class Me{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Me,this,t)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_UnrestrictedResponse"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Me.getTypeName()])}}Me.H_={T_:Me.getTypeName(),B_:Me.getBaseTypes()},function(e){e.LoopingVideos="32318599-a475-448c-a583-7aadf5e41c8c",e.Icons="f9a6197b-243d-4381-ad7d-43250cb11014",e.Illustrations="5c594da3-1700-4c4e-824b-dbefe528f53b",e.CartoonPeople="71309e27-d6ab-4fa5-865c-60d4e6d863b3",e.Images="f8218404-63dd-4670-b0f5-f8b50674f963",e.AiGeneratedImages="60f8b9be-536b-4a0f-9552-f3321c243f86",e.CutoutPeople="42fea961-805e-4900-a0f5-7288c55d7780",e.Stickers="0678df82-d05e-475d-9c04-5daa1f5c6d55",e.Annotations="0b60f44c-a895-4414-ab8f-6f62b5de973c",e.Shapes="9409ec95-a250-402e-8609-319208802c02",e.Emojis="84e04d41-3574-4764-a2d3-c24ae80c75eb",e.Audios="72b42841-c22c-44fd-9ac3-964371503269",e.SFX="dbddd5cf-9502-42f3-bee8-9ad41a2b6ff8",e.Overlays="c4d5cd5-eaf3-47da-8b3c-0a6bced0fe71",e.Filters="9e3db81f-2412-4606-88a7-18902fae34a6",e.Transitions="0629c8e7-8f4c-4138-bf04-816285391431",e.ClipchampIcons="01234567-89ab-cdef-0123-456789abcdef",e.Backgrounds="12345678-90ab-cdef-1234-567890abcdef",e.ClipchampStickers="f3e2d1c0-b9a8-7654-3210-fedcba987654",e.ClipchampAnnotations="456789ab-cdef-0123-4567-89abcdef0123",e.ClipchampShapes="98765432-10fe-dcba-9876-543210fedcba",e.Frames="0fedcba9-8765-4321-0abc-def123456789"}(Y||(Y={})),function(e){e.Icon="Icon",e.Image="Image",e.Video="Video",e.Audio="Audio",e.Collection="Collection",e.PowerpointTemplate="PowerpointTemplate",e.WordTemplate="WordTemplate",e.ClipchampTemplate="ClipchampTemplate",e.PromptTemplate="PromptTemplate",e.Folder="Folder"}(J||(J={})),function(e){e.My="My",e.Stock="Stock",e.Enterprise="Enterprise",e.External="External",e.Clipchamp="Clipchamp",e.Brand="Brand",e.Cit="Cit"}(X||(X={})),function(e){e.Bing="Bing",e.Getty="Getty",e.GettyVideo="GettyVideo",e.Giphy="Giphy",e.GooglePhotos="GooglePhotos",e.Hubble="Hubble",e.OneDrivePhotos="OneDrivePhotos",e.Shutterstock="Shutterstock",e.StockImages="StockImagesSearch",e.Storyblocks="Storyblocks",e.TAS="TAS",e.TasFirstPartyImageSearch="TasFirstPartyImageSearch",e.Tenor="Tenor",e.Cit="Cit",e.Unknown="Unknown",e.BrandKit="BrandKit",e.OAL="OAL",e.Templafy="Templafy",e.AdobeExpManager="AdobeExpManager"}(Z||(Z={}));class Pe{constructor(t){e.assign(Pe,this,t)}static getTypeName(){return"AugLoop_Hubble_BaseContentSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Pe.getTypeName()])}}Pe.H_={T_:Pe.getTypeName(),B_:Pe.getBaseTypes()};class Te{constructor(t){e.assign(Te,this,t)}static getTypeName(){return"AugLoop_Hubble_ContentSearchSignal"}static getBaseTypes(){return["AugLoop_Hubble_BaseContentSignal","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Te.getTypeName()])}}Te.H_={T_:Te.getTypeName(),B_:Te.getBaseTypes()};class Ue{constructor(t){e.assign(Ue,this,t)}static getTypeName(){return"AugLoop_Hubble_ContentDownloadSignal"}static getBaseTypes(){return["AugLoop_Hubble_BaseContentSignal","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Ue.getTypeName()])}}Ue.H_={T_:Ue.getTypeName(),B_:Ue.getBaseTypes()};class Fe{constructor(t){e.assign(Fe,this,t)}static getTypeName(){return"AugLoop_Hubble_AssetDownloadSignal"}static getBaseTypes(){return["AugLoop_Hubble_BaseContentSignal","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Fe.getTypeName()])}}Fe.H_={T_:Fe.getTypeName(),B_:Fe.getBaseTypes()};class He{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(He,this,t)}static getTypeName(){return"AugLoop_Hubble_BaseContentAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[He.getTypeName()])}}He.H_={T_:He.getTypeName(),B_:He.getBaseTypes()};class Re{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Re,this,t)}static getTypeName(){return"AugLoop_Hubble_ContentDownloadAnnotation"}static getBaseTypes(){return["AugLoop_Hubble_BaseContentAnnotation","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Re.getTypeName()])}}Re.H_={T_:Re.getTypeName(),B_:Re.getBaseTypes()};class Ne{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Ne,this,t)}static getTypeName(){return"AugLoop_Hubble_AssetDownloadAnnotation"}static getBaseTypes(){return["AugLoop_Hubble_BaseContentAnnotation","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Ne.getTypeName()])}}Ne.H_={T_:Ne.getTypeName(),B_:Ne.getBaseTypes()};class Be{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Be,this,t)}static getTypeName(){return"AugLoop_Hubble_ContentAnnotation"}static getBaseTypes(){return["AugLoop_Hubble_BaseContentAnnotation","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Be.getTypeName()])}}Be.H_={T_:Be.getTypeName(),B_:Be.getBaseTypes()};class je{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(je,this,t)}static getTypeName(){return"AugLoop_Hubble_ProviderContentAnnotation"}static getBaseTypes(){return["AugLoop_Hubble_ContentAnnotation","AugLoop_Hubble_BaseContentAnnotation","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[je.getTypeName()])}}je.H_={T_:je.getTypeName(),B_:je.getBaseTypes()};class Ve{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Ve,this,t)}static getTypeName(){return"AugLoop_Hubble_AggregateContentAnnotation"}static getBaseTypes(){return["AugLoop_Hubble_ContentAnnotation","AugLoop_Hubble_BaseContentAnnotation","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Ve.getTypeName()])}}Ve.H_={T_:Ve.getTypeName(),B_:Ve.getBaseTypes()};var ze,Ge=function(){function t(n){e.assign(t,this,n)}return t.getTypeName=function(){return"AugLoop_TextToIcon_TextToIconSignal"},t.getBaseTypes=function(){return["AugLoop_TextToSuggestions_TextToSuggestionSignal","AugLoop_Signals_Signal"]},t.typeGuard=function(n){return e.matchesTypesFor(n,[t.getTypeName()])},t.H_={T_:t.getTypeName(),B_:t.getBaseTypes()},t}(),Ke=function(){function t(n){e.assign(t,this,n)}return Object.defineProperty(t.prototype,"metadata",{get:function(){return this.M_},set:function(e){this.M_=e},enumerable:!1,configurable:!0}),t.getTypeName=function(){return"AugLoop_TextToIcon_TextToIconAnnotation"},t.getBaseTypes=function(){return["AugLoop_Core_Annotation"]},t.typeGuard=function(n){return e.matchesTypesFor(n,[t.getTypeName()])},t.H_={T_:t.getTypeName(),B_:t.getBaseTypes()},t}();class We{constructor(t){e.assign(We,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_SharePointCopilotOdslSignal"}static getBaseTypes(){return["AugLoop_CopilotOdsl_CopilotOdslSignal","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[We.getTypeName()])}}We.H_={T_:We.getTypeName(),B_:We.getBaseTypes()};class qe{constructor(t){e.assign(qe,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_BaseAuthoringRequest"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[qe.getTypeName()])}}qe.H_={T_:qe.getTypeName(),B_:qe.getBaseTypes()};class Qe{constructor(t){e.assign(Qe,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_SectionSubtopicRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseAuthoringRequest","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Qe.getTypeName()])}}Qe.H_={T_:Qe.getTypeName(),B_:Qe.getBaseTypes()};class Ye{constructor(t){e.assign(Ye,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_PageSkeletonRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseAuthoringRequest","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Ye.getTypeName()])}}Ye.H_={T_:Ye.getTypeName(),B_:Ye.getBaseTypes()};class Je{constructor(t){e.assign(Je,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_PageOutlineRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseAuthoringRequest","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Je.getTypeName()])}}Je.H_={T_:Je.getTypeName(),B_:Je.getBaseTypes()};class Xe{constructor(t){e.assign(Xe,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_PageAuthoringRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseAuthoringRequest","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Xe.getTypeName()])}}Xe.H_={T_:Xe.getTypeName(),B_:Xe.getBaseTypes()};class Ze{constructor(t){e.assign(Ze,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_DraftComposeRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseAuthoringRequest","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Ze.getTypeName()])}}Ze.H_={T_:Ze.getTypeName(),B_:Ze.getBaseTypes()};class $e{constructor(t){e.assign($e,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_WebPartsAuthoringRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseAuthoringRequest","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[$e.getTypeName()])}}$e.H_={T_:$e.getTypeName(),B_:$e.getBaseTypes()};class et{constructor(t){e.assign(et,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_CommonAuthoringRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseAuthoringRequest","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[et.getTypeName()])}}et.H_={T_:et.getTypeName(),B_:et.getBaseTypes()};class tt{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(tt,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_SharepointCopilotAnswer"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[tt.getTypeName()])}}tt.H_={T_:tt.getTypeName(),B_:tt.getBaseTypes()};class nt{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(nt,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_SharePointCopilotPanelAnswer"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[nt.getTypeName()])}}nt.H_={T_:nt.getTypeName(),B_:nt.getBaseTypes()};class at{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(at,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_SharepointListCopilotAnswer"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[at.getTypeName()])}}at.H_={T_:at.getTypeName(),B_:at.getBaseTypes()};class it{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(it,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_SharePointCopilotOdslAnnotation"}static getBaseTypes(){return["AugLoop_CopilotOdsl_CopilotOdslAnnotation","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[it.getTypeName()])}}it.H_={T_:it.getTypeName(),B_:it.getBaseTypes()};class rt{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(rt,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_PageAuthoringCopilotAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[rt.getTypeName()])}}rt.H_={T_:rt.getTypeName(),B_:rt.getBaseTypes()};class ot{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(ot,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_CommonAuthoringPartialAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[ot.getTypeName()])}}ot.H_={T_:ot.getTypeName(),B_:ot.getBaseTypes()};class st{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(st,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_CommonAuthoringAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[st.getTypeName()])}}st.H_={T_:st.getTypeName(),B_:st.getBaseTypes()};class ct{constructor(t){e.assign(ct,this,t)}static getTypeName(){return"AugLoop_Translator_TranslatorSignalBase"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[ct.getTypeName()])}}ct.H_={T_:ct.getTypeName(),B_:ct.getBaseTypes()};class dt{constructor(t){e.assign(dt,this,t)}static getTypeName(){return"AugLoop_Translator_TranslateFileSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[dt.getTypeName()])}}dt.H_={T_:dt.getTypeName(),B_:dt.getBaseTypes()};class lt{constructor(t){e.assign(lt,this,t)}static getTypeName(){return"AugLoop_Translator_TranslateFileBlobSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[lt.getTypeName()])}}lt.H_={T_:lt.getTypeName(),B_:lt.getBaseTypes()};class ut{constructor(t){e.assign(ut,this,t)}static getTypeName(){return"AugLoop_Translator_TranslateChunkedFileChunk"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[ut.getTypeName()])}}ut.H_={T_:ut.getTypeName(),B_:ut.getBaseTypes()};class ft{constructor(t){e.assign(ft,this,t)}static getTypeName(){return"AugLoop_Translator_TranslateChunkedFileSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[ft.getTypeName()])}}ft.H_={T_:ft.getTypeName(),B_:ft.getBaseTypes()};class pt{constructor(t){e.assign(pt,this,t)}static getTypeName(){return"AugLoop_Translator_TranslateContentSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[pt.getTypeName()])}}pt.H_={T_:pt.getTypeName(),B_:pt.getBaseTypes()};class mt{constructor(t){e.assign(mt,this,t)}static getTypeName(){return"AugLoop_Translator_TranslateContentArraySignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[mt.getTypeName()])}}mt.H_={T_:mt.getTypeName(),B_:mt.getBaseTypes()};class _t{constructor(t){e.assign(_t,this,t)}static getTypeName(){return"AugLoop_Translator_DictionaryLookupSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[_t.getTypeName()])}}_t.H_={T_:_t.getTypeName(),B_:_t.getBaseTypes()};class ht{constructor(t){e.assign(ht,this,t)}static getTypeName(){return"AugLoop_Translator_SupportedLanguagesSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[ht.getTypeName()])}}ht.H_={T_:ht.getTypeName(),B_:ht.getBaseTypes()};class bt{constructor(t){e.assign(bt,this,t)}static getTypeName(){return"AugLoop_Translator_BreakSentencesSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[bt.getTypeName()])}}bt.H_={T_:bt.getTypeName(),B_:bt.getBaseTypes()};class gt{constructor(t){e.assign(gt,this,t)}static getTypeName(){return"AugLoop_Translator_DictionaryExamplesSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[gt.getTypeName()])}}gt.H_={T_:gt.getTypeName(),B_:gt.getBaseTypes()};class vt{constructor(t){e.assign(vt,this,t)}static getTypeName(){return"AugLoop_Translator_DetectLanguagesArraySignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[vt.getTypeName()])}}vt.H_={T_:vt.getTypeName(),B_:vt.getBaseTypes()};class yt{constructor(t){e.assign(yt,this,t)}static getTypeName(){return"AugLoop_Translator_TranslatePptAuditSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[yt.getTypeName()])}}yt.H_={T_:yt.getTypeName(),B_:yt.getBaseTypes()};class St{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(St,this,t)}static getTypeName(){return"AugLoop_Translator_TranslatorAnnotationBase"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[St.getTypeName()])}}St.H_={T_:St.getTypeName(),B_:St.getBaseTypes()};class Dt{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Dt,this,t)}static getTypeName(){return"AugLoop_Translator_TranslateContentResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Dt.getTypeName()])}}Dt.H_={T_:Dt.getTypeName(),B_:Dt.getBaseTypes()};class It{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(It,this,t)}static getTypeName(){return"AugLoop_Translator_TranslateContentArrayResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[It.getTypeName()])}}It.H_={T_:It.getTypeName(),B_:It.getBaseTypes()};class xt{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(xt,this,t)}static getTypeName(){return"AugLoop_Translator_DictionaryLookupResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[xt.getTypeName()])}}xt.H_={T_:xt.getTypeName(),B_:xt.getBaseTypes()};class Ct{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Ct,this,t)}static getTypeName(){return"AugLoop_Translator_TranslateFileResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Ct.getTypeName()])}}Ct.H_={T_:Ct.getTypeName(),B_:Ct.getBaseTypes()};class Ot{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Ot,this,t)}static getTypeName(){return"AugLoop_Translator_TranslateFileBlobResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Ot.getTypeName()])}}Ot.H_={T_:Ot.getTypeName(),B_:Ot.getBaseTypes()};class wt{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(wt,this,t)}static getTypeName(){return"AugLoop_Translator_SupportedLanguagesResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[wt.getTypeName()])}}wt.H_={T_:wt.getTypeName(),B_:wt.getBaseTypes()};class Et{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Et,this,t)}static getTypeName(){return"AugLoop_Translator_BreakSentencesResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Et.getTypeName()])}}Et.H_={T_:Et.getTypeName(),B_:Et.getBaseTypes()};class At{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(At,this,t)}static getTypeName(){return"AugLoop_Translator_DictionaryExamplesResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[At.getTypeName()])}}At.H_={T_:At.getTypeName(),B_:At.getBaseTypes()};class Lt{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Lt,this,t)}static getTypeName(){return"AugLoop_Translator_DetectLanguagesArrayResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Lt.getTypeName()])}}Lt.H_={T_:Lt.getTypeName(),B_:Lt.getBaseTypes()};class kt{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(kt,this,t)}static getTypeName(){return"AugLoop_Translator_TranslateAuditAnnotation"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[kt.getTypeName()])}}kt.H_={T_:kt.getTypeName(),B_:kt.getBaseTypes()};class Mt{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Mt,this,t)}static getTypeName(){return"AugLoop_SharepointDesignIdeasPersonalizer_DesignIdeasRankAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Mt.getTypeName()])}}Mt.H_={T_:Mt.getTypeName(),B_:Mt.getBaseTypes()};class Pt{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Pt,this,t)}static getTypeName(){return"AugLoop_SharepointDesignIdeasPersonalizer_DesignIdeasRewardAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Pt.getTypeName()])}}Pt.H_={T_:Pt.getTypeName(),B_:Pt.getBaseTypes()};class Tt{constructor(t){e.assign(Tt,this,t)}static getTypeName(){return"AugLoop_SharepointDataVisualizations_SharepointDataVisualizationsSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Tt.getTypeName()])}}Tt.H_={T_:Tt.getTypeName(),B_:Tt.getBaseTypes()};class Ut{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Ut,this,t)}static getTypeName(){return"AugLoop_SharepointDataVisualizations_SharepointDataVisualizationsAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Ut.getTypeName()])}}Ut.H_={T_:Ut.getTypeName(),B_:Ut.getBaseTypes()};class Ft{get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_AzureKeyPhrases_AzureKeyPhraseAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Ft.getTypeName()])}constructor(t){e.assign(Ft,this,t)}}Ft.H_={T_:Ft.getTypeName(),B_:Ft.getBaseTypes()},function(e){e[e.Success=0]="Success",e[e.NoResults=1]="NoResults",e[e.Cancelled=2]="Cancelled",e[e.Timeout=3]="Timeout",e[e.UnexpectedError=4]="UnexpectedError",e[e.InvalidInputError=5]="InvalidInputError",e[e.SubstrateResponseError=6]="SubstrateResponseError"}(ze||(ze={}));class Ht{static typeGuard(t){return e.matchesTypesFor(t,[Ht.getTypeName()])}static getTypeName(){return"AugLoop_LayoutAnalysis_LayoutAnalysisRequest"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}constructor(t){e.assign(Ht,this,t)}}Ht.H_={T_:Ht.getTypeName(),B_:Ht.getBaseTypes()};class Rt{constructor(t){e.assign(Rt,this,t)}static getTypeName(){return"AugLoop_Core_BlobContainer"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Rt.getTypeName()])}}Rt.H_={T_:Rt.getTypeName(),B_:Rt.getBaseTypes()};class Nt{constructor(t){e.assign(Nt,this,t)}static getTypeName(){return"AugLoop_Core_Blob"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Nt.getTypeName()])}}Nt.H_={T_:Nt.getTypeName(),B_:Nt.getBaseTypes()};class Bt{constructor(t){e.assign(Bt,this,t)}static getTypeName(){return"AugLoop_Core_Binary"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Bt.getTypeName()])}}Bt.H_={T_:Bt.getTypeName(),B_:Bt.getBaseTypes()};class jt{constructor(t){e.assign(jt,this,t)}static getTypeName(){return"AugLoop_Core_TileGroup"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[jt.getTypeName()])}}jt.H_={T_:jt.getTypeName(),B_:jt.getBaseTypes()};class Vt{constructor(t){e.assign(Vt,this,t)}static getTypeName(){return"AugLoop_Core_Session"}static getBaseTypes(){return["AugLoop_Core_TileGroup"]}static typeGuard(t){return e.matchesTypesFor(t,[Vt.getTypeName()])}}Vt.H_={T_:Vt.getTypeName(),B_:Vt.getBaseTypes()};class zt{constructor(t){e.assign(zt,this,t)}static getTypeName(){return"AugLoop_Core_Document"}static getBaseTypes(){return["AugLoop_Core_TileGroup"]}static typeGuard(t){return e.matchesTypesFor(t,[zt.getTypeName()])}}zt.H_={T_:zt.getTypeName(),B_:zt.getBaseTypes()};class Gt{constructor(t){e.assign(Gt,this,t)}static getTypeName(){return"AugLoop_Core_SubDocument"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Gt.getTypeName()])}}Gt.H_={T_:Gt.getTypeName(),B_:Gt.getBaseTypes()};class Kt{constructor(t){e.assign(Kt,this,t)}static getTypeName(){return"AugLoop_Core_GridCell"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Kt.getTypeName()])}}Kt.H_={T_:Kt.getTypeName(),B_:Kt.getBaseTypes()};class Wt{constructor(t){e.assign(Wt,this,t)}static getTypeName(){return"AugLoop_Core_GridNeighborhoodContext"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Wt.getTypeName()])}}Wt.H_={T_:Wt.getTypeName(),B_:Wt.getBaseTypes()};class qt{constructor(t){e.assign(qt,this,t)}static getTypeName(){return"AugLoop_Core_ItemFilter"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[qt.getTypeName()])}}qt.H_={T_:qt.getTypeName(),B_:qt.getBaseTypes()};class Qt{constructor(t){e.assign(Qt,this,t)}static getTypeName(){return"AugLoop_Core_DynamicContext"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Qt.getTypeName()])}}Qt.H_={T_:Qt.getTypeName(),B_:Qt.getBaseTypes()};class Yt{constructor(t){e.assign(Yt,this,t)}static getTypeName(){return"AugLoop_Core_ContextHolder"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Yt.getTypeName()])}}Yt.H_={T_:Yt.getTypeName(),B_:Yt.getBaseTypes()};class Jt{constructor(t){e.assign(Jt,this,t)}static getTypeName(){return"AugLoop_Core_UserContextHolder"}static getBaseTypes(){return["AugLoop_Core_ContextHolder"]}static typeGuard(t){return e.matchesTypesFor(t,[Jt.getTypeName()])}}Jt.H_={T_:Jt.getTypeName(),B_:Jt.getBaseTypes()};class Xt{constructor(t){e.assign(Xt,this,t)}static getTypeName(){return"AugLoop_Core_TenantContextHolder"}static getBaseTypes(){return["AugLoop_Core_ContextHolder"]}static typeGuard(t){return e.matchesTypesFor(t,[Xt.getTypeName()])}}Xt.H_={T_:Xt.getTypeName(),B_:Xt.getBaseTypes()};class Zt{constructor(t){e.assign(Zt,this,t)}static getTypeName(){return"AugLoop_Core_EventsHolder"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Zt.getTypeName()])}}Zt.H_={T_:Zt.getTypeName(),B_:Zt.getBaseTypes()};class $t{constructor(t){e.assign($t,this,t)}static getTypeName(){return"AugLoop_Core_UserCommandsHolder"}static getBaseTypes(){return["AugLoop_Core_EventsHolder"]}static typeGuard(t){return e.matchesTypesFor(t,[$t.getTypeName()])}}$t.H_={T_:$t.getTypeName(),B_:$t.getBaseTypes()};var en=o(737);const tn="spdf",nn="prodbubble",an="prod",rn="dprod",on="gcch",sn="ag08",cn="ag09",dn="https://augloop.svc.cloud.microsoft",ln={[tn]:"https://dogfood.augloop.svc.cloud.microsoft",[nn]:"https://msit.augloop.svc.cloud.microsoft",[an]:dn,[rn]:dn,gcc:"https://gcc.augloop.svc.cloud.microsoft",[on]:"https://augloop.gov.online.office365.us",dod:"https://augloop.dod.online.office365.us",[sn]:"https://svc.augloop.eaglex.ic.gov",[cn]:"https://svc.augloop.microsoft.scloud",chn:"https://augloop.microsoftonline.cn"},un={[tn]:"Dogfood",[nn]:"Microsoft",[an]:"Production",[rn]:"Production",gcc:"GCC Moderate",[on]:"GCC High",dod:"DoD",[sn]:"AG08",[cn]:"AG09",chn:"CN"};function fn(){const e=new URLSearchParams(window.location?.search||"").get("alTest")||void 0;if(e)try{return new URL(e),e}catch{return"https://test.augloop.svc.cloud.dev.microsoft"}}var pn;!function(e){e[e.error=0]="error",e[e.warn=1]="warn",e[e.info=3]="info",e[e.metric=4]="metric",e[e.verbose=5]="verbose",e[e.debug=6]="debug",e[e.disabled=7]="disabled"}(pn||(pn={}));var mn={util:{},roots:{default:{}}},_n=(mn.util,mn.roots.default||(mn.roots.default={}),function(){function e(e){if(e)for(var t in e)null!=e[t]&&(this[t]=e[t])}return e.prototype.count=0,e.prototype.cv="",e.prototype.serviceName="",e.prototype.sessionKey="",e.prototype.traceId="",e.prototype.durationMs=0,e.prototype.success=!1,e.prototype.resultDescription="",e.prototype.resultJSON="",e.prototype.resultSignature="",e.prototype.operationName="",e.prototype.resourceId="",e.prototype.dimension0="",e.prototype.dimension1="",e.prototype.dimension2="",e.prototype.dimension3="",e.prototype.clientAppName="",e.prototype.clientAppPlatform="",e.prototype.clientRuntimeVersion="",e.prototype.clientAppVersion="",e.prototype.clientReleaseAudienceGroup="",e.prototype.clientReleaseChannel="",e.prototype.clientReleaseFork="",e.prototype.clientSessionId="",e.prototype.clientFlights="",e.prototype.clientIPRange="",e.prototype.clientDocSessionId="",e.prototype.clientUserAgent="",e.prototype.userType="",e.prototype.userId="",e.prototype.userTenantId="",e.prototype.joinContextId="",e.prototype.ariaTenant="",e.prototype.ariaNamespace="",e.prototype.dataFields="",e.prototype.userDataBoundaryType="",e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/OperationEvent"},e}());const hn="undefined"!=typeof process&&process.hrtime?()=>{const e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:"undefined"!=typeof performance&&performance.now?()=>performance.now():()=>Date.now(),bn=("undefined"!=typeof process&&process.hrtime||"undefined"!=typeof performance&&performance.now,Symbol("dataFieldsObject")),gn=Symbol("dataFieldsAreDirty"),vn=Symbol("_dataFields");class yn extends _n{constructor(e,t){super(e),this.eventName="Operation",this.options=t,this.durationMs=null==e?void 0:e.durationMs,e&&null!=e.count||(this.count=1),(null==e?void 0:e.dataFields)&&(this.dataFields=e.dataFields)}setClientMetadata(e,t){return e&&(this.clientAppName=e.appName,this.clientAppPlatform=e.appPlatform,this.clientAppVersion=e.appVersion,null!=t&&t||(this.clientFlights=e.flights),this.clientReleaseAudienceGroup=e.releaseAudienceGroup,this.clientReleaseChannel=e.releaseChannel,this.clientReleaseFork=e.releaseFork,this.clientRuntimeVersion=e.runtimeVersion,this.clientSessionId=e.sessionId,this.clientDocSessionId=e.docSessionId,this.clientUserAgent=e.userAgent),this}setUserContext(e){return e&&(this.userId=e.puid||e.oid,this.userType=e.userType&&e.userType.toString(),this.userTenantId=e.tid),this}setMetricCustomDimensions(e,t){if(!this.options)throw new Error(`Attempting to set custom dimensions ${e} to operation ${this.operationName} without activating MetricCount or MetricDuration`);this.options.metricCustomDimensions=this.options.metricCustomDimensions||{},this.options.metricCustomDimensions[e]=t}setDataField(e,t){this[bn]||(this[bn]={}),this[bn][e]=t,this[gn]=!0}setDataFields(e){this[bn]||(this[bn]={}),this[bn]=Object.assign(Object.assign({},this[bn]),e),this[gn]=!0}start(){return this.startTime=hn(),this}recordStep(e){return this.setDataField(e,Math.floor(hn()-this.startTime)),this}stop(){const e=hn();return this.durationMs=Math.round(e-this.startTime),this}addCustomMetric(e){void 0===this.customMetrics&&(this.customMetrics=[]),this.customMetrics.push(e)}getCustomMetrics(){const e=[];if(void 0!==this.customMetrics){const t=e=>[...this.getDimensionNames(),...e.extraDimensions.map(e=>e.name)];for(const n of this.customMetrics){const a={};a[`${this.operationName}.${n.nameSuffix}`]={dimensionNames:()=>t(n),dimensionValues:[...this.getDimensionValues(),...n.extraDimensions.map(e=>e.value)],value:n.value},e.push(a)}}return e}getMetrics(e){var t,n;const a={};if(this.operationName)switch(this.operationName){case"SessionHealthOrphanedEventsWithoutProperSessionKey":case"SessionHealthOrphanedSessions":case"WorkflowActivationState":a[this.operationName+".CountV2"]={dimensionNames:yn.getOrphanedSessionHealthDimensionNames.bind(yn),dimensionValues:this.getOrphanedSessionHealthDimensionValues(),value:this.count};break;case"MarkUnhealthySession":case"MarkHealthWarningSession":a[this.operationName+".Reason"]={dimensionNames:yn.getSessionHealthDimensionNames.bind(yn),dimensionValues:this.getSessionHealthDimensionValues(),value:1};break;default:if("matchmaker_timer"===this.operationName&&(a["Workflow.DurationMs"]={dimensionNames:yn.getWorkflowDimensionNames.bind(yn),dimensionValues:this.getWorkflowDimensionValues(),value:this.durationMs||0},a["Workflow.Count"]={dimensionNames:yn.getWorkflowDimensionNames.bind(yn),dimensionValues:this.getWorkflowDimensionValues(),value:1}),void 0!==this.durationMs){const n=`${this.operationName}.DurationMsV2`;((null===(t=this.options)||void 0===t?void 0:t.metricDuration)||e.indexOf(n)>=0)&&(a[n]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.durationMs})}{const t=`${this.operationName}.CountV2`;((null===(n=this.options)||void 0===n?void 0:n.metricCount)||e.indexOf(t)>=0)&&(a[t]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.count})}}return a}getDimensionNames(){var e,t;let n=yn.dimensionNames;if(null===(e=this.options)||void 0===e?void 0:e.metricCustomDimensions){n=n.slice();for(const e in null===(t=this.options)||void 0===t?void 0:t.metricCustomDimensions)n.push(e)}return n}getDimensionValues(){var e,t;const n=[this.success,this.clientAppName,this.clientAppPlatform,this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3];if(null===(e=this.options)||void 0===e?void 0:e.metricCustomDimensions)for(const e in null===(t=this.options)||void 0===t?void 0:t.metricCustomDimensions)n.push(this.options.metricCustomDimensions[e]);return n}static getOrphanedSessionHealthDimensionNames(){return this.orphanedSessionHealthDimensionNames}getOrphanedSessionHealthDimensionValues(){return[this.success,this.clientAppName,this.clientAppPlatform,this.clientReleaseAudienceGroup,this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}static getSessionHealthDimensionNames(){return this.sessionHealthDimensionNames}getSessionHealthDimensionValues(){return[this.resultSignature,this.clientAppName,this.clientAppPlatform,this.clientAppVersion,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}static getWorkflowDimensionNames(){return this.workflowDimensionNames}getWorkflowDimensionValues(){return[this.resultSignature,this.resourceId,this.resourceId,this.success]}}var Sn,Dn,In,xn,Cn,On;yn.dimensionNames=["Success","ClientAppName","ClientAppPlatform","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"],yn.orphanedSessionHealthDimensionNames=["Success","ClientAppName","ClientAppPlatform","ClientReleaseAudienceGroup","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"],yn.sessionHealthDimensionNames=["Reason","ClientAppName","ClientAppPlatform","ClientAppVersion","Dimension0","Dimension1","Dimension2","Dimension3"],yn.workflowDimensionNames=["ResultSignature","WorkflowId","ResourceId","Success"],Object.defineProperty(yn.prototype,"dataFields",{get:function(){var e,t;return this[gn]&&(this[vn]=JSON.stringify(null!==(e=this[bn])&&void 0!==e?e:{}),this[gn]=!1),void 0!==this[gn]?this[vn]:null!==(t=this[vn])&&void 0!==t?t:""},set:function(e){this[bn]=e&&""!==e?JSON.parse(e):{},this[vn]=e,this[gn]=!1},enumerable:!0,configurable:!0}),function(e){e[e.EditorLowPrivilege=0]="EditorLowPrivilege",e[e.AugLoopLowPrivilege=1]="AugLoopLowPrivilege",e[e.Anonymous=2]="Anonymous",e[e.ClientAssertion=3]="ClientAssertion",e[e.ClientAssertionV2=4]="ClientAssertionV2",e[e.AutoClpLowPrivilege=5]="AutoClpLowPrivilege",e[e.AutoClpAppOnlyLowPrivilege=6]="AutoClpAppOnlyLowPrivilege",e[e.Substrate=7]="Substrate",e[e.WacUserInfo=8]="WacUserInfo",e[e.OwaExchange=9]="OwaExchange",e[e.SmartCompose=10]="SmartCompose",e[e.WritingAnalyticsLowPrivilege=11]="WritingAnalyticsLowPrivilege",e[e.DWEngineLowPrivilege=12]="DWEngineLowPrivilege",e[e.SubstrateApp=13]="SubstrateApp",e[e.CortanaAppPop=14]="CortanaAppPop",e[e.OfficeAppsAppOnly=15]="OfficeAppsAppOnly",e[e.PPTFrontdoorAppPop=16]="PPTFrontdoorAppPop",e[e.EditorAppOnlyLowPrivilege=17]="EditorAppOnlyLowPrivilege",e[e.AugLoopApp=18]="AugLoopApp",e[e.MeetingIntelligenceApp=19]="MeetingIntelligenceApp",e[e.GraphApp=20]="GraphApp",e[e.IceServicesApp=21]="IceServicesApp",e[e.AzureMapsApp=22]="AzureMapsApp",e[e.SpoApp=23]="SpoApp",e[e.OneDrive=24]="OneDrive",e[e.GoogleDrive=25]="GoogleDrive",e[e.GettyApp=26]="GettyApp",e[e.Dropbox=27]="Dropbox",e[e.GooglePhotos=28]="GooglePhotos",e[e.EditorApp=29]="EditorApp",e[e.AmazonKindle=30]="AmazonKindle",e[e.ShredderApp=31]="ShredderApp",e[e.FormsLowPrivilege=32]="FormsLowPrivilege",e[e.VivaSalesLowPrivilege=33]="VivaSalesLowPrivilege",e[e.IntentSvcApp=34]="IntentSvcApp",e[e.DcgLowPrivilege=35]="DcgLowPrivilege",e[e.CSALowPrivilege=36]="CSALowPrivilege",e[e.ConsumerSydneyLowPrivilege=37]="ConsumerSydneyLowPrivilege",e[e.CompliantSydneyApp=38]="CompliantSydneyApp",e[e.M365AdminApp=39]="M365AdminApp",e[e.MeetingArtifactsServiceLowPrivilege=40]="MeetingArtifactsServiceLowPrivilege",e[e.AlchemyApp=41]="AlchemyApp",e[e.M365Admin=42]="M365Admin",e[e.ConsumerShellApp=43]="ConsumerShellApp",e[e.PowerQueryLowPrivilege=44]="PowerQueryLowPrivilege",e[e.CIIApp=45]="CIIApp",e[e.ConsumerShell=46]="ConsumerShell",e[e.AssistCopilotLowPrivilege=47]="AssistCopilotLowPrivilege",e[e.Pva=48]="Pva",e[e.TeamsCopilotServiceLowPrivilege=49]="TeamsCopilotServiceLowPrivilege",e[e.CallAnalytics=50]="CallAnalytics",e[e.IncomingPFT=51]="IncomingPFT",e[e.GraphExchange=52]="GraphExchange",e[e.EXOAdmin=53]="EXOAdmin",e[e.InsightsServicesLowPrivilege=54]="InsightsServicesLowPrivilege",e[e.VivaServicesLowPrivilege=55]="VivaServicesLowPrivilege",e[e.EcsAppOnly=56]="EcsAppOnly",e[e.ShredderLowPrivilege=57]="ShredderLowPrivilege",e[e.SpoLowPrivilege=58]="SpoLowPrivilege",e[e.PromptValidationApp=59]="PromptValidationApp",e[e.CompliantSydneyLowPrivilege=60]="CompliantSydneyLowPrivilege",e[e.SubstrateTenantFeedbackApp=61]="SubstrateTenantFeedbackApp",e[e.MonitoringPlatform=62]="MonitoringPlatform",e[e.YammerLowPrivilege=63]="YammerLowPrivilege",e[e.VivaLearningLowPrivilege=64]="VivaLearningLowPrivilege",e[e.VivaInsightsLowPrivilege=65]="VivaInsightsLowPrivilege",e[e.ClientAugLoopApp=66]="ClientAugLoopApp",e[e.AssistAuthLowPrivilege=67]="AssistAuthLowPrivilege",e[e.VivaLearningSearchPreProdLowPrivilege=68]="VivaLearningSearchPreProdLowPrivilege",e[e.SubstrateSearchApp=69]="SubstrateSearchApp",e[e.SparkContentPlatformLowPrivilege=70]="SparkContentPlatformLowPrivilege",e[e.SparkContentPlatformPopApp=71]="SparkContentPlatformPopApp",e[e.ConsumerSydneyApp=72]="ConsumerSydneyApp",e[e.BusinessAssistAuthLowPrivilege=73]="BusinessAssistAuthLowPrivilege",e[e.AzureResourceManager=74]="AzureResourceManager",e[e.AlchemyPortal=75]="AlchemyPortal",e[e.VivaUserSkillsApp=76]="VivaUserSkillsApp",e[e.VivaEngageAppPop=77]="VivaEngageAppPop",e[e.SubstrateAppOnly=78]="SubstrateAppOnly",e[e.PowerAutomateFlowCreationLowPrivilege=79]="PowerAutomateFlowCreationLowPrivilege",e[e.PowerAutomateConnectionCreationLowPrivilege=80]="PowerAutomateConnectionCreationLowPrivilege",e[e.PowerAutomateAuthorizeConnectionLowPrivilege=81]="PowerAutomateAuthorizeConnectionLowPrivilege",e[e.TCAAppPop=82]="TCAAppPop",e[e.BusinessAssistAuthAppPop=83]="BusinessAssistAuthAppPop",e[e.HolmesApp=84]="HolmesApp",e[e.GraphAppOnly=85]="GraphAppOnly",e[e.SimsApp=86]="SimsApp",e[e.VivaOrgInsightsLowPrivilege=87]="VivaOrgInsightsLowPrivilege",e[e.VivaGoalsAppPop=88]="VivaGoalsAppPop",e[e.GCBotAppPop=89]="GCBotAppPop",e[e.ShredderV2App=90]="ShredderV2App",e[e.ShredderV2LowPrivilege=91]="ShredderV2LowPrivilege",e[e.AmplifyProfileService=92]="AmplifyProfileService",e[e.AzureDevopsLowPrivilege=93]="AzureDevopsLowPrivilege",e[e.CommuteServices=94]="CommuteServices",e[e.GCBotAppOnly=95]="GCBotAppOnly",e[e.TCAAppOnly=96]="TCAAppOnly",e[e.MavenAgentLowPrivilege=97]="MavenAgentLowPrivilege",e[e.VivaOrgInsightsAppPop=98]="VivaOrgInsightsAppPop",e[e.EduAssignmentsPftAtPop=99]="EduAssignmentsPftAtPop",e[e.AugloopAppPop=100]="AugloopAppPop",e[e.OneNoteLowPrivilege=101]="OneNoteLowPrivilege",e[e.TeamsAuthzSvcAppPop=102]="TeamsAuthzSvcAppPop",e[e.LoopAppPop=103]="LoopAppPop",e[e.LoopAppOnly=104]="LoopAppOnly",e[e.BapLowPrivilege=105]="BapLowPrivilege",e[e.IC3AppPop=106]="IC3AppPop",e[e.PowerPlatformApiGateway=107]="PowerPlatformApiGateway",e[e.OdspNotifyAppPop=108]="OdspNotifyAppPop",e[e.MIPSyncService=109]="MIPSyncService",e[e.RightsManagementServices=110]="RightsManagementServices",e[e.TCAV2AppPop=111]="TCAV2AppPop",e[e.SubstrateLLMLowPrivilege=112]="SubstrateLLMLowPrivilege",e[e.SubstrateSearchLowPrivilege=113]="SubstrateSearchLowPrivilege",e[e.CloudPolicyServiceAppPop=114]="CloudPolicyServiceAppPop",e[e.TCAV2LowPrivilege=115]="TCAV2LowPrivilege",e[e.AiHubServicesAppPop=116]="AiHubServicesAppPop",e[e.TMRAppOnly=117]="TMRAppOnly",e[e.PacmanAppPop=118]="PacmanAppPop",e[e.AugloopAlternativeIdentity=119]="AugloopAlternativeIdentity",e[e.SpoAppOnly=120]="SpoAppOnly",e[e.DataverseLowPrivilege=121]="DataverseLowPrivilege",e[e.SubstrateLLMApp=122]="SubstrateLLMApp",e[e.SimsAppOnly=123]="SimsAppOnly",e[e.PythonService=124]="PythonService",e[e.PythonServiceAppOnly=125]="PythonServiceAppOnly",e[e.DesignerAppServiceLowPrivilege=126]="DesignerAppServiceLowPrivilege",e[e.DesignerAppServiceAppPop=127]="DesignerAppServiceAppPop",e[e.AmplifyProfileServiceAppOnly=128]="AmplifyProfileServiceAppOnly",e[e.MARSAppPop=129]="MARSAppPop",e[e.PlannerAppPop=130]="PlannerAppPop",e[e.BingForBusinessLowPrivilege=131]="BingForBusinessLowPrivilege",e[e.OLS=132]="OLS",e[e.OLSAppPop=133]="OLSAppPop",e[e.GCS=134]="GCS",e[e.AugLoopConsumer=135]="AugLoopConsumer",e[e.ContentValidationServiceAppOnly=136]="ContentValidationServiceAppOnly",e[e.FabricLowPrivilege=137]="FabricLowPrivilege",e[e.FeatureAccessManagementAppPop=138]="FeatureAccessManagementAppPop",e[e.FireIntelligenceAppOnly=139]="FireIntelligenceAppOnly",e[e.MARSLowPrivilege=140]="MARSLowPrivilege",e[e.EXOAdminAppPop=141]="EXOAdminAppPop",e[e.IncomingAT=142]="IncomingAT",e[e.CopilotLabLowPrivilege=143]="CopilotLabLowPrivilege",e[e.VivaPulseLowPrivilege=144]="VivaPulseLowPrivilege",e[e.WacAppPop=145]="WacAppPop",e[e.PowerAppsAiBuilderLowPrivilege=146]="PowerAppsAiBuilderLowPrivilege",e[e.CognitiveApiAppOnly=147]="CognitiveApiAppOnly",e[e.CopilotMetricsAppOnly=148]="CopilotMetricsAppOnly",e[e.ShredderAppOnly=149]="ShredderAppOnly",e[e.TeamsAuthzSvcLowPrivilege=150]="TeamsAuthzSvcLowPrivilege",e[e.PlannerLowPrivilege=151]="PlannerLowPrivilege",e[e.VivaGlintLowPrivilege=152]="VivaGlintLowPrivilege",e[e.DiscoveryServiceAppPop=153]="DiscoveryServiceAppPop",e[e.PowerAppsOrchardLowPrivilege=154]="PowerAppsOrchardLowPrivilege",e[e.EduSkillingPlatformPftAtPop=155]="EduSkillingPlatformPftAtPop",e[e.IncomingPFTAppOnly=156]="IncomingPFTAppOnly",e[e.EduSkillingPlatformLowPrivilege=157]="EduSkillingPlatformLowPrivilege",e[e.MCPSAppOnly=158]="MCPSAppOnly",e[e.TeamsMiddleTierLowPrivilege=159]="TeamsMiddleTierLowPrivilege",e[e.SharePointESignatureAppPop=160]="SharePointESignatureAppPop",e[e.SparkContentPlatformAppOnly=161]="SparkContentPlatformAppOnly"}(Sn||(Sn={})),function(e){e[e.Unknown=0]="Unknown",e[e.Consumer=1]="Consumer",e[e.Enterprise=2]="Enterprise"}(Dn||(Dn={})),function(e){e[e.Default=0]="Default",e[e.EDPSCompliant=1]="EDPSCompliant"}(In||(In={})),function(e){e.AuthorizationCode="authorization_code",e.ClientCredentials="client_credentials",e.RefreshToken="refresh_token"}(xn||(xn={})),function(e){e[e.LoggedIn=0]="LoggedIn",e[e.LoggedOut=1]="LoggedOut"}(Cn||(Cn={})),function(e){e.Log="Log"}(On||(On={}));const wn="undefined"!=typeof process?{NODE_ENV:"production"}.SERVICE_NAME:"client",En="abcdefghijklmnopqrstuvwxyz0123456789",An={97:0,98:1,99:2,100:3,101:4,102:5,103:6,104:7,105:8,106:9,107:10,108:11,109:12,110:13,111:14,112:15,113:16,114:17,115:18,116:19,117:20,118:21,119:22,120:23,121:24,122:25,48:26,49:27,50:28,51:29,52:30,53:31,54:32,55:33,56:34,57:35};let Ln,kn=[],Mn=[],Pn=e=>null,Tn=e=>{};const Un=new Map,Fn=new Map,Hn=new Map,Rn=new Map;var Nn,Bn;!function(e){e.Default="",e.EDPSCompliant="edps"}(Nn||(Nn={})),function(e){e.defineCoreLogCategory=e=>({root:"Core",name:e}),e.defineWorkflowLogCategory=e=>({root:"Workflow",name:e}),e.clearLoggers=()=>{kn=[],Mn=[],Fn.clear(),Hn.clear()},e.clearAggregators=()=>{Un.clear()},e.addLogger=e=>{-1===kn.indexOf(e)&&(kn.push(e),jn(Fn,e))},e.addDecidingLogger=e=>{-1===Mn.indexOf(e)&&(Mn.push(e),jn(Hn,e))},e.setCorrelationContextCallback=e=>{Ln=e},e.setStartPerformanceEventCallback=e=>{Pn=e},e.setStopPerformanceEventCallback=e=>{Tn=e},e.addAggregator=e=>{e.init((e,t)=>{Xn(e,t)}),Un.has(e.eventName)?Un.get(e.eventName).push(e):Un.set(e.eventName,[e])},e.flushAggregators=e=>{Un.forEach(t=>{t.forEach(t=>t.flush(e))})},e.setTagLevelOverride=(e,t)=>{const n=na(e);Rn.set(n,t)},e.resetTagLevelOverrides=()=>{Rn.clear()},e.error=(e,t,n,a,i,r,o,s,c,d)=>{Jn(e,t,pn.error,n,a,i,r,o,s,c,d)},e.warn=(e,t,n,a,i,r,o,s,c,d)=>{Jn(e,t,pn.warn,n,a,i,r,o,s,c,d)},e.info=(e,t,n,a,i,r,o,s,c,d)=>{Jn(e,t,pn.info,n,a,i,r,o,s,c,d)},e.verbose=(e,t,n,a,i,r,o,s,c,d)=>{Jn(e,t,pn.verbose,n,a,i,r,o,s,c,d)},e.debug=(e,t,n,a,i,r,o,s,c,d)=>{Jn(e,t,pn.debug,n,a,i,r,o,s,c,d)},e.metric=(e,t,n,a,i,r,o,s,c,d)=>{Jn(e,t,pn.metric,n,a,i,r,o,s,c,d)},e.formatMetric=(e,t,n,a)=>{const i={};return i[e]={dimensionNames:n,dimensionValues:a,value:t},i},e.dynamic=e=>{Xn(e)}}(Bn||(Bn={}));const jn=(e,t)=>{const n=t.level;Object.keys(pn).map(e=>pn[e]).filter(e=>"string"!=typeof e).filter(e=>e<=n).forEach(n=>{e.has(n)?e.get(n).push(t):e.set(n,[t])})},Vn=e=>{if("string"==typeof e)return e;let t="";for(let n=0;n<e.length;n++){n>0&&(t+=" ");const a=e[n];a instanceof Error?t+=JSON.stringify({message:a.message,name:a.name,stack:a.stack}):t+="object"==typeof a?JSON.stringify(a):a}return t},zn=e=>`${e.root}.${e.name}`,Gn=[],Kn=["Level","Tag"],Wn=["Level","Tag","Workflow"],qn=e=>Qn(e).length,Qn=e=>void 0!==e?Fn.get(e)||Gn:kn,Yn=(e,t)=>(void 0!==e?Hn.get(e)||[]:Mn).filter(e=>e.shouldLog(t)),Jn=(e,t,n,a,i,r,o,s,c,d,l)=>{n=Rn.get(e)||n;const u=Qn(n),f=Yn(n,a);if(0==u.length&&0==f.length)return;const p=Pn(On.Log),m=ta(e),_=((e,t,n,a,i,r,o,s)=>{if(void 0===t&&("string"==typeof e||"object"==typeof e))return e;if(void 0===t&&"function"==typeof e)return e();const c=[];for(const d of[e,t,n,a,i,r,o,s])void 0!==d&&c.push("function"==typeof d?d():d);return c})(a,i,r,o,s,c,d,l);if(Zn(t))$n(_)&&Xn({eventName:"Metrics",tagId:m,category:zn(t),traceLevel:n,message:"",getMetrics:()=>_},!1,u,f);else if($n(_)){const e=_;e.tagId=m,e.category=zn(t),"Operation"===e.eventName&&"Workflow"===t.root&&(e.eventName="WorkflowOperation",Ln&&(e.joinContextId=Ln().joinContextId,e.workflow=Ln().workflow)),e.traceLevel=n;const a=Un.get(e.eventName);if(a)for(let t=0;t<a.length;++t){const n=a[t];if(n&&n.add(e,t===a.length-1))break}else Xn(e,!1,u,f)}else{const e=()=>{var e;return"Core"===t.root?{TraceEventV2:{dimensionNames:()=>Kn,dimensionValues:[String(n),m],value:1}}:{WorkflowTraceEvent:{dimensionNames:()=>Wn,dimensionValues:[String(n),m,Ln?null===(e=Ln())||void 0===e?void 0:e.workflow:""],value:1}}};Xn({eventName:"Log",tagId:m,category:zn(t),traceLevel:n,message:Vn(_),getMetrics:e},!1,u,f)}Tn(p)},Xn=(e,t=!1,n,a)=>{var i,r,o,s,c,d,l,u,f,p,m,_,h,b;let g;if(null==n&&(n=Qn(e.traceLevel)),a=a||Gn,n.length>0||a.length>0){if(e.serviceName=wn,!t&&Ln){const t=Ln();t&&(g={disableLogging:t.disableLogging,userDataBoundaryType:null===(r=null===(i=t.sessionDescriptor)||void 0===i?void 0:i.userContext)||void 0===r?void 0:r.userDataBoundaryType},e.cv=e.cv?e.cv:t.cv.toString(),e.sessionKey=e.sessionKey?e.sessionKey:t.sessionKey,e.userTenantId=e.userTenantId?e.userTenantId:t.userTenantId,e.workflow=e.workflow?e.workflow:t.workflow,e.clientAppName=e.clientAppName?e.clientAppName:null===(o=t.clientMetadata)||void 0===o?void 0:o.appName,e.clientAppPlatform=e.clientAppPlatform?e.clientAppPlatform:null===(s=t.clientMetadata)||void 0===s?void 0:s.appPlatform,e.clientAppVersion=e.clientAppVersion?e.clientAppVersion:null===(c=t.clientMetadata)||void 0===c?void 0:c.appVersion,e.clientDocSessionId=e.clientDocSessionId?e.clientDocSessionId:null===(d=t.clientMetadata)||void 0===d?void 0:d.docSessionId,e.clientReleaseAudienceGroup=e.clientReleaseAudienceGroup?e.clientReleaseAudienceGroup:null===(l=t.clientMetadata)||void 0===l?void 0:l.releaseAudienceGroup,e.clientReleaseChannel=e.clientReleaseChannel?e.clientReleaseChannel:null===(u=t.clientMetadata)||void 0===u?void 0:u.releaseChannel,e.clientReleaseFork=e.clientReleaseFork?e.clientReleaseFork:null===(f=t.clientMetadata)||void 0===f?void 0:f.releaseFork,e.clientRuntimeVersion=e.clientRuntimeVersion?e.clientRuntimeVersion:null===(p=t.clientMetadata)||void 0===p?void 0:p.runtimeVersion,e.clientSessionId=e.clientSessionId?e.clientSessionId:null===(m=t.clientMetadata)||void 0===m?void 0:m.sessionId,e.clientUserAgent=e.clientUserAgent?e.clientUserAgent:null===(_=t.clientMetadata)||void 0===_?void 0:_.userAgent,e.traceId=e.traceId||t.traceId,e.isClientTelemetrySampled=e.isClientTelemetrySampled?e.isClientTelemetrySampled:null===(h=t.clientMetadata)||void 0===h?void 0:h.isClientTelemetrySampled,e.userDataBoundaryType=ea(g),e.ecsConfigIDs=null===(b=t.ecsConfigIDsManager)||void 0===b?void 0:b.getAllConfigIDsString())}for(const t of n)t.log(e,g);for(const t of a)t.log(e)}},Zn=e=>e.name===aa.WorkflowMetricsOnly.name&&e.root===aa.WorkflowMetricsOnly.root,$n=e=>!Array.isArray(e)&&"object"==typeof e,ea=e=>(null==e?void 0:e.userDataBoundaryType)===In.EDPSCompliant?Nn.EDPSCompliant:Nn.Default,ta=e=>En[e>>24&63]+En[e>>18&63]+En[e>>12&63]+En[e>>6&63]+En[e>>0&63],na=e=>e&&5===e.length?An[e.charCodeAt(0)]<<24|An[e.charCodeAt(1)]<<18|An[e.charCodeAt(2)]<<12|An[e.charCodeAt(3)]<<6|An[e.charCodeAt(4)]:-1;class aa{}var ia,ra;function oa(e){if(!e)return new sa([],new Set,new Map,new Map);const t=e.split(";"),n=new Set,a=new Map,i=new Map;for(const e of t){const t=e.trim();if(""===t)continue;n.add(sa.normalizeName(t));const[r,...o]=t.split(":"),s=o.join(":"),c=sa.normalizeName(r);if(c){a.set(c,s);const e=sa.parseName(c);e&&e!==c&&i.set(e,c)}}return new sa(t,n,a,i)}aa.CoreDefault=Bn.defineCoreLogCategory("Default"),aa.CoreSystem=Bn.defineCoreLogCategory("System"),aa.CoreUnsampled=Bn.defineCoreLogCategory("Unsampled"),aa.WorkflowDefault=Bn.defineWorkflowLogCategory("Default"),aa.WorkflowUnsampled=Bn.defineWorkflowLogCategory("Unsampled"),aa.WorkflowMetricsOnly=Bn.defineWorkflowLogCategory("MetricsOnly"),aa.PrivacyGuardEvent=Bn.defineCoreLogCategory("PrivacyGuardEvent"),function(e){e[e.JSWebSockets=0]="JSWebSockets",e[e.LocalWorkflowsOnly=1]="LocalWorkflowsOnly",e[e.HostWebSockets=2]="HostWebSockets",e[e.HttpFallback=3]="HttpFallback"}(ia||(ia={})),function(e){e.Workflow="Workflow",e.Client="Client",e.HttpEndpoint="HttpEndpoint"}(ra||(ra={}));class sa{constructor(e,t,n,a){this.originalFlights=e,this.normalizedFlights=t,this.keyValueFlightsMap=n,this.parsedFlightsMap=a}static normalizeName(e){return null==e?void 0:e.toLowerCase()}static parseName(e){const t=null==e?void 0:e.split(".");return t?t[t.length-1]:void 0}hasFlight(e){const t=sa.normalizeName(e),n=this.normalizedFlights.has(t),a=this.keyValueFlightsMap.has(t),i=this.parsedFlightsMap.has(t);return n||a||i}getBooleanValue(e,t){var n,a;const i=null===(n=this.getStringValue(e))||void 0===n?void 0:n.toLowerCase(),r=null===(a=this.getStringValue(this.parsedFlightsMap.get(sa.normalizeName(e))))||void 0===a?void 0:a.toLowerCase();return"true"===i||"true"===r||"false"!==i&&"false"!==r&&t}getIntValue(e,t){const n=this.getStringValue(e),a=Number.parseInt(n,10);return Number.isNaN(a)?t:a}getStringValue(e,t){var n;return null!==(n=this.keyValueFlightsMap.get(sa.normalizeName(e)))&&void 0!==n?n:t}getAll(){return this.originalFlights}getAllParsed(){const e=[];return this.keyValueFlightsMap.forEach((t,n)=>{const a=null==t?void 0:t.toLowerCase();switch(a){case"true":e.push({name:n,value:!0});break;case"false":e.push({name:n,value:!1});break;default:{const i=Number.parseInt(a,10);Number.isNaN(i)?e.push({name:n,value:t}):e.push({name:n,value:i})}}}),e}}class ca{constructor(e=500,t=!1){this.prevSeq=-1,this.bufferingTimeMs=e,this.rejectOutdatedSequenceNumbers=t}sequence(e){return new Promise((t,n)=>{if(e<this.prevSeq){if(this.rejectOutdatedSequenceNumbers){const t=new Error(`BufferingSequencer: Item out of order. Expecting seqId > ${this.prevSeq}. Actual seqId ${e}`);return t.name=ca.Rejected,void n(t)}this.prevSeq=-1}e!=this.prevSeq+1&&Bn.warn(542712385,aa.CoreDefault,`BufferingSequencer: got out of order sequence number. Got ${e}, expected ${this.prevSeq+1}`);const a={seq:e,resolve:t};this.insertItem(a),this.runInOrder(a,!0,!1)})}insertItem(e){if(!this.firstQueueItem)return this.firstQueueItem=e,void(this.lastQueueItem=e);let t=this.lastQueueItem,n=null;do{if(e.seq>t.seq)return e.prev=t,t.next=e,void(n?(n.prev=e,e.next=n):this.lastQueueItem=e);n=t,t=t.prev}while(t);n&&(n.prev=e),e.next=n,this.firstQueueItem=e}runInOrder(e,t,n){let a=this.prevSeq,i=!1;const r=[];for(;this.firstQueueItem;){const t=this.firstQueueItem;if(a+1!=t.seq&&(!n||t.seq>e.seq))break;a=t.seq,t.timeout&&clearTimeout(t.timeout),r.push(t),e==t&&(i=!0),this.firstQueueItem=this.firstQueueItem.next,this.firstQueueItem&&(this.firstQueueItem.prev=null)}r.length>0&&setTimeout(()=>{for(const e of r)e.resolve(e.seq)},0),this.prevSeq=a,!i&&t&&(e.timeout=setTimeout(()=>{this.runInOrder(e,!1,!0)},this.bufferingTimeMs))}}ca.Rejected="SequenceItemRejected";class da{constructor(e=500){this.bufferingTimeMs=500,this.workflowIdToSequencersMap=new Map,this.bufferingTimeMs=e}create(e){if(!e.ownerId)return null;let t=this.workflowIdToSequencersMap.get(e.ownerId);return t||(t=new ca(this.bufferingTimeMs),this.workflowIdToSequencersMap.set(e.ownerId,t)),t}}class la{constructor(e=500,t){this.sequencerFactory=null!=t?t:new da(e)}sequence(e){var t,n,a,i;return n=this,void 0,i=function*(){if(null==(null===(t=null==e?void 0:e.M_)||void 0===t?void 0:t.seq))return;const n=this.sequencerFactory.create(e);n&&(yield n.sequence(e.M_.seq))},new((a=void 0)||(a=Promise))(function(e,t){function r(e){try{s(i.next(e))}catch(e){t(e)}}function o(e){try{s(i.throw(e))}catch(e){t(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof a?n:new a(function(e){e(n)})).then(r,o)}s((i=i.apply(n,[])).next())})}}class ua{constructor(e){this.annotationSequencer=null!=e?e:new la}process(e,t,n,a){const i=[];for(const a of e.ops){const r=[];if(null==a?void 0:a.items)for(const e of a.items){const n=this.annotationSequencer.sequence(e.body).then(()=>{t(a,e)});r.push(n)}i.push(Promise.all(r).then(()=>{n(a,e.cv)}))}Promise.all(i).then(()=>a(e))}}class fa{process(e,t,n,a){for(const a of e.ops){if(null==a?void 0:a.items)for(const e of a.items)t(a,e);n(a,e.cv)}a(e)}}class pa{constructor(e,t,n){this.isOrderingEnabled=e,this.orderedAnnotationResultsProcessor=null!=t?t:new ua,this.unorderedAnnotationResultsProcessor=null!=n?n:new fa}process(e,t,n,a){this.isOrderingEnabled()?this.orderedAnnotationResultsProcessor.process(e,t,n,a):this.unorderedAnnotationResultsProcessor.process(e,t,n,a)}}var ma,_a,ha,ba,ga,va,ya,Sa,Da,Ia,xa,Ca,Oa,wa,Ea,Aa,La,ka=function(e,t,n,a){return new(n||(n=Promise))(function(i,r){function o(e){try{c(a.next(e))}catch(e){r(e)}}function s(e){try{c(a.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,s)}c((a=a.apply(e,t||[])).next())})};class Ma{constructor(e,t){this.changeGatesInitialized=!1,this.hostCallbacks=e,this.changeGateMap=t||new Map}init(){return ka(this,void 0,void 0,function*(){const e=[];this.hostCallbacks&&this.hostCallbacks.isChangeGateEnabled&&this.changeGateMap.forEach((t,n)=>{e.push(this.hostCallbacks.isChangeGateEnabled(n).then(e=>{this.changeGateMap.set(n,e)}))}),yield Promise.all(e).then(()=>{this.changeGatesInitialized=!0}).catch(e=>{})})}isFeatureEnabled(e,t=!1,n="None"){return this.hostCallbacks&&this.hostCallbacks.isFeatureEnabled?this.hostCallbacks.isFeatureEnabled(e,n).catch(()=>Promise.resolve(t)):Promise.resolve(t)}isChangeGateEnabled(e){var t;return ka(this,void 0,void 0,function*(){return!this.changeGateMap||(this.changeGatesInitialized&&this.changeGateMap.has(e)?this.changeGateMap.get(e):!(!this.changeGatesInitialized&&(null===(t=this.hostCallbacks)||void 0===t?void 0:t.isChangeGateEnabled))||(yield this.hostCallbacks.isChangeGateEnabled(e)))})}isChangeGateEnabledSync(e){var t;if(!this.changeGatesInitialized&&(null===(t=this.hostCallbacks)||void 0===t?void 0:t.isChangeGateEnabled)){const t=new yn({operationName:"GateUtilsNotInitialized",success:!1,resultDescription:`${e}`});Bn.error(505529628,aa.CoreDefault,t)}return!this.changeGateMap||!this.changeGatesInitialized||!this.changeGateMap.has(e)||this.changeGateMap.get(e)}isChangeGatesInitialized(){return this.changeGatesInitialized}getChangeGateMap(){return this.changeGateMap}}!function(e){e[e.Undefined=0]="Undefined",e[e.Created=10]="Created",e[e.Sent=20]="Sent",e[e.Duplicated=30]="Duplicated",e[e.Seen=40]="Seen",e[e.Tried=50]="Tried",e[e.Kept=60]="Kept",e[e.Rejected=70]="Rejected"}(ma||(ma={}));class Pa{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Pa,this,t)}static getTypeName(){return"AugLoop_Core_Annotation"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Pa.getTypeName()])}}Pa.H_={T_:Pa.getTypeName(),B_:Pa.getBaseTypes()};class Ta{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Ta,this,t)}static getTypeName(){return"AugLoop_Core_BinaryClassificationAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Ta.getTypeName()])}}Ta.H_={T_:Ta.getTypeName(),B_:Ta.getBaseTypes()};class Ua{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Ua,this,t)}static getTypeName(){return"AugLoop_Core_StreamAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Ua.getTypeName()])}}Ua.H_={T_:Ua.getTypeName(),B_:Ua.getBaseTypes()};class Fa{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Fa,this,t)}static getTypeName(){return"AugLoop_Core_ExecutionCorrelatedAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Fa.getTypeName()])}}Fa.H_={T_:Fa.getTypeName(),B_:Fa.getBaseTypes()};class Ha{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Ha,this,t)}static getTypeName(){return"AugLoop_Core_ClaimsChallengeAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Ha.getTypeName()])}}Ha.H_={T_:Ha.getTypeName(),B_:Ha.getBaseTypes()};class Ra{constructor(t){e.assign(Ra,this,t)}static getTypeName(){return"AugLoop_Signals_Signal"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Ra.getTypeName()])}}Ra.H_={T_:Ra.getTypeName(),B_:Ra.getBaseTypes()};class Na{constructor(t){e.assign(Na,this,t)}static getTypeName(){return"AugLoop_Core_DirtyAreaSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Na.getTypeName()])}}Na.H_={T_:Na.getTypeName(),B_:Na.getBaseTypes()};class Ba{constructor(t){e.assign(Ba,this,t)}static getTypeName(){return"AugLoop_Core_DirtyDocumentSignal"}static getBaseTypes(){return["AugLoop_Core_DirtyAreaSignal","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Ba.getTypeName()])}}Ba.H_={T_:Ba.getTypeName(),B_:Ba.getBaseTypes()},function(e){e[e.SingleItem=0]="SingleItem",e[e.Reduce=1]="Reduce",e[e.Grid=2]="Grid",e[e.DynamicText=3]="DynamicText",e[e.Join=4]="Join",e[e.Generic=5]="Generic"}(_a||(_a={})),function(e){e.Default="Default",e.Copilot="Copilot"}(ha||(ha={})),function(e){e[e.None=0]="None",e[e.ContentFiltering_M365Copilot=1]="ContentFiltering_M365Copilot"}(ba||(ba={})),function(e){e[e.Default=0]="Default",e[e.LocalOnly=1]="LocalOnly",e[e.Exclusive=2]="Exclusive"}(ga||(ga={})),function(e){e[e.PreActivate=0]="PreActivate",e[e.Default=1]="Default",e[e.DelayActivate=1]="DelayActivate",e[e.NeverActivate=2]="NeverActivate"}(va||(va={})),(La=ya||(ya={}))[La.Required=-3]="Required",La[La.Optional=-1]="Optional",(Aa=Sa||(Sa={}))[Aa.Never=0]="Never",Aa[Aa.Always=1]="Always",function(e){e[e.PreSeed=1]="PreSeed",e[e.OnSeed=2]="OnSeed",e[e.PostSeed=4]="PostSeed",e[e.All=5]="All"}(Da||(Da={})),(Ea=Ia||(Ia={}))[Ea.UpstreamWorkflowsReady=0]="UpstreamWorkflowsReady",Ea[Ea.AnnotationMetadataUpdated=1]="AnnotationMetadataUpdated",Ea[Ea.DeltaUpdate=2]="DeltaUpdate",Ea[Ea.NonExclusiveTriggerSignals=3]="NonExclusiveTriggerSignals",function(e){e[e.Character=1]="Character",e[e.Paragraph=2]="Paragraph"}(xa||(xa={})),function(e){e.Input="Input",e.Delta="Delta",e.UILanguage="UILanguage",e.MaxInputCount="MaxInputCount",e.ExtensionLimits="ExtensionLimits"}(Ca||(Ca={})),function(e){e.SetPredefinedAnnotation="SetPredefinedAnnotation",e.ClearAnnotations="ClearAnnotations"}(Oa||(Oa={})),function(e){e[e.JoinContext=0]="JoinContext",e[e.Session=1]="Session"}(wa||(wa={})),Error;var ja,Va,za,Ga,Ka={util:{},roots:{default:{}}},Wa=(Ka.util,Ka.roots.default||(Ka.roots.default={}),function(){function e(e){if(e)for(var t in e)null!=e[t]&&(this[t]=e[t])}return e.prototype.sessionKey="",e.prototype.annotationType="",e.prototype.annotationState=0,e.prototype.workflowId="",e.prototype.traceId="",e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/AnnotationMetaDataChangeEvent"},e}());class qa extends Wa{constructor(e){super(e),this.eventName="AnnotationMetaDataChange"}}!function(e){e[e.NotAuthenticated=0]="NotAuthenticated",e[e.Pending=1]="Pending",e[e.Authenticated=2]="Authenticated",e[e.WacUserInfoAuthenticated=3]="WacUserInfoAuthenticated",e[e.TokenMissingInteractionRequired=4]="TokenMissingInteractionRequired"}(ja||(ja={}));class Qa{constructor(t){e.assign(Qa,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_Message"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Qa.getTypeName()])}}Qa.H_={T_:Qa.getTypeName(),B_:Qa.getBaseTypes()};class Ya{constructor(t){e.assign(Ya,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_Response"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Ya.getTypeName()])}}Ya.H_={T_:Ya.getTypeName(),B_:Ya.getBaseTypes()};class Ja{constructor(t){e.assign(Ja,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_StreamingResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[Ja.getTypeName()])}}Ja.H_={T_:Ja.getTypeName(),B_:Ja.getBaseTypes()};class Xa{constructor(t){e.assign(Xa,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_StreamingRequest"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Xa.getTypeName()])}}Xa.H_={T_:Xa.getTypeName(),B_:Xa.getBaseTypes()};class Za{constructor(t){e.assign(Za,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_ExecutionError"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Za.getTypeName()])}}Za.H_={T_:Za.getTypeName(),B_:Za.getBaseTypes()};class $a{constructor(t){e.assign($a,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_GetAnnotationsClientError"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[$a.getTypeName()])}}$a.H_={T_:$a.getTypeName(),B_:$a.getBaseTypes()};class ei{constructor(t){e.assign(ei,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_GetAnnotationsErrorInfo"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[ei.getTypeName()])}}ei.H_={T_:ei.getTypeName(),B_:ei.getBaseTypes()};class ti{constructor(t){e.assign(ti,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_ErrorResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[ti.getTypeName()])}}ti.H_={T_:ti.getTypeName(),B_:ti.getBaseTypes()};class ni{constructor(t){e.assign(ni,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_TimeoutErrorResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_ErrorResponse","AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[ni.getTypeName()])}}ni.H_={T_:ni.getTypeName(),B_:ni.getBaseTypes()};class ai{constructor(t){e.assign(ai,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_RateLimitErrorResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_ErrorResponse","AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[ai.getTypeName()])}}ai.H_={T_:ai.getTypeName(),B_:ai.getBaseTypes()};class ii{constructor(t){e.assign(ii,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_SessionInitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[ii.getTypeName()])}}ii.H_={T_:ii.getTypeName(),B_:ii.getBaseTypes()};class ri{constructor(t){e.assign(ri,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_SessionInitResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[ri.getTypeName()])}}ri.H_={T_:ri.getTypeName(),B_:ri.getBaseTypes()};class oi{constructor(t){e.assign(oi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_SessionLongPollMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[oi.getTypeName()])}}oi.H_={T_:oi.getTypeName(),B_:oi.getBaseTypes()};class si{constructor(t){e.assign(si,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_SessionLongPollResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[si.getTypeName()])}}si.H_={T_:si.getTypeName(),B_:si.getBaseTypes()};class ci{constructor(t){e.assign(ci,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_SessionCloseReason"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[ci.getTypeName()])}}ci.H_={T_:ci.getTypeName(),B_:ci.getBaseTypes()};class di{constructor(t){e.assign(di,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_SessionSwapOnClose"}static getBaseTypes(){return["AugLoop_Session_Protocol_SessionCloseReason"]}static typeGuard(t){return e.matchesTypesFor(t,[di.getTypeName()])}}di.H_={T_:di.getTypeName(),B_:di.getBaseTypes()};class li{constructor(t){e.assign(li,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_SessionCloseMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[li.getTypeName()])}}li.H_={T_:li.getTypeName(),B_:li.getBaseTypes()};class ui{constructor(t){e.assign(ui,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_CacheDumpRequestMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[ui.getTypeName()])}}ui.H_={T_:ui.getTypeName(),B_:ui.getBaseTypes()};class fi{constructor(t){e.assign(fi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_CacheDumpRequestResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[fi.getTypeName()])}}fi.H_={T_:fi.getTypeName(),B_:fi.getBaseTypes()};class pi{constructor(t){e.assign(pi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationActivationMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[pi.getTypeName()])}}pi.H_={T_:pi.getTypeName(),B_:pi.getBaseTypes()};class mi{constructor(t){e.assign(mi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationActivationResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[mi.getTypeName()])}}mi.H_={T_:mi.getTypeName(),B_:mi.getBaseTypes()};class _i{constructor(t){e.assign(_i,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationResultStateMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[_i.getTypeName()])}}_i.H_={T_:_i.getTypeName(),B_:_i.getBaseTypes()};class hi{constructor(t){e.assign(hi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationReleaseMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[hi.getTypeName()])}}hi.H_={T_:hi.getTypeName(),B_:hi.getBaseTypes()};class bi{constructor(t){e.assign(bi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationReleaseResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[bi.getTypeName()])}}bi.H_={T_:bi.getTypeName(),B_:bi.getBaseTypes()};class gi{constructor(t){e.assign(gi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationConfigUpdateMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[gi.getTypeName()])}}gi.H_={T_:gi.getTypeName(),B_:gi.getBaseTypes()};class vi{constructor(t){e.assign(vi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationConfigUpdateResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[vi.getTypeName()])}}vi.H_={T_:vi.getTypeName(),B_:vi.getBaseTypes()};class yi{constructor(t){e.assign(yi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_BatchedMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[yi.getTypeName()])}}yi.H_={T_:yi.getTypeName(),B_:yi.getBaseTypes()};class Si{constructor(t){e.assign(Si,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_SyncMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Si.getTypeName()])}}Si.H_={T_:Si.getTypeName(),B_:Si.getBaseTypes()};class Di{constructor(t){e.assign(Di,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_MicroSyncMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Di.getTypeName()])}}Di.H_={T_:Di.getTypeName(),B_:Di.getBaseTypes()};class Ii{constructor(t){e.assign(Ii,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_SyncResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[Ii.getTypeName()])}}Ii.H_={T_:Ii.getTypeName(),B_:Ii.getBaseTypes()};class xi{constructor(t){e.assign(xi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_SessionDeleteMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[xi.getTypeName()])}}xi.H_={T_:xi.getTypeName(),B_:xi.getBaseTypes()};class Ci{constructor(t){e.assign(Ci,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationResultsMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_SyncMessage","AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Ci.getTypeName()])}}Ci.H_={T_:Ci.getTypeName(),B_:Ci.getBaseTypes()};class Oi{constructor(t){e.assign(Oi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_TokenProvisionMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Oi.getTypeName()])}}Oi.H_={T_:Oi.getTypeName(),B_:Oi.getBaseTypes()};class wi{constructor(t){e.assign(wi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_TokenFailureMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[wi.getTypeName()])}}wi.H_={T_:wi.getTypeName(),B_:wi.getBaseTypes()};class Ei{constructor(t){e.assign(Ei,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_TokenProvisionResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[Ei.getTypeName()])}}Ei.H_={T_:Ei.getTypeName(),B_:Ei.getBaseTypes()};class Ai{constructor(t){e.assign(Ai,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_KeepAlive"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Ai.getTypeName()])}}Ai.H_={T_:Ai.getTypeName(),B_:Ai.getBaseTypes()};class Li{constructor(t){e.assign(Li,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowGraphInitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Li.getTypeName()])}}Li.H_={T_:Li.getTypeName(),B_:Li.getBaseTypes()};class ki{constructor(t){e.assign(ki,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowGraphInitResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[ki.getTypeName()])}}ki.H_={T_:ki.getTypeName(),B_:ki.getBaseTypes()};class Mi{constructor(t){e.assign(Mi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowExecutionCompleteMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_SyncMessage","AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Mi.getTypeName()])}}Mi.H_={T_:Mi.getTypeName(),B_:Mi.getBaseTypes()};class Pi{constructor(t){e.assign(Pi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_SeedingStatusChangeMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Pi.getTypeName()])}}Pi.H_={T_:Pi.getTypeName(),B_:Pi.getBaseTypes()};class Ti{constructor(t){e.assign(Ti,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2InitV2Message"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Ti.getTypeName()])}}Ti.H_={T_:Ti.getTypeName(),B_:Ti.getBaseTypes()};class Ui{constructor(t){e.assign(Ui,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2InitV2Response"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[Ui.getTypeName()])}}Ui.H_={T_:Ui.getTypeName(),B_:Ui.getBaseTypes()};class Fi{constructor(t){e.assign(Fi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2InitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Fi.getTypeName()])}}Fi.H_={T_:Fi.getTypeName(),B_:Fi.getBaseTypes()};class Hi{constructor(t){e.assign(Hi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2InitResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[Hi.getTypeName()])}}Hi.H_={T_:Hi.getTypeName(),B_:Hi.getBaseTypes()};class Ri{constructor(t){e.assign(Ri,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2CallbackMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Ri.getTypeName()])}}Ri.H_={T_:Ri.getTypeName(),B_:Ri.getBaseTypes()};class Ni{constructor(t){e.assign(Ni,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_BridgeMessage"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Ni.getTypeName()])}}Ni.H_={T_:Ni.getTypeName(),B_:Ni.getBaseTypes()};class Bi{constructor(t){e.assign(Bi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_SessionConnectMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Bi.getTypeName()])}}Bi.H_={T_:Bi.getTypeName(),B_:Bi.getBaseTypes()};class ji{constructor(t){e.assign(ji,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_SessionDisconnectMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[ji.getTypeName()])}}ji.H_={T_:ji.getTypeName(),B_:ji.getBaseTypes()};class Vi{constructor(t){e.assign(Vi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_SessionReconnectMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Vi.getTypeName()])}}Vi.H_={T_:Vi.getTypeName(),B_:Vi.getBaseTypes()};class zi{constructor(t){e.assign(zi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_SubmittedCustomMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[zi.getTypeName()])}}zi.H_={T_:zi.getTypeName(),B_:zi.getBaseTypes()};class Gi{constructor(t){e.assign(Gi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_ServerAuthenticationStateChangeMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Gi.getTypeName()])}}Gi.H_={T_:Gi.getTypeName(),B_:Gi.getBaseTypes()};class Ki{constructor(t){e.assign(Ki,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_ClaimsChallengeMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Ki.getTypeName()])}}Ki.H_={T_:Ki.getTypeName(),B_:Ki.getBaseTypes()};class Wi{constructor(t){e.assign(Wi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_BlobUploadResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[Wi.getTypeName()])}}Wi.H_={T_:Wi.getTypeName(),B_:Wi.getBaseTypes()};class qi{constructor(t){e.assign(qi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_GetPluginsMetadataMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[qi.getTypeName()])}}qi.H_={T_:qi.getTypeName(),B_:qi.getBaseTypes()};class Qi{constructor(t){e.assign(Qi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_GetPluginsMetadataResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[Qi.getTypeName()])}}Qi.H_={T_:Qi.getTypeName(),B_:Qi.getBaseTypes()};class Yi{constructor(t){e.assign(Yi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_ExecutionCorrelatedClientResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Yi.getTypeName()])}}Yi.H_={T_:Yi.getTypeName(),B_:Yi.getBaseTypes()};class Ji{constructor(t){e.assign(Ji,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_WorkflowRegistrationMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Ji.getTypeName()])}}Ji.H_={T_:Ji.getTypeName(),B_:Ji.getBaseTypes()};class Xi{constructor(t){e.assign(Xi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowExecutionRequest"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Xi.getTypeName()])}}Xi.H_={T_:Xi.getTypeName(),B_:Xi.getBaseTypes()};class Zi{constructor(t){e.assign(Zi,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowCancellationRequest"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[Zi.getTypeName()])}}Zi.H_={T_:Zi.getTypeName(),B_:Zi.getBaseTypes()};class $i{constructor(t){e.assign($i,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowExecutionResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[$i.getTypeName()])}}$i.H_={T_:$i.getTypeName(),B_:$i.getBaseTypes()};class er{constructor(t){e.assign(er,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_RuntimeInitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[er.getTypeName()])}}er.H_={T_:er.getTypeName(),B_:er.getBaseTypes()};class tr{constructor(t){e.assign(tr,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_DiagnosticTraceMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[tr.getTypeName()])}}tr.H_={T_:tr.getTypeName(),B_:tr.getBaseTypes()};class nr{constructor(t){e.assign(nr,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_TelemetryMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[nr.getTypeName()])}}nr.H_={T_:nr.getTypeName(),B_:nr.getBaseTypes()};class ar{constructor(t){e.assign(ar,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_TelemetryFlushMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[ar.getTypeName()])}}ar.H_={T_:ar.getTypeName(),B_:ar.getBaseTypes()};class ir{constructor(t){e.assign(ir,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_SessionCloseResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[ir.getTypeName()])}}ir.H_={T_:ir.getTypeName(),B_:ir.getBaseTypes()};class rr{constructor(t){e.assign(rr,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_WorkflowDefinitionOverrideMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[rr.getTypeName()])}}rr.H_={T_:rr.getTypeName(),B_:rr.getBaseTypes()};class or{constructor(t){e.assign(or,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_GetAnnotationsRequestMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_StreamingRequest","AugLoop_Session_Protocol_Message"]}static typeGuard(t){return e.matchesTypesFor(t,[or.getTypeName()])}}or.H_={T_:or.getTypeName(),B_:or.getBaseTypes()};class sr{constructor(t){e.assign(sr,this,t)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_GetAnnotationsResponseMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_StreamingResponse","AugLoop_Session_Protocol_Response"]}static typeGuard(t){return e.matchesTypesFor(t,[sr.getTypeName()])}}sr.H_={T_:sr.getTypeName(),B_:sr.getBaseTypes()},function(e){e[e.Add=0]="Add",e[e.Delete=1]="Delete",e[e.Update=2]="Update",e[e.CursorUpdate=3]="CursorUpdate",e[e.FormattingUpdate=4]="FormattingUpdate",e[e.OtherNonContentUpdate=5]="OtherNonContentUpdate",e[e.AttributionUpdate=6]="AttributionUpdate"}(Va||(Va={})),function(e){e[e.Chars=0]="Chars",e[e.Word=1]="Word",e[e.PartialSentence=2]="PartialSentence",e[e.Sentence=3]="Sentence",e[e.Paragraph=4]="Paragraph"}(za||(za={})),function(e){e[e.SessionUser=0]="SessionUser",e[e.Programmatic=1]="Programmatic",e[e.Collaborator=2]="Collaborator"}(Ga||(Ga={}));class cr{constructor(t){e.assign(cr,this,t)}static getTypeName(){return"AugLoop_Text_TextTileDelta"}static getBaseTypes(){return["AugLoop_Core_ItemDelta"]}static typeGuard(t){return e.matchesTypesFor(t,[cr.getTypeName()])}}cr.H_={T_:cr.getTypeName(),B_:cr.getBaseTypes()};class dr{constructor(t){e.assign(dr,this,t)}static getTypeName(){return"AugLoop_Text_FormattedTextTileDelta"}static getBaseTypes(){return["AugLoop_Text_TextTileDelta","AugLoop_Core_ItemDelta"]}static typeGuard(t){return e.matchesTypesFor(t,[dr.getTypeName()])}}function lr(e,t=!1){switch(e){case 12288:case 8197:case 32:case 11:case 9:case 160:return!0;case 13:case 10:case 65532:return!t}return!1}function ur(e,t){return e.charCodeAt(t)>=56320&&e.charCodeAt(t)<=57343}dr.H_={T_:dr.getTypeName(),B_:dr.getBaseTypes()};var fr=o(513),pr=o.n(fr);const mr=/[ \u00a0\u2000-\u200a\u202f\u205f\u3000\t]/g,_r=/[.!?]/g;function hr(e,t){const n=[],a=gr(e,t);return a&&n.push(a),n}function br(e,t){const n=[],a=gr(e,t);a&&n.push(a);const i=function(e,t,n){var a,i,r,o,s,c;const d=e,l=t;if((null==d?void 0:d.ipPosition)!==(null==l?void 0:l.ipPosition)||(null==d?void 0:d.isColdIp)!==(null==l?void 0:l.isColdIp)){if((null==d?void 0:d.isColdIp)===(null==l?void 0:l.isColdIp)&&n)if(n.deltaType===Va.Add){if((null==l?void 0:l.ipPosition)===(null!==(a=n.position)&&void 0!==a?a:0)+(null!==(i=n.length)&&void 0!==i?i:0))return}else if(n.deltaType===Va.Update){if((null==l?void 0:l.ipPosition)===(null!==(r=n.position)&&void 0!==r?r:0)+(null!==(s=null===(o=n.content)||void 0===o?void 0:o.length)&&void 0!==s?s:0))return}else if(n.deltaType===Va.Delete&&(null==l?void 0:l.ipPosition)===(null!==(c=n.position)&&void 0!==c?c:0))return;return new dr({deltaType:Va.CursorUpdate,cursorData:{ipPosition:null==l?void 0:l.ipPosition,isColdIp:null==l?void 0:l.isColdIp}})}}(e,t,a);i&&n.push(i);const r=function(e,t,n){var a,i,r,o,s,c,d;const l=e,u=t;if((null===(a=u.formattedRanges)||void 0===a?void 0:a.length)<=(null===(i=l.formattedRanges)||void 0===i?void 0:i.length))if(n){let e=l.formattedRanges?[...l.formattedRanges]:[];const t=function(e,t,n){if(!e)return;if(t.deltaType===Va.Add){const t=e.find(e=>e.start===n&&0===e.length);if(t)return t;n=Math.max(n-1,0)}const a=e.find(e=>0===e.length?e.start===n:e.start<=n&&n<e.start+e.length);return a}(l.formattedRanges,n,n.position),a=t?e.indexOf(t):-1;if(-1!==a&&(n.position+(n.length||0)>t.start+t.length?t.length=n.position+(null!==(r=n.content)&&void 0!==r?r:"").length-t.start:t.length+=(null!==(o=n.content)&&void 0!==o?o:"").length-(n.length||0),e[a]=t),e.length>0){for(const t of e.slice(a+1))t.start<n.position||(n.position+(n.length||0)>t.start?(t.length=t.start+t.length-(n.position+(n.length||0)),t.start=n.position+(null!==(s=n.content)&&void 0!==s?s:"").length):t.start+=(null!==(c=n.content)&&void 0!==c?c:"").length-(n.length||0));e=e.filter(e=>e.length>0)}const i=null!==(d=null==u?void 0:u.formattedRanges)&&void 0!==d?d:[];if(pr()(e,i)||0===e.length&&0===i.length)return}else if(pr()(null==l?void 0:l.formattedRanges,null==u?void 0:u.formattedRanges))return;return new dr({deltaType:Va.FormattingUpdate,formattedRanges:null==u?void 0:u.formattedRanges})}(e,t,a);r&&n.push(r);const o=function(e,t,n){var a;const i=e,r=t;if(((null==i?void 0:i.attributionRanges)||r.attributionRanges||(null===(a=null==n?void 0:n.attributionData)||void 0===a?void 0:a.ranges))&&!pr()(null==i?void 0:i.attributionRanges,null==r?void 0:r.attributionRanges)){if(i.attributionRanges&&r.attributionRanges){const e=[];for(const t of r.attributionRanges)i.attributionRanges.some(e=>pr()(e,t))||e.push(t);if(0===e.length)return;return new dr({deltaType:Va.AttributionUpdate,attributionData:{ranges:e}})}return new dr({deltaType:Va.AttributionUpdate,attributionData:{ranges:null==r?void 0:r.attributionRanges}})}}(e,t,a);o&&n.push(o);const s=function(e,t){const n=e,a=t;let i;const r={};let o=!1;for(i in a)-1===["ipPosition","isColdIp","content","formattedRanges","attributionRanges"].indexOf(i)&&(pr()(a[i],n[i])||(o=!0,r[i]=a[i]));if(o)return new dr({deltaType:Va.OtherNonContentUpdate,otherNonContentData:r})}(e,t);return s&&n.push(s),n}function gr(e,t){const n=e.content,a=t.content,i=function(e,t,n=!1){let a,i,r={firstDiffLeft:0,firstDiffRight:t.length};return e.length<t.length?(a=e,i=t):(a=t,i=e),0===i.indexOf(a)?(r.firstDiffLeft=a.length,r.firstDiffRight=0):i.endsWith(a)?(r.firstDiffLeft=0,r.firstDiffRight=a.length):(r=function(e,t,n=!1){const a={firstDiffLeft:0,firstDiffRight:t.length};let i;for(i=0;i<e.length&&i<t.length;i+=1){const a=e.charCodeAt(i),r=t.charCodeAt(i);if(!(a===r||lr(a,n)&&lr(r,n)))break}for(a.firstDiffLeft=i,i=0;i<e.length&&i<t.length;i+=1){const a=e.charCodeAt(e.length-i-1),r=t.charCodeAt(t.length-i-1);if(!(a===r||lr(a,n)&&lr(r,n)))break}return a.firstDiffRight=i,a}(e,t,n),r.firstDiffLeft+r.firstDiffRight>a.length&&(r.firstDiffRight=a.length-r.firstDiffLeft)),function(e,t,n){if(e.firstDiffLeft>0){const a=e.firstDiffLeft<t.length&&ur(t,e.firstDiffLeft),i=e.firstDiffLeft<n.length&&ur(n,e.firstDiffLeft);(a||i)&&(e.firstDiffLeft-=1)}if(e.firstDiffRight>1){const a=e.firstDiffRight<t.length&&ur(t,t.length-e.firstDiffRight),i=e.firstDiffRight<n.length&&ur(n,n.length-e.firstDiffRight);(a||i)&&(e.firstDiffRight-=1)}}(r,e,t),r}(n,a),r=i.firstDiffLeft,o=n.length-i.firstDiffRight,s=a.length-i.firstDiffRight;let c,d=Va.Update;if(n.length!==a.length)o===r?(d=Va.Add,c=n[n.length-1]):s===r&&(d=Va.Delete,c=a[a.length-1]);else if(n===a)return;let l,u=0;switch(d){case Va.Update:u=o-r,l=a.substring(r,s);break;case Va.Add:l=a.substring(r,s);break;case Va.Delete:u=o-r,l=n.substring(r,o)}const f=function(e,t){const n=Array.from(e.matchAll(mr));if(mr.lastIndex=0,0===n.length)return za.Chars;if(1===n.length){if(0===n[0].index)return t&&_r.test(t)?za.Sentence:t&&!mr.test(t)?za.Word:za.Chars;if(n[0].index+1===e.length)return _r.test(e[n[0].index-1])?za.Sentence:mr.test(e[n[0].index-1])?za.Chars:za.Word;if(e[n[0].index-1]){const t=e[n[0].index-1];if(_r.test(t))return za.Sentence;if(mr.test(t))return za.Chars}return za.Word}const a=Array.from(e.matchAll(_r));return _r.lastIndex=0,0===a.length?za.PartialSentence:a.length>1?za.Paragraph:a[0].index+1<=e.length?mr.test(e[a[0].index+1])?za.Sentence:za.Paragraph:void 0}(l,c);if(void 0!==f)return new dr({content:d!==Va.Delete?l:void 0,deltaType:d,unit:f,position:r,length:d!==Va.Add?u:0})}class vr{constructor(){this.deltaBuilderHandlers=new Map,this.registerDeltaBuilderHandler(E.getTypeName(),hr),this.registerDeltaBuilderHandler(A.getTypeName(),br)}registerDeltaBuilderHandler(e,t){this.deltaBuilderHandlers.set(e,t)}executeDeltaBuilderHandler(e,t,n){const a=this.deltaBuilderHandlers.get(e);return a?a(t,n):[]}}const yr=(e,t)=>t?Sr([...t,e]):e,Sr=e=>e.join("\\");class Dr{constructor(t){this.createTextTileDeltasFromItem=(t,n)=>{var a;const i=new yn({operationName:"CreateTextTileDeltaFromItem",success:!0}).start();try{if(!t)return i.success=!1,i.resultDescription="Unable to create text tile delta, parent item is undefined",void Bn.info(524883085,aa.CoreDefault,i.stop());if(!t.body)return i.success=!1,i.resultDescription="Unable to create text tile delta, parent item has undefined body",void Bn.info(524883086,aa.CoreDefault,i.stop());const r=t.body;if(!E.typeGuard(r))return i.success=!1,void(i.resultDescription=`Unable to create text tile delta, parent item body is not proper type: expected ${E.getTypeName()}, received ${e.getTypeNameFor(r)}`);const o=yr(t.id,n),s=null!==(a=this.lastSeenTileByTileId.get(o))&&void 0!==a?a:new E({content:""}),c=this.createDeltas(s,r);return c&&0!==c.length?(i.dimension0=c.length.toString(),this.lastSeenTileByTileId.set(o,r)):(i.dimension0="0",i.resultDescription="No delta differences found"),Bn.info(524883087,aa.CoreDefault,i.stop()),c}catch(e){return i.success=!1,i.resultDescription=`Error creating text tile delta: ${e}`,void Bn.info(524883088,aa.CoreDefault,i.stop())}},this.lastSeenTileByTileId=null!=t?t:new Map,this.deltaBuilder=new vr}addItemToLocalMap(e,t){const n=yr(e.id,t),a=e.body;E.typeGuard(a)&&!this.lastSeenTileByTileId.has(n)&&this.lastSeenTileByTileId.set(n,a)}deleteItemFromLocalMap(e,t){const n=yr(e.id,t);this.lastSeenTileByTileId.has(n)&&this.lastSeenTileByTileId.delete(n)}moveItemsInLocalMap(e,t,n){const a=new Set(n),i=Sr(t),r=Sr(e),o=[],s=(e,t)=>e.length>t.length?e.substring(t.length+"\\".length).split("\\")[0]:void 0;for(const[e,t]of this.lastSeenTileByTileId)if(e.startsWith(i)){const n=s(e,i);if(void 0===n||a.has(n)){const n=e.replace(i,r);o.push({item:t,newPathKey:n,prevPathKey:e})}}for(const e of o)this.lastSeenTileByTileId.delete(e.prevPathKey),this.lastSeenTileByTileId.set(e.newPathKey,e.item)}createDeltas(t,n){return this.deltaBuilder.executeDeltaBuilderHandler(e.getTypeNameFor(n),t,n)}}class Ir{constructor(e){this.childCount=0,this.id=e||function(){for(let e=0;e<22;e++)Cr[e]=xr[Math.floor(Math.random()*xr.length)];return Cr.join("")}()}static fromString(e,t){if(!e)throw new Error("Received invalid correlation vector string");let n;return n=e.endsWith(".0")?new Ir(e.substring(0,e.length-2)):new Ir(e),t&&(n.childCount=t),n}newChild(){return++this.childCount,new Ir(this.id+"."+this.childCount.toString())}toString(){return this.id.length>127?this.id.substring(0,127)+"!":this.id}}const xr=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],Cr=new Array(22);var Or,wr,Er;!function(e){e[e.Local=0]="Local",e[e.External=1]="External"}(Or||(Or={}));class Ar{constructor(){this.graphNodeByLocationAndWorkflowId=new Map}getWorkflow(e,t){var n;const a=this.getLocation(t);return null===(n=this.graphNodeByLocationAndWorkflowId.get(a))||void 0===n?void 0:n.get(e)}addWorkflow(e,t=!1){if(this.getWorkflow(e.id,t)){const n=new yn({operationName:"AddWorkflowToGraphFailure",success:!1,resourceId:e.id,resultDescription:`Adding a new with workflow with a duplicated workflowId: ${t}`}).start();return void Bn.error(524300630,aa.CoreDefault,n.stop())}const n=this.getLocation(t),a=new Lr(e,n);this.addWorkflowAsDependency(a);let i=this.graphNodeByLocationAndWorkflowId.get(n);i||(i=new Map,this.graphNodeByLocationAndWorkflowId.set(n,i)),i.set(e.id,a)}getUpstreamRuntimeVisibleWorkflows(){const e=[];for(const t of this.graphNodeByLocationAndWorkflowId.values()||[])for(const n of t.values()||[]){const t=this.createWorkflowDefinition(n.workflow);n.workflow.visibility===ga.LocalOnly?this.compressDownstreamWorkflows(t,n):t.outputTypes.push(...n.workflow.outputTypes),0!==t.inputTypes.length&&e.push(t)}return e}removeWorkflows(e){const t=this.getLocation(e),n=this.graphNodeByLocationAndWorkflowId.get(t),a=Array.from((null==n?void 0:n.values())||[]);for(const e of a){for(const t of e.upstreamWorkflows.values())t.downstreamWorkflows.delete(e);for(const t of e.downstreamWorkflows.values())t.upstreamWorkflows.delete(e);n.delete(e.workflow.id)}}getWorkflowsDefinitions(){const e=[];for(const t of this.graphNodeByLocationAndWorkflowId.values()||[])for(const n of t.values()||[])e.push(n.workflow);return e}getWorkflowNodes(e){const t=[];for(const e of this.graphNodeByLocationAndWorkflowId.values())for(const n of e.values())t.push(n);return t}getLocation(e){return e?Or.External:Or.Local}createWorkflowDefinition(e){return Object.assign(Object.assign({},e),{outputTypes:[]})}compressDownstreamWorkflows(e,t){for(const n of t.downstreamWorkflows)if(n.workflow.visibility!==ga.LocalOnly){if(n.workflow.kind!==_a.Join||-1!==e.inputTypes.indexOf(n.workflow.collectionScopeType))for(const t of n.workflow.outputTypes)-1===e.outputTypes.indexOf(t)&&e.outputTypes.push(t)}else this.compressDownstreamWorkflows(e,n)}addWorkflowAsDependency(e){for(const t of this.graphNodeByLocationAndWorkflowId.values())for(const n of t.values()){for(const t of n.workflow.inputTypes)-1!==e.workflow.outputTypes.indexOf(t)&&this.addWorkflowChain(e,n);for(const t of n.workflow.outputTypes)-1!==e.workflow.inputTypes.indexOf(t)&&this.addWorkflowChain(n,e)}}addWorkflowChain(e,t){e.downstreamWorkflows.add(t),t.upstreamWorkflows.add(e)}}class Lr{constructor(e,t){this.isActivated=!0,this.upstreamWorkflows=new Set,this.downstreamWorkflows=new Set,this.location=t,this.workflow=Object.assign(Object.assign({},e),{inputTypes:Array.isArray(e.inputTypes)?e.inputTypes:[],outputTypes:Array.isArray(e.outputTypes)?e.outputTypes:[]})}}class kr{constructor(){this.listeners=new Map,this.lastId=0}addListener(e){if(!e)throw new Error("No callback provided for data listener");return this.listeners.set(this.lastId,e),this.lastId++}removeListener(e){this.listeners.delete(e)}notifyListeners(e){this.listeners.forEach(t=>{t(e)})}}!function(e){e.Add="Add",e.Remove="Remove",e.Set="Set",e.Delete="Delete"}(Er||(Er={}));class Mr{static applyECSPatchOperation(e,t){let n=!1;if("object"==typeof t||Array.isArray(t))switch(e.operation){case Er.Add:case Er.Remove:n=Mr.applyAddOrRemoveOperation(e.path,t,e.value,e.operation);break;case Er.Set:n=Mr.applySetOperation(e.path,t,e.value);break;case Er.Delete:n=Mr.applyDeleteOperation(e.path,t,e.value)}return n?Bn.verbose(505956121,aa.CoreDefault,`PATCH operation succeeded for ${e.operation} on ${e.settingName} with path: ${e.path}.`):Bn.error(505956122,aa.CoreDefault,`PATCH operation failed for ${e.operation} on ${e.settingName} with path: ${e.path}`),n}static applyAddOrRemoveOperation(e,t,n,a){let i=!1;try{let r=[];if("object"!=typeof t||Array.isArray(t)?Array.isArray(t)&&(r=t):r=e.reduce((e,t)=>e&&e[t],t),Array.isArray(r))if(a===Er.Add)r.push(n),i=!0;else if(a===Er.Remove){const e=r.indexOf(n);e>=0&&(r.splice(e,1),i=!0)}}catch(e){Bn.info(505968832,aa.CoreDefault,`Exception thrown while applying operation type: ${a} for an array. Error: ${e}`),i=!1}return i}static applySetOperation(e,t,n){let a=!1;try{const i=e.slice(0,-1),r=e[e.length-1];let o={};"object"!=typeof t||Array.isArray(t)||(o=i.reduce((e,t)=>e&&e[t],t),"object"!=typeof o||Array.isArray(o)||(o[r]=n,a=!0))}catch(e){Bn.info(505968802,aa.CoreDefault,`Exception thrown while applying set operation. Error: ${e}`),a=!1}return a}static applyDeleteOperation(e,t,n){let a=!1;try{let i={};"object"!=typeof t||Array.isArray(t)||(i=e.reduce((e,t)=>e&&e[t],t),"object"!=typeof i||Array.isArray(i)||"string"!=typeof n||i.hasOwnProperty(n)&&(delete i[n],a=!0))}catch(e){Bn.info(505968801,aa.CoreDefault,`Exception thrown while applying delete operation. Error: ${e}`),a=!1}return a}}wr=Mr,Mr.parseECSOperation=(e,t)=>{if(!t.hasOwnProperty("operationType")||!t.hasOwnProperty("path")||!t.hasOwnProperty("value"))throw new Error(`Invalid format for PATCH operation on setting: ${e}`);const n=t.operationType.toLowerCase(),a=wr.convertToConfigPatchOperationType(n);return{settingName:e,path:t.path?t.path.split("."):[],operation:a,value:t.value}},Mr.convertToConfigPatchOperationType=e=>{switch(e){case"add":return Er.Add;case"remove":return Er.Remove;case"set":return Er.Set;case"delete":return Er.Delete;default:throw new Error(`Invalid operation type: ${e}`)}};var Pr=function(e,t,n,a){return new(n||(n=Promise))(function(i,r){function o(e){try{c(a.next(e))}catch(e){r(e)}}function s(e){try{c(a.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,s)}c((a=a.apply(e,t||[])).next())})};class Tr extends kr{constructor(e){super(),this.name=e}static initEcsSettingsProvider(e){Bn.info(505999498,aa.CoreDefault,"Initializing ECS settings provider."),Tr.ecsSettingsProvider=e}static enableEcsPatchConfig(e){Tr.ecsPatchConfigEnabled=e}static getInstance(e){let t=this.allSettings.get(e);if(!t){t=new Tr(e);const n=Tr.tryGetConfigProperty(Tr.currentConfig,e);n.success&&t.updateValue(n.value),this.allSettings.set(e,t)}return t}static getPatternInstance(e){let t=this.allPatternSettings.get(e);if(!t){t={regex:new RegExp(e),setting:new Tr(e)};const n=Tr.tryGetConfigPropertyByPattern(Tr.currentConfig,t.regex);t.setting.updateValue(n),this.allPatternSettings.set(e,t)}return t.setting}static setNewConfig(e){Tr.currentConfig=e,Bn.info(572837966,aa.CoreDefault,`New config: ${JSON.stringify(e)}`),Tr.allSettings.forEach((e,t)=>{const n=Tr.tryGetConfigProperty(Tr.currentConfig,t).value;e.updateValue(n)&&(Bn.info(572837967,aa.CoreDefault,`Setting new value for ${t}: ${n instanceof Object?JSON.stringify(n):n}`),e.notifyListeners(n))}),Tr.allPatternSettings.forEach((t,n)=>{const a=Tr.tryGetConfigPropertyByPattern(e,t.regex);t.setting.updateValue(a)&&(Bn.info(508432774,aa.CoreDefault,`Setting new value for pattern ${n}: ${JSON.stringify(a)}`),t.setting.notifyListeners(a))})}static tryGetConfigProperty(e,t){return e&&e.hasOwnProperty(t)?{success:!0,value:Tr.selectApplicableValue(e[t])}:{success:!1,value:void 0}}static tryGetConfigPropertyByPattern(e,t){const n=[];if(e){const a=Object.getOwnPropertyNames(e).filter(e=>t.test(e));for(const t of a)n.push({name:t,value:Tr.selectApplicableValue(e[t])})}return n}static setGlobalFilter(e){Tr.globalFilter=e}static setLocalConfig(e){Tr.localConfig=e,Bn.info(506053841,aa.CoreDefault,`Setting localConfig field in Setting class: ${JSON.stringify(Tr.localConfig)}`)}static clear(){Tr.currentConfig=void 0,Tr.localConfig=void 0,Tr.allSettings.clear(),Tr.allPatternSettings.clear(),Tr.ecsSettingsProvider=void 0}static selectApplicableValue(e){let t;if(e){const n=e.find(e=>!Tr.globalFilter||Tr.globalFilter(e));n&&(t=n.value)}return t}getName(){return this.name}getValue(){if(function(){var e;return void 0!==globalThis.process&&"true"===(null===(e=globalThis.process.env)||void 0===e?void 0:e.VALIDATE_CORRECT_USAGE_OF_GET_VALUE)}()&&0===this.listeners.size){const e=new Error(`SettingInstance or ChangeGate is being used incorrectly. Make sure .getValue() or ChangeGate is called during runtime or there is a listener set up on the setting. For more info visit: ${Tr.troubleshootUrl}`);throw e.name="Incorrect usage of getValue()",e}return this.value}getValueAdvancedAsync(e){return Pr(this,void 0,void 0,function*(){const t=new yn({operationName:"ECSGetValueAsync"},{metricDuration:!0}).start();let n;try{const a=yield Tr.ecsSettingsProvider.getSettingValue(this.name,e);t.dimension0=a.userAuthenticated?"Authenticated":"Anonymous",t.success=!0;let i=a.value,r=a.ecsSection;return i||(i=Tr.tryGetConfigProperty(Tr.localConfig,this.name).value,i&&a.patchValue&&(i=Tr.applyPatchOperationOnSetting(this.name,i,a.patchValue),r=a.ecsPatchSection)),n=`Setting value for ${this.name} is ${JSON.stringify(i)}.\n Config IDs: ${JSON.stringify(r)}.`,i}catch(e){Bn.error(505226379,aa.CoreDefault,`Exception thrown while getting setting value for ${this.name}. Error: ${e}\n Error stack trace: ${e.stack}`),t.success=!1;const a=Tr.tryGetConfigProperty(Tr.localConfig,this.name).value;return n=`Setting value for ${this.name} is ${JSON.stringify(a)}.`,a}finally{Bn.info(506053839,aa.CoreDefault,t.stop()),Bn.info(505821320,aa.CoreDefault,n)}})}updateValue(e){return!pr()(this.value,e)&&(Bn.info(572837968,aa.CoreDefault,`Received new property value for ${this.getName()}:`,e),this.value=e,!0)}static applyPatchOperationsOnConfig(e){try{if(!Tr.ecsPatchConfigEnabled)return e;const t=this.tryGetConfigProperty(e,"patchOperations").value;if(!t||0===t.length)return e;const n=[];for(const[e,a]of Object.entries(t))try{n.push(Mr.parseECSOperation(e,a))}catch(t){Bn.error(505734922,aa.CoreDefault,`Exception thrown while parsing ECS PATCH operation for setting: ${e}. Error: ${t}`);continue}const a=new Map;for(const t of n)if(null==e?void 0:e.hasOwnProperty(t.settingName)){const n=JSON.parse(JSON.stringify(e[t.settingName])),i=Tr.selectApplicableValue(n);Mr.applyECSPatchOperation(t,i)&&(a.set(t.settingName,i),e[t.settingName]=n)}if(a.size>0){const e={};a.forEach((t,n)=>{e[n]=t}),Bn.info(505788322,aa.CoreDefault,`Resulting settings after PATCHes were applied: ${JSON.stringify(e)}`)}return e}catch(t){return Bn.error(505788321,aa.CoreDefault,`Exception thrown while applying ECS PATCH operations. Error: ${t}`),e}}static applyPatchOperationOnSetting(e,t,n){try{if(!Tr.ecsPatchConfigEnabled)return t;const a=JSON.parse(JSON.stringify(t)),i=n,r=Mr.parseECSOperation(e,i);return Mr.applyECSPatchOperation(r,a),a}catch(e){return Bn.error(505788323,aa.CoreDefault,`Exception thrown while applying ECS PATCH operation on setting. Error: ${e}`),t}}}Tr.allSettings=new Map,Tr.allPatternSettings=new Map,Tr.ecsPatchConfigEnabled=!1,Tr.troubleshootUrl="https://eng.ms/docs/experiences-devices/opg/office-ai/augloop-ai-platform/augmentation-loop/documentation/server-workflow-tutorials/settings/troubleshoot";class Ur extends kr{constructor(e,t){super(),this.listenerId=NaN,this.defaultValue=t,this.setting=Tr.getInstance(e)}getDefaultValue(){return this.defaultValue}addListener(e){return Number.isNaN(this.listenerId)&&(this.listenerId=this.setting.addListener(()=>{this.notifyListeners(this.getValue())})),super.addListener(e)}removeListener(e){super.removeListener(e),0!==this.listeners.size||Number.isNaN(this.listenerId)||(this.setting.removeListener(this.listenerId),this.listenerId=NaN)}getValue(){const e=this.setting.getValue();return void 0===e?this.defaultValue:e}getValueAdvancedAsync(e){return Pr(this,void 0,void 0,function*(){const t=yield this.setting.getValueAdvancedAsync(e);return void 0===t?this.defaultValue:t})}}new Ur("enableRichContentApis",!1);const Fr=e=>({id:e.id,kind:e.kind,visibility:e.visibility,collectionScopeType:e.collectionScopeType,inputTypes:e.inputTypes,outputTypes:e.outputTypes,correlatedSignals:e.correlatedSignals}),Hr=(e,t)=>null!=e&&null!=t&&e.length>0&&(e===t||0===t.indexOf(e)&&"."===t.charAt(e.length));class Rr{constructor(){this.workflowDefByWorkflowAndContextId=new Map,this.workflowDefByWorkflow=new Map}static mergeDefinitions(e,t,n){return Object.assign(Object.assign(Object.assign({},e),t),n)}mergeWorkflowDefinition(e,t,n){if(n){const a=((e,t,n)=>{let a=e.get(t);return a||(a=new Map,e.set(t,a)),a})(this.workflowDefByWorkflowAndContextId,e.id);a.set(n,Rr.mergeDefinitions(e,a.get(n),t))}else this.workflowDefByWorkflow.set(e.id,Rr.mergeDefinitions(e,this.workflowDefByWorkflow.get(e.id),t))}getWorkflowDefinition(e,t){var n;let a;return t&&(a=null===(n=this.workflowDefByWorkflowAndContextId.get(e.id))||void 0===n?void 0:n.get(t)),a||(a=this.workflowDefByWorkflow.get(e.id)),a||(a=e),a}deleteWorkflowDefinition(e,t){const n=this.workflowDefByWorkflowAndContextId.get(e.id);n&&(n.delete(t),0===n.size&&this.workflowDefByWorkflowAndContextId.delete(e.id))}}var Nr;!function(e){e.JsClient="C",e.Server="S"}(Nr||(Nr={}));const Br=new Set([f.getTypeName(),_.getTypeName(),x.getTypeName(),D.getTypeName()]);class jr{constructor(e,t){this.nextId=1,this.runtimeKind=e,this.workflowGraph=t}static isParentContextId(e,t){return Hr(e,t)}applyContextIdOnOperations(t){for(const n of t){const t=e.getTypeNameFor(n);if(this.isSupportedOperation(t))for(const e of n.items)e.contextId?e.source&&this.workflowGraph.getWorkflow(e.source,!1)?e.contextId=this.addNewContextId(e.contextId):this.tryLogMessage(new yn({operationName:"ApplyContextIdOnOperations",success:!0}).start(),"Item with a contextId but without a workflow source atribute"):e.contextId=this.addNewContextId()}}addNewContextId(e){const t=`${this.runtimeKind}${this.nextId++}`;return e?`${e}.${t}`:t}isSupportedOperation(e){return Br.has(e)}tryLogMessage(e,t,n=!0){e&&(e.success=n,e.resultDescription=t,Bn.verbose(527308633,aa.CoreDefault,e.stop()))}}var Vr;!function(e){e[e.Idle=1]="Idle",e[e.Pending=2]="Pending",e[e.Running=3]="Running",e[e.Executed=4]="Executed"}(Vr||(Vr={}));const zr=(e,t)=>Object.assign(Object.assign({},t),{parentPath:e}),Gr=e=>Array.isArray(e)?5===e.length?`${e[0]}\\${e[1]}\\${e[2]}\\${e[3]}\\${e[4]}`:4===e.length?`${e[0]}\\${e[1]}\\${e[2]}\\${e[3]}`:3===e.length?`${e[0]}\\${e[1]}\\${e[2]}`:2===e.length?`${e[0]}\\${e[1]}`:1===e.length?e[0]:e.join("\\"):"(malformed path)";class Kr{constructor(e){this.scopeItemsByContextId=new Map,this.itemsByWorkflowAndContextId=new Map,this.workflowDefinitionManager=e}setScopeItem(e,t){var n;const a=e.contextId;if(a)if(this.itemsByWorkflowAndContextId.has(t.id)||this.itemsByWorkflowAndContextId.set(t.id,new Map),this.itemsByWorkflowAndContextId.get(t.id).set(a,[]),this.scopeItemsByContextId.has(a)){if(null===(n=this.itemsByWorkflowAndContextId.get(t.id))||void 0===n?void 0:n.has(a)){const n=new yn({resultDescription:`Trying to set new scope item: ${e.id} with already existing contextId ${a} for workflow ${t.id}`,operationName:"WIS.setScopeItem",resourceId:t.id,success:!0}).start();Bn.verbose(527291288,aa.CoreDefault,n.stop())}}else this.scopeItemsByContextId.set(a,e)}updateScopeItemPath(e,t,n){var a,i;if(!e)return;const r=this.scopeItemsByContextId.get(e);if(!r)return;const o=r.parentPath;this.scopeItemsByContextId.set(e,zr(t,r));const s=null!==(i=null===(a=this.itemsByWorkflowAndContextId.get(n.id))||void 0===a?void 0:a.get(e))&&void 0!==i?i:[];for(let e=0;e<s.length;e++)s[e]=zr([...t,...s[e].parentPath.slice(0,o.length)],s[e])}getScopeItem(e,t){var n;for(const a of(null===(n=this.itemsByWorkflowAndContextId.get(t.id))||void 0===n?void 0:n.keys())||[])if(Hr(a,e))return this.scopeItemsByContextId.get(a)}addItemToWorkflowList(e,t){const n=e.contextId;if(!n)return;const a=this.itemsByWorkflowAndContextId.get(t.id);if(a)for(const[i,r]of a)if(Hr(i,n)){r.push(e);const n=new yn({resultDescription:`Items for contextId ${i}: [${r.map(e=>e.id).join(",")}]`,operationName:"WIS.addItemOnContextIdList",resourceId:t.id,success:!0}).start();Bn.info(526403808,aa.CoreDefault,n.stop())}}isWorkflowReady(e,t){const n=this.workflowDefinitionManager.getWorkflowDefinition(t,e).maxAnnotations;return this.getGeneratedItems(e,t).length>=n}getItemsToExecute(e,t){const n=this.getGeneratedItems(e,t);return this.itemsByWorkflowAndContextId.get(t.id).delete(e),n}onWorkflowExecuted(e,t){const n=e.contextId,a=this.itemsByWorkflowAndContextId.get(t.id);a&&(a.delete(n),0===a.size&&this.itemsByWorkflowAndContextId.delete(t.id)),this.hasWorkflowsAwaitingExecution(n)||this.scopeItemsByContextId.delete(n)}getGeneratedItems(e,t){var n;if(!(null===(n=this.itemsByWorkflowAndContextId.get(t.id))||void 0===n?void 0:n.get(e)))return[];const a=this.workflowDefinitionManager.getWorkflowDefinition(t,e).maxAnnotations;return this.itemsByWorkflowAndContextId.get(t.id).get(e).slice(0,a)}hasWorkflowsAwaitingExecution(e){for(const t of this.itemsByWorkflowAndContextId.values())for(const n of t.keys())if(n===e)return!0;return!1}}var Wr,qr,Qr,Yr,Jr,Xr,Zr,$r,eo,to;!function(e){e[e.Unknown=0]="Unknown",e[e.LiveId=1]="LiveId",e[e.OrgId=2]="OrgId",e[e.ActiveDirectory=3]="ActiveDirectory",e[e.ADAL=4]="ADAL",e[e.SSPI=5]="SSPI",e[e.OAuth2=6]="OAuth2",e[e.Badger=7]="Badger"}(Wr||(Wr={})),function(e){e[e.Augloop=0]="Augloop",e[e.Substrate=1]="Substrate"}(qr||(qr={})),function(e){e[e.Unknown=0]="Unknown",e[e.TokenMissingInteractionRequired=1]="TokenMissingInteractionRequired"}(Qr||(Qr={})),function(e){e[e.ServerError=0]="ServerError",e[e.WorkflowDisabled=100]="WorkflowDisabled",e[e.TokenNotReady=101]="TokenNotReady",e[e.FlightNotReady=102]="FlightNotReady",e[e.ContextNotReady=103]="ContextNotReady",e[e.WorkflowExcluded=104]="WorkflowExcluded",e[e.WorkflowExecutionTimeout=105]="WorkflowExecutionTimeout",e[e.LambdaExecutionError=106]="LambdaExecutionError",e[e.UnexpectedOutput=107]="UnexpectedOutput",e[e.FailedToFetchInputs=108]="FailedToFetchInputs",e[e.FailedToFetchRequestedContexts=109]="FailedToFetchRequestedContexts"}(Yr||(Yr={})),function(e){e[e.Unknown=0]="Unknown",e[e.InvalidRequest=1]="InvalidRequest",e[e.InvalidResponse=2]="InvalidResponse",e[e.RuntimeNotInitialized=3]="RuntimeNotInitialized",e[e.RequestCancelled=4]="RequestCancelled",e[e.ResponseReceivedAfterFinalResponse=5]="ResponseReceivedAfterFinalResponse"}(Jr||(Jr={})),function(e){e[e.Unknown=0]="Unknown",e[e.Found=302]="Found",e[e.BadRequest=400]="BadRequest",e[e.Unauthorized=401]="Unauthorized",e[e.Forbidden=403]="Forbidden",e[e.NotFound=404]="NotFound",e[e.RequestTimeout=408]="RequestTimeout",e[e.Conflict=409]="Conflict",e[e.Gone=410]="Gone",e[e.RequestEntityTooLarge=413]="RequestEntityTooLarge",e[e.UnsupportedMediaType=415]="UnsupportedMediaType",e[e.UnprocessableContent=422]="UnprocessableContent",e[e.TooManyRequests=429]="TooManyRequests",e[e.SocketDisconnect=499]="SocketDisconnect",e[e.InternalServerError=500]="InternalServerError",e[e.ServiceUnavailable=503]="ServiceUnavailable",e[e.GatewayTimeout=504]="GatewayTimeout",e[e.UnsupportedMessage=1e3]="UnsupportedMessage",e[e.Cancelled=1001]="Cancelled",e[e.EgressError=1002]="EgressError",e[e.SyncMessageException=2e3]="SyncMessageException",e[e.SyncMessageUnsupported=2001]="SyncMessageUnsupported",e[e.SyncMessageUnexpectedSeed=2002]="SyncMessageUnexpectedSeed",e[e.SyncMessageUnsupportedBatch=2003]="SyncMessageUnsupportedBatch",e[e.SyncMessageQueueFull=2004]="SyncMessageQueueFull",e[e.SyncMessageTooLateOrDuplicate=2005]="SyncMessageTooLateOrDuplicate",e[e.SyncMessageGroupIdMismatch=2006]="SyncMessageGroupIdMismatch",e[e.SyncMessageGroupStop=2007]="SyncMessageGroupStop",e[e.SyncMessageLost=2008]="SyncMessageLost",e[e.SyncMessageUnprocessedDuplicate=2009]="SyncMessageUnprocessedDuplicate",e[e.SyncMessageSessionClosed=2010]="SyncMessageSessionClosed",e[e.SyncMessageAbandoned=2011]="SyncMessageAbandoned",e[e.SyncMessageTooManyDeltaOperations=2012]="SyncMessageTooManyDeltaOperations",e[e.SyncMessageSessionSizeLimitExceeded=2013]="SyncMessageSessionSizeLimitExceeded",e[e.TokenValidationError=2100]="TokenValidationError",e[e.TokenDecryptError=2101]="TokenDecryptError",e[e.TokenTypeError=2102]="TokenTypeError",e[e.TokenUserBlocked=2103]="TokenUserBlocked",e[e.AnnotationActivationInvalidType=2200]="AnnotationActivationInvalidType",e[e.AnnotationReleaseTokenNotFound=2300]="AnnotationReleaseTokenNotFound"}(Xr||(Xr={})),function(e){e[e.UnKnown=0]="UnKnown",e[e.Start=1]="Start",e[e.Regular=2]="Regular",e[e.CheckConnection=3]="CheckConnection",e[e.PostEgress=4]="PostEgress",e[e.TimeoutResend=5]="TimeoutResend",e[e.FailResend=6]="FailResend"}(Zr||(Zr={})),function(e){e[e.IdentityChange=0]="IdentityChange"}($r||($r={})),function(e){e[e.Idle=0]="Idle",e[e.Pending=1]="Pending"}(eo||(eo={})),function(e){e[e.NotStarted=0]="NotStarted",e[e.Started=1]="Started",e[e.Incomplete=2]="Incomplete",e[e.Finished=3]="Finished"}(to||(to={}));var no,ao,io,ro={util:{},roots:{default:{}}},oo=(ro.util,ro.roots.default||(ro.roots.default={}),function(){function e(e){if(e)for(var t in e)null!=e[t]&&(this[t]=e[t])}return e.prototype.cv="",e.prototype.serviceName="",e.prototype.sessionKey="",e.prototype.traceId="",e.prototype.clientAppName="",e.prototype.clientAppPlatform="",e.prototype.clientRuntimeVersion="",e.prototype.clientAppVersion="",e.prototype.clientReleaseAudienceGroup="",e.prototype.clientReleaseChannel="",e.prototype.clientReleaseFork="",e.prototype.clientSessionId="",e.prototype.clientFlights="",e.prototype.clientIPRange="",e.prototype.clientDocSessionId="",e.prototype.clientUserAgent="",e.prototype.userType="",e.prototype.userId="",e.prototype.userTenantId="",e.prototype.sessionHealthEventName="",e.prototype.source="",e.prototype.reason="",e.prototype.reasonDependency="",e.prototype.subReason="",e.prototype.impact="",e.prototype.success=!1,e.prototype.durationMs=0,e.prototype.count=0,e.prototype.message="",e.prototype.affectedWorkflows="",e.prototype.resourceId="",e.prototype.dimension0="",e.prototype.dimension1="",e.prototype.dimension2="",e.prototype.dimension3="",e.prototype.resultDescription="",e.prototype.resultSignature="",e.prototype.joinContextId="",e.prototype.userDataBoundaryType="",e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/SessionHealthEvent"},e}());!function(e){e[e.Unknown=0]="Unknown",e[e.Core=1]="Core",e[e.Workflow=2]="Workflow",e[e.SessionExtension=3]="SessionExtension",e[e.Client=4]="Client",e[e.ClientRuntime=5]="ClientRuntime"}(no||(no={})),function(e){e[e.Unknown=0]="Unknown",e[e.Core=1]="Core",e[e.Workflow=2]="Workflow",e[e.SessionExtension=3]="SessionExtension",e[e.Client=4]="Client",e[e.Network=5]="Network",e[e.AugLoopDependency=6]="AugLoopDependency",e[e.WorkflowDependency=7]="WorkflowDependency",e[e.ClientRuntime=8]="ClientRuntime"}(ao||(ao={})),function(e){e[e.Unknown=0]="Unknown",e[e.None=1]="None",e[e.MissingInput=2]="MissingInput",e[e.MissingOutput=3]="MissingOutput"}(io||(io={}));class so extends oo{constructor(e,t){var n,a;super({source:no[e.source],reason:ao[e.reason],reasonDependency:e.reasonDependency,subReason:e.subReason,sessionHealthEventName:e.sessionHealthEventName,impact:io[e.impact],success:e.success,durationMs:null!==(n=e.durationMs)&&void 0!==n?n:0,count:"number"==typeof e.count?e.count:1,message:e.message,affectedWorkflows:(null!==(a=e.affectedWorkflows)&&void 0!==a?a:[]).join(","),resourceId:e.resourceId,dimension0:e.dimension0,dimension1:e.dimension1,dimension2:e.dimension2,dimension3:e.dimension3,cv:e.cv,resultSignature:e.resultSignature,resultDescription:e.resultDescription,joinContextId:e.joinContextId}),this.eventName="SessionHealth",this.aggregationEnabled=!1,t&&this.setClientMetadata(t),this.metricCount=e.metricCount,this.metricDuration=e.metricDuration}getMetrics(){const e={};return(void 0===this.metricCount||this.metricCount)&&(e[`${this.sessionHealthEventName}.CountV2`]={dimensionNames:()=>so.dimensionNames,dimensionValues:this.getDimensionValues(),value:this.count}),(void 0===this.metricDuration||this.metricDuration)&&(e[`${this.sessionHealthEventName}.DurationMsV2`]={dimensionNames:()=>so.dimensionNames,dimensionValues:this.getDimensionValues(),value:this.durationMs}),e}setClientMetadata(e){return e&&(this.clientAppName=e.appName,this.clientAppPlatform=e.appPlatform,this.clientAppVersion=e.appVersion,this.clientFlights=e.flights,this.clientReleaseAudienceGroup=e.releaseAudienceGroup,this.clientReleaseChannel=e.releaseChannel,this.clientReleaseFork=e.releaseFork,this.clientRuntimeVersion=e.runtimeVersion,this.clientSessionId=e.sessionId,this.clientDocSessionId=e.docSessionId,this.clientUserAgent=e.userAgent),this}setUserContext(e){return e&&(this.userId=e.puid||e.oid,this.userType=e.userType&&e.userType.toString(),this.userTenantId=e.tid),this}setReason(e){return this.reason=ao[e],this}setSource(e){return this.source=no[e],this}setImpact(e){return this.impact=io[e],this}setAffectedWorkflows(e){return this.affectedWorkflows=(null!=e?e:[]).join(","),this}getAffectedWorkflows(){return this.affectedWorkflows.split(",")}enableAggregation(){return this.aggregationEnabled=!0,this}shouldBeAggregated(){return this.aggregationEnabled}start(){return this.startTime=hn(),this}stop(){const e=hn();return this.durationMs=Math.round(e-this.startTime),this}getDimensionValues(){var e;return[this.clientAppName,this.clientAppPlatform,this.clientAppVersion,this.success?"1":"0",`${this.reason}_${this.reasonDependency}`,this.impact,null!==(e=this.getAffectedWorkflows()[0])&&void 0!==e?e:"",this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}}so.dimensionNames=["ClientAppName","ClientAppPlatform","ClientAppVersion","Success","Reason","Impact","FirstAffectedWorkflow","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"];const co=new Ur("disabledChangeGates",[]),lo=(e,t,...n)=>{const a=-1===co.getValue().indexOf(e);return t?a?t(...n):void 0:a};class uo{constructor(e){if(this.cache=new Map,this.options=e||{sweepInterval:100},null!=this.options.idleDurationMs&&this.options.idleDurationMs<=0)throw new Error("Idle duration must be positive");if(this.interval=this.options.sweepInterval||100,this.interval<=0)throw new Error("Sweep interval must be a positive number")}static setLogIntervalError(e){uo.logIntervalError=e}put(e,t,n,a,i,r,o){if(null==n||n<=0)throw new Error("Cache timeout must be a positive number");(null==i||i<=0)&&(i=this.options.idleDurationMs);const s={value:t,lastUsed:i?Date.now():void 0,expire:n+Date.now(),idleDurationMs:i,expireCallback:a,expiringTriggerTime:r+Date.now(),expiringCallback:o};return this.cache.set(e,s),this.timeout||(this.timeout=setInterval(this.onInterval.bind(this),this.interval),this.timeout.unref&&this.timeout.unref()),t}del(e){if(this.options.delCallback){const t=this.cache.get(e);t&&this.options.delCallback(e,t.value)}const t=this.cache.delete(e);return 0===this.size()&&this.clear(),t}clear(){this.timeout&&(clearInterval(this.timeout),this.timeout=void 0),this.cache.clear()}get(e){let t=this.cache.get(e);if(t){if(this.options.idleDurationMs&&(t.lastUsed=Date.now()),t.expire<Date.now()&&(this.del(e),t.expireCallback&&t.expireCallback(e,t.value),t=this.cache.get(e),!t))return;return t.value}}keys(){return this.cache.keys()}forEach(e){this.cache.forEach((t,n)=>{e(t.value,n)})}size(){return this.cache.size}updateExpireTime(e,t){return!!(this.cache.has(e)&&t>=0)&&(this.cache.get(e).expire=t+Date.now(),!0)}onInterval(){const e=Date.now();this.cache.forEach((t,n)=>{try{if(t.idleDurationMs&&t.lastUsed<e-t.idleDurationMs)return this.del(n),void(this.options.idleCallback&&this.options.idleCallback(n,t.value));t.expire<e&&(this.del(n),t.expireCallback&&t.expireCallback(n,t.value)),t.expiringTriggerTime<e&&t.expiringCallback&&(t.expiringCallback(n,t.value),t.expiringCallback=void 0)}catch(e){uo.logIntervalError&&uo.logIntervalError(e)}})}}const fo=new Ur("processAndRejectMessageEndpointValidation",!1);var po,mo,_o,ho;function bo(e){const t=["AugLoop_Excel_Session_Protocol_","AugLoop_Powerpoint_Session_Protocol_","AugLoop_Session_Protocol_"];let n;for(const a of t)if(0===e.indexOf(a)){n=a;break}if(!n)return"MalformedMessageName";const a="Message",i=e.indexOf(a,e.length-a.length)===e.length-a.length;return e.slice(n.length,i?-a.length:void 0)}!function(e){e.ClientDisconnected="Client disconnected.",e.ClientClosed="Client closed",e.UnsupportedSyncMessage="SyncMessages with seq = -1 are not supported anymore.",e.UnexpectedSeedMessage="Unexpected seed message",e.SyncMessageUnsupportedBatch="SyncMessage with unsupported batching.",e.AnnotationTokenNotFound="Token not found",e.TooManyDeltaOperations="SyncMessage with too many delta operations",e.UnsupportedSyncMessageSeq0NonSeeding="SyncMessages with seq 0 are not supported in non seeding sequencer (SenderId)."}(po||(po={})),function(e){e.ProvisionTokenValidationError="Token provision message didn't pass token validation.",e.ProvisionTokenDecryptAndTransformError="Token provision message didn't pass token decrypt and transform."}(mo||(mo={}));class go{constructor(e){this.config=e,this.nextMessageId=1,this.pendingResponseCallbacks=new uo({sweepInterval:5e3}),this.messageCallbacks=new Map,this.messageValidators=new Map,this.messageIdPrefix=e.messageIdPrefix,this.source="c"===e.messageIdPrefix?no.ClientRuntime:no.Core,this.stats={sendMessageCount:0,sendMessageClientDisconnectedErrors:0,sendMessageErrors:0,sendMessageDurationMsMax:0,processMessageCount:0,processMessageProvisionTokenErrors:0,processMessageErrors:0,processMessageDurationMsMax:0}}setClientMetadata(e){this.clientMetadata=e}setEgress(e){this.egress=e,this.config.resendPendingMessagesOnReconnect&&this.egress&&this.pendingResponseCallbacks.forEach((e,t)=>{e.logOp.dimension1=(e.sendCount++).toString(),this.egress(e.message,t=>this.onEgressError(t,e))})}ingress(e,t){Ya.typeGuard(e)?(this.processResponse(e),t()):this.processMessage(e,t),li.typeGuard(e)&&!e.reconnectAllowed&&this.clearAllPendingResponses()}sendMessage(t,n,a,i=0){var r,o;const s=new so({sessionHealthEventName:"SendMessage",source:this.source,reason:ao.Client,impact:this.source===no.ClientRuntime?io.MissingInput:io.MissingOutput,success:!0,message:"",affectedWorkflows:["All"],cv:t.cv,resourceId:bo(e.getTypeNameFor(t)),dimension0:i.toString()}).start().enableAggregation(),c=()=>{if(s.setClientMetadata(this.clientMetadata),s.success)Bn.info(572836e3,aa.CoreDefault,s.stop());else{const e="ErrorWithoutPendingResponse"===s.resultSignature||"ResponseCallbackException"===s.resultSignature||"We called into done callback"!==s.message;s.message=JSON.stringify({errorNotPropagatedToDoneCallback:e}),Bn.error(572836001,aa.CoreDefault,s.stop())}};lo("PersistMessageId")?t.messageId=null!==(r=t.messageId)&&void 0!==r?r:`${this.messageIdPrefix}${this.nextMessageId++}`:t.messageId=`${this.messageIdPrefix}${this.nextMessageId++}`,yi.typeGuard(t)&&t.messages.forEach((e,n)=>e.messageId=t.messageId+"."+n);const d=e.getTypeNameFor(t)===li.getTypeName(),l={message:t,logOp:s,logEvent:c,callback:void 0,sendCount:1};if(!a&&!d){l.callback=(a,i)=>{var r;if(a?lo("IgnoreUnsupportedMessageErrorForOldClientVersion")&&a.code===Xr.UnsupportedMessage?(s.resultSignature="Success",s.resultDescription=`Ignore error for ${e.getTypeNameFor(t)} message ${t.messageId}${Si.typeGuard(t)?`, seq ${t.seq}`:""}: ${a.error}`):(s.success=!1,s.resultSignature=a.error,s.resultDescription=`Error for ${e.getTypeNameFor(t)} message ${t.messageId}${Si.typeGuard(t)?`, seq ${t.seq}`:""}: ${a.error}`):s.resultSignature="Success",n)try{s.message="We called into done callback",n(a,i)}catch(e){s.success=!1,s.resultSignature="ResponseCallbackException",s.resultDescription="Web"===(null===(r=this.clientMetadata)||void 0===r?void 0:r.appPlatform)?JSON.stringify({message:e.message,stack:e.stack}):JSON.stringify({message:e.message})}c(),this.updateSendMessageStats(s.success,s.durationMs,a?new Error(a.error):void 0)};const a=()=>{l.callback(new ni({code:Xr.RequestTimeout,error:"Timeout waiting for response"}),void 0)};let i=this.config.responseTimeoutMs;if(oi.typeGuard(t)){const e=t;i=e.longPollTimeoutHint>=15e3&&e.longPollTimeoutHint<=3e5?e.longPollTimeoutHint+5e3:12e4}else Xa.typeGuard(t)&&(i=null!==(o=t.maxDelayMs)&&void 0!==o?o:12e4);this.pendingResponseCallbacks.put(t.messageId,l,i,a)}this.egress&&this.egress(t,e=>this.onEgressError(e,l),i)}onEgressError(t,n){var a,i;if(t){const r=n.message,o=this.pendingResponseCallbacks.get(n.message.messageId);o?(this.pendingResponseCallbacks.del(r.messageId),o.callback(new ti({messageId:r.messageId,code:Xr.EgressError,error:t.message}))):li.typeGuard(r)?(n.logOp.success=null!==(i=null===(a=t.message)||void 0===a?void 0:a.endsWith("Client disconnected."))&&void 0!==i&&i,n.logOp.resultSignature="ErrorSendingSessionCloseMessage",n.logOp.resultDescription=`Error for ${e.getTypeNameFor(r)} message ${r.messageId}: ${t.message}`,n.logEvent()):(n.logOp.success=!1,n.logOp.resultSignature="ErrorWithoutPendingResponse",n.logOp.resultDescription=`Error for ${e.getTypeNameFor(r)} message ${r.messageId}: ${t.message}`,n.logEvent())}}queryEgressCacheSize(){return this.pendingResponseCallbacks.size()}onMessage(e,t,n){this.messageCallbacks.set(e,t),n&&this.messageValidators.set(e,n)}onMessageAsync(e,t,n){this.messageCallbacks.set(e,(e,n)=>{return a=this,void 0,r=function*(){try{const a=yield t(e);ti.typeGuard(a)?n(a,void 0):n(void 0,a)}catch(e){n(e)}},new((i=void 0)||(i=Promise))(function(e,t){function n(e){try{s(r.next(e))}catch(e){t(e)}}function o(e){try{s(r.throw(e))}catch(e){t(e)}}function s(t){var a;t.done?e(t.value):(a=t.value,a instanceof i?a:new i(function(e){e(a)})).then(n,o)}s((r=r.apply(a,[])).next())});var a,i,r}),n&&this.messageValidators.set(e,n)}getStats(){return this.stats}hasMessageCallback(e){return this.messageCallbacks.has(e)}cancelPendingResponseCallbacks(e){this.pendingResponseCallbacks.forEach((t,n)=>{t&&(this.pendingResponseCallbacks.del(n),t.callback(new ti({messageId:n,code:Xr.Cancelled,error:`Cancelled. Reason: ${e}`})))})}clearAllPendingResponses(){if(0==this.pendingResponseCallbacks.size())return;const e=new yn({operationName:"PurgePendingResponses",resultDescription:this.pendingResponseCallbacks.size().toString(),success:!0});Bn.info(572836002,aa.CoreDefault,e),this.pendingResponseCallbacks.clear()}processMessage(t,n){var a,i,r,o;const s=new so({sessionHealthEventName:"ProcessMessage",source:this.source,reason:ao.Client,impact:this.source===no.ClientRuntime?io.MissingOutput:io.MissingInput,success:!0,message:"",affectedWorkflows:["All"],cv:t.cv}).start().enableAggregation(),c=()=>{if(s.setClientMetadata(this.clientMetadata),s.success)Bn.info(572836003,aa.CoreDefault,s.stop());else{const e="UnsupportedMessage"===s.resourceId||"Timeout"===s.resultSignature||"OnResponseInvokedMoreThanOnce"===s.resultSignature||"MessageCallbackException"===s.resultSignature||"We called into messageCallback"!==s.message;s.message=JSON.stringify({errorHappenedOutsideRegisteredMessageCallback:e}),Bn.error(572836032,aa.CoreDefault,s.stop())}},d=["*is missing","AnnotationActivationMessage.config: SchemaObjectHeader: Expected object, got undefined object for SchemaObjectHeaderValidator",'MicroSyncMessage.item: Item: Required field "id" is wrong type','SyncMessage.ops: Operation.items: Item: Required field "id" is wrong type'],l=this.messageValidators.get(e.getTypeNameFor(t)),u=(null===(i=null===(a=this.clientMetadata)||void 0===a?void 0:a.userAgent)||void 0===i?void 0:i.startsWith("test-suite"))||(null===(o=null===(r=this.clientMetadata)||void 0===r?void 0:r.userAgent)||void 0===o?void 0:o.startsWith("e2e-test"));let f;if(lo("enableMessageValidation")&&l&&!u){const n=new yn({operationName:"MessageValidationFailure",resourceId:bo(e.getTypeNameFor(t)),success:!1,resultDescription:""},{metricDuration:!0}).start(),a=l.validate(t);n.success=a.success,a.success||(d.some(e=>{if(e.startsWith("*")){const t=e.substring(1);return a.error.includes(t)}return a.error===e})?n.dimension0="ValidationErrorAllowed":(n.dimension0="ValidationErrorNotAllowed",f=`Message type ${e.getTypeNameFor(t)} had a type validation error`),n.resultDescription=a.error,Bn.info(504971855,aa.CoreDefault,n.stop()))}let p=this.messageCallbacks.get(e.getTypeNameFor(t));p?(s.resourceId=bo(e.getTypeNameFor(t)),fo.getValue()&&f&&(Bn.error(504729920,aa.CoreDefault,`Rejecting message ${t.messageId} due to validation error`),p=(e,t)=>{t(new ti({messageId:e.messageId,code:Xr.BadRequest,error:f}))})):p=(t,n)=>{s.resourceId=bo(e.getTypeNameFor(t)),"MalformedMessageName"!==s.resourceId&&(s.resourceId="UnsupportedMessage"),n(new ti({messageId:t.messageId,code:Xr.UnsupportedMessage,error:`Message type ${e.getTypeNameFor(t)} is not supported`}))};const m=(e,t)=>void 0!==t?JSON.stringify({message:e,stack:t}):e;let _=!1;const h=(a,i)=>{if(_){s.success=!1,s.resultSignature="OnResponseInvokedMoreThanOnce";const n=`Invoked onResponse for ${e.getTypeNameFor(t)} message ${t.messageId} more than once`;s.resultDescription=m(n)}else if(a){s.success=!1,s.resultSignature=a.error,void 0!==a.code&&(s.dimension0=Xr[a.code]);const n=`Error for ${e.getTypeNameFor(t)} message ${t.messageId}: ${a.error}`;s.resultDescription=m(n)}else s.resultSignature="Success",s.resultDescription=m("");_=!0,c(),a&&!e.matchesTypesFor(a,[ti.getTypeName()])&&(a=new ti({error:"Internal Server Error"})),this.updateProcessMessageStats(s.success,s.durationMs,a?new Error(a.error):void 0),a?(a.messageId=t.messageId,n(a)):i?(i.messageId=t.messageId,n(void 0,i)):n()};try{s.message="We called into messageCallback",p(t,h)}catch(e){s.success=!1,s.resultSignature="MessageCallbackException",s.resultDescription=m(e.message,e.stack),c(),this.updateProcessMessageStats(!1,s.durationMs,e),n()}}processResponse(t){var n;const a=new yn({operationName:"ProcessResponse"});if(a.success=!0,a.setClientMetadata(this.clientMetadata),a.start(),t.messageId){const n=this.pendingResponseCallbacks.get(t.messageId),i=null==n?void 0:n.callback;if(i){if(Ja.typeGuard(t)&&!t.finalResponse){const e=n.message.maxDelayMs;this.pendingResponseCallbacks.updateExpireTime(t.messageId,e)}else this.pendingResponseCallbacks.del(t.messageId);e.matchesTypesFor(t,[ti.getTypeName()])?i(t):i(void 0,t)}else a.resultSignature="NoPendingMessage",a.resultDescription=`${t.messageId}`,a.success=!1}else a.resultSignature="NoMessageIdSetInResponse",ti.typeGuard(t)?a.resultDescription=t.error:a.resultDescription="MessageId is not available",a.success=!1;"Production"!==(null===(n=this.clientMetadata)||void 0===n?void 0:n.releaseAudienceGroup)&&(a.resourceId=bo(e.getTypeNameFor(t)),Bn.info(572836034,aa.CoreDefault,a.stop()))}updateSendMessageStats(e,t,n){this.stats.sendMessageCount++,this.stats.sendMessageDurationMsMax=Math.max(t,this.stats.sendMessageDurationMsMax),e||n?e&&n&&Bn.warn(572836036,aa.CoreDefault,"Succeeded send message provided error object."):Bn.warn(572836035,aa.CoreDefault,"Failed send message did not provide error object."),e||(n&&n.message===po.ClientDisconnected?this.stats.sendMessageClientDisconnectedErrors++:this.stats.sendMessageErrors++)}updateProcessMessageStats(e,t,n){this.stats.processMessageCount++,this.stats.processMessageDurationMsMax=Math.max(t,this.stats.processMessageDurationMsMax),e||n?e&&n&&Bn.warn(572836038,aa.CoreDefault,"Succeeded process message provided error object."):Bn.warn(572836037,aa.CoreDefault,"Failed process message did not provide error object."),e||(n&&n.message===mo.ProvisionTokenValidationError?this.stats.processMessageProvisionTokenErrors++:this.stats.processMessageErrors++)}}!function(e){e[e.None=0]="None",e[e.HttpsGetDownloadUrl=1]="HttpsGetDownloadUrl",e[e.AlCodedLocation=2]="AlCodedLocation",e[e.Token=3]="Token",e[e.SpeAlCodedLocation=4]="SpeAlCodedLocation"}(_o||(_o={})),function(e){e[e.NewDocument=0]="NewDocument",e[e.EditDocument=1]="EditDocument",e[e.ViewOnlyDocument=2]="ViewOnlyDocument"}(ho||(ho={}));class vo{}vo.lowerIndexBound=1,vo.maxNumberOfRows=1048576,vo.maxNumberOfColumns=16384,vo.firstColumnName="A",vo.lastColumnName="XFD";class yo{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(yo,this,t)}static getTypeName(){return"AugLoop_Core_Apology"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[yo.getTypeName()])}}yo.H_={T_:yo.getTypeName(),B_:yo.getBaseTypes()};class So{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(So,this,t)}static getTypeName(){return"AugLoop_Core_SecondaryApology"}static getBaseTypes(){return["AugLoop_Core_Apology","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[So.getTypeName()])}}So.H_={T_:So.getTypeName(),B_:So.getBaseTypes()};class Do{constructor(t){e.assign(Do,this,t)}static getTypeName(){return"AugLoop_Core_WorkflowActivationFailureDetails"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[Do.getTypeName()])}}Do.H_={T_:Do.getTypeName(),B_:Do.getBaseTypes()};class Io{constructor(t){e.assign(Io,this,t)}static getTypeName(){return"AugLoop_Core_AuthTokenIsMissingDetails"}static getBaseTypes(){return["AugLoop_Core_WorkflowActivationFailureDetails"]}static typeGuard(t){return e.matchesTypesFor(t,[Io.getTypeName()])}}Io.H_={T_:Io.getTypeName(),B_:Io.getBaseTypes()};class xo{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(xo,this,t)}static getTypeName(){return"AugLoop_Core_NotActivatedWorkflowApology"}static getBaseTypes(){return["AugLoop_Core_Apology","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[xo.getTypeName()])}}xo.H_={T_:xo.getTypeName(),B_:xo.getBaseTypes()};const Co=e=>Oo(e,Number.POSITIVE_INFINITY),Oo=(e,t)=>{let n=0;const a=[],i=[e];for(;i.length>0;){const e=i.pop(),r=typeof e;if("boolean"===r)n+=4;else if("string"===r)n+=2*e.length;else if("number"===r)n+=8;else if("object"===r&&e&&-1===a.indexOf(e))if(e instanceof Uint8Array)n+=e.length;else{a.push(e);for(const t in e)i.push(e[t])}if(n>t)return n}return n},wo=(e,t)=>{const n=[];for(const a of null!=e?e:[])if(void 0===t||t===a.cardinality)for(const e of a.contextTypes)n.push([e,a.cardinality,a.producerWaitPolicy]);return n};class Eo{constructor(e,t,n,a){this.sendMessage=e,this.annotationType=t,this.options=n,this.token=`${t}-${Eo.nextActivationResultBatchId++}`,this.annotationDoesNotExistOnServiceEnabled=a}activate(e,t,n){return new Promise((a,i)=>{this.sendMessage(new pi({annotationType:this.annotationType,token:this.token,config:this.options?this.options.config:void 0,ignoreExistingAnnotations:e,sendStateUpdates:this.options?!!this.options.stateUpdateCallback:void 0,forceReturnCachedAnnotations:this.options?this.options.forceReturnCachedAnnotations:void 0,returnAnnotationDoesNotExist:this.annotationDoesNotExistOnServiceEnabled||!1,sendApologies:n}),(e,t)=>{e?i(new Error(e.error)):(mi.typeGuard(t)&&this.annotationDoesNotExistOnServiceEnabled&&(this.annotationDoesNotExistOnService=t.annotationNotExists),a({token:this.token}))},t)})}release(){return new Promise((e,t)=>{this.annotationDoesNotExistOnService&&this.annotationDoesNotExistOnServiceEnabled?e(!1):this.sendMessage(new hi({token:this.token}),(n,a)=>{n?t(new Error(n.error)):e(a.lastRelease)})})}}var Ao,Lo,ko;Eo.nextActivationResultBatchId=1,function(e){e[e.Input=0]="Input",e[e.Exception=1]="Exception",e[e.WaitOn=2]="WaitOn",e[e.StopAndFilterWorkflow=3]="StopAndFilterWorkflow"}(Ao||(Ao={})),function(e){e[e.Unknown=0]="Unknown",e[e.NoOutput=1]="NoOutput",e[e.Authentication=2]="Authentication",e[e.JoinTimedOut=3]="JoinTimedOut",e[e.LambdaThrow=4]="LambdaThrow",e[e.LambdaErrorCallback=5]="LambdaErrorCallback"}(Lo||(Lo={})),function(e){e[e.ExceedingMaxSize=0]="ExceedingMaxSize",e[e.GroupComplete=1]="GroupComplete",e[e.BatchIntervalElapsed=2]="BatchIntervalElapsed"}(ko||(ko={}));class Mo{constructor(e,t,n,a,i){this.batchesByGroupingKey=new Map,this.getOrderOfMagnitudeDimension=e=>e<0?"Negative":0===e?"0":1===e?"1":`Magnitude ${e.toString().length}`,this.submit=e,this.onSummary=a,this.reduceBatchOperationsEnabled=t,this.batchMessagesEnabled=n,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=i}addBatchItem(e,t,n,a,i,r){const{delayMs:o,delayMsMax:s,maxInputSize:c,estimateSize:d,groupingKeyExtractor:l}=t,u=d(e),f=l(e);if(t.split&&u>c){let o;try{o=t.split(e)}catch(e){const t=new Error("Split error: "+e.message);return void(r?r(t):Bn.error(573366352,aa.CoreDefault,t))}if(o&&Array.isArray(o.inputs)&&o.inputs.length>1){let e;const s=[],c=r?(t,n)=>{if(e=e||t,s.push(n),s.length===o.inputs.length){let n;try{n=o.join(s)}catch(t){return void r(new Error("Join error: "+t.message))}r(e,n)}}:void 0;for(let e=0;e<o.inputs.length;e++){const r=o.inputs[e];this.addBatchItem(r,t,n,a,i&&e===o.inputs.length-1,c)}return}}let p=this.batchesByGroupingKey.get(f);if(p&&p.size+u>c&&(this.executeBatch(f,p,t,ko.ExceedingMaxSize),p=void 0),p||(p={items:[],size:0,hasItemsWithCallbacks:!1,context:n,creationTime:Date.now()},this.batchesByGroupingKey.set(f,p)),this.batchMessagesEnabled){const t=p.items[p.items.length-1];t&&t.cv===a&&t.callback===r?(t.input=[...t.input,...e],t.size+=u):p.items.push({input:e,size:u,cv:a,callback:r,creationTime:Date.now()})}else p.items.push({input:e,size:u,callback:r,creationTime:Date.now()});p.size+=u,p.hasItemsWithCallbacks=p.hasItemsWithCallbacks||!!r,this.batchMessagesEnabled||(p.cv=a),p.groupComplete=i,p.groupComplete?this.executeBatch(f,p,t,ko.GroupComplete):(Date.now()-p.creationTime+o<s&&(clearTimeout(p.timeout),p.timeout=void 0),p.timeout||(p.timeout=setTimeout(()=>{this.executeBatch(f,p,t,ko.BatchIntervalElapsed)},o)))}removeAllBatchedItems(){this.batchesByGroupingKey.forEach(e=>{e.timeout&&clearTimeout(e.timeout)}),this.batchesByGroupingKey.clear()}close(){for(const[e,t]of this.batchesByGroupingKey){const n=1e3;void 0!==t.creationTime&&void 0!==t.timeout&&void 0!==t.timeoutDuration&&Date.now()-t.creationTime>t.timeoutDuration+n&&Bn.info(504690067,aa.CoreDefault,{operationName:"BatchStillPendingAfterTimeout",resourceId:t.context.name,resultDescription:`Batch with groupingKey "${e}" still pending after timeout. Items: ${t.items.length}, Size: ${t.size}`,dimension0:t.items.length>0?`LastItemAge: ${Date.now()-t.items[t.items.length-1].creationTime}ms`:"No items in batch"})}}reduceBatchOperations(e){const t=new yn({operationName:"ReduceBatchOperations"}).start();let n=0,a=0,i=0;const r=new Set,o=[],s=(e,t)=>e.parentPath.toString()+"/"+e.parentRevId+"/"+t.id;for(const t of e.input.reverse()){const e=[];for(const o of t.input.reverse())if(_.typeGuard(o)){const t=[];for(const e of o.items){i++;const c=s(o,e);r.has(c)?a++:(t.push(e),r.add(c),n++)}0!==t.length&&(o.items=t,e.push(o))}else if(f.typeGuard(o)){for(const e of o.items){const t=s(o,e);r.delete(t)}e.push(o)}else e.push(o);0!==e.length&&o.push({input:e.reverse(),size:t.size,cv:t.cv,callback:t.callback,creationTime:t.creationTime})}e.input=o.reverse(),0!=i&&(t.dimension0=`${this.getOrderOfMagnitudeDimension(a)}`,t.dimension1=`noOp: ${0===a}`),t.success=i-a==n,Bn.info(507839488,aa.CoreDefault,t.stop())}maxNumberOfDeltaUpdateOpsPerItemPerBatch(e){const t=(e,t)=>e.parentPath.toString()+"/"+t.id;let n=0;const a=new Map;for(const i of e.input)if(D.typeGuard(i))for(const e of i.items){const r=t(i,e);a.has(r)||a.set(r,0),a.set(r,a.get(r)+1),n=Math.max(n,a.get(r))}return n}executeBatch(e,t,n,a){clearTimeout(t.timeout),t.timeout=void 0,this.batchesByGroupingKey.delete(e);const i=t.items,r=new yn({operationName:"ExecuteBatch",cv:this.batchMessagesEnabled?"":t.cv,resourceId:t.context.name,resultDescription:`batching duration: ${Date.now()-t.creationTime}ms`,dimension0:`${this.batchMessagesEnabled?"Batched items count":"Batched ops count:"} ${this.getOrderOfMagnitudeDimension(i.length)}`,dimension1:`Size ${this.getOrderOfMagnitudeDimension(t.size)}`,dimension2:a.toString()}).start(),o=(e,n,a)=>{let o;if(n&&n.exceptionType===Lo.NoOutput)r.success=!0,Bn.info(573366353,aa.CoreDefault,r.stop());else{const a=`${e} error: ${n?n.message||n:"Unknown error"}`;o=n||new Error(a),r.success=!1,r.resultDescription=`Batch of ${i.length} items of size ${t.size} with ${a}`,r.resultSignature=`${e} Error`,Bn.error(573366354,aa.CoreDefault,r.stop())}if(t.hasItemsWithCallbacks)for(const e of i)e.callback&&e.callback(o,a)};let s;try{s=n.multiplex(this.batchMessagesEnabled?i:i.map(e=>e.input))}catch(e){return void o("Multiplex",e)}this.reduceBatchOperationsEnabled&&this.batchMessagesEnabled&&"operations"==e&&this.reduceBatchOperations(s),!this.batchMessagesEnabled&&"operations"==e&&this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled&&(r.dimension3=this.getOrderOfMagnitudeDimension(this.maxNumberOfDeltaUpdateOpsPerItemPerBatch(s))),this.submit(s.input,t,(e,a)=>{if(e||a&&("exceptionType"in a||a instanceof Error))o("Submit",e||a,a);else if(t.hasItemsWithCallbacks||n.summaryExtractor){let c,d,l;if(t.hasItemsWithCallbacks)try{if(c=s.demultiplex(a),c.length!==i.length)throw new Error("Mismatched output length")}catch(e){return void o("Demultiplex",e)}if(n.summaryExtractor)try{[l,d]=n.summaryExtractor(a)}catch(e){return void o("SummaryExtractor",e)}if(r.success=!0,Bn.info(573366342,aa.CoreDefault,r.stop()),t.hasItemsWithCallbacks)for(let e=0;e<i.length;e++)i[e].callback&&i[e].callback(void 0,c[e]);d&&this.onSummary(l,d,t.context)}else r.success=!0,Bn.info(573366343,aa.CoreDefault,r.stop())})}}var Po=o(882);const{AugLoopTextEncoder:To,AugLoopTextDecoder:Uo}=(()=>{if("undefined"==typeof TextEncoder||"undefined"==typeof TextDecoder){o(832);const e={AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder};return TextEncoder=void 0,TextDecoder=void 0,e}return{AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder}})();var Fo=function(e,t,n,a){return new(n||(n=Promise))(function(i,r){function o(e){try{c(a.next(e))}catch(e){r(e)}}function s(e){try{c(a.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,s)}c((a=a.apply(e,t||[])).next())})};class Ho{static extractFragments(e){if(e[0]!==Ho.IDENTIFIERBYTE)throw new Error("Invalid Binary: Incorrect Identifier");let t=1;const n=[],a=new DataView(e.buffer,e.byteOffset,e.byteLength);for(;t<e.byteLength;){if(t+4>e.byteLength)throw new Error("Invalid Binary: Error reading fragment length");const i=a.getUint32(t);if(t+i+4>e.byteLength)throw new Error("Invalid Binary: Fragment out of range");"undefined"!=typeof Buffer&&Buffer.from?n.push(Buffer.from(e.buffer,e.byteOffset+t+4,i)):n.push(new Uint8Array(e.buffer,e.byteOffset+t+4,i)),t+=4+i}if(n.length<1)throw new Error("Invalid Binary: No fragments found");return n}static deserialize(e,t=(e=>e)){const n=Ho.extractFragments(e),a=Ho.textDecoder.decode(n[0]);return JSON.parse(a,(e,a)=>{if("string"==typeof a){if(a.substring(0,Ho.BINARYKEYWORD.length)===Ho.BINARYKEYWORD){const e=parseInt(a.substring(Ho.BINARYKEYWORD.length),10);if("number"!=typeof e||e>=n.length-1)throw new Error("Invalid Binary: Binary index out of range");return t(n[e+1])}if(a.substring(0,Ho.ESCAPEKEYWORD.length)===Ho.ESCAPEKEYWORD)return a.substring(Ho.ESCAPEKEYWORD.length)}return a})}static deserializeAsync(e,t=(e=>Fo(this,void 0,void 0,function*(){return e}))){return Fo(this,void 0,void 0,function*(){const n=Ho.extractFragments(e),a=Ho.textDecoder.decode(n[0]),i=[],r=Symbol("placeholder"),o=e=>{if(Array.isArray(e)){for(let t=0;t<e.length;t++)e[t]=o(e[t]);return e}if(null!==e&&"object"==typeof e){if(e[r])return e.value;for(const t of Object.keys(e))e[t]=o(e[t]);return e}return e};let s=JSON.parse(a,(e,a)=>{if("string"==typeof a){if(a.startsWith(Ho.BINARYKEYWORD)){const e=parseInt(a.substring(Ho.BINARYKEYWORD.length),10);if("number"!=typeof e||e>=n.length-1)throw new Error("Invalid Binary: Binary index out of range");const o=t(n[e+1]);return i.push(o),(e=>{const t={[r]:!0,value:void 0};return e.then(e=>{t.value=e}),t})(o)}if(a.startsWith(Ho.ESCAPEKEYWORD))return a.substring(Ho.ESCAPEKEYWORD.length)}return a});return yield Promise.all(i),s=yield o(s),s})}static serializeInternal(e){const t=[void 0],n=JSON.stringify(e,(e,n)=>ArrayBuffer.isView(n)?(t.push(n),`${Ho.BINARYKEYWORD}${t.length-2}`):n&&"Buffer"===n.type&&Array.isArray(n.data)?(t.push(new Uint8Array(n.data)),`${Ho.BINARYKEYWORD}${t.length-2}`):"string"==typeof n&&n.substring(0,Ho.ESCAPEKEYWORD.length)===Ho.ESCAPEKEYWORD?Ho.ESCAPEKEYWORD+n:n);t[0]=Ho.textEncoder.encode(n);const a=t.reduce((e,t)=>e+4+t.byteLength,0),i=new Uint8Array(a+1);i[0]=Ho.IDENTIFIERBYTE;let r=1;const o=new DataView(i.buffer,i.byteOffset,i.byteLength);for(const e of t)o.setUint32(r,e.byteLength),i.set(e,r+4),r+=4+e.byteLength;return i}static serialize(e){return Ho.serializeInternal(e)}static serializeAsync(e){return Fo(this,void 0,void 0,function*(){return new Promise((t,n)=>{try{t(Ho.serializeInternal(e))}catch(e){n(e)}})})}}function Ro(e,t){return n=this,void 0,i=function*(){const{authToken:n,origin:a,sessionUrl:i}=e,{body:r,cv:o,method:s,requestUrl:c}=t,d=yield(0,Po.fetch)(c||i,{method:s,headers:Object.assign({Authorization:`Bearer ${n}`,"x-origin":a,"x-correlationid":o},t.headers),body:r});if(200!==d.status)throw new Error(`Unexpected status code: ${d.status}`);return d},new((a=void 0)||(a=Promise))(function(e,t){function r(e){try{s(i.next(e))}catch(e){t(e)}}function o(e){try{s(i.throw(e))}catch(e){t(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof a?n:new a(function(e){e(n)})).then(r,o)}s((i=i.apply(n,[])).next())});var n,a,i}Ho.IDENTIFIERBYTE=3,Ho.BINARYKEYWORD=":b",Ho.ESCAPEKEYWORD=":",Ho.textDecoder=new Uo,Ho.textEncoder=new To;const No=(e,t)=>{t?(e.resultDescription=t,e.success=!1,Bn.error(507646878,aa.CoreDefault,e.stop())):Bn.info(507646877,aa.CoreDefault,e.stop())};function Bo(e,t,n,a){let i;Ro(e,{headers:{"Content-Type":"application/jsond"},body:Ho.serialize(t),cv:n.cv,method:"POST"}).then(e=>e.json()).catch(e=>{i=new ti({messageId:t.messageId,error:e.message})}).then(e=>{No(n,i?i.error:void 0),a(i,e)})}function jo(e,t,n,a){let i;Ro(e,{headers:{"Content-Type":"application/octet-stream"},body:t,cv:n.cv,method:"POST",requestUrl:`${e.sessionUrl}/blob`}).then(e=>e.json()).catch(e=>{i=new ti({error:e.message})}).then(e=>{No(n,i?i.error:void 0),a(i,e)})}function Vo(e,t,n,a){const{sessionUrl:i}=e;let r;Ro(e,{cv:a.cv,method:"GET",requestUrl:t.refType===_o.AlCodedLocation?`${i}/blob/${t.value}`:t.value}).then(e=>e.arrayBuffer()).then(e=>new Uint8Array(e)).catch(e=>{r=e}).then(e=>{No(a,r?r.message:void 0),n(r,e)})}var zo=o(662);class Go extends zo.EventEmitter{init(){return Promise.resolve()}sendMessage(e,t,n){}onMessage(e,t){}forceReconnect(){return Promise.resolve()}closeSession(){}sendBytes(e){}getCorrelationVector(){return new Ir}getNetworkWorkerManager(){}setState(e){}}const Ko=t=>{var n,a;if(Ci.typeGuard(t)){const a=t.ops.filter(t=>e.matchesTypesFor(t,["AugLoop_Core_AddOperation"]));for(const e of a)for(const t of e.items)if(t.body&&(null===(n=t.body)||void 0===n?void 0:n.isFirstUserPerceivedResponse))return!0}else if(sr.typeGuard(t))return null===(a=t.content)||void 0===a?void 0:a.some(e=>{var t;return null===(t=e.body)||void 0===t?void 0:t.isFirstUserPerceivedResponse});return!1},Wo=(t,n,a,i,r)=>{const o=(t=>{const n=t.filter(t=>e.matchesTypesFor(t,["AugLoop_Signals_SignalOperation"]));for(const t of n)for(const n of t.items)if(n.body&&e.matchesTypesFor(n.body,["AugLoop_CopilotChatHistory_CopilotChatHistorySignal","AugLoop_Copilot_CopilotInputSignal"]))return n})(t);o&&(r.setDataField("CurrentTimestamp",a),r.cv=n||"",r.resultSignature=i,r.resourceId=e.getTypeNameFor(o.body),o.contextId&&r.setDataField("ContextId",o.contextId),o.sourceTimestamp&&r.setDataField("SourceTimestamp",o.sourceTimestamp),Bn.info(505983429,aa.CoreDefault,r.stop()))},qo=(e,t,n,a,i)=>{a&&!Ko(e)||(i.setDataField("CurrentTimestamp",t),i.cv=e.cv,i.resultSignature=n,i.resourceId=e.annotationType,i.dimension1=`AreApologies: ${e.areApologies}`,Bn.info(505983428,aa.CoreDefault,i.stop()))};var Qo;!function(e){e[e.Undefined=0]="Undefined",e[e.Schema=1]="Schema",e[e.Boolean=2]="Boolean",e[e.Number=3]="Number",e[e.String=4]="String",e[e.Buffer=5]="Buffer",e[e.Function=6]="Function"}(Qo||(Qo={}));class Yo{static createHealthCheckRequest(e){return{payload:{},payloadSchema:{category:Qo.Schema,schema:{name:"HealthCheckRequest"}},requestedSchema:{category:Qo.Schema,schema:{name:"HealthCheckResponse"}},clientMetadata:Object.assign(Object.assign({},e),{flights:""})}}static isFeatureEnabled(e,t,n=!1,a="None"){return e&&e.isFeatureEnabled?e.isFeatureEnabled("Microsoft.Office.AugLoop."+t,a).catch(()=>Promise.resolve(n)):Promise.resolve(n)}static isChangeGateEnabled(e,t){return e&&e.isChangeGateEnabled?e.isChangeGateEnabled(t):Promise.resolve(!1)}static convertWebSocketUrlToHttp(e){return this.convertUrl(e,!1)}static convertServiceUrlToWebSocket(e){return this.convertUrl(e,!0)}static convertUrl(e,t){if(!e)return e;const n=e.split(":");let a=n[0].toLowerCase();return 0==a.indexOf(t?"http":"ws")?(a=t?a.replace("http","ws"):a.replace("ws","http"),n[0]=a,n.join(":")):e}static deepEquals(e,t){return pr()(e,t)}static collectTelemetry(e,t,n,a,i,r){var o,s,c,d;e.start(),e.resultSignature=null!=a?a:"",e.resultDescription=null!=i?i:"",e.success=n,r?(e.dimension0=null!==(o=r[0])&&void 0!==o?o:"",e.dimension1=null!==(s=r[1])&&void 0!==s?s:"",e.dimension2=null!==(c=r[2])&&void 0!==c?c:"",e.dimension3=null!==(d=r[3])&&void 0!==d?d:""):(e.dimension0="",e.dimension1="",e.dimension2="",e.dimension3=""),t.log(()=>Bn.info(508367457,aa.CoreDefault,e.stop()))}}Yo.getCurrentTimeMs=()=>Date.now?Date.now():(new Date).getTime();class Jo{constructor(e){this.maxNumberOfLogs=40,this.numberOfLogs=0,this.id=e}log(e){if(this.numberOfLogs<this.maxNumberOfLogs&&(this.numberOfLogs++,e(),this.numberOfLogs===this.maxNumberOfLogs)){const e=new yn({operationName:"OnLastLog",success:!0,resourceId:this.id,resultDescription:`Limit for number of logs for id: ${this.id} reached - all next logs will be dropped`});Bn.warn(572838107,aa.CoreDefault,e)}}}e.getTypeName(),Pa.getTypeName(),Ra.getTypeName();const Xo=(e,t=0)=>Number.isFinite(e)?e:t;var Zo,$o=function(e,t,n,a){return new(n||(n=Promise))(function(i,r){function o(e){try{c(a.next(e))}catch(e){r(e)}}function s(e){try{c(a.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,s)}c((a=a.apply(e,t||[])).next())})},es=function(e){return this instanceof es?(this.v=e,this):new es(e)};!function(e){e[e.LocalWorkflow=0]="LocalWorkflow",e[e.ServerWorkflow=1]="ServerWorkflow",e[e.Submitted=2]="Submitted"}(Zo||(Zo={}));const ts=(e,t)=>{t?(e.resultDescription=t,e.success=!1,Bn.error(509203144,aa.CoreDefault,e.stop())):Bn.info(509203143,aa.CoreDefault,e.stop())},ns=e=>!e.items.some(e=>e.source&&0===e.source.indexOf("ThirdParty"));class as{constructor(e){var t,n;this.annotationActivationTrackers=new Map,this.annotationCallbacks=new Map,this.apologyCallbacks=new Map,this.annotationResultStates=new Map,this.tokensByAnnotationType=new Map,this.registeredContextTypes=new Set,this.availableContexts=new Map,this.nextSyncSequenceId=1,this.allowSeed=!0,this.allowGroupSeed=!0,this.seedGroupSize=0,this.batchedSeedMessageGroupSize=0,this.hasSessionConnected=!1,this.isSessionClosed=!1,this.serverAuthenticationState=ja.NotAuthenticated,this.sessionCloseCallbacks=new Map,this.connectCallbacks=new Map,this.reconnectCallbacks=new Map,this.disconnectCallbacks=new Map,this.sessionStateCallbackToken=0,this.workflowGraph=new Ar,this.workflowDefinitionManager=new Rr,this.contextIdManager=new jr(Nr.JsClient,this.workflowGraph),this.workflowItemStorage=new Kr(this.workflowDefinitionManager),this.pendingConnectCallbacks=[],this.onAnnotationsSubmittedEnabled=!1,this.reduceBatchOperationsEnabled=!1,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=!1,this.batchMessagesEnabled=!1,this.seedingStatus=to.NotStarted,this.onConnectTelemetryCG=void 0,this.cachedClaimsChallenge={claimsVersion:0,actionRequired:!1},this.tokenMessageVersion=1,this.hostCallbacks=e.hostCallbacks,this.sessionManager=e.sessionManager,this.batchMessagesEnabled=e.batchMessagesEnabled||!1,this.reduceBatchOperationsEnabled=e.reduceBatchOperationsEnabled||!1,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=e.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled||!1,this.operationBatchConfig=e.batchOptions?this.getOperationBatchConfig(e.batchOptions):void 0,this.extensionConfigs=e.extensionConfigs,this.clientMetadata=e.clientMetadata,this.userContext=e.userContext,this.localWorkflowManager=e.localWorkflowManager,this.annotationResultsProcessor=e.annotationResultsProcessor,this.gateUtils=e.gateUtils,this.localRegisteredWorkflows=e.localRegisteredWorkflows||[],this.enableRemoteExecutionNotification=e.enableRemoteExecutionNotification||!1,this.networkMode=e.networkMode,this.egress=e.egress,this.serverAuthenticationStateChangeCallback=[],this.claimsChallengeCallback=[],this.seedingStatusChangeCallbacks=[],this.onAnnotationsSubmittedEnabled=e.onAnnotationsSubmittedEnabled||!1,this.annotationDoesNotExistOnServiceEnabled=e.annotationDoesNotExistOnServiceEnabled||!1,this.sessionManager.on("sessionClose",this.onSessionClose.bind(this)),this.sessionManager.on("reconnect",this.onReconnect.bind(this)),this.sessionManager.on("connect",this.onConnect.bind(this)),this.sessionManager.on("disconnect",this.onDisconnect.bind(this)),this.sessionManager.on("resetNextSyncSequenceId",this.resetNextSyncSequenceId.bind(this)),this.sessionManager.on("serverAuthenticationStateChange",this.onServerAuthenticationStateChange.bind(this)),this.sessionManager.onMessage(Ci.getTypeName(),this.onAnnotationResultsFromServer.bind(this)),this.sessionManager.onMessage(_i.getTypeName(),this.onAnnotationResultStateMessage.bind(this)),this.sessionManager.onMessage(Mi.getTypeName(),this.onWorkflowExecutionCompleteMessage.bind(this)),this.sessionManager.onMessage(Ki.getTypeName(),this.onClaimsChallengeMessage.bind(this)),this.sessionManager.onMessage(Pi.getTypeName(),this.onSeedingStatusChangeMessage.bind(this)),e.isDeltaGeneratorEnabled&&(this.enableSyncDeltaSending=!e.disableSyncDeltaSending,this.syncDeltaTimeout=null!==(t=e.syncDeltaTimeout)&&void 0!==t?t:700,this.enableDeltaGenerator()),this.setServerAuthenticationStateChangeCallback(this.updateGraphOnAuthStateChange.bind(this)),(null===(n=this.gateUtils)||void 0===n?void 0:n.isChangeGateEnabledSync(mc))||this.setClaimsChallengeCallback(this.requestAuthTokenWithClaims.bind(this))}enabledRemoteExecutionNotification(){return this.enableRemoteExecutionNotification}getSessionReconnectParams(){if(!this.connectParams)throw new Error("Session has not been established yet.");return{sessionUrl:this.connectParams.sessionUrl,origin:this.connectParams.origin,authToken:this.connectParams.authToken,nextSyncSequenceId:this.nextSyncSequenceId}}setNextSequenceId(e){this.nextSyncSequenceId=e}tryGetDocSessionId(){if(this.clientMetadata&&this.clientMetadata.docSessionId)return this.clientMetadata.docSessionId}getSessionStateCallbackToken(e){var t;return e+"-callback-"+(null!==(t=this.tryGetDocSessionId())&&void 0!==t?t:"unknown")+"-"+this.sessionStateCallbackToken++}updateGraphOnAuthStateChange(e){this.tryActivateWorkflows()}tryActivateWorkflows(){if(this.enableRemoteExecutionNotification){const e=new yn({operationName:"GraphServerWorkflowActivation",success:!0}).setClientMetadata(this.clientMetadata).start(),t=[];this.workflowGraph.getWorkflowNodes().filter(e=>e.location===Or.External).forEach(e=>{this.localWorkflowManager.canActivateWorkflow(e,this)?e.isActivated=!0:(this.localWorkflowManager.deactivateServerWorkflow(e,this),t.push(e.workflow.id))}),e.resultDescription=`deactivated workflows: [${t.join()}]`,Bn.info(508879493,aa.CoreDefault,e.stop())}}initialize(){return $o(this,void 0,void 0,function*(){return this.localWorkflowManager&&this.localWorkflowManager.addSession(this),this.registerLocalWorkflowsWithoutGraphInit(this.localRegisteredWorkflows),this.gateUtils&&!this.onConnectTelemetryCG&&(this.onConnectTelemetryCG=yield this.gateUtils.isChangeGateEnabled("OnConnectTelemetry")),yield this.sessionManager.init(this.extensionConfigs,this.hostCallbacks.onInitSession?this.hostCallbacks.onInitSession:void 0,this.egress),this.localWorkflowManager&&this.localWorkflowManager.setTokenCallback(this.getAuthToken.bind(this)),this})}isLocalWorkflowRegistered(e){return this.getLocalRegisteredWorkflows().some(t=>e===t.id)}get isConnected(){return!!this.connectParams}get hasConnected(){return this.hasSessionConnected}get isClosed(){return this.isSessionClosed}getServerAuthenticationState(){return this.serverAuthenticationState}getContextIdManager(){return this.contextIdManager}getWorkflowItemStorage(){return this.workflowItemStorage}getWorkflowDefinition(e,t){return this.workflowDefinitionManager.getWorkflowDefinition(e,t)}registerLocalWorkflows(e){this.registerLocalWorkflowsWithoutGraphInit(e),this.trySendWorkflowGraphInitMessage()}registerLocalWorkflowsWithoutGraphInit(e){if(e.length&&this.localWorkflowManager)for(const t of e)this.localWorkflowManager.registerLocalWorkflow(t,this)}registerLocalWorkflow(e){this.registerLocalWorkflows([e]);const t=new yn({operationName:"SessionRegisterLocalWorkflow",resourceId:e.id,success:!0}).setClientMetadata(this.clientMetadata).start();ts(t)}activateAnnotation(e,t,n){var a;const i=new Eo(this.sendMessageToSession.bind(this),e,t,this.annotationDoesNotExistOnServiceEnabled),r=(t,n)=>{let a=t.get(e);a||(a=new Map,t.set(e,a)),a.set(i.token,n)};(null==t?void 0:t.callback)&&r(this.annotationCallbacks,null==t?void 0:t.callback),(null==t?void 0:t.apologyCallback)&&r(this.apologyCallbacks,null==t?void 0:t.apologyCallback);const o=null!==(a=this.tokensByAnnotationType.get(e))&&void 0!==a?a:[];return-1===o.indexOf(i.token)&&o.push(i.token),this.tokensByAnnotationType.set(e,o),this.annotationActivationTrackers.set(i.token,i),this.activateAnnotationForTracker(i,{ignoreExistingAnnotations:!1,sendOnlyIfConnected:!1,sendApologies:void 0!==(null==t?void 0:t.apologyCallback)})}activateServerRequestResponse(e,t,n){return $o(this,void 0,void 0,function*(){yield this.activateAnnotation(e,{callback:(e,n)=>{for(const n of e.items){const e=new yn({operationName:"ServerRequestResponseAnnotationReceived",success:!0}).setClientMetadata(this.clientMetadata).start(),a=n.body;if(!(null==a?void 0:a.workflowExecutionCorrelation)){const t="Received annotation without workflowExecutionCorrelation";throw ts(e,t),new Error(t)}let i=!1;const r=(t,n)=>{if(i){const t="Final response has already been sent for this annotation";throw ts(e,t),new Error(t)}i=void 0===n||n;const r=new Yi({workflowExecutionCorrelation:a.workflowExecutionCorrelation,finalResponse:i,content:t}),o=this.submitCustomMessage(r).catch(t=>{throw ts(e,`Error submitting response: ${t.message}`),t});return n&&ts(e),o};null==t||t.onAnnotationCallback(a,r).catch(t=>{ts(e,`Error in onAnnotationCallback: ${t.message}`)})}}},n)})}activateAnnotationForTracker(e,t){const n=new yn({operationName:"ActivateAnnotation",resourceId:e.annotationType,success:!0}).setClientMetadata(this.clientMetadata).start();return n.setDataField("StartTimestamp",Date.now()),e.activate(t.ignoreExistingAnnotations,t.sendOnlyIfConnected,t.sendApologies).then(a=>(n.resultSignature="Ok",n.resultDescription=`Activated annotation ${e.annotationType} with token ${e.token}; sendOnlyIfConnected: ${t.sendOnlyIfConnected}`,ts(n),a)).catch(a=>{throw ts(n,`error on activate annotation type ${e.annotationType}: ${a}; sendOnlyIfConnected: ${t.sendOnlyIfConnected}`),a})}updateAnnotationConfig(e,t){const n=new gi({token:e,config:t});this.sendMessageToSession(n);const a=this.annotationActivationTrackers.get(e);a&&a.options&&(a.options.config=t)}releaseAnnotation(e){const t=this.annotationActivationTrackers.get(e);if(t){this.annotationActivationTrackers.delete(e);const n=n=>{const a=n.get(t.annotationType);a&&(a.delete(e),0==a.size&&n.delete(t.annotationType))};return n(this.annotationCallbacks),n(this.apologyCallbacks),t.release()}return Promise.resolve(!1)}setAnnotationState(e,t,n){const a={state:n};this.submitOperation(new m({parentPath:e,items:[{id:t}],M_:a}))}setAnnotationMetadata(e,t,n){this.submitOperation(new m({parentPath:e,items:[{id:t}],M_:n}))}submitOperation(e,t){this.submitOperations([e],t)}submitOperations(e,t){var n,a;if(t||(t=this.generateCorrelationId()),Wo(e,t,Date.now(),"SubmitInRuntimeClient",new yn({operationName:"AugloopClientPerfTracker",success:!0}).setClientMetadata(this.clientMetadata).start()),this.contextIdManager.applyContextIdOnOperations(e),this.updateWorkflowExecutionStates(e),!this.onAnnotationsSubmittedEnabled){const[n,a]=this.partitionAnnotationOperations(e);this.executeCallbacksOnAnnotationSubmitted(n,t)}const i=e.filter(this.filterOperationsForSession.bind(this)).filter(ns),r=[];if(this.deltaGenerator){const e=new yn({operationName:"ExecuteDeltaGenerator",success:!0}).setClientMetadata(this.clientMetadata).start();for(const e of i)if(_.typeGuard(e))r.push(...this.createDeltasFromUpdateOperation(e));else{const t=e;for(const i of t.items)f.typeGuard(e)?this.deltaGenerator.addItemToLocalMap(i,t.parentPath):h.typeGuard(e)?this.deltaGenerator.deleteItemFromLocalMap(i,t.parentPath):p.typeGuard(e)&&this.deltaGenerator.moveItemsInLocalMap(e.parentPath,e.prevParentPath,null!==(a=null===(n=e.items)||void 0===n?void 0:n.map(e=>e.id))&&void 0!==a?a:[]);r.push(e)}ts(e)}if(this.onAnnotationsSubmittedEnabled){const[e,n]=this.partitionAnnotationOperations(r.length?r:i);this.onAnnotationsSubmitted(e,t),this.submitOperationsToSession(n,t)}else this.submitOperationsToSession(r.length?r:i,t);this.localWorkflowManager&&this.localWorkflowManager.runLocalWorkflows(e,this,!0)}submitSeedOperations(e,t){if(!this.allowSeed)throw new Error("Cannot submit seed operations more than once per session");if(this.networkMode===ia.LocalWorkflowsOnly&&this.localWorkflowManager)return void this.localWorkflowManager.runLocalWorkflows(e,this);t||(t=this.generateCorrelationId()),this.allowSeed=!1,this.allowGroupSeed=!1;const[n,a]=this.partitionAnnotationOperations(e);this.onAnnotationsSubmittedEnabled?this.onAnnotationsSubmitted(n,t):this.executeCallbacksOnAnnotationSubmitted(n,t),this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(this.onAnnotationsSubmittedEnabled?a:e,!0,t):this.sendMessageToSession(new Si({cv:t,seq:0,ops:this.onAnnotationsSubmittedEnabled?a:e}))}submitSeedGroupOperations(e,t,n){if(!this.allowGroupSeed)throw new Error("Seed operations are not allowed for this session");if(this.networkMode===ia.LocalWorkflowsOnly&&this.localWorkflowManager)return void this.localWorkflowManager.runLocalWorkflows(e,this);n||(n=this.generateCorrelationId()),t&&(this.allowGroupSeed=!1),this.allowSeed=!1;const[a,i]=this.partitionAnnotationOperations(e);this.executeCallbacksOnAnnotationSubmitted(a,n),this.onAnnotationsSubmittedEnabled?this.onAnnotationsSubmitted(a,n):this.executeCallbacksOnAnnotationSubmitted(a,n),this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(this.onAnnotationsSubmittedEnabled?i:e,!!t,n):(this.seedGroupSize++,this.sendMessageToSession(new Si({cv:n,seq:0,ops:this.onAnnotationsSubmittedEnabled?i:e,groupId:"Seed",groupSize:t?this.seedGroupSize:void 0,groupComplete:t||void 0})))}submitCustomMessage(t){return new Promise((n,a)=>{this.sendMessageToSession(t,(i,r)=>{i?a(new Error(`${i.error}; for message type: ${e.getTypeNameFor(t)}`)):n(r)})})}submitLargeBinaryDataMessage(e){return new Promise((t,n)=>{this.sendMessageToSessionPostEndpoint(e,(e,a)=>{e?n(new Error(e.error)):t(a)})})}submitBinaryStreamUploadMessage(e){return new Promise((t,n)=>{const a=new yn({operationName:"sendBinaryStreamUploadMessage",success:!0}).setClientMetadata(this.clientMetadata).start();if(this.connectParams)jo(this.connectParams,e,a,(e,a)=>{e?n(new Error(e.error)):t(a)});else{const i=(i=>jo(i,e,a,(e,a)=>{e?n(new Error(e.error)):t(a)})).bind(this);this.pendingConnectCallbacks.push(i)}})}requestBinaryDataForBlob(e){return e.data?Promise.resolve(e.data):e.dataPointer&&e.dataPointer.refType!==_o.None?new Promise((t,n)=>{this.requestBinaryDataFromSessionBlobEndpoint(e.dataPointer,(e,a)=>{e?n(e):t(a)})}):Promise.reject(new Error("Blob does not have a data pointer"))}requestCacheDump(e){if(e)throw new Error("NYI");return this.submitCustomMessage(new ui)}forceReconnect(e){return this.extensionConfigs=e,this.sessionManager.forceReconnect(e)}close(e){var t;this.isSessionClosed=!0,this.sessionManager.closeSession(e),this.localWorkflowManager&&this.localWorkflowManager.closeSession(this),this.graphInitMessageTimer&&(clearTimeout(this.graphInitMessageTimer),this.graphInitMessageTimer=void 0),(null===(t=this.gateUtils)||void 0===t?void 0:t.isChangeGateEnabledSync(_c))||this.batchedOperationsManager&&this.batchedOperationsManager.close()}authenticateInteractive(e){return $o(this,void 0,void 0,function*(){if((!e||!e.forceUserPrompt)&&this.cachedClaimsChallenge.claimsVersion>0&&!this.cachedClaimsChallenge.actionRequired)return;const t=yield this.requestAuthTokenInteractive(this.cachedClaimsChallenge,{interactive:!0});if(wi.typeGuard(t))throw new Error(t.reason)})}getClientMetadata(){return this.clientMetadata}getUserContext(){return this.userContext}setSessionCloseCallback(e){const t=this.getSessionStateCallbackToken("close");return e&&this.sessionCloseCallbacks.set(t,e),t}setConnectCallback(e){const t=this.getSessionStateCallbackToken("connect");return e&&this.connectCallbacks.set(t,e),t}setDisconnectCallback(e){const t=this.getSessionStateCallbackToken("disconnect");return e&&this.disconnectCallbacks.set(t,e),t}setReconnectCallback(e){const t=this.getSessionStateCallbackToken("reconnect");return e&&this.reconnectCallbacks.set(t,e),t}removeSessionStateCallback(e){function t(t){return!!t.has(e)&&(t.delete(e),!0)}return t(this.sessionCloseCallbacks)||t(this.reconnectCallbacks)||t(this.disconnectCallbacks)||t(this.connectCallbacks)}setServerAuthenticationStateChangeCallback(e){this.serverAuthenticationStateChangeCallback.push(e),e(this.serverAuthenticationState)}setClaimsChallengeCallback(e){this.cachedClaimsChallenge.actionRequired&&e(this.cachedClaimsChallenge),this.claimsChallengeCallback.push(e)}setSeedingStatusChangeCallback(e){e(new Pi({newStatus:this.seedingStatus})),this.seedingStatusChangeCallbacks.push(e)}getConnectParams(){return this.connectParams}setOfflineMode(){this.sessionManager=new Go}onAnnotationResults(e,t,n){Bn.info(508916486,aa.CoreDefault,new yn({operationName:"OnAnnotationResultsEgress",dimension0:null==e?void 0:e.annotationType,success:!0,cv:e.cv})),n(void 0,new Ya),t===Zo.LocalWorkflow&&this.contextIdManager.applyContextIdOnOperations(e.ops),this.updateWorkflowExecutionStates(e.ops),this.egress&&this.egress(e,()=>{}),this.annotationResultsProcessor.process(e,(e,n)=>{this.applyOperationForContext(e,n,t)},(n,a)=>{const i=Date.now();this.triggerRegisteredAnnotationCallbacks(n,e.annotationType,a,e.areApologies),t===Zo.ServerWorkflow&&qo(e,i,"CallbackInRuntimeClient",!0,new yn({operationName:"AugloopClientPerfTracker",success:!0}).setClientMetadata(this.clientMetadata).start())},e=>{if(t!==Zo.ServerWorkflow){const t=e.ops.filter(this.filterOperationsForSession.bind(this)).filter(ns);this.submitOperationsToSession(t,e.cv)}this.localWorkflowManager&&this.localWorkflowManager.runLocalWorkflows(e.ops,this)})}onAnnotationResultStateMessage(e,t){var n;t(void 0,new Ya);for(const t of e.updates){const{annotationType:e,state:a}=t;if(!this.tokensByAnnotationType.has(e))continue;let i;i=this.annotationResultStates.has(e)?this.annotationResultStates.get(e):a===eo.Idle?eo.Pending:eo.Idle;for(const t of this.tokensByAnnotationType.get(e)){const e=this.annotationActivationTrackers.get(t);(null===(n=e.options)||void 0===n?void 0:n.stateUpdateCallback)&&e.options.stateUpdateCallback(i,a)}}}submitOperationsToSession(e,t){t||(t=this.generateCorrelationId());const n=e.filter(e=>x.typeGuard(e)),a=e.filter(e=>!x.typeGuard(e));if(n.length>0&&this.sendMessageToSession(new Si({cv:t,ops:n})),a.length>0)if(this.operationBatchConfig){if(!this.batchedOperationsManager){let e;e=this.batchMessagesEnabled?(e,t,n)=>{if(e.length){const t=new yi;t.messages=[],e.forEach(e=>{t.messages.push(new Si({cv:e.cv,seq:this.nextSyncSequenceId++,ops:e.input}))}),this.sendMessageToSession(t,e=>{n(e?new Error(e.error):void 0)})}}:(e,t,n)=>{this.sendMessageToSession(new Si({cv:t.cv,seq:this.nextSyncSequenceId++,ops:e}),e=>{n(e?new Error(e.error):void 0)})},this.batchedOperationsManager=new Mo(e,this.reduceBatchOperationsEnabled,this.batchMessagesEnabled,void 0,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled)}this.batchedOperationsManager.addBatchItem(a,this.operationBatchConfig,{name:"SubmitOperations"},t)}else this.sendMessageToSession(new Si({cv:t,seq:this.nextSyncSequenceId++,ops:a}))}sendMessageToSession(e,t){this.sessionManager.sendMessage(e,t),li.typeGuard(e)&&this.close()}sendMessageToSessionPostEndpoint(e,t){const n=new yn({operationName:"SendLargeBinaryDataMessage",success:!0,cv:e.cv}).setClientMetadata(this.clientMetadata).start();if(this.connectParams)Bo(this.connectParams,e,n,t);else{const a=(a=>Bo(a,e,n,t)).bind(this);this.pendingConnectCallbacks.push(a)}}requestBinaryDataFromSessionBlobEndpoint(e,t){const n=new yn({operationName:"RequestBinaryData",success:!0,cv:(new Ir).toString()}).setClientMetadata(this.clientMetadata).start();if(this.connectParams)Vo(this.connectParams,e,t,n);else{const a=(a=>Vo(a,e,t,n)).bind(this);this.pendingConnectCallbacks.push(a)}}registerContextTypes(e){for(const t of e)this.activateAnnotation(t),this.registeredContextTypes.add(t)}applyOperationForContext(t,n,a){let i=e.getTypeNameFor(t);if(i!=f.getTypeName()&&i!=l.getTypeName()&&i!=_.getTypeName()&&i!=h.getTypeName())return;i==l.getTypeName()&&(i=f.getTypeName());const r=zr(this.resolvePlaceholdersInOperationParentPath(t.parentPath),n),o=Gr(r.parentPath);if(i==f.getTypeName()||i==_.getTypeName()){if(!r.body)return;const t=e.getTypeNameFor(r.body);if(!this.registeredContextTypes.has(t))return;let n=this.availableContexts.get(t);n||(n=new Map,this.availableContexts.set(t,n));let s=n.get(a);if(s||(s=[],n.set(a,s)),r.id||this.localWorkflowManager&&(r.id=this.localWorkflowManager.getNextClientAnnotationId()),i==f.getTypeName())0==s.filter(e=>Gr(e.parentPath)==o&&e.id==r.id).length?s.push(r):Bn.info(540848911,aa.CoreDefault,`AddOperation for (${a}, ${r.id}, ${r.source}) can't be applied as the context item with matching path and ID already exists. Use UpdateOperation instead.`);else for(let e=0;e<s.length;e++)if(s[e].id==r.id&&Gr(s[e].parentPath)==o){if(s[e].source==r.source){s[e]=r;break}Bn.warn(540848912,aa.CoreDefault,`UpdateOperation for (${a}, ${r.id}, ${r.source}) can't be applied as the context item with provided path and ID has different source: ${s[e].source}`)}else Bn.warn(540848913,aa.CoreDefault,`UpdateOperation for (${a}, ${r.id}, ${r.source}) can't be applied as the context item with matching path and ID was not found. AddOperation should be used instead`)}else if(i==h.getTypeName()){if(!r.id)return;this.availableContexts.forEach((e,t)=>{let n=e.get(a);n&&(n=n.filter(e=>!(Gr(e.parentPath)==o&&e.id==r.id)),0==n.length?e.delete(a):e.set(a,n),0==e.size?this.availableContexts.delete(t):this.availableContexts.set(t,e))})}}updateWorkflowExecutionStates(t){if(this.localWorkflowManager){const n=this.enableRemoteExecutionNotification?this.workflowGraph.getWorkflowNodes().map(e=>e.workflow):this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this);for(const a of t)if(Br.has(e.getTypeNameFor(a)))for(const e of a.items)for(const t of n||[])this.localWorkflowManager.preProcessItemToWorkflow(t,e,this)}}resolveRequestedContexts(e){const t=[];for(const[n,a,i]of wo(e.requestedContextTypesRules)){if(!this.availableContexts.has(n)){if(a==ya.Required)return[!1,[]];continue}const e=Array.from(this.availableContexts.get(n).values()).reduce((e,t)=>e.concat(t),[]);if(0==e.length)throw new Error(`Assert: availableContexts have the entry for ${n} which does not contain any context annotation.`);t.push(...e)}return[!0,this.removeDuplicatedContextItems(t)]}removeDuplicatedContextItems(e){return e.filter((e,t,n)=>n.findIndex(t=>Yo.deepEquals(t,e))===t)}getContextAnnotations(e,t,n,a){var i,r;const o=n?Gr(n):void 0;return null===(r=null===(i=this.availableContexts.get(e))||void 0===i?void 0:i.get(t))||void 0===r?void 0:r.filter(e=>!(o&&Gr(e.parentPath)!=o||a&&e.source!=a))}onWorkflowDefinitionOverrideMessage(e){const t=new yn({operationName:"WorkflowDefinitionOverride",success:!0}).setClientMetadata(this.clientMetadata).start(),n=e=>{throw ts(t,e),Error(`WorkflowDefinitionOverride: ${e}`)};if(!this.localWorkflowManager)return void n("Not supported by this local SessionProxy instance.");const a=this.localWorkflowManager.getWorkflowDefinitionsByName(this),i=a.get(e.sourceWorkflowId);if(!i)return void n(`Workflow registration for source workflow '${e.targetWorkflowId}' was not found.`);t.resourceId=i.id;const r=a.get(e.targetWorkflowId);r&&(r.allowDefinitionOverride?i.definitionOverrideTargetWorkflows&&-1!==i.definitionOverrideTargetWorkflows.indexOf(r.id)?(this.workflowDefinitionManager.mergeWorkflowDefinition(r,e.definition,e.contextId),t.resultDescription=`Updated config for workflow: ${e.targetWorkflowId}, context id: ${e.contextId}`,ts(t)):n(`Workflow '${i.id}' does not allow workflow definition for workflow '${r.id}'.`):n(`Workflow '${r.id}' does not allow workflow definition override.`))}applyContextIdOnOperations(e){this.contextIdManager.applyContextIdOnOperations(e)}attachToWorkflowGraph(e){this.addToWorkflowGraph(e),this.attachExecutionTrackerToEachWorkflow()}triggerRegisteredAnnotationCallbacks(e,t,n,a){if(this.callAnnotationCallbacks(e,t,n,a),this.hostCallbacks.onAnnotationResult)try{a?this.hostCallbacks.onApologyResult&&this.hostCallbacks.onApologyResult(e,n):this.hostCallbacks.onAnnotationResult(e,n)}catch(e){Bn.error(540301151,aa.CoreDefault,new yn({operationName:"HostCallbackOnAnnotationResultError",dimension0:t,resultDescription:`onAnnotationResult error: ${e}`}))}}attachExecutionTrackerToEachWorkflow(){this.localWorkflowManager&&this.localWorkflowManager.attachExecutionTrackerToEachWorkflow(this.workflowGraph,this,this.onWorkflowExecutionComplete.bind(this))}onWorkflowExecutionCompleteMessage(e,t){t(void 0,new Ya),this.localWorkflowManager&&this.localWorkflowManager.onExternalWorkflowExecuted(e.contextId,e.workflowId,this)}onWorkflowExecutionComplete(e,t){}enableDeltaGenerator(){var e,t;this.deltaGenerator=null!==(e=this.deltaGenerator)&&void 0!==e?e:new Dr,this.syncDeltaTimers=null!==(t=this.syncDeltaTimers)&&void 0!==t?t:new Map}createDeltasFromUpdateOperation(e){var t,n;const a=[];Bn.info(523776396,aa.CoreDefault,`Calling delta create for UpdateOperation under parent path [${e.parentPath}] (${null===(t=e.items)||void 0===t?void 0:t.length} item(s), first item id: ${(null===(n=e.items)||void 0===n?void 0:n.length)>0?e.items[0].id:"(no items)"})`);let i=[...e.parentPath];for(const t of e.items){const n=[],r=this.deltaGenerator.createTextTileDeltasFromItem(t,e.parentPath);if(null==r?void 0:r.length){for(const a of r){const r=O();i=[...e.parentPath,t.id];const o={id:r,revId:t.revId,body:a,contextId:t.contextId,source:t.source};n.push(o)}n.length>0&&(a.push(new D({parentPath:i,items:n})),this.enableSyncDeltaSending&&this.setupSyncDeltaAfterDelay(t,i,n))}else Bn.info(523329632,aa.CoreDefault,`Failed to create delta on item ${t.id}`)}return a}setupSyncDeltaAfterDelay(e,t,n){var a,i,r;const o=this.syncDeltaTimers.get(e.id);o&&(clearTimeout(o),this.syncDeltaTimers.delete(e.id));const s=n.find(e=>{var t;return(null===(t=e.body)||void 0===t?void 0:t.unit)===za.Chars});if(s){const n=s.body,o={content:"",deltaType:Va.Update,length:0,position:(null!==(a=null==n?void 0:n.position)&&void 0!==a?a:0)+(null!==(r=null===(i=null==n?void 0:n.content)||void 0===i?void 0:i.length)&&void 0!==r?r:0),unit:za.Sentence},c=A.typeGuard(e.body)?new dr(o):new cr(o),d={id:O(),revId:e.revId,body:c,contextId:e.contextId,source:e.source},l=new D({parentPath:t,items:[d]}),u=setTimeout((e,t)=>{this.submitOperation(e),this.syncDeltaTimers.delete(t)},this.syncDeltaTimeout,l,e.id);this.syncDeltaTimers.set(e.id,u)}}addToWorkflowGraph(e){this.workflowGraph.addWorkflow(Fr(e))}getAnnotations(e,t){var n,a,i;const r=null!==(n=e.cv)&&void 0!==n?n:this.sessionManager.getCorrelationVector().newChild().toString(),o=new yn({operationName:"GetAnnotations",success:!0,resultSignature:"GetAnnotationsEntry",resourceId:`${e.sourceInfo.featureId}-${e.sourceInfo.entryPoint}`,cv:r}).setClientMetadata(this.clientMetadata).start();o.setDataFields({AnnotationType:null===(a=e.annotationType)||void 0===a?void 0:a.toString(),MaxDelayMs:null===(i=e.maxDelayMs)||void 0===i?void 0:i.toString()});const s=new or({annotationTypes:e.annotationType,transientItems:e.transientItems,configs:e.configs,maxDelayMs:e.maxDelayMs,sourceInfo:e.sourceInfo,caller:ra.Client,tryResolveUpstreamDependencies:e.tryResolveUpstreamDependencies,correlationInfo:{cvString:r},cv:r}),c=[];let d;ts(o),this.sendMessageToSession(s,(e,n)=>{(null==t?void 0:t.IsCancellationRequested)||(c.push({error:e,response:n}),null==d||d(!0))});const l=this;let u=!1;const f=new Promise((e,n)=>{null==t||t.onCancel(t=>{u?e():n(new Error(as.requestCancelledError))})});return{[Symbol.asyncIterator](){var e,n,a,i,r,s,p;return function(m,_,h){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var b,g=function*(){for(;!u;)try{0===c.length&&(yield es(Promise.race([new Promise(e=>d=e),f]))),o.resultSignature="AnnotationReceived";const m=c.shift();if(null==t?void 0:t.IsCancellationRequested)throw new Error(as.requestCancelledError);u=(null===(e=m.response)||void 0===e?void 0:e.finalResponse)||void 0!==m.error,o.setDataField("FinalResponse",u);const _=Ko(m.response);let h,b,g;if(o.setDataField("FirstUserPerceivedResponse",_),m.error){const e=`ErrorCode: ${m.error.code}, Error: ${m.error.error}, Retryable: ${m.error.retryable}`;o.setDataField("ServerError",e),g=m.error.error,h={serviceError:[{code:Yr.ServerError,error:m.error.error,retryable:null==l?void 0:l.canBeRetried(m.error)}]}}else if((null===(a=null===(n=m.response)||void 0===n?void 0:n.errorInfo)||void 0===a?void 0:a.length)>0){const e=m.response.errorInfo.map(e=>`ErrorCode: ${e.code}, Error: ${e.error}, Retryable: ${e.retryable}, ResourceId: ${e.resourceId}`).join("\n");o.setDataField("WorkflowErrors",e),g="Workflow execution error",h={serviceError:m.response.errorInfo}}else o.resultDescription="OK";if((null===(r=null===(i=m.response)||void 0===i?void 0:i.warningInfo)||void 0===r?void 0:r.length)>0){b={serviceError:m.response.warningInfo};const e=m.response.warningInfo.map(e=>`ErrorCode: ${e.code}, Error: ${e.error}, Retryable: ${e.retryable}, ResourceId: ${e.resourceId}`).join("\n");o.setDataField("WorkflowWarnings",e)}ts(o,g),yield yield es({content:null===(s=m.response)||void 0===s?void 0:s.content,error:null!=h?h:void 0,warning:null!=b?b:void 0,finalResponse:null===(p=m.response)||void 0===p?void 0:p.finalResponse})}catch(e){const t=e.message===as.requestCancelledError?Jr.RequestCancelled:Jr.Unknown;o.setDataField("ClientError",`ErrorCode: ${t}, Error: ${e.message}`),ts(o,null==e?void 0:e.message),yield yield es({content:void 0,error:{clientError:{code:t,error:null==e?void 0:e.message}}}),u=!0;break}}.apply(m,_||[]),v=[];return b={},y("next"),y("throw"),y("return"),b[Symbol.asyncIterator]=function(){return this},b;function y(e){g[e]&&(b[e]=function(t){return new Promise(function(n,a){v.push([e,t,n,a])>1||S(e,t)})})}function S(e,t){try{(n=g[e](t)).value instanceof es?Promise.resolve(n.value.v).then(D,I):x(v[0][2],n)}catch(e){x(v[0][3],e)}var n}function D(e){S("next",e)}function I(e){S("throw",e)}function x(e,t){e(t),v.shift(),v.length&&S(v[0][0],v[0][1])}}(this,arguments)}}}isHttpFallback(){const e=this.sessionManager.getNetworkWorkerManager();return!(!e||e.getInitNetworkMode()!==ia.JSWebSockets||e.getNetworkMode()!==ia.HttpFallback)}canBeRetried(e){return(null==e?void 0:e.code)===Xr.TooManyRequests||(null==e?void 0:e.code)===Xr.RequestTimeout||e.error.includes(po.ClientDisconnected)}getAuthToken(e,t){const n={Tickets:[]};this.clientMetadata.docSessionId&&(n.DocSessionId=this.clientMetadata.docSessionId);const a=(e=>{if(e===Sn.Substrate)return qr.Substrate})(e);a&&(n.TokenType=a),this.hostCallbacks.requestAuthToken(n).then(n=>{var a;if(!n)throw new Error("Missing AuthTokenResponse from requestAuthToken");if(!n.Token)throw new Error("Missing Token from requestAuthToken");t(void 0,n.Token,{returnedTokenType:e,timeToLiveSec:null===(a=n.TokenProperties)||void 0===a?void 0:a.timeToLiveSec})}).catch(e=>{t(e)})}resetNextSyncSequenceId(){this.nextSyncSequenceId=1}onReconnect(){if(this.annotationActivationTrackers.forEach(e=>{var t;this.activateAnnotationForTracker(e,{ignoreExistingAnnotations:!0,sendOnlyIfConnected:!0,sendApologies:void 0!==(null===(t=e.options)||void 0===t?void 0:t.apologyCallback)}).catch(()=>{})}),this.reconnectCallbacks.forEach((e,t)=>{e()}),!this.connectParams)throw new Error("Expected onConnect before onReconnect")}onSessionClose(e){this.isSessionClosed=!0,this.connectParams=void 0,this.sessionCloseCallbacks.forEach((t,n)=>{t(e)})}onConnect(e,t,n,a,i,r,o,s){const c=new yn({operationName:"OnConnect",success:!0}).setClientMetadata(this.clientMetadata).start();c.setDataField("HasSessionConnected",this.hasSessionConnected),c.setDataField("IsSeedingRequired",e),c.setDataField("SeedingStatus",this.seedingStatus);let d=!1;e&&(this.hasSessionConnected&&(this.allowSeed=!0,this.allowGroupSeed=!0,d=this.changeSeedingStatus(to.NotStarted,"ReconnectReset",!1),this.seedGroupSize=0,this.batchedSeedMessageGroupSize=0,this.seedBatchedOperationsManager&&(this.seedBatchedOperationsManager.removeAllBatchedItems(),this.seedBatchedOperationsManager=void 0),this.batchedOperationsManager&&(this.batchedOperationsManager.removeAllBatchedItems(),this.batchedOperationsManager=void 0)),this.cachedClaimsChallenge=Object.assign(Object.assign({},this.cachedClaimsChallenge),{claimsVersion:0})),this.enableRemoteExecutionNotification&&!this.hasSessionConnected&&this.addDownstreamWorkflowsIntoClientGraph(r),this.connectParams={isSeedingRequired:e,sessionUrl:t,origin:n,authToken:a,routingSessionKey:o,blobFileId:s},this.hasSessionConnected=!0,this.tryActivateWorkflows();for(const e of this.pendingConnectCallbacks)e(this.connectParams);this.connectCallbacks.forEach((i,r)=>{i(e,t,n,a,o,s)}),d&&this.triggerSeedingStatusChangeCallbacks(),this.serverInputTypes=i,this.onConnectTelemetryCG&&ts(c)}onDisconnect(e){this.connectParams=void 0,this.disconnectCallbacks.forEach((t,n)=>{t(e)})}onSeedingStatusChangeMessage(e,t){t(void 0,new Ya),this.changeSeedingStatus(e.newStatus,"SeedingStatusChangeMessage")}changeSeedingStatus(e,t,n=!0){const a=new yn({operationName:"SeedingStatusChange",success:!0}).setClientMetadata(this.clientMetadata).start();return a.setDataField("Status",to[e]),a.setDataField("Reason",t),ts(a),this.seedingStatus!=e&&(this.seedingStatus=e,n&&this.triggerSeedingStatusChangeCallbacks(),!0)}triggerSeedingStatusChangeCallbacks(){this.seedingStatusChangeCallbacks.forEach(e=>{e(new Pi({newStatus:this.seedingStatus}))})}onServerAuthenticationStateChange(e){if(e!=this.serverAuthenticationState){if(this.serverAuthenticationState==ja.Authenticated&&e==ja.Pending)return;const t=new yn({operationName:"ServerAuthStateChange",dimension0:ja[e],dimension1:ja[this.serverAuthenticationState],success:!0}).setClientMetadata(this.clientMetadata).start();t.resultDescription=`Changing Server Authentication State newState: ${ja[e]}, previousState: ${ja[this.serverAuthenticationState]}`,ts(t),this.serverAuthenticationState=e;for(const e of this.serverAuthenticationStateChangeCallback)e(this.serverAuthenticationState)}}callAnnotationCallbacks(e,t,n,a){if(0===this.annotationCallbacks.size&&0===this.apologyCallbacks.size)return;const i=a?this.apologyCallbacks.get(t):this.annotationCallbacks.get(t);i&&i.forEach(t=>{t(e,n)})}getOperationBatchConfig(e){let t;return t=this.batchMessagesEnabled?e=>({input:e,demultiplex:()=>[[]]}):e=>({input:e.filter(e=>e.length).reduce((e,t)=>e.concat(t),[]),demultiplex:()=>[[]]}),{delayMs:e.delayMs,delayMsMax:e.delayMsMax,maxInputSize:e.maxInputSize,estimateSize:Co,groupingKeyExtractor:()=>"operations",multiplex:t,split:e=>{if(!(e.length<=1))return{inputs:e.reduce((e,t)=>(e.push([t]),e),[]),join:()=>[]}}}}sendSeedMessagesViaBatchManager(e,t,n){if(!this.seedBatchedOperationsManager){let e;e=this.batchMessagesEnabled?(e,t,n)=>{if(this.batchedSeedMessageGroupSize+=e.length,e.length){const a=new yi;a.messages=[],e.forEach(e=>{a.messages.push(new Si({cv:e.cv,seq:0,ops:e.input,groupId:"Seed",groupSize:t.groupComplete?this.batchedSeedMessageGroupSize:void 0,groupComplete:t.groupComplete?t.groupComplete:void 0}))}),this.sendMessageToSession(a,e=>{n(e?new Error(e.error):void 0)})}}:(e,t,n)=>{this.seedGroupSize++,this.sendMessageToSession(new Si({cv:t.cv,seq:0,ops:e,groupId:"Seed",groupSize:t.groupComplete?this.seedGroupSize:void 0,groupComplete:t.groupComplete?t.groupComplete:void 0}),e=>{n(e?new Error(e.error):void 0)})},this.seedBatchedOperationsManager=new Mo(e,this.reduceBatchOperationsEnabled,this.batchMessagesEnabled,void 0,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled)}this.seedBatchedOperationsManager.addBatchItem(e,this.operationBatchConfig,{name:"SubmitSeedOperations"},n,t)}onAnnotationResultsFromServer(e,t){qo(e,Date.now(),"ReceiveFromNetwork",!0,new yn({operationName:"AugloopClientPerfTracker",success:!0}).setClientMetadata(this.clientMetadata).start()),this.onAnnotationResults(e,Zo.ServerWorkflow,t)}getLocalRegisteredWorkflows(){return this.localWorkflowManager?this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this).map(e=>Fr(e)):[]}sendWorkflowGraphInitMessage(){const e=this.getLocalRegisteredWorkflows(),t=new yn({operationName:"WorkflowGraphInit",success:!0}).setClientMetadata(this.clientMetadata).start(),n=new Li({upstreamRuntimeWorkflows:e});this.sendMessageToSession(n,(n,a)=>{n?ts(t,n.error):(t.resultDescription=`local workflows: ${e.map(e=>e.id)}, remote workflows: ${a.downstreamRuntimeWorkflows.map(e=>e.id)}`,ts(t),this.onWorkflowGraphInitResponse(a))})}trySendWorkflowGraphInitMessage(){!this.graphInitMessageTimer&&this.enableRemoteExecutionNotification&&(this.graphInitMessageTimer=setTimeout(()=>{this.graphInitMessageTimer=void 0,this.sendWorkflowGraphInitMessage()},10))}onWorkflowGraphInitResponse(e){this.addDownstreamWorkflowsIntoClientGraph(e.downstreamRuntimeWorkflows),this.tryActivateWorkflows()}addDownstreamWorkflowsIntoClientGraph(e){this.workflowGraph.removeWorkflows(!0);for(const t of e||[])this.workflowGraph.addWorkflow(t,!0);this.attachExecutionTrackerToEachWorkflow()}resolvePlaceholdersInOperationParentPath(e){let t=e;return 3==t.length&&"session"==t[0]&&"user"==t[1]&&t[2].startsWith("user_")&&(Bn.info(540848914,aa.CoreDefault,`Replacing user context placeholder for: ${Gr(e)}.`),t=["session","#userContext#"]),3==t.length&&"session"==t[0]&&"user"==t[1]&&t[2].startsWith("tenant_")&&(Bn.info(540848915,aa.CoreDefault,`Replacing tenant context placeholder for: ${Gr(e)}.`),t=["session","#tenantContext#"]),t}filterOperationsForSession(t){return((t,n)=>{if(!Array.isArray(n)||0===n.length)return!0;if(D.typeGuard(t)||m.typeGuard(t))return!0;for(const a of t.items)if(!a.body||e.matchesTypesFor(a.body,n))return!0;return!1})(t,this.serverInputTypes)}executeCallbacksOnAnnotationSubmitted(e,t){const{annotationOpsMap:n,apologyOpsMap:a}=this.getAnnotationOperationsByType(e);n.forEach((e,n)=>{Array.from(e).forEach(e=>this.triggerRegisteredAnnotationCallbacks(e,n,t,!1))}),a.forEach((e,n)=>{Array.from(e).forEach(e=>this.triggerRegisteredAnnotationCallbacks(e,n,t,!0))})}partitionAnnotationOperations(e){return e.reduce(([e,t],n)=>n.items.some(e=>e.body&&Pa.typeGuard(e.body))?[[...e,n],t]:[e,[...t,n]],[[],[]])}onAnnotationsSubmitted(e,t){const{annotationOpsMap:n,apologyOpsMap:a}=this.getAnnotationOperationsByType(e);n.forEach((e,n)=>{const a=Array.from(e);this.onAnnotationResults(new Ci({annotationType:n,ops:a,cv:t,areApologies:!1}),Zo.Submitted,()=>{})}),a.forEach((e,n)=>{const a=Array.from(e);this.onAnnotationResults(new Ci({annotationType:n,ops:a,cv:t,areApologies:!0}),Zo.Submitted,()=>{})})}getAnnotationOperationsByType(t){const n=new Map,a=new Map;for(const i of t)for(const t of i.items)if(t.body&&Pa.typeGuard(t.body)){const r=(e,t)=>{const n=e.get(t)||new Set;n.add(i),e.set(t,n)};yo.typeGuard(t.body)?r(a,t.body.annotationTypeName):r(n,e.getTypeNameFor(t.body))}return{annotationOpsMap:n,apologyOpsMap:a}}onClaimsChallengeMessage(e,t){var n;const a=new yn({operationName:"OnClaimsChallengeMessage",dimension0:e.claimsVersion.toString(),dimension1:e.error,success:!0}).setClientMetadata(this.clientMetadata).start(),i=e.claims&&e.claims.length>0;a.resultSignature=`HasClaims: ${i}`,a.resultDescription="Received Claims Challenge Message from Server",ts(a),e.claimsVersion>this.cachedClaimsChallenge.claimsVersion&&(this.cachedClaimsChallenge=Object.assign(Object.assign({},e),{actionRequired:!0})),(null===(n=this.gateUtils)||void 0===n?void 0:n.isChangeGateEnabledSync(mc))?this.requestAuthTokenInteractive(e).then(e=>{wi.typeGuard(e)&&this.invokeClaimsChallengeCallbacks()}).catch(()=>{}):this.invokeClaimsChallengeCallbacks(),t(void 0,new Ya)}generateCorrelationId(){return this.sessionManager.getCorrelationVector().newChild().toString()}onTokenProvisionResponse(e){e&&this.onServerAuthenticationStateChange(ja.Authenticated)}invokeClaimsChallengeCallbacks(){for(const e of this.claimsChallengeCallback)e(this.cachedClaimsChallenge)}requestAuthTokenWithClaims(e){this.requestAuthTokenInteractive(e).catch(()=>{})}requestAuthTokenInteractive(e,t){var n;const a=new yn({operationName:"RequestAuthTokenInteractive",success:!0,dimension0:`isInteractive: ${null!==(n=null==t?void 0:t.interactive)&&void 0!==n&&n}`}).start();a.dimension1=`HasClaims: ${!!e.claims&&e.claims.length>0}`;const i={Tickets:[],DocSessionId:this.clientMetadata.docSessionId,TokenType:qr.Augloop,ConnectParams:this.connectParams,Claims:e.claims,Interactive:null==t?void 0:t.interactive};return this.hostCallbacks.requestAuthToken(i).then(t=>{if(!t)throw new Error("Missing AuthTokenResponse from requestAuthToken claims");if(!t.Token)throw new Error("Missing Token from requestAuthToken claims");return a.resultSignature="Token",new Oi({authToken:t.Token,version:++this.tokenMessageVersion,claimsVersion:e.claimsVersion})}).catch(t=>(a.resultSignature="NoToken",a.dimension2=t.message,new wi({reason:t.message,version:++this.tokenMessageVersion,claimsVersion:e.claimsVersion,clientHandlesResponse:!0}))).then(e=>new Promise((t,n)=>{this.sendMessageToSession(e,(i,r)=>{ts(a,null==i?void 0:i.error),i?n(new Error(i.error)):(Oi.typeGuard(e)&&(this.cachedClaimsChallenge.actionRequired=!1,this.onTokenProvisionResponse(r)),t(e))})}))}ensureConnection(){return Promise.resolve()}keepAlive(){}}as.requestCancelledError="Request cancelled";class is{constructor(e){this.item=e,this.operation=e.op,this.delta=e.delta,this.deltas=e.deltas,this.id=Gr(this.itemPath),this.revId=e.revId}get itemPath(){return[...this.item.parentPath,this.item.id]}getModelIterator(){throw new Error("Method not implemented.")}getBody(){return this.item.body}getItemReference(){throw new Error("Method not implemented.")}getParentItem(e){throw new Error("Method not implemented.")}getParentItemBody(e){throw new Error("Method not implemented.")}getPrevItem(e,t){throw new Error("Method not implemented.")}getPrevItemBody(e,t){throw new Error("Method not implemented.")}getNextItem(e,t){throw new Error("Method not implemented.")}getNextItemBody(e,t){throw new Error("Method not implemented.")}getChildItem(e){throw new Error("Method not implemented.")}getChildItemBody(e){throw new Error("Method not implemented.")}getChildItems(e){throw new Error("Method not implemented.")}getChildItemBodies(e){throw new Error("Method not implemented.")}getSubtreeItem(e){throw new Error("Method not implemented.")}getSubtreeItemBody(e){throw new Error("Method not implemented.")}getSubtreeItems(e){throw new Error("Method not implemented.")}getSubtreeItemBodies(e){throw new Error("Method not implemented.")}getContextItem(e){throw new Error("Method not implemented.")}getContextItemBody(e){throw new Error("Method not implemented.")}getContextItems(e){throw new Error("Method not implemented.")}getContextItemBodies(e){throw new Error("Method not implemented.")}addAnnotation(e,t){throw new Error("Method not implemented.")}updateAnnotation(e,t){throw new Error("Method not implemented.")}deleteAnnotation(e){throw new Error("Method not implemented.")}loadSubtree(e){throw new Error("Method not implemented.")}getSourceTimestamp(){return this.item.sourceTimestamp}getContextId(){return this.item.contextId}}class rs{constructor(t,n=[]){this.scopeItem=void 0,this.rootItem=void 0,this.normalizeFilter=t=>{if(!t)return e=>void 0!==e;if("function"==typeof t)throw new Error("Not implemented yet");if((t.id?1:0)+(t.ids?1:0)+(t.itemType?1:0)+(t.itemTypes?1:0)!=1)throw new Error("Exactly one condition expected on IItemFilter");if(t.itemType)return n=>n&&e.matchesTypesFor(n.body,[t.itemType]);if(t.itemTypes)return n=>n&&e.matchesTypesFor(n.body,t.itemTypes);throw new Error("Not implemented yet")},this.items=[...n,t],this.scopeItem=new is(t)}getItem(e){throw new Error("Method not implemented.")}getItems(e){throw new Error("Method not implemented.")}getItemBody(e){return this.getItemBodies(e)[0]}getItemBodies(e){const t=this.normalizeFilter(e);return this.items.filter(t).map(e=>e.body)}getItemByReference(e){throw new Error("Method not implemented.")}getItemBodyByReference(e){throw new Error("Method not implemented.")}}const os=[Va.CursorUpdate,Va.FormattingUpdate,Va.OtherNonContentUpdate,Va.AttributionUpdate];function ss(t,n,a){const i=new yn({operationName:"ApplyTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0}).start();try{if(!n)return i.success=!1,i.resultDescription="Unable to apply text tile delta, parent tile is undefined",void Bn.info(538798173,aa.CoreDefault,i.stop());if(e.getTypeNameFor(n)!==E.getTypeName())return i.success=!1,i.resultDescription=`Unable to apply text tile delta, parent tile is not proper type: expected ${cr.getTypeName()}, received ${e.getTypeNameFor(n)}`,void Bn.info(538798174,aa.CoreDefault,i.stop());const a=t,r=n.content;let o="";if(void 0===a.position||a.position<0)return i.success=!1,i.resultDescription="Unable to apply text tile delta, invalid text tile position",void Bn.info(538798175,aa.CoreDefault,i.stop());switch(a.deltaType){case Va.Add:o=a.position<r.length?`${r.slice(0,a.position)}${a.content}${r.slice(a.position,r.length)}`:r+a.content;break;case Va.Update:a.content||a.unit!==za.Sentence||(i.dimension0="1"),o=`${r.slice(0,a.position)}${a.content}${r.slice(a.position+(a.length||0),r.length)}`;break;case Va.Delete:o=`${r.slice(0,a.position)}${r.slice(a.position+(a.length||0),r.length)}`}return Bn.info(538837071,aa.CoreDefault,i.stop()),new E({content:o})}catch(e){return i.success=!1,i.resultDescription=`Error applying text tile delta: ${e}`,void Bn.info(538798176,aa.CoreDefault,i.stop())}}function cs(e,t){var n,a,i,r,o;const s=(null===(n=t.attributionData)||void 0===n?void 0:n.ranges)||t.attributionRanges;if((null===(a=t.attributionData)||void 0===a?void 0:a.isFullUpdate)||t.deltaType!==Va.AttributionUpdate&&void 0!==s)return s;if(!(null===(i=e.attributionRanges)||void 0===i?void 0:i.length)&&!s||t.deltaType===Va.Update&&0===t.length)return e.attributionRanges;let c=e.attributionRanges?[...e.attributionRanges]:[];if(t.deltaType!==Va.AttributionUpdate){const n=ls(e.attributionRanges,t.deltaType,t.position),a=n?c.indexOf(n):-1;-1!==a&&(n.length=t.position-n.start);const i=(null!==(r=t.content)&&void 0!==r?r:"").length,s=null!==(o=t.length)&&void 0!==o?o:0,d=t.position+s,l=t.position+i;for(const e of c.slice(a+1)){if(e.start<t.position)continue;const n=e.start+e.length;d>e.start&&(e.length=n-d),e.start=Math.max(e.start+i-s,l)}return c=c.filter(e=>e.length>0),c}const d=[];for(const e of s)0!==d.length&&d[d.length-1].start+d[d.length-1].length>=e.start?d[d.length-1].length=e.start+e.length-d[d.length-1].start:d.push({start:e.start,length:e.length});c=c.filter(e=>e.length>0&&!(e=>{for(const t of d)if(t.start<=e.start&&t.start+t.length>=e.start+e.length)return!0;return!1})(e)),null==s||s.forEach(e=>{c.push(e)}),c.sort((e,t)=>e.start-t.start);const l=[];for(const e of c){const t=l.length>0?l[l.length-1]:void 0;t&&t.start+t.length>e.start&&(t.length=Math.max(e.start-t.start,0)),!t||(f=e,(u=t).attribution.userId!==f.attribution.userId||u.attribution.timestamp!==f.attribution.timestamp||u.attribution.dataSource!==f.attribution.dataSource)||e.start>t.start+t.length?l.push(e):t.length+=Math.max(e.start+e.length-(t.start+t.length),0)}var u,f;return l}function ds(t,n,a){var i,r,o,s;const c=new yn({operationName:"ApplyFormattedTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0}).start();c.clientFlights=a;try{if(!n)return c.success=!1,c.resultDescription="Unable to apply formatted text tile delta, parent tile is undefined",void Bn.info(538798177,aa.CoreDefault,c.stop());if(e.getTypeNameFor(n)!==A.getTypeName())return c.success=!1,c.resultDescription=`Unable to apply formatted text tile delta, parent tile is not proper type: expected ${A.getTypeName()}, received ${e.getTypeNameFor(n)}`,void Bn.info(538798178,aa.CoreDefault,c.stop());const a=n,d=t,l=a.content;let u="";if((void 0===d.position||d.position<0)&&!fs(d.deltaType))return c.success=!1,c.resultDescription="Unable to apply formatted text tile delta, invalid text tile position",void Bn.info(538798179,aa.CoreDefault,c.stop());if(void 0===d.content&&!fs(d.deltaType))return c.success=!1,c.resultDescription="Unable to apply formatted text tile delta, non-delete, non-formatting, non-other-non-content-update and non-cursor-update operation without content defined",void Bn.info(538798208,aa.CoreDefault,c.stop());if(d.deltaType===Va.Add&&0!==d.length?Bn.info(538798209,aa.CoreDefault,new yn({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta add operation with delta length, expected length 0",success:!0})):fs(d.deltaType)&&void 0!==d.content&&Bn.info(538798210,aa.CoreDefault,new yn({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta delete or non-content related operation with content defined, expected undefined",success:!0})),!us(d.deltaType)){const e=function(e,t){var n,a,i,r;const o=ls(e.formattedRanges,t.deltaType,t.position);let s=e.formattedRanges?[...e.formattedRanges]:[];const c=o?s.indexOf(o):-1;-1!==c&&(t.position+(t.length||0)>o.start+o.length?o.length=t.position+(null!==(n=t.content)&&void 0!==n?n:"").length-o.start:o.length+=(null!==(a=t.content)&&void 0!==a?a:"").length-(t.length||0),s[c]=o);for(const e of s.slice(c+1))e.start<t.position||(t.position+(t.length||0)>e.start?(e.length=e.start+e.length-(t.position+(t.length||0)),e.start=t.position+(null!==(i=t.content)&&void 0!==i?i:"").length):e.start+=(null!==(r=t.content)&&void 0!==r?r:"").length-(t.length||0));return s=s.filter(e=>e.length>0),s}(a,d),t=cs(a,d);let n=a.ipPosition;switch(d.deltaType){case Va.Add:u=d.position<l.length?`${l.slice(0,d.position)}${d.content}${l.slice(d.position,l.length)}`:l+d.content,n=d.position+d.length;break;case Va.Update:d.content||d.unit!==za.Sentence||(c.dimension0="1"),u=`${l.slice(0,d.position)}${d.content}${l.slice(d.position+(null!==(i=d.length)&&void 0!==i?i:0),l.length)}`,n=d.position+d.content.length;break;case Va.Delete:u=`${l.slice(0,d.position)}${l.slice(d.position+(null!==(r=d.length)&&void 0!==r?r:0),l.length)}`,n=d.position}const o=new A(Object.assign(Object.assign({},a),{ipPosition:n,content:u,formattedRanges:e,attributionRanges:t,queryRange:d.queryRange}));return Bn.info(538837073,aa.CoreDefault,c.stop()),o}if(d.deltaType===Va.CursorUpdate)return new A(Object.assign(Object.assign({},a),{ipPosition:null===(o=d.cursorData)||void 0===o?void 0:o.ipPosition,isColdIp:null===(s=d.cursorData)||void 0===s?void 0:s.isColdIp}));if(d.deltaType===Va.FormattingUpdate)return new A(Object.assign(Object.assign({},a),{formattedRanges:d.formattedRanges}));if(d.deltaType===Va.OtherNonContentUpdate){let e;const t={};for(e in d.otherNonContentData)t[e]=d.otherNonContentData[e];return new A(Object.assign(Object.assign({},a),t))}return d.deltaType===Va.AttributionUpdate?new A(Object.assign(Object.assign({},a),{attributionRanges:cs(a,d)})):void 0}catch(e){return c.success=!1,c.resultDescription=`Error applying formatted text tile delta: ${e}`,void Bn.info(538798211,aa.CoreDefault,c.stop())}}function ls(e,t,n){const a=new yn({operationName:"FindRangeForDelta",success:!0});if(a.start(),!e)return a.resultDescription="No formatted ranges found within the tile, skipping.",void Bn.info(538798212,aa.CoreDefault,a.stop());if(t===Va.Add){const t=e.find(e=>e.start===n&&0===e.length);if(t)return a.resultDescription=`Found a zero-length formatted range for add operation with start ${t.start}.`,Bn.info(538798213,aa.CoreDefault,a.stop()),t;n=Math.max(n-1,0)}const i=e.find(e=>0===e.length?e.start===n:e.start<=n&&n<e.start+e.length);return i?(a.resultDescription=`Updating formatted range for operation with start: ${i.start} and length: ${i.length}`,Bn.info(538798214,aa.CoreDefault,a.stop())):(a.resultDescription=`Unable to find formatted range for operation at position ${n}, skipping.`,Bn.info(538798215,aa.CoreDefault,a.stop())),i}function us(e){return-1!==os.indexOf(e)}function fs(e){return us(e)||Va.Delete===e}class ps{constructor(e){this.model=e.model,this.clientMetadata=e.clientMetadata,this.userContext=e.userContext,this.site=e.site,this.getTokenCallback=e.getTokenCallback}get flights(){var e;return null!==(e=this._flights)&&void 0!==e||(this._flights=oa(this.clientMetadata.flights)),this._flights}getToken(e,t){return this.getTokenCallback(e,t)}getTokenAsync(e){return new Promise((t,n)=>{this.getToken(e,(e,a,i)=>{e?n(e):t(Object.assign(Object.assign({},i),{token:a}))})})}}class ms{constructor(e,t,n){this.itemsContextId=new Set,this.executionState=new Map,this.graphNode=e,this.onContextIdWorkflowExecutionComplete=t,n&&(this.itemsContextId=n.itemsContextId,this.executionState=n.executionState)}addInputItemToProcess(e){this.itemsContextId.add(e)}removeProcessedInputItem(e){this.itemsContextId.delete(e)}countItemsToProcess(e){let t=0;for(const n of this.itemsContextId)0===n.indexOf(e)&&(t+=1);return t}getExecutionState(){return this.executionState}setExecutionState(e,t){return this.graphNode.isActivated?e?(this.executionState.set(e,t),!0):(Bn.info(520217546,aa.CoreDefault,new yn({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,joinContextId:e,resultDescription:`Trying to set state ${t} for a undefined contextId (setExecutionState)`})),!1):(Bn.info(508883415,aa.CoreDefault,new yn({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,joinContextId:e,resultDescription:`Trying to set state ${t} for a not activated workflow`})),!1)}beforeWorkflowExecution(e){this.setExecutionState(e,Vr.Pending)}afterWorkflowExecution(e){this.setExecutionState(e,Vr.Executed)&&this.tryToCompleteWorkflowExecution(e)}clearWorkflowExecutions(){this.executionState.forEach((e,t)=>this.afterWorkflowExecution(t))}tryToCompleteWorkflowExecution(e){if(this.executionState.get(e)===Vr.Executed&&this.canCompleteExecution(e)){this.executionState.delete(e),this.onContextIdWorkflowExecutionComplete&&this.onContextIdWorkflowExecutionComplete(this.graphNode.workflow.id,e);for(const t of this.downstreamWorkflowExecutionTrackers)for(const[n,a]of t.getExecutionState())a===Vr.Executed&&jr.isParentContextId(e,n)&&t.tryToCompleteWorkflowExecution(n)}}canCompleteExecution(e){for(const t of this.upstreamWorkflowExecutionTrackers)for(const n of t.getExecutionState().keys())if(jr.isParentContextId(n,e))return!1;return!0}}var _s;!function(e){e.Unknown="",e.InputReceived="input",e.JoinMaxAnnnotation="maxAnnotation",e.JoinMaxTimeout="maxTimeout",e.JoinEarlyCompletion="earlyCompletion"}(_s||(_s={}));class hs{constructor(t,n,a){this.executionTrackersByWorkflowNameBySession=new Map,this.workflowsWithSessionAffinity=new Map,this.workflowDefinitionsWithSessionAffinity=[],this.workflowsWithoutSessionAffinity=[],this.pendingScopeExecutionNotificationsByWorkflow=new Map,this.sweepIntervalMs=200,this.sweepTimers=new Map,this.getResourceAsArrayBuffer=(e,t,n)=>this.modelDownloader?this.modelDownloader.getResourceAsArrayBuffer(e,t,n):Promise.reject(new Error("Resource Downloader never created")),this.getResourceAsURL=(e,t,n)=>this.modelDownloader?this.modelDownloader.getResourceAsURL(e,t,n):Promise.reject(new Error("Resource Downloader never created")),this.createModel=e=>(!this.inferenceService&&this.inferenceServiceFactory&&(this.inferenceService=this.inferenceServiceFactory()),this.inferenceService?this.inferenceService.then(t=>t.createModel(e)):Promise.reject(new Error("Inference Service never created"))),this.createModelInputs=()=>{if(!this.inferenceService&&this.inferenceServiceFactory&&(this.inferenceService=this.inferenceServiceFactory()),this.inferenceService)return this.inferenceService.then(e=>e.createInputs());throw new Error("Inference Service never created")},this.nextAnnotationId=1,this.nextSignalId=1,this.modelDownloader=t,this.inferenceServiceFactory=n,a.enableDeltas&&(this.deltaHandlers=(new Map).set(e.getTypeNameFor(cr),ss).set(e.getTypeNameFor(dr),ds),this.itemsForDelta=new Map),this.enableEarlyJoin=a.enableEarlyJoin||!1,this.site={getResourceAsArrayBuffer:this.getResourceAsArrayBuffer,getResourceAsURL:this.getResourceAsURL,createModel:this.createModel,createModelInputs:this.createModelInputs}}getNextClientAnnotationId(){return"#AC"+this.nextAnnotationId++}getNextClientSignalId(){return"#SC"+this.nextSignalId++}registerLocalWorkflow(e,t){const n=new yn({operationName:"WorkflowRegistration",resourceId:e.id}).start();if(0===e.inputTypes.length)throw new Error("Invalid workflow params");t?(this.workflowsWithSessionAffinity.get(t).push(this.createWorkflowImplementation(e,t)),t.registerContextTypes(wo(e.requestedContextTypesRules).map(([e,t])=>e)),t.attachToWorkflowGraph(e),n.setClientMetadata(t.getClientMetadata())):(e.isStateful?(this.workflowDefinitionsWithSessionAffinity.push(e),this.workflowsWithSessionAffinity.forEach((t,n)=>{t.push(this.createWorkflowImplementation(e,n))})):this.workflowsWithoutSessionAffinity.push(this.createWorkflowImplementation(e)),this.workflowsWithSessionAffinity.forEach((t,n)=>{n.registerContextTypes(wo(e.requestedContextTypesRules).map(([e,t])=>e)),n.attachToWorkflowGraph(e)})),n.success=!0,Bn.info(572838110,aa.CoreDefault,n.stop())}getAllRegisteredWorkflowsFromSession(e){const t=[];return t.push(...this.workflowsWithoutSessionAffinity||[]),t.push(...this.workflowsWithSessionAffinity.get(e)||[]),t.map(e=>e.workflow)}getWorkflowDefinitionsByName(e){var t;const n=new Map;return null===(t=this.workflowsWithSessionAffinity.get(e))||void 0===t||t.forEach(e=>n.set(e.workflow.id,e.workflow)),n}getWorkflowDefinitionsWithSessionAffinity(){return this.workflowDefinitionsWithSessionAffinity}attachExecutionTrackerToEachWorkflow(e,t,n){const a=e.getWorkflowNodes(),i=this.executionTrackersByWorkflowNameBySession.get(t),r=(e,a)=>{if(n&&n(e,a),this.enableEarlyJoin){const e=()=>{var e;for(const n of(null===(e=this.executionTrackersByWorkflowNameBySession.get(t))||void 0===e?void 0:e.values())||[])if(n.graphNode.workflow.kind===_a.Join)for(const e of n.getExecutionState().keys())if(jr.isParentContextId(e,a))return!0;return!1};e()&&(this.cancelSweepTimer(t),this.ensureSweepTimer(t),this.sweepScopeExecutionNotifications())}};if(i){for(const e of a){const t=i.get(e.workflow.id),n=new ms(e,r.bind(this),t);i.set(e.workflow.id,n)}for(const e of i.values())this.setDownstreamWorkflowExecutionTrackers(e,i),this.setUpstreamWorkflowExecutionTrackers(e,i)}}canActivateWorkflow(e,t){var n;return e.location===Or.Local||!!t.hasConnected&&!((null===(n=e.workflow.requiredTokenTypes)||void 0===n?void 0:n.length)>0&&t.getServerAuthenticationState()===ja.NotAuthenticated)}setDownstreamWorkflowExecutionTrackers(e,t){if(void 0!==e.downstreamWorkflowExecutionTrackers)return;e.downstreamWorkflowExecutionTrackers=new Set;const{graphNode:n}=e;for(const a of n.downstreamWorkflows||[]){const n=t.get(a.workflow.id);this.setDownstreamWorkflowExecutionTrackers(n,t),e.downstreamWorkflowExecutionTrackers.add(n)}}setUpstreamWorkflowExecutionTrackers(e,t){if(void 0!==e.upstreamWorkflowExecutionTrackers)return;e.upstreamWorkflowExecutionTrackers=new Set;const{graphNode:n}=e;for(const a of n.upstreamWorkflows||[]){const n=t.get(a.workflow.id);this.setUpstreamWorkflowExecutionTrackers(n,t),e.upstreamWorkflowExecutionTrackers.add(n)}}deactivateServerWorkflow(e,t){var n,a;e.location!==Or.Local&&(null===(a=null===(n=this.executionTrackersByWorkflowNameBySession.get(t))||void 0===n?void 0:n.get(e.workflow.id))||void 0===a||a.clearWorkflowExecutions(),e.isActivated=!1)}addSession(e){this.isWorkflowTrackingEnabled(e)&&this.executionTrackersByWorkflowNameBySession.set(e,new Map);const t=[];for(const n of this.workflowDefinitionsWithSessionAffinity)t.push(this.createWorkflowImplementation(n)),e.attachToWorkflowGraph(n);this.workflowsWithSessionAffinity.set(e,t);for(const t of this.workflowsWithoutSessionAffinity)e.attachToWorkflowGraph(t.workflow)}isWorkflowTrackingEnabled(e){return this.enableEarlyJoin||e.enabledRemoteExecutionNotification()}closeSession(e){this.cancelSweepTimer(e);for(const t of this.workflowsWithSessionAffinity.get(e)||[])t.workflowLambda.dispose();this.workflowsWithSessionAffinity.delete(e),this.isWorkflowTrackingEnabled(e)&&this.executionTrackersByWorkflowNameBySession.delete(e)}setTokenCallback(e){this.getAuthTokenCallback=e}preProcessItemToWorkflow(t,n,a){var i;const r=null===(i=this.executionTrackersByWorkflowNameBySession.get(a))||void 0===i?void 0:i.get(t.id);r&&(t.kind===_a.Join&&e.matchesTypesFor(n.body,t.inputTypes)&&r.addInputItemToProcess(n.contextId),(t.kind===_a.SingleItem&&e.matchesTypesFor(n.body,t.inputTypes)||t.kind===_a.Join&&e.matchesTypesFor(n.body,[t.collectionScopeType]))&&r.beforeWorkflowExecution(n.contextId))}isReadyToEarlyJoin(e,t,n){if(!e)return!1;const a=a=>{var i;const r=Array.from(null!==(i=a.states)&&void 0!==i?i:[]).map(e=>`${e[0]}: ${e[1].map(e=>e.join())}`).join(),o=new yn({operationName:"EarlyJoinCompletion",resourceId:e.graphNode.workflow.id,joinContextId:t,success:!0}).start();o.setClientMetadata(n),o.resultDescription=`isReadyToEarlyJoin (${this.enableEarlyJoin}) -> hasProcessedAllInputItems: ${a.hasProcessedAllInputItems}, allUpstreamComplete: ${a.allUpstreamComplete}, states: ${r}`,Bn.info(512550800,aa.CoreDefault,o.stop())},i=0===e.countItemsToProcess(t);if(!i)return this.enableEarlyJoin||a({hasProcessedAllInputItems:i}),!1;const{allUpstreamComplete:r,states:o}=this.areAllUpstreamWorkflowComplete(e,t);return this.enableEarlyJoin?r:(a({hasProcessedAllInputItems:i,allUpstreamComplete:r,states:o}),!1)}areAllUpstreamWorkflowComplete(e,t){const n=new Map;for(const a of e.upstreamWorkflowExecutionTrackers){const e=[];for(const[i,r]of a.getExecutionState())if(e.push([i,r]),jr.isParentContextId(t,i))return n.set(a.graphNode.workflow.id,e),{allUpstreamComplete:!1,states:n};e.length>0&&n.set(a.graphNode.workflow.id,e)}return{allUpstreamComplete:!0,states:n}}runLocalWorkflows(t,n,a=!1){var i,r,o;const s=(t,a,i)=>{var r,o;const s=n.getWorkflowItemStorage(),{workflow:c}=t,d=null===(r=this.executionTrackersByWorkflowNameBySession.get(n))||void 0===r?void 0:r.get(c.id),l=c.inputTypes.concat(c.kind===_a.Join?c.collectionScopeType:[]),u=new yn({operationName:"RunLocalWorkflows",success:!0,resourceId:c.id,joinContextId:a.contextId}).start();if(u.setClientMetadata(n.getClientMetadata()),e.matchesTypesFor(a.body,l)){const r=zr(i.parentPath,a);if(c.kind===_a.Join){if(e.matchesTypesFor(r.body,[c.collectionScopeType]))return s.setScopeItem(r,c),u.resultDescription=`Scope item: ${a.id} (${e.getTypeNameFor(a.body)})`,Bn.info(524126153,aa.CoreDefault,u.stop()),void this.setScopeExecutionNotification(n,t,r);{null==d||d.removeProcessedInputItem(r.contextId);const t=s.getScopeItem(r.contextId,c);if(!t)return u.resultDescription=`Filtered out join invalidation: out of scope type (${c.collectionScopeType}), item id: ${r.id}`,void Bn.info(541173894,aa.CoreDefault,u.stop());s.addItemToWorkflowList(r,c),u.joinContextId=t.contextId,u.resultDescription=`Input item: ${a.id} (${e.getTypeNameFor(a.body)})`}}if(e.getBaseTypesFor(r.body).indexOf(Yt.getTypeName())>=0){const e=[...r.parentPath,r.id];let t=!0;for(const a of null!==(o=c.outputTypes)&&void 0!==o?o:[])if(!n.getContextAnnotations(a,Zo.LocalWorkflow,e,c.id)){t=!1;break}if(t)return}const l=()=>{var e;const[i,o]=n.resolveRequestedContexts(c);if(!i)return u.resultDescription=`Required contexts are not ready for ${c.id}. Retrying execution in 500 milliseconds...`,Bn.info(545837259,aa.CoreDefault,u.stop()),void setTimeout(l,500);if(c.kind===_a.SingleItem)this.queueWorkflow({workflowInfo:t,scopeItem:r,inputItems:[r],requestedContexts:o,session:n,triggerReason:_s.InputReceived,onCompleteCallback:this.onWorkflowExecuted.bind(this,r,c,n)}).then(()=>{Bn.info(509154263,aa.WorkflowDefault,u.stop())}).catch(e=>{u.resultDescription=e,Bn.error(572838111,aa.CoreDefault,u.stop())});else if(c.kind===_a.Join){const i=a.contextId,r=s.getScopeItem(i,t.workflow);if(!r)return u.resultDescription=`No scope item for ${c.id} workflow from contextId ${i}`,void Bn.info(526758475,aa.CoreDefault,u.stop());const l=this.isReadyToEarlyJoin(d,r.contextId,n.getClientMetadata()),f=l?_s.JoinEarlyCompletion:_s.JoinMaxAnnnotation;if(s.isWorkflowReady(r.contextId,c)||l){if(!(null===(e=this.pendingScopeExecutionNotificationsByWorkflow.get(c.id))||void 0===e?void 0:e.get(r.contextId)))return u.resultDescription=`Workflow ${c.id}, contextId ${r.contextId}, already queued, skipping new scope execution`,void Bn.info(528048977,aa.CoreDefault,u.stop());const a=s.getItemsToExecute(r.contextId,c);this.queueWorkflow({workflowInfo:t,scopeItem:r,inputItems:a,requestedContexts:o,session:n,triggerReason:f,onCompleteCallback:this.onWorkflowExecuted.bind(this,r,c,n)}).then(()=>{Bn.info(509154262,aa.WorkflowDefault,u.stop())}).catch(e=>{u.resultDescription=e,Bn.error(541173895,aa.CoreDefault,u.stop())}),this.pendingScopeExecutionNotificationsByWorkflow.get(c.id).delete(r.contextId),0===this.pendingScopeExecutionNotificationsByWorkflow.get(c.id).size&&this.pendingScopeExecutionNotificationsByWorkflow.delete(c.id)}}};l()}};let c=t;a&&(c=[new f({parentPath:["session"],items:[{id:"#userContext#",body:new Jt}]}),new f({parentPath:["session"],items:[{id:"#tenantContext#",body:new Xt}]})],n.getContextIdManager().applyContextIdOnOperations(c),c=c.concat(t));for(const t of c){const a=e.getTypeNameFor(t);for(const e of t.items)if(n.applyOperationForContext(t,e,Zo.Submitted),a!==h.getTypeName()){if(e.body)if(a===D.getTypeName()&&this.deltaHandlers&&this.itemsForDelta)this.handleLocalDeltaUpdate(e,t,n);else{null===(r=this.itemsForDelta)||void 0===r||r.set(t.parentPath.concat(e.id).toString(),e);for(const n of this.workflowsWithoutSessionAffinity)s(n,e,t);for(const a of null!==(o=this.workflowsWithSessionAffinity.get(n))&&void 0!==o?o:[])s(a,e,t)}}else null===(i=this.itemsForDelta)||void 0===i||i.delete(t.parentPath.concat(e.id).toString())}}handleLocalDeltaUpdate(t,n,a){const i=new yn({operationName:"LocalDeltaUpdate",dimension0:e.getTypeNameFor(t.body),success:!0});i.start();try{const r=this.deltaHandlers.get(e.getTypeNameFor(t.body)),o=this.itemsForDelta.get(n.parentPath.toString());if(r&&o){const e=n.parentPath.length>0?n.parentPath.slice(0,n.parentPath.length-1):n.parentPath,s=r(t.body,o.body);if(s){const n={id:o.id,revId:t.revId,body:s,parentPath:e,delta:t.body,contextId:t.contextId},r=new l({parentPath:n.parentPath,items:[n]});Bn.info(539637591,aa.CoreDefault,i.stop()),this.runLocalWorkflows([r],a)}else i.success=!1,i.resultDescription="Failed because the handler did not produce valid updated item",Bn.info(539637592,aa.CoreDefault,i.stop())}else i.success=!1,i.resultDescription="Failed due to lack of handler or parent item",Bn.info(539637593,aa.CoreDefault,i.stop())}catch(e){i.success=!1,i.resultDescription=`Failed to apply delta, error: ${e}`,Bn.info(539637594,aa.CoreDefault,i.stop())}}createWorkflowImplementation(e,t){const n=e.factory();return{workflow:e,workflowLambda:n,initPromise:this.initWorkflow(e.kind,n,t)}}initWorkflow(e,t,n){const a=new ps({model:void 0,clientMetadata:n?n.getClientMetadata():void 0,userContext:n?n.getUserContext():void 0,site:this.site,getTokenCallback:this.getAuthTokenCallback});return e===_a.SingleItem||e===_a.Join?t.init(this.site,a):Promise.resolve()}queueWorkflow(e){var t,n;return null===(n=null===(t=this.executionTrackersByWorkflowNameBySession.get(e.session))||void 0===t?void 0:t.get(e.workflowInfo.workflow.id))||void 0===n||n.setExecutionState(e.scopeItem.contextId,Vr.Running),this.executeLocalWorkflow(e.workflowInfo,e.scopeItem,e.inputItems,e.session,e.requestedContexts,e.triggerReason).then(t=>{this.processAnnotationResults(t,e.session),e.onCompleteCallback()}).catch(t=>{throw e.onCompleteCallback(),t})}processAnnotationResults(e,t){for(const n of e)t.onAnnotationResults(n,Zo.LocalWorkflow,()=>{})}executeLocalWorkflow(t,n,a,i,r,o){return new Promise((s,c)=>{var d,l,u;const p=[],m=t.workflow,h=new yn({operationName:"ExecuteWorkflow",resourceId:m.id,joinContextId:null!==(d=null==n?void 0:n.contextId)&&void 0!==d?d:"",resultDescription:null!=o?o:"",success:!0}).setClientMetadata(i.getClientMetadata());h.start();const b=null!==(l=null==n?void 0:n.contextId)&&void 0!==l?l:a[0].contextId,g=null!==(u=null==n?void 0:n.revId)&&void 0!==u?u:a[0].revId,v=(()=>{const t=new Map;if(n&&(n.parentPath||Bn.error(525382231,aa.CoreDefault,`Missing scope item parent. Workflow: ${m.id}. Type: ${e.getTypeNameFor(n.body)}`),t.set(n.body,n)),Array.isArray(a))for(const n of a)n&&n.body&&(n.parentPath||Bn.error(525382232,aa.CoreDefault,`Missing parent. Workflow: ${m.id}. Type: ${e.getTypeNameFor(n.body)}`),t.set(n.body,n));return t})(),y=(e,t=h)=>{if(e)return t.success=!1,t.resultDescription+="string"==typeof e?e:e.message,t.resultSignature="Exception",Bn.error(572838112,aa.CoreDefault,t.stop()),"string"==typeof e?new Error(e):e;Bn.info(572838113,aa.CoreDefault,t.stop())},S=new ps({model:new rs(a[0],r),clientMetadata:i.getClientMetadata(),userContext:i.getUserContext(),site:this.site,getTokenCallback:this.getAuthTokenCallback}),D=e=>{y(e?e.message:void 0),e?c(e):s(p)},I={setAnnotations:(r,o,s,d)=>{var l;const u=new yn({operationName:"SetAnnotations",resourceId:o,joinContextId:null!==(l=null==n?void 0:n.contextId)&&void 0!==l?l:"",success:!0}).setClientMetadata(i.getClientMetadata());u.start();const h=e=>{Bn.info(555866112,aa.CoreDefault,new qa({annotationType:o,annotationState:e,workflowId:t.workflow.id}))};for(const e of s)e.metadata=Object.assign(Object.assign({},e.metadata),{state:ma.Created}),h(ma.Created);const S=v.get(r),D=e.getTypeNameFor(S.body),I=(()=>{var t;if(m.kind===_a.SingleItem&&a[0].body!==r){const e=`Expected obj to be ${a[0].body} but instead it was ${r}`;return y(e,u),void c(y(e))}let n,l;if(Array.isArray(s))if(!m.outputTypes||m.outputTypes.indexOf(o)<0)n=`Workflow said it would output one of [${m.outputTypes}] but instead output ${o}`;else if(S)for(const t of s)e.matchesTypesFor(t,[Pa.getTypeName()])?e.getTypeNameFor(t)!==o&&(n=`Workflow produced inconsistent annotation types in setAnnotations call (${e.getTypeNameFor(t)} did not match expected ${o})`):n=`Workflow produced an output that is not an annotation ${e.getTypeNameFor(t)}`;else n="No item provided";else n="Workflow produced an invalid annotation array";if(n)return y(n,u),void c(y(n));l=d&&d.isSessionAnnotation?["session"]:d&&d.ancestorType?S.parentPath:S.parentPath.concat(S.id);const p=[],v=[];for(const e of s){e.metadata=Object.assign(Object.assign({},e.metadata),{state:ma.Sent}),h(ma.Sent);const n=e.id,a=n?null===(t=i.getContextAnnotations(o,Zo.LocalWorkflow,l,m.id))||void 0===t?void 0:t.filter(e=>{var t;return(null===(t=e.body)||void 0===t?void 0:t.id)==n}):void 0;1==(null==a?void 0:a.length)?1==a.length?v.push({id:a[0].id,source:m.id,revId:g,body:e,contextId:b}):Bn.error(545837260,aa.CoreDefault,`Assert: Multiple existing context annotations with body id ${n} found for ${o} and local workflow ${m.id}).`):p.push({id:this.getNextClientAnnotationId(),source:m.id,revId:g,body:e,contextId:b})}const D=[];return p.length>0&&D.push(new f({parentPath:l,items:p,parentRevId:g})),v.length>0&&D.push(new _({parentPath:l,items:v,parentRevId:g})),new Ci({annotationType:o,ops:D})})();I?(d&&d.immediate?i.onAnnotationResults(I,Zo.LocalWorkflow,()=>{}):p.push(I),(D==Jt.getTypeName()||D==Xt.getTypeName()||e.matchesTypesFor(S.body,[zt.getTypeName(),Gt.getTypeName()]))&&i.submitOperationsToSession(I.ops),Bn.info(509644822,aa.CoreDefault,u.stop())):Bn.info(509644823,aa.CoreDefault,u.stop())},submitSignals:t=>{const n=new yn({operationName:"submitSignalsAction",resourceId:m.id,success:!0}).setClientMetadata(i.getClientMetadata());for(const a of t){const t=e.getTypeNameFor(a);e.matchesTypesFor(a,[Ra.getTypeName()])||(n.resultDescription=`Workflow produced an output that is not an signal (${e.getTypeNameFor(a)})`,Bn.info(521413954,aa.CoreDefault,n)),m.outputTypes&&-1!==m.outputTypes.indexOf(t)||(n.resultDescription=`Workflow said it would output one of [${m.outputTypes}] but instead output ${t}`,Bn.info(521413953,aa.CoreDefault,n)),a.timestamp&&(hs.logTimestampUsageByWorkflowId.has(m.id)||(hs.logTimestampUsageByWorkflowId.add(m.id),n.resultDescription=`Workflow "${m.id}" sets signal.timeStamp`,Bn.info(509212803,aa.CoreDefault,n)))}const a=t.map(e=>({id:this.getNextClientSignalId(),source:m.id,revId:g,body:e,contextId:b})),r=new x({parentPath:["session"],parentRevId:g,items:a});i.submitOperations([r])},done:D,overrideWorkflowDefinition:(e,t,a)=>{let r;switch(a){case wa.JoinContext:if(!n.contextId){const e="ContextId is not defined for this scope item.";throw Bn.error(527472289,aa.CoreDefault,e),new Error(e)}r=n.contextId;break;case wa.Session:r=void 0;break;default:{const e="Defined scope is not supported. "+a;throw Bn.error(527472290,aa.CoreDefault,e),new Error(e)}}const o=new rr({definition:t,contextId:r,sourceWorkflowId:m.id,targetWorkflowId:e});i.onWorkflowDefinitionOverrideMessage(o)},getDynamicAnnotations:void 0,setBillingDomain:void 0,sendClientRequest:void 0,sendClientRequestStreaming:void 0},C=t.workflowLambda;if(m.kind===_a.SingleItem){1!==a.length&&D(new Error("Single item workflows expect a single input")),S.delta=a[0].delta,S.deltas=a[0].deltas;try{const e=C;t.initPromise||(t.initPromise=e.init(this.site,S)),t.initPromise.then(()=>{e.execute(a[0].body,S,I)}).catch(e=>{y(e)})}catch(e){y(e)}}else if(m.kind===_a.Join){0===a.length&&D(new Error("Join workflows expect an inputs array")),S.delta=n.delta,S.deltas=n.deltas;try{const e=C;t.initPromise||(t.initPromise=e.init(this.site,S)),t.initPromise.then(()=>{e.execute(n.body,a.map(e=>e.body),S,I)}).catch(e=>{y(e)})}catch(e){y(e)}}else y(`Workflow kind ${m.kind} not supported`)})}ensureSweepTimer(e){if(!this.sweepTimers.get(e)){const t=setInterval(this.onSweep.bind(this),this.sweepIntervalMs);this.sweepTimers.set(e,t)}}cancelSweepTimer(e){const t=this.sweepTimers.get(e);this.sweepTimers.get(e)&&(clearInterval(t),this.sweepTimers.delete(e))}onSweep(){this.sweepScopeExecutionNotifications()}setScopeExecutionNotification(e,t,n){var a,i;const r=Date.now(),o={session:e,workflowImplementation:t,scopeItem:n,startTime:r,minTime:r+Xo(t.workflow.minDelayMs,1e3),maxTime:r+Xo(t.workflow.maxDelayMs,5e3)},s=t.workflow.kind===_a.Join?n.contextId:o.scopeItem.parentPath.concat(n.id).join("\\");if(this.pendingScopeExecutionNotificationsByWorkflow.get(t.workflow.id)||this.pendingScopeExecutionNotificationsByWorkflow.set(t.workflow.id,new Map),this.pendingScopeExecutionNotificationsByWorkflow.get(t.workflow.id).get(s)){const a=new yn({resultDescription:`Duplicated pending scope execution for ${t.workflow.id} at ${s}`,operationName:"LocalScopeExecutionNotification",resourceId:t.workflow.id,joinContextId:null!==(i=null==n?void 0:n.contextId)&&void 0!==i?i:"",success:!0}).setClientMetadata(e.getClientMetadata()).start();Bn.info(509727899,aa.CoreDefault,a.stop())}else{const i=new yn({resultDescription:`New pending scope execution for ${t.workflow.id} at ${s}`,operationName:"LocalScopeExecutionNotification",resourceId:t.workflow.id,joinContextId:null!==(a=null==n?void 0:n.contextId)&&void 0!==a?a:"",success:!0}).setClientMetadata(e.getClientMetadata()).start();Bn.info(539883075,aa.CoreDefault,i.stop()),this.pendingScopeExecutionNotificationsByWorkflow.get(t.workflow.id).set(s,o)}this.ensureSweepTimer(e)}sweepScopeExecutionNotifications(){var e,t;const n=new Set(Array.from(this.sweepTimers.keys()));for(const[a,i]of Array.from(this.pendingScopeExecutionNotificationsByWorkflow.entries()))for(const[r,o]of Array.from(i.entries())){const{session:i,workflowImplementation:{workflow:s}}=o,c=i.getWorkflowItemStorage(),d=new yn({operationName:"LocalScopeExecutionNotification",resourceId:s.id,joinContextId:null!==(t=null===(e=o.scopeItem)||void 0===e?void 0:e.contextId)&&void 0!==t?t:"",success:!0}).setClientMetadata(i.getClientMetadata()).start(),l=()=>{var e;if(s.kind===_a.Join){const t=Date.now(),{workflow:n}=o.workflowImplementation,a=o.scopeItem.contextId,r=i.getWorkflowDefinition(n,a).maxDelayMs;return c.isWorkflowReady(a,n)?(d.resultDescription=`Join Workflow: ${n.id} queuing by maxAnnotation, contextId: ${a}`,Bn.info(528048978,aa.CoreDefault,d.stop()),{isValid:!0,triggerReason:_s.JoinMaxAnnnotation}):o.startTime+r<t?(d.resultDescription=`Join Workflow: ${n.id} queuing by maxTimeout, contextId: ${a}`,Bn.info(528048979,aa.CoreDefault,d.stop()),{isValid:!0,triggerReason:_s.JoinMaxTimeout}):this.isReadyToEarlyJoin(null===(e=this.executionTrackersByWorkflowNameBySession.get(i))||void 0===e?void 0:e.get(n.id),a,i.getClientMetadata())?(Bn.info(512550856,aa.CoreDefault,`Workflow: ${n.id} queuing by early completion, contextId: ${a}, timeout: ${r}`),{isValid:!0,triggerReason:_s.JoinEarlyCompletion}):{isValid:!1,triggerReason:_s.Unknown}}return{isValid:!0,triggerReason:_s.Unknown}};(()=>{const{isValid:e,triggerReason:t}=l();if(!e)return!1;const[n,a]=i.resolveRequestedContexts(s);if(!n)return!1;try{if(s.kind===_a.Join){const e=o.scopeItem.contextId,n=c.getScopeItem(e,s);if(n){const r=c.getItemsToExecute(n.contextId,s);if(0===r.length)return d.resultDescription=`Failed to retrieve items for workflow: ${s.id}, contextId: ${e}, skipping execution`,Bn.info(527472291,aa.CoreDefault,d.stop()),this.onWorkflowExecuted(n,s,i),!0;this.queueWorkflow({workflowInfo:o.workflowImplementation,scopeItem:n,inputItems:r,requestedContexts:a,session:i,triggerReason:t,onCompleteCallback:this.onWorkflowExecuted.bind(this,n,s,i)}).catch(e=>{d.success=!1,d.resultDescription=e.message,Bn.error(509092189,aa.CoreDefault,d.stop())})}else d.resultDescription="ContextId no longer exists, skipping workflow execution",Bn.info(539883076,aa.CoreDefault,d.stop())}else d.resultDescription=`Workflow in type ${s.kind} is not supported`,Bn.error(539883077,aa.CoreDefault,d.stop())}catch(e){d.resultDescription=`Trying to execute ${s.id} caused an exception: ${e}`,Bn.warn(539883078,aa.CoreDefault,d.stop())}return!0})()?(this.pendingScopeExecutionNotificationsByWorkflow.get(a).delete(r),0===this.pendingScopeExecutionNotificationsByWorkflow.get(a).size&&this.pendingScopeExecutionNotificationsByWorkflow.delete(a)):n.delete(i)}if(0!==n.size)for(const e of Array.from(n)){const t=new yn({resultDescription:"No pending scope notifications left, cancelling sweep timer",operationName:"LocalScopeExecutionNotification",success:!0}).start();Bn.debug(539883079,aa.CoreDefault,t.stop()),this.cancelSweepTimer(e)}}onExternalWorkflowExecuted(e,t,n){const a={id:"",parentPath:[],contextId:e},i={id:t};this.onWorkflowExecuted(a,i,n,!1)}onWorkflowExecuted(e,t,n,a=!0){var i,r;null===(r=null===(i=this.executionTrackersByWorkflowNameBySession.get(n))||void 0===i?void 0:i.get(t.id))||void 0===r||r.afterWorkflowExecution(e.contextId),a&&t.kind===_a.Join&&n.getWorkflowItemStorage().onWorkflowExecuted(e,t)}}const bs="Request timed out";function gs(e,t,n){const a=new Po.Request(e,t);return vs.add(a,n)}const vs=new class{constructor(e,t,n){if(this.requestInProgress=!1,this.queuedRequests=[],null==e)throw new Error("No request.");this.fetch=e,this.fetchTimeout=t,this.queueTimeout=n}tryProcessNextRequest(){if(this.requestInProgress=!1,this.queuedRequests.length>0){const[e,t,n]=this.queuedRequests.shift();clearTimeout(n),this.add(e,t)}}add(e,t){if(this.requestInProgress){const n=setTimeout(()=>{t(new Error("Timed out waiting in queue"),null),this.queuedRequests.shift()},this.queueTimeout);this.queuedRequests.push([e,t,n])}else this.requestInProgress=!0,new Promise((t,n)=>{let a=!1;const i=setTimeout(()=>{a=!0,n(new Error("Fetch timed out"))},this.fetchTimeout);this.fetch(e).then(e=>{a||(clearTimeout(i),t(e))}).catch(e=>{a||(clearTimeout(i),n(e))})}).then(e=>{t(null,e),this.tryProcessNextRequest()}).catch(e=>{t(e,null),this.tryProcessNextRequest()})}}(Po.fetch,2e4,12e4),ys=JSON.stringify(new si({error:bs}));class Ss{constructor(e){this.networkOverrideOptions=e,this.isClosed=!1,this.pendingEgress=[]}init(e,t,n,a){const i=new yn({operationName:"HttpWorkerInit",success:!0}).start(),r=e.split("/?x-origin=");2===r.length?(this.url=Yo.convertWebSocketUrlToHttp(r[0]),this.origin=r[1]):(this.url=Yo.convertWebSocketUrlToHttp(e),this.origin=void 0),this.ingress=t,this.onOpen=n,this.onClose=a,Bn.info(507839180,aa.CoreDefault,i.stop())}egress(e){const t=new yn({operationName:"HttpEgress",success:!0}).start();if(!this.isConnectedToSession()&&!e.isHttpSessionInitMessage)return this.pendingEgress.push(e),t.success=!1,t.resultDescription="NotConnected, pendingQueueSize:  "+this.pendingEgress.length.toString(),void Bn.info(508163394,aa.CoreDefault,t.stop());const n=this.getRequestInfo(e,t);if(!n.url)return t.success=!1,t.resultDescription="Could not generate HTTP request",void Bn.error(508163393,aa.CoreDefault,t.stop());e.isHttpSessionLongPollMessage?this.egressLongPoll(n,t):gs(n.url,n.request,(e,n)=>{e?this.onEgressError(t,"OnEgressError:"+(null==e?void 0:e.message)):n&&n.ok?n.text().then(e=>{t.success=!0,Bn.info(508163362,aa.CoreDefault,t.stop()),this.ingressInternal(e)}).catch(e=>{this.onEgressError(t,"OnEgressParseError: "+(null==e?void 0:e.message))}):this.onEgressError(t,"OnEgressResponseError: "+(null==e?void 0:e.message)+`, Status ${null==n?void 0:n.status}: ${null==n?void 0:n.statusText}`)})}close(){const e=new yn({operationName:"HttpWorkerClose",success:!0}).start();if(this.isClosed)return e.resultDescription="AlreadyClosed",void Bn.info(508163360,aa.CoreDefault,e.stop());Bn.info(508163359,aa.CoreDefault,e.stop()),this.isClosed=!0,this.sessionSettings=void 0,this.onClose&&(this.onClose(void 0),this.onClose=void 0)}onEgressError(e,t){e.success=!1,e.resultDescription=t,Bn.error(508163358,aa.CoreDefault,e.stop()),this.isClosed||this.close()}ingressInternal(e,t){let n=e;t||(n=this.formatServerInput(e)),n&&(this.logIngressCount(n),this.ingress(n,e=>{ri.typeGuard(e)&&this.onSessionInitResponse(e)}))}onSessionInitResponse(e){const t=new yn({operationName:"HttpWorkerOpen",success:!0}).start();if(!(e.sessionKey&&e.origin&&e.anonymousToken&&e.sessionUrlBase))return t.success=!1,t.resultDescription="SessionInitResponse missing information",void Bn.error(507809949,aa.CoreDefault,t.stop());Bn.info(508163357,aa.CoreDefault,t.stop()),this.setSessionSettings(e.sessionKey,e.origin,e.anonymousToken,e.sessionUrlBase),this.onOpen(),this.pendingEgress.forEach(e=>{this.egress(e)}),this.pendingEgress=[]}egressLongPoll(e,t){var n,a;(n=e.url,a=e.request,new Promise((e,t)=>{const i=setTimeout(()=>{t(new Error(bs))},2e4);(0,Po.fetch)(n,a||{}).then(t=>{clearTimeout(i),e(t)}).catch(e=>{clearTimeout(i),t(e)})})).then(e=>{e&&e.ok?e.text().then(e=>{t.success=!0,t.resourceId="LongPoll",Bn.info(508163355,aa.CoreDefault,t.stop()),this.ingressInternal(e)}).catch(e=>{this.onEgressError(t,"LongPollFetchParseError: "+(null==e?void 0:e.message))}):this.onEgressError(t,"LongPollFetchStatusFailure: "+(null==e?void 0:e.statusText))}).catch(e=>{e.message===bs?(t.success=!1,t.resultDescription="LongPollFetchResponseTimeout:"+(null==e?void 0:e.message),Bn.error(508163353,aa.CoreDefault,t.stop()),this.ingressInternal(ys,!0)):this.onEgressError(t,"LongPollFetchResponseError: "+(null==e?void 0:e.message))})}getRequestInfo(e,t){const n=this.getUrl(null==e?void 0:e.isHttpSessionInitMessage),a=this.getHeader(e,t);return t.resultSignature=n,{url:n,request:{method:"POST",headers:a,body:e.obj}}}getUrl(e){const t=this.sessionSettings&&this.sessionSettings.sliceUrl?this.sessionSettings.sliceUrl:this.url;return e?t+"/sessioninit":this.isConnectedToSession()?t+"/session/"+this.sessionSettings.sessionKey:""}getHeader(e,t){var n;const a=new Po.Headers;return(null==e?void 0:e.isHttpSessionInitMessage)?(a.set("Content-Type","application/json"),this.origin&&a.set("x-origin",this.origin)):this.isConnectedToSession()&&(e.obj instanceof Uint8Array||e.obj instanceof ArrayBuffer?(a.set("Content-Type","application/jsond2"),t.dimension0=e.obj.byteLength.toString().length.toString()):a.set("Content-Type","application/json"),a.append("Authorization",`Bearer ${this.sessionSettings.anonymousToken}`),a.set("x-origin",this.sessionSettings.origin)),(null===(n=this.networkOverrideOptions)||void 0===n?void 0:n.hostHeader)&&a.set("host",this.networkOverrideOptions.hostHeader),a}setSessionSettings(e,t,n,a){const i=a.replace("/session","");this.sessionSettings={sessionKey:e,origin:t,anonymousToken:n,sliceUrl:i}}isConnectedToSession(){return this.sessionSettings&&this.sessionSettings.sessionKey.length>0&&this.sessionSettings.anonymousToken.length>0&&this.sessionSettings.origin.length>0&&this.sessionSettings.sliceUrl.length>0&&!this.isClosed}formatServerInput(e){return e.length>1?e.substring(1,e.length-1):""}logIngressCount(e){const t=e.length;if(t>1e5){const e=new yn({operationName:"HttpIngressByteOrderOfMagnitude",success:!0}).start();e.dimension2=t.toString().length.toString(),Bn.info(508409622,aa.CoreDefault,e.stop())}}}class Ds{}var Is,xs,Cs=o(22),Os=o.n(Cs);!function(e){e.ArrivedBeforeReseeding="Message is dropped from queue since it arrived before reseeding is started",e.DroppedAsOldestInQueue="Message is dropped as oldest in full queue",e.DroppedBecauseClientDisconnected="Message is dropped because client is disconnected from server"}(Is||(Is={}));class ws{constructor(e){this.logOp=new yn({operationName:"MessageQueue",success:!0}),this.queue=new(Os())(1e3),this.callbacks=e}clear(){this.queue.clear()}size(){return this.queue.length}push(e,t,n){this.logOp.start();const a=this.queue;if(1e3===a.length){this.logOp.resourceId="QueueFull",this.logOp.success=!1,Bn.warn(508843746,aa.CoreDefault,this.logOp.stop());const e=a.shift();e.onResponse&&e.onResponse(new ti({error:Is.DroppedAsOldestInQueue}))}a.push({message:e,onResponse:t,timeQueued:Yo.getCurrentTimeMs(),attemptNumber:n})}sendOnSessionInitialized(e){this.logOp.start();const t=this.queue.length;let n=0;if(t>0){const a=Yo.getCurrentTimeMs()-this.queue.get(0).timeQueued;for(;this.queue.length>0&&this.callbacks.canSendMessage();){const t=this.queue.shift();e&&this.containSequencedSyncMessage(t)?(n++,t.onResponse&&t.onResponse(new ti({error:Is.ArrivedBeforeReseeding}))):t.message instanceof Uint8Array?this.callbacks.sendBytes(t.message):this.callbacks.sendMessage(t.message,t.onResponse,t.attemptNumber)}this.logOp.resourceId="SendOnSessionInitialized",this.logOp.resultDescription=`Queue size before: ${t}, after: ${this.queue.length}. droppedSyncMessages: ${n}`,this.logOp.setDataField("OldestMessageInQueueTimeWaitingMs",a),this.logOp.success=!0,Bn.warn(508843745,aa.CoreDefault,this.logOp.stop())}}containSequencedSyncMessage(t){return t.message instanceof Si&&e.matchesTypesFor(t.message,[Si.getTypeName()])&&t.message.seq>=0||t.message instanceof yi&&e.matchesTypesFor(t.message,[yi.getTypeName()])}}!function(e){e[e.Initing=0]="Initing",e[e.Running=1]="Running",e[e.Disconnected=2]="Disconnected",e[e.Closed=3]="Closed"}(xs||(xs={}));const Es=(t,n,a,i)=>{n&&(n.cv||(n.cv=t.cvParent.newChild().toString()),t.messageEndpoint.sendMessage(n,(n,i)=>{n||e.getTypeNameFor(i)!==Ii.getTypeName()||(t.stats.lastSyncMessage=Date.now()),a&&a(n,i)},void 0,i))},As=(e,t,n,a)=>{t&&(e.messageQueue.push(t,n,a),e.networkWorkerManager.init(void 0,e.customInitPromise).catch(e=>{const t=new yn({operationName:"WorkerManagerInit",success:!1,resultDescription:`${e}`});Bn.error(508843789,aa.CoreDefault,t)}))},Ls=(e,t)=>{t&&(e.messageQueue.push(t),e.networkWorkerManager.init(void 0,e.customInitPromise).catch(e=>{Bn.error(508843788,aa.CoreDefault,`Init failed: ${e}`)}))};class ks{constructor(e){this.context=e}onEnter(e){}sendMessage(e,t,n,a){}sendBytes(e){}canSendMessage(){return!1}onConnectionClose(){}}class Ms extends ks{constructor(){super(...arguments),this.stateName=xs.Initing,this.possibleNextStates=[xs.Running,xs.Disconnected,xs.Closed]}sendMessage(t,n,a){e.matchesTypesFor(t,[ii.getTypeName()])?Es(this.context,t,n,a):As(this.context,t,n)}sendBytes(e){Ls(this.context,e)}onConnectionClose(){this.context.setState(xs.Disconnected)}}class Ps extends ks{constructor(){super(...arguments),this.stateName=xs.Running,this.possibleNextStates=[xs.Disconnected,xs.Closed]}onEnter(e){e&&e.isSessionReseedingStarted&&this.context.resetNextSyncSequenceId(),this.context.messageQueue.sendOnSessionInitialized(e&&e.isSessionReseedingStarted)}sendMessage(e,t,n,a){Es(this.context,e,t,n)}sendBytes(e){e&&this.context.networkWorkerManager.egressBytes(e)}canSendMessage(){return!0}onConnectionClose(){this.context.setState(xs.Disconnected)}}class Ts extends ks{constructor(){super(...arguments),this.stateName=xs.Disconnected,this.possibleNextStates=[xs.Initing,xs.Closed]}onEnter(e){this.context.messageEndpoint.cancelPendingResponseCallbacks(po.ClientDisconnected)}sendMessage(t,n,a,i){if(e.matchesTypesFor(t,[ii.getTypeName()]))this.context.setState(xs.Initing),Es(this.context,t,n,a);else if(e.matchesTypesFor(t,[li.getTypeName()]))this.context.setState(xs.Closed);else{if(!i)return void As(this.context,t,n,a);n&&n(new ti({messageId:t.messageId,error:Is.DroppedBecauseClientDisconnected}))}}sendBytes(e){Ls(this.context,e)}}class Us extends ks{constructor(){super(...arguments),this.stateName=xs.Closed,this.possibleNextStates=[]}onEnter(e){this.context.messageEndpoint.cancelPendingResponseCallbacks(po.ClientClosed)}}const Fs=3e4;class Hs{constructor(e,t,n,a){this.lastPingTime=0,this.lastPongTime=0,this.lastEgressTime=0,this.remainingPingFailures=3,this.isPingPongSuccessful=!1,this.reducedPingPongRetryEnabled=a,this.pingPongLogOp=new yn({operationName:"WebSocketReliabilityManager",success:!0,resourceId:this.reducedPingPongRetryEnabled?"reducedPingPongRetryEnabled":""}).start(),this.pingPongLogOp.setClientMetadata(n,!0),this.worker=e,this.rateControllerClose=t}start(){this.reducedPingPongRetryEnabled?(this.pingPongLogOp.start(),this.pingPongLogOp.resultSignature="initial ping"):this.logOperation(!0,"ping","initial ping"),this.ping(),this.isPingPongSuccessful=!0,this.startInterval()}onResponse(){this.lastPongTime=Date.now(),this.reducedPingPongRetryEnabled&&(this.pingPongLogOp.success=!0,Bn.info(506795283,aa.CoreDefault,this.pingPongLogOp.stop()))}isReliabilityResponse(e){return"string"==typeof e&&1===e.length&&e===Hs.pingPongMessage}close(){this.reducedPingPongRetryEnabled?(this.pingPongLogOp.start(),this.pingPongLogOp.success=!0,this.pingPongLogOp.resultSignature="close",Bn.info(506795282,aa.CoreDefault,this.pingPongLogOp.stop())):this.logOperation(!0,"ping","close"),this.lastPingTime=0,this.lastPongTime=0,this.isPingPongSuccessful=!1,this.clearPingInterval(),this.worker=void 0}checkConnection(){return this.isPingPongSuccessful}postEgress(){this.lastEgressTime=Date.now()}needsParsedResponses(){return!1}ping(){this.reducedPingPongRetryEnabled?this.worker||(this.pingPongLogOp.success=!1,this.pingPongLogOp.resultDescription="websocket worker undefined",this.rateControllerClose(),Bn.info(506795281,aa.CoreDefault,this.pingPongLogOp.stop())):this.lastPingTime=Date.now(),this.worker&&(this.reducedPingPongRetryEnabled&&(this.lastPingTime=Date.now()),this.worker.egress({obj:Hs.pingPongMessage}))}startInterval(){this.pingInterval=setInterval(()=>{if(this.reducedPingPongRetryEnabled){if(this.lastPongTime<this.lastPingTime&&Date.now()-this.lastPingTime<Fs)return;this.isPingPongSuccessful=this.lastPongTime>=this.lastPingTime,this.pingPongLogOp.start(),this.isPingPongSuccessful?(this.pingPongLogOp.resultSignature="ping",this.ping()):(this.pingPongLogOp.success=!1,this.pingPongLogOp.resultDescription="Pong not received",Bn.info(506795280,aa.CoreDefault,this.pingPongLogOp.stop()),this.worker?this.worker.close():this.rateControllerClose())}else{if(this.isPingPongSuccessful=this.lastPongTime>=this.lastPingTime&&this.lastPongTime-this.lastPingTime<=Fs,this.lastPongTime>this.lastEgressTime)return;const e=this.lastPongTime-this.lastPingTime;this.isPingPongSuccessful?(this.remainingPingFailures=3,this.ping()):this.remainingPingFailures>0?(--this.remainingPingFailures,this.ping()):(this.logOperation(!1,"ping","Pong still not received after all retry attempts",[`${e}`,`${this.remainingPingFailures}`]),this.worker?this.worker.close():this.rateControllerClose())}},Fs)}clearPingInterval(){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=void 0)}logOperation(e,t,n,a){var i,r,o,s;this.pingPongLogOp.start(),this.pingPongLogOp.success=e,this.pingPongLogOp.resultSignature=t,this.pingPongLogOp.resultDescription=n,a&&(this.pingPongLogOp.dimension0=null!==(i=a[0])&&void 0!==i?i:"",this.pingPongLogOp.dimension1=null!==(r=a[1])&&void 0!==r?r:"",this.pingPongLogOp.dimension2=null!==(o=a[2])&&void 0!==o?o:"",this.pingPongLogOp.dimension3=null!==(s=a[3])&&void 0!==s?s:""),Bn.info(507320073,aa.CoreDefault,this.pingPongLogOp.stop())}}Hs.pingPongMessage="~";const Rs="Request timed out";class Ns{constructor(e,t,n){this.remainingRetryAttempts=4,this.isAsleep=!1,this.isLongPollSuccessful=!1,this.isActiveLongPoll=!1,this.isResponseReceived=!1,this.lastEgressTime=0,this.longPollLogOp=new yn({operationName:"OnLongPollMessage",success:!0}),this.clientMetadata=t,this.sessionCorrelationVector=n,this.longPollLogOp.setClientMetadata(this.clientMetadata,!0),this.worker=e}start(){const e=new yn({operationName:"StartHttpReliabilityManager",success:!0}).start();e.setClientMetadata(this.clientMetadata,!0),Bn.info(508163399,aa.CoreDefault,e.stop()),this.trySendLongPoll(Zr.Start,!0),this.isLongPollSuccessful=!0}onResponse(e){if(!e||this.isResponseReceived){const e=new yn({operationName:"HttpReliabilityManagerFailure",success:!1}).start();return e.setClientMetadata(this.clientMetadata,!0),void Bn.info(508162497,aa.CoreDefault,e.stop())}this.isResponseReceived=!0,this.isActiveLongPoll=!1;const t=e;if(t.error)if(this.isLongPollSuccessful=!1,--this.remainingRetryAttempts,this.remainingRetryAttempts>0){this.longPollLogOp.success=!1,this.longPollLogOp.resultDescription=`Retry attempts left : ${this.remainingRetryAttempts}`,this.longPollLogOp.resultSignature=t.error,Bn.info(508163398,aa.CoreDefault,this.longPollLogOp.stop());const e=t.error===Rs?Zr.TimeoutResend:Zr.FailResend;t.error===Rs||3===this.remainingRetryAttempts?this.trySendLongPoll(e,!0):this.enqueueSendLongPoll(e)}else this.longPollLogOp.success=!1,this.longPollLogOp.resultDescription="Long poll still not received after all retry attempts",Bn.info(508163397,aa.CoreDefault,this.longPollLogOp.stop()),this.worker&&this.worker.close();else this.longPollLogOp.success=!0,this.longPollLogOp.resultDescription="Long poll received",Bn.info(508163401,aa.CoreDefault,this.longPollLogOp.stop()),this.remainingRetryAttempts=4,this.isLongPollSuccessful=!0,this.trySendLongPoll(Zr.Regular)}close(){const e=new yn({operationName:"CloseHttpReliabilityManager",success:!0}).start();e.setClientMetadata(this.clientMetadata,!0),Bn.info(508162467,aa.CoreDefault,e.stop()),this.sendLongPollTimer&&(clearTimeout(this.sendLongPollTimer),this.sendLongPollTimer=void 0),this.isActiveLongPoll=!1,this.isLongPollSuccessful=!1,this.worker=void 0}checkConnection(){if(this.isAsleep){this.isAsleep=!1;const e=new yn({operationName:"AwakenHttpReliabilityManager",success:!0}).start();e.setClientMetadata(this.clientMetadata,!0),Bn.info(508162496,aa.CoreDefault,e.stop()),this.trySendLongPoll(Zr.CheckConnection,!0)}return this.isLongPollSuccessful}isReliabilityResponse(e){return"string"!=typeof e&&si.typeGuard(e)}postEgress(){this.lastEgressTime=Date.now(),this.trySendLongPoll(Zr.PostEgress)}needsParsedResponses(){return!0}enqueueSendLongPoll(e){this.sendLongPollTimer=setTimeout(()=>{this.trySendLongPoll(e,!0)},2e4)}trySendLongPoll(e,t){if(!this.worker){const e=new yn({operationName:"LongPollNoOp",success:!0}).start();return e.setClientMetadata(this.clientMetadata,!0),e.resultDescription="Worker is undefined",void Bn.info(507281438,aa.CoreDefault,e.stop())}if(!0===this.isActiveLongPoll){const e=new yn({operationName:"LongPollNoOp",success:!0}).start();return e.setClientMetadata(this.clientMetadata,!0),e.resultDescription="Already active long poll",void Bn.info(508163396,aa.CoreDefault,e.stop())}if(this.isActiveLongPoll=!0,Date.now()-this.lastEgressTime>6e4&&!t){this.isActiveLongPoll=!1,this.isAsleep=!0;const e=new yn({operationName:"LongPollSleep",success:!0}).start();return e.setClientMetadata(this.clientMetadata),e.resultDescription=`isAsleep: ${this.isAsleep}, isActiveLongPoll: ${this.isActiveLongPoll}`,void Bn.info(507278739,aa.CoreDefault,e.stop())}this.longPollLogOp.start(),this.isResponseReceived=!1,this.worker.egress({obj:this.getLongPollMessageString(e),isHttpSessionLongPollMessage:!0,isHttpSessionInitMessage:!1})}getLongPollMessageString(e){const t=new oi({longPollTimeoutHint:15e3,type:e});return this.sessionCorrelationVector&&(t.cv=this.sessionCorrelationVector().newChild().toString()),JSON.stringify(t)}}var Bs=function(e,t,n,a){return new(n||(n=Promise))(function(i,r){function o(e){try{c(a.next(e))}catch(e){r(e)}}function s(e){try{c(a.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,s)}c((a=a.apply(e,t||[])).next())})};const js=1e5;class Vs{constructor(e){var t;this.emptyMessageId=0,this.egressMessageCount=0,this.egressByteCount=0,this.prevSeq=-1,this.rpsThreshold=150,this.bpsThreshold=5e8,this.isClosing=!1,this.messageQueue=void 0,this.egressRateLogOp=new yn({operationName:"NetworkEgressRate",success:!0}),this.egressedCache=new Map,this.initPromise=new Promise(e=>{this.resolveInitPromise=e}),this.messageQueue=new(Os()),this.reducedPingPongRetryEnabled=null!==(t=null==e?void 0:e.reducedPingPongRetryEnabled)&&void 0!==t&&t}init(e,t,n,a,i){this.worker=e,this.ingress=t,this.clientMetadata=a,this.networkMode=n,this.reliabilityManager=((e,t,n,a,i)=>e instanceof Ss?new Ns(e,n,a):new Hs(e,t,n,i))(this.worker,this.close.bind(this),void 0,i,this.reducedPingPongRetryEnabled),this.egressRateLogOp.setClientMetadata(this.clientMetadata,!0),this.resetRateLimiter(),this.onCloseController=new Promise(e=>{this.resolveCloseControllerPromise=e}),this.queueProcessingCompletePromise=new Promise(e=>{this.resolveQueueProcessingCompletePromise=e}),this.resolveInitPromise()}open(){const e=new yn({operationName:"NetworkRateControllerOpen",success:!0,dimension3:`networkMode: ${this.networkMode}`}).start();e.setClientMetadata(this.clientMetadata,!0),this.initPromise.then(()=>{if(!this.reliabilityManager)return e.success=!1,void(e.resultDescription="Reliability Manager is undefined");this.egressRateControlIntervalStart=Date.now(),this.reliabilityManager.start(),this.processQueue()}).catch(t=>{var n;e.success=!1,e.resultDescription="Catch: "+(null!==(n=null==t?void 0:t.message)&&void 0!==n?n:"")}).finally(()=>{Bn.info(507834384,aa.CoreDefault,e.stop())})}ingressFromWorker(e,t){this.reliabilityManager?this.reliabilityManager.needsParsedResponses()||!this.reliabilityManager.isReliabilityResponse(e)?this.ingress(e,e=>{null==t||t(e),this.reliabilityManager.needsParsedResponses()&&this.reliabilityManager.isReliabilityResponse(e)&&this.reliabilityManager.onResponse(e)}):this.reliabilityManager.onResponse():this.ingress(e,t)}onRateLimitErrorResponse(e){const t=new yn({operationName:"NetworkRateControllerOnRateLimitResponse",success:!0}).start();t.setClientMetadata(this.clientMetadata,!0),t.resultSignature=`rateLimitAlreadyStarted: ${void 0!==this.rateLimitTimeout}`,t.setDataField("RetryAfterMs",e.retryAfterMs),t.setDataField("QueueSize",this.messageQueue.length),this.startRateLimiting(e.retryAfterMs),Bn.info(507388684,aa.CoreDefault,t.stop())}setRpsBps(e,t){const n=new yn({operationName:"NetworkRateControllerRateLimitsSet",success:!0}).start();n.setClientMetadata(this.clientMetadata,!0),e&&(this.rpsThreshold=.8*e,n.resultDescription+=`maxRPS: ${e}, rpsThreshold: ${this.rpsThreshold}; `),t&&(this.bpsThreshold=.8*t,n.resultDescription+=`maxRPS: ${t}, rpsThreshold: ${this.bpsThreshold}; `),Bn.info(507388683,aa.CoreDefault,n.stop())}close(){var e,t;return Bs(this,void 0,void 0,function*(){const n=new yn({operationName:"NetworkRateControllerClose",success:!0,dimension3:`networkMode: ${this.networkMode}`}).start();n.setClientMetadata(this.clientMetadata,!0),this.isClosing=!0,null===(e=this.resolveCloseControllerPromise)||void 0===e||e.call(this);const a=null===(t=this.reliabilityManager)||void 0===t?void 0:t.checkConnection();n.setDataField("QueueSizeBeforeFlush",this.messageQueue.length),0!=this.messageQueue.length&&a&&(yield this.queueProcessingCompletePromise),n.setDataField("QueueSizeAfterFlush",this.messageQueue.length),n.setDataField("IsConnected",a),this.reliabilityManager?this.reliabilityManager.close():n.resultDescription="Reliability Manager is undefined",this.worker=void 0,this.prevSeq=-1,this.clearEgressControlTimeout(),this.reliabilityManager=void 0,Bn.info(507834381,aa.CoreDefault,n.stop())})}clearMessageQueues(){this.egressedCache.clear(),this.messageQueue=void 0}egress(e,t=0){var n,a;if(!this.reliabilityManager)return void this.logEgressActivity(!1,"Reliability Manager is undefined","");const i=this.getMessageSize(e);if(i>=3e6)return void this.logEgressActivity(!1,"Message size exceeded 3000000",`Message size: ${i}`);if((e.obj instanceof ArrayBuffer||e.isHttpSessionInitMessage)&&this.worker)return this.logEgressActivity(!0,`isArrayBuffer: ${e.obj instanceof ArrayBuffer}, isHttpSessionInitMessage: ${e.isHttpSessionInitMessage}`,""),void this.worker.egress(e);this.validateSyncMessage(e.messageId,e.seqId);const r=null!==(n=e.messageId)&&void 0!==n?n:"id"+this.emptyMessageId++,o={obj:e.obj,seqId:null==e?void 0:e.seqId,messageId:r,isHttpSessionInitMessage:null==e?void 0:e.isHttpSessionInitMessage},s=t>0,c=new yn({operationName:"NetworkRateControllerQueueItem",success:!0,dimension3:`isRetry: ${s}`}).start();c.setClientMetadata(this.clientMetadata,!0);const d={message:o,logOp:c};if(s?this.messageQueue.unshift(d):this.messageQueue.push(d),this.messageQueue.length>1e4){const e=this.messageQueue.shift(),t=`NetworkRateControllerQueue max size reached. Dropping messageId: ${e.message.messageId}`;throw e.logOp.resultDescription=t,e.logOp.success=!1,Bn.info(506001225,aa.CoreDefault,e.logOp.stop()),new Error(t)}null===(a=this.resolveQueueNotEmptyPromise)||void 0===a||a.call(this)}getMessageSize(e){return e.obj instanceof ArrayBuffer?e.obj.byteLength:e.obj.length}sendToNetworkWorker(e){var t;try{if(!this.worker)return void this.logEgressActivity(!1,"NetworkWorker is undefined","SendToNetworkWorkerFailure");if(!this.reliabilityManager)return void this.logEgressActivity(!1,"Reliability Manager is undefined","SendToNetworkWorkerFailure");this.worker.egress(e),this.onSendToNetworkWorker(e),null===(t=this.reliabilityManager)||void 0===t||t.postEgress();const n=this.getMessageSize(e);this.logEgressCount(n)}catch(e){this.logEgressActivity(!1,"SendToNetworkWorkerFailure",e?e.message:"")}}onSendToNetworkWorker(e){if("string"==typeof e.obj)try{const i=JSON.parse(e.obj);Si.typeGuard(i)?(t=i,n=Date.now(),a=new yn({operationName:"AugloopClientPerfTracker",success:!0}).setClientMetadata(this.clientMetadata).start(),Wo(t.ops,t.cv,n,"SendToNetwork",a)):or.typeGuard(i)&&((e,t,n)=>{var a,i,r,o;n.resultSignature="GetAnnotationsSendToNetwork",n.resourceId=`${null===(a=e.sourceInfo)||void 0===a?void 0:a.featureId}-${null===(i=e.sourceInfo)||void 0===i?void 0:i.entryPoint}`,n.cv=e.cv,n.setDataFields({AnnotationTypes:null===(r=e.annotationTypes)||void 0===r?void 0:r.toString(),MaxDelayMs:null===(o=e.maxDelayMs)||void 0===o?void 0:o.toString()}),Bn.info(505455200,aa.CoreDefault,n.stop())})(i,0,new yn({operationName:"AugloopClientPerfTracker",success:!0}).setClientMetadata(this.clientMetadata).start())}catch(e){}var t,n,a}processQueue(){var e,t,n;return Bs(this,void 0,void 0,function*(){if(!this.reliabilityManager){const e=new yn({operationName:"NetworkRateControllerProcessQueueFailure",success:!1,dimension3:`networkMode: ${this.networkMode}`}).start();return e.setClientMetadata(this.clientMetadata,!0),e.resultDescription="Reliability Manager is undefined",void Bn.info(507573643,aa.CoreDefault,e.stop())}const a=new yn({operationName:"NetworkRateControllerProcessQueue",success:!0}).start();for(;;){if(0===this.messageQueue.length){if(this.isClosing){a.setDataField("ExitReason","Stage#1 Closing");break}yield Promise.race([this.queueNotEmpty(),this.onCloseController])}if(this.rateLimitTimeout){const e=new yn({operationName:"NetworkRateControllerRateLimitBackoff",dimension3:`networkMode: ${this.networkMode}`}).start();e.setClientMetadata(this.clientMetadata,!0),e.setDataField("QueueLengthBeforeBackoff",this.messageQueue.length),yield Promise.race([this.rateLimitTimeout,this.onCloseController]),e.setDataField("QueueLengthAfterBackoff",this.messageQueue.length),e.setDataField("IsClosing",this.isClosing),e.success=!0,this.rateLimitTimeout=void 0,this.resetRateLimiter(),Bn.info(507281410,aa.CoreDefault,e.stop())}if(!(null===(e=this.reliabilityManager)||void 0===e?void 0:e.checkConnection())){if(this.isClosing){a.setDataField("ExitReason","Stage#2 Closing");break}yield this.checkConnectionPromise(),this.connectionPromise=void 0}if(!this.reliabilityManager){a.setDataField("ExitReason","Stage#2 ReliabilityManager null");break}for(;this.messageQueue.length>0&&this.reliabilityManager.checkConnection();){if(Date.now()-this.egressRateControlIntervalStart>=1e3)this.resetRateLimiter();else if(this.egressMessageCount>=this.rpsThreshold||this.egressByteCount>=this.bpsThreshold){const e=1100;let t="";this.egressMessageCount>=this.rpsThreshold&&(t+="RPS exceeded."),this.egressByteCount>=this.bpsThreshold&&(t+="BPS exceeded.");const n="rateLimitHit",a=new yn({operationName:"NetworkRateControllerEgress",dimension3:`networkMode: ${this.networkMode}`}).start();a.setClientMetadata(this.clientMetadata,!0),a.success=!0,a.resultDescription=n,a.resultSignature=t,a.dimension0=this.messageQueue.length.toString().length.toString(),a.dimension1="rateLimitHit",a.setDataField("QueueLength",this.messageQueue.length),a.setDataField("RateLimitDelayMs",e),Bn.info(507281409,aa.CoreDefault,a.stop()),this.startRateLimiting(e);break}const e=this.messageQueue.shift();this.sendToNetworkWorker(e.message),Bn.info(507388682,aa.CoreDefault,e.logOp.stop())}this.onQueueNotEmpty=void 0,this.resolveQueueNotEmptyPromise=void 0}null===(t=this.resolveQueueProcessingCompletePromise)||void 0===t||t.call(this),this.resolveQueueProcessingCompletePromise=void 0,a.setClientMetadata(this.clientMetadata,!0),a.setDataField("QueueSize",this.messageQueue.length),a.setDataField("IsConnected",null===(n=this.reliabilityManager)||void 0===n?void 0:n.checkConnection()),a.setDataField("IsClosing",this.isClosing),Bn.info(507368671,aa.CoreDefault,a.stop())})}queueNotEmpty(){return this.onQueueNotEmpty||(this.onQueueNotEmpty=new Promise(e=>{this.resolveQueueNotEmptyPromise=e})),this.onQueueNotEmpty}checkConnectionPromise(){return this.connectionPromise||(this.connectionPromise=new Promise(e=>{setTimeout(e,1e3)})),this.connectionPromise}startRateLimiting(e){this.rateLimitTimeout||(this.rateLimitTimeout=new Promise(t=>{setTimeout(t,e)}))}resetRateLimiter(){this.egressRateControlIntervalStart=Date.now(),this.egressMessageCount=0,this.egressByteCount=0}clearEgressControlTimeout(){this.egressRateControlTimer&&(clearInterval(this.egressRateControlTimer),this.egressRateControlTimer=void 0)}validateSyncMessage(e,t){if(!(void 0===t||void 0===e||t<=this.prevSeq)){if(t&&t!==this.prevSeq+1){const e=new yn({operationName:"NetworkRateControllerAbandonedSyncMessage",success:!0,dimension3:`networkMode: ${this.networkMode}`}).start();e.setClientMetadata(this.clientMetadata,!0),e.resultDescription="Gap in sync message",e.dimension0=`${this.prevSeq}`,e.dimension1=`${t}`,e.dimension2=""+(t-this.prevSeq),Bn.info(507834370,aa.CoreDefault,e.stop())}this.prevSeq=t}}logEgressActivity(e,t,n,a){var i,r,o,s;const c=new yn({operationName:"NetworkRateControllerEgress",dimension3:`networkMode: ${this.networkMode}`}).start();c.setClientMetadata(this.clientMetadata,!0),c.success=e,c.resultDescription=t,c.resultSignature=n,a&&(c.dimension0=null!==(i=a[0])&&void 0!==i?i:"",c.dimension1=null!==(r=a[1])&&void 0!==r?r:"",c.dimension2=null!==(o=a[2])&&void 0!==o?o:"",c.dimension3=null!==(s=a[3])&&void 0!==s?s:""),Bn.info(507626007,aa.CoreDefault,c.stop())}logEgressCount(e){const t=Date.now();t-this.egressRateControlIntervalStart>1e3&&((this.egressMessageCount>50||this.egressByteCount>js)&&(this.egressRateLogOp.start(),this.egressRateLogOp.resultDescription=this.egressMessageCount>50?"rps logging threshold exceeded":"",this.egressRateLogOp.resultDescription=this.egressByteCount>js?"bps logging threshold exceeded":"",this.egressRateLogOp.dimension0=(t-this.egressRateControlIntervalStart).toString(),this.egressRateLogOp.dimension1=`${this.egressMessageCount}`,this.egressRateLogOp.dimension2=`${this.egressByteCount}`,this.egressRateLogOp.dimension3=`networkMode: ${this.networkMode}`,Bn.info(508843792,aa.CoreDefault,this.egressRateLogOp.stop())),this.egressRateControlIntervalStart=t,this.egressMessageCount=0,this.egressByteCount=0),this.egressMessageCount++,this.egressByteCount+=null!=e?e:0}}var zs,Gs;!function(e){e[e.ProductServiceUsage=2]="ProductServiceUsage",e[e.ProductServicePerformance=4]="ProductServicePerformance"}(zs||(zs={})),function(e){e[e.BasicEvent=10]="BasicEvent",e[e.FullEvent=100]="FullEvent",e[e.RequiredServiceDataEvent=110]="RequiredServiceDataEvent"}(Gs||(Gs={}));const Ks="n~",Ws=/\|\~/g;class qs{constructor(){this.count=0,this.measureSums=new Map}}class Qs{constructor(e,t,n,a,i){this.buckets=new Map,this.init=e=>{this.log=e},this.add=(e,t=!0)=>{if(!this.condition||!this.condition(e))return!0===t&&this.log(e,!1),!1;const n=[];for(const t of this.dimensions)if(void 0===e[t]||null===e[t])n.push(null);else{let a="";"boolean"==typeof e[t]?a="b~":"number"==typeof e[t]&&(a=Ks),n.push(`${a}${e[t].toString().replace(Ws,"_")}`)}const a=n.join("|");let i=this.buckets.get(a);if(!i){i=new qs,i.traceLevel=e.traceLevel;for(const e of this.avgMeasures)i.measureSums.set(e,0);this.buckets.set(a,i)}i.count++;for(const t of this.avgMeasures)e[t]&&i.measureSums.set(t,i.measureSums.get(t)+e[t]);return!0},this.flush=(e=!1)=>{this.buckets.forEach((e,t)=>{const n={traceLevel:e.traceLevel,eventName:this.eventName,count:e.count},a=t.split("|");for(let e=0;e<this.dimensions.length;e++){const t=this.dimensions[e],i=a[e];0===i.indexOf("b~")?n[t]="b~true"===i:0===i.indexOf(Ks)?n[t]=parseInt(i.slice(Ks.length),10):n[t]=i}for(const t of this.avgMeasures)n[t]=Math.round(e.measureSums.get(t)/e.count);this.log(n,!0)}),this.buckets.clear(),e&&(this.condition=null,clearInterval(this.interval))},this.eventName=e,this.condition=t,this.dimensions=n,this.avgMeasures=a,i>0&&(this.interval=setInterval(this.flush,1e3*i))}}const Ys=["cloud.dev.microsoft","officeppe.com","cloud.microsoft","office.com","office365.us","ic.gov","microsoft.scloud","microsoftonline.cn"],Js=(e,t,n,a)=>new Qs(e,e=>e.success&&n.indexOf(e[t])>=0,[t,"ariaNamespace","resourceId","success","resultSignature","clientDocSessionId","dimension0","dimension1","dimension2","dimension3"],["durationMs"],a),Xs=e=>{if(!e)return e;for(const t of Ys)if(e.indexOf(t)>=0)return e;return"**redacted**"};class Zs{constructor(e){this.level=pn.info,this.hostCallbacks=e}log(e){if(null==this.hostCallbacks||null==this.hostCallbacks.sendTelemetryEvent)return;const t=(e,t,n,a,i)=>{let r=t.charAt(0).toUpperCase()+t.slice(1),o={DocSessionId:e.clientDocSessionId,ResourceId:e.resourceId,ResultDescription:e.resultDescription,ResultSignature:e.resultSignature,Dimension0:e.dimension0,Dimension1:e.dimension1,Dimension2:e.dimension2,Dimension3:e.dimension3,JoinContextId:e.joinContextId,ServerSessionKey:this.serverSessionKey};n&&(o=Object.assign(Object.assign({},o),JSON.parse(n)));const s=a||Zs.augLoopAriaTenantToken,c=i||s!=Zs.augLoopAriaTenantToken?i:Zs.augLoopAriaNamespace;r=r||Zs.operationNamePlaceholder;const d={CV:e.cv,Duration:1e3*(e.durationMs||0),Count:e.count,AggMode:2,Success:e.success};this.hostCallbacks.sendTelemetryEvent(s,c?`${c}_${r}`:r,o,"Office.System.Activity",d,!1,zs.ProductServiceUsage|zs.ProductServicePerformance,Gs.RequiredServiceDataEvent)};if("Workflow.MetricsOnly"==e.category);else if("Operation"===e.eventName){const n=e;t(n,n.operationName,n.dataFields,void 0,n.ariaNamespace)}else if("SessionHealth"===e.eventName)t(e,e.sessionHealthEventName);else if("WorkflowOperation"===e.eventName){const n=e;t(n,n.operationName,n.dataFields,n.ariaTenant,n.ariaNamespace)}else"Log"===e.eventName&&((e,t,n)=>{this.hostCallbacks.sendDiagnosticTrace&&this.hostCallbacks.sendDiagnosticTrace(e,t,n)})(e.tagId,e.traceLevel,e.message)}setServerSessionKey(e){this.serverSessionKey=e}}Zs.augLoopAriaTenantToken="3de4087d4de34817b1c376e3d1e6e293-983c4292-5ba9-485a-ab10-9797863c788b-6770",Zs.augLoopAriaNamespace="Office_AugLoop_Client",Zs.operationNamePlaceholder="OperationNameNotProvided";class $s{constructor(e,t,n,a,i,r,o,s,c){this.logCountLimiter=new Jo($s.className),this.isWorkerReady=!1,this.permanentlyClosed=!1,this.currentReconnectAttempt=0,this.lastInitializationAttemptTimeMs=0,this.offlineInterval=void 0,this.alreadyLoggedReconnectAttempt=!1,this.httpTestsLeft=5,this.httpTestsSuccessCount=0,this.workerOpenCount=0,this.testHttpConnection=e=>{const t=Yo.convertWebSocketUrlToHttp(this.globalUrl),n=!e,a=null!=e?e:new yn({operationName:"HttpsTest",resourceId:Xs(t),success:!1,resultDescription:"",resultSignature:"HttpResponse:"}).start();gs(t,{method:"POST",headers:{"content-type":"application/json","X-CorrelationId":a.cv},body:JSON.stringify(Yo.createHealthCheckRequest(this.clientMetadata))},(e,t)=>{e?(a.dimension1="HttpErr",a.resultDescription+=`HttpErr: ${e.message}`):t&&t.ok?(a.dimension1="HttpOK",this.leaveOfflineMode(),this.httpTestsSuccessCount++,n&&(a.success=!0)):(a.dimension1="HttpNoResp",a.resultDescription+=`HttpStatus: ${null==t?void 0:t.status}`),n&&a.stop(),this.logCountLimiter.log(()=>{Bn.info(508843780,aa.CoreDefault,a)})})},this.globalUrl=e,this.clientMetadata=t,this.workerFactory=n,this.sessionInitializer=a,this.ingress=i,this.onConnectionClose=r,this.sessionCorrelationVector=o,this.reducedPingPongRetryEnabled=s.reducedPingPongRetryEnabled,this.networkWorkerLogOp=new yn({operationName:"CreateNetworkWorker",success:!0}),this.networkMode=c||ia.JSWebSockets,this.initNetworkMode=this.networkMode}init(e,t,n=!1){if(this.permanentlyClosed)return Promise.reject(new Error("permanentlyClosed"));if(this.isWorkerReady||this.pendingInitPromise)return this.pendingInitPromise?this.pendingInitPromise:Promise.resolve();this.extensionConfigs=e||this.extensionConfigs;const a=()=>{if(n||!this.alreadyLoggedReconnectAttempt){const e=n?$s.initialAttemptTimeout:$s.reconnectAttemptTimeout;this.connTimeout=setTimeout(()=>{const t=new yn({operationName:"ConnectionFailingOrSlow",dimension0:n?"Initial":"Reconnect",dimension1:e.toString(),dimension2:this.currentReconnectAttempt.toString()});Bn.info(508843787,aa.CoreDefault,t),this.alreadyLoggedReconnectAttempt=!n,this.connTimeout=void 0},e)}};return t?this.pendingInitPromise=t().catch(e=>{const t=new yn({operationName:"WorkerManagerCustomInit",success:!1,resultDescription:`${e}`});Bn.error(508843786,aa.CoreDefault,t)}).then(()=>{a(),this.initInternal()}):(this.pendingInitPromise=Promise.resolve(),a(),this.initInternal()),this.pendingInitPromise}egress(e,t){return!this.isWorkerReady&&this.pendingInitPromise?this.pendingInitPromise.then(()=>{this.egressInternal(e,t)}):(this.egressInternal(e,t),Promise.resolve())}egressBytes(e){return!this.isWorkerReady&&this.pendingInitPromise?this.pendingInitPromise.then(()=>{this.egressBytesInternal(e)}):(this.egressBytesInternal(e),Promise.resolve())}getNetworkMode(){return this.networkMode}getInitNetworkMode(){return this.initNetworkMode}onRateLimitErrorResponse(e){this.getNetworkRateController().onRateLimitErrorResponse(e)}close(e){this.isWorkerReady=!1,this.networkRateController&&this.getNetworkRateController().close(),this.worker&&(this.worker.close(),this.worker=null),this.networkRateController=null,this.permanentlyClosed=e||this.permanentlyClosed,this.permanentlyClosed&&(this.leaveOfflineMode(),clearTimeout(this.connTimeout))}initInternal(){if(this.isWorkerReady=!1,this.permanentlyClosed||this.isOffline()){const e=new yn({operationName:"WorkerManagerInitOffline",success:!0,resultSignature:this.permanentlyClosed?"PermanentlyClosed":"Offline"});Bn.info(508843785,aa.CoreDefault,e)}else this.currentReconnectAttempt>0?setTimeout(()=>{this.tryToConnectAndInitializeSession()},((e,t,n)=>{let a=0;const i=Yo.getCurrentTimeMs()?Yo.getCurrentTimeMs()-t:0,r=[1e3,2e3,5e3,1e4,6e4];return a=r[Math.max(0,Math.min(r.length-1,e-1))],a=Math.max(a-i,1e3),a=n&&n>0?Math.min(5e3,a):a,a})(this.currentReconnectAttempt,this.lastInitializationAttemptTimeMs,this.httpTestsSuccessCount)):this.getNetworkMode()===ia.HttpFallback?setTimeout(()=>{this.tryToConnectAndInitializeSession()},100):this.tryToConnectAndInitializeSession()}egressInternal(t,n){if(!this.isWorkerReady&&!e.matchesTypesFor(t,[ii.getTypeName()]))return void(e.matchesTypesFor(t,[Ya.getTypeName()])||Bn.error(508843784,aa.CoreDefault,new yn({operationName:"UnexpectedEgressCall",resultDescription:`isWorkerReady: ${this.isWorkerReady}`})));let a,i;if(e.matchesTypesFor(t,[Di.getTypeName()])?(this.castBinaryData(t),a=Ho.serialize(t)):a=JSON.stringify(t),Si.typeGuard(t)&&(i=t.seq),this.bypassRateController(t))return void this.worker.egress({obj:a});const r=ii.typeGuard(t)&&this.getNetworkMode()===ia.HttpFallback;this.getNetworkRateController().egress({obj:a,isHttpSessionInitMessage:r,messageId:t.messageId,seqId:i},n)}bypassRateController(e){return li.typeGuard(e)}egressBytesInternal(e){this.isWorkerReady?this.getNetworkRateController().egress({obj:e}):Bn.error(508843783,aa.CoreDefault,new yn({operationName:"UnexpectedEgressBytesCall",resultDescription:`isWorkerReady: ${this.isWorkerReady}`}))}tryToConnectAndInitializeSession(){this.currentReconnectAttempt++,this.lastInitializationAttemptTimeMs=Yo.getCurrentTimeMs();const e=t=>{if(this.permanentlyClosed||this.isOffline())return;const n=this.sliceUrl?this.sliceUrl:this.globalUrl;t.setDataField("connectionUrl",Xs(n)),this.connect(n),this.sessionInitializer.initSession({isTokenRefresh:!1,isReconnectOnSameSlice:!!this.sliceUrl,extensionConfigs:this.extensionConfigs,onResponse:(n,a)=>{if(t.success=!n,t.resourceId=a?Xs(a.sliceUrl):"",t.dimension2=this.getNetworkModeLogString(),this.getNetworkMode()===ia.HttpFallback?(t.resultDescription=n?`HTTP Error: ${n.error}`:"",t.dimension0=t.success?"HTTPOK":"HTTPFail"):(t.resultDescription=n?`WS Error: ${n.error}`:"",t.dimension0=t.success?"WSOK":"WSFail"),n||!this.worker)return this.sliceUrl=void 0,this.close(),this.httpTestsLeft>0?(this.httpTestsLeft--,this.testHttpConnection(t.stop())):(this.getNetworkMode()===ia.JSWebSockets?0===this.workerOpenCount&&this.httpTestsSuccessCount>=5?(t.dimension1="WSBlocked",t.dimension3="HTTP Fallback",this.networkMode=ia.HttpFallback,this.currentReconnectAttempt=0,this.resetHttpTestsCounter()):0===this.httpTestsSuccessCount&&(this.startOfflineMode(),t.dimension1="WSOffline"):0===this.httpTestsSuccessCount&&(this.startOfflineMode(),t.dimension1="HTTPOffline"),this.logCountLimiter.log(()=>{Bn.info(508843782,aa.CoreDefault,t.stop())})),void this.initInternal();if(this.logCountLimiter.log(()=>{Bn.info(508843781,aa.CoreDefault,t.stop())}),a.forceReconnect){this.close();const t=new yn({operationName:"ForcedReconnect"}).start();t.resultSignature=`globalUrl: ${this.globalUrl}. sliceUrl: ${this.sliceUrl}`,this.sliceUrl=void 0,setTimeout(()=>{e(t)},1e3)}else clearTimeout(this.connTimeout),this.sliceUrl=a.sliceUrl,this.getNetworkRateController().setRpsBps(a.maxRPS,a.maxBPS),this.ready();this.resetHttpTestsCounter()}})},t=new yn({operationName:"TryToConnectAndInitializeSession",resultSignature:`Reconnection attempt #${this.currentReconnectAttempt}`}).start();e(t)}getNetworkRateController(){return this.networkRateController||(this.networkRateController=new Vs({reducedPingPongRetryEnabled:this.reducedPingPongRetryEnabled})),this.networkRateController}connect(e){const t=this.getNetworkMode();this.networkWorkerLogOp.start(),this.networkWorkerLogOp.resultDescription=this.getNetworkModeLogString(),this.networkWorkerLogOp.dimension0=t.toString(),this.logCountLimiter.log(()=>Bn.info(508372418,aa.CoreDefault,this.networkWorkerLogOp.stop())),this.worker=this.workerFactory(t),this.worker.init(e,this.getNetworkRateController().ingressFromWorker.bind(this.networkRateController),()=>{this.workerOpenCount++,this.getNetworkRateController().open(),this.leaveOfflineMode()},e=>{this.close(),this.onConnectionClose(e)},this.clientMetadata),this.getNetworkRateController().init(this.worker,this.ingress,t,this.clientMetadata,this.sessionCorrelationVector)}ready(){this.isWorkerReady=!0,this.pendingInitPromise=void 0,this.currentReconnectAttempt=0}castBinaryData(e){if(e){if(Array.isArray(e.__binaryMembers__))for(const t of e.__binaryMembers__)ArrayBuffer.isView(e[t])||(e[t]=new Uint8Array(e[t]));for(const t of Object.keys(e))"object"==typeof e[t]&&null!==e[t]&&this.castBinaryData(e[t])}}isOffline(){return!!this.offlineInterval}startOfflineMode(){this.offlineInterval=setInterval(()=>{this.testHttpConnection()},6e4)}leaveOfflineMode(){this.isOffline()&&(clearInterval(this.offlineInterval),this.offlineInterval=void 0,this.resetHttpTestsCounter(),this.tryToConnectAndInitializeSession())}resetHttpTestsCounter(){this.httpTestsLeft=5,this.httpTestsSuccessCount=0}getNetworkModeLogString(){return"NetworkMode: "+(this.getNetworkMode()===ia.JSWebSockets?"WebSocket":"HTTP")}}$s.initialAttemptTimeout=1e5,$s.reconnectAttemptTimeout=2e4,$s.className="NetworkWorkerManager";class ec extends zo.EventEmitter{constructor(e,t,n,a,i,r,o,s,c){super(),this.cvParent=new Ir,this.logOp=new yn({operationName:"SessionState",success:!0}).start(),this.sessionStateChangeLogCountLimiter=new Jo("SessionState"),this.stats=t,this.allStates={[xs.Initing]:new Ms(this),[xs.Running]:new Ps(this),[xs.Disconnected]:new Ts(this),[xs.Closed]:new Us(this)},this.setState(xs.Initing),this.messageEndpoint=new go({messageIdPrefix:"c",responseTimeoutMs:3e4,resendPendingMessagesOnReconnect:!1}),this.messageEndpoint.setClientMetadata(i),this.messageEndpoint.setEgress(this.egress.bind(this)),this.messageEndpoint.onMessage(li.getTypeName(),(e,t)=>{this.onSessionCloseMessage(e,t)}),this.networkWorkerManager=new $s(e,i,n,a,this.ingress.bind(this),this.onConnectionClose.bind(this),this.getCorrelationVector.bind(this),o,c),this.messageQueue=new ws({sendMessage:(e,t,n,a)=>this.state.sendMessage(e,t,n,a),sendBytes:this.sendBytes.bind(this),canSendMessage:()=>this.state.canSendMessage()}),a.on("connect",(e,t,n,a,i,r,o,s,c)=>{this.setState(xs.Running,"",{isSessionReseedingStarted:e&&t}),this.emit("connect",e,n,a,i,r,o,s,c)}),a.on("reconnect",()=>this.emit("reconnect")),a.on("serverAuthenticationStateChange",e=>this.emit("serverAuthenticationStateChange",e)),this.resetNextSyncSequenceId=()=>this.emit("resetNextSyncSequenceId"),this.tokenRefreshManager=r,this.gateUtils=s}setState(e,t,n){if(this.state&&e===this.state.stateName)return;const a=this.state?xs[this.state.stateName]:"undefined",i=this.state?this.state.possibleNextStates.indexOf(e)>=0:e===xs.Initing;this.sessionStateChangeLogCountLimiter.log(()=>{this.logOp.stop(),this.logOp.resourceId=`New state: ${i?xs[e]:a}`,this.logOp.resultDescription=`Previous state: ${a}`,this.logOp.dimension0=`Attempted state: ${xs[e]||"undefined"}`,this.logOp.resultSignature=t+(this.state&&!i?"Unexpected state change":""),this.logOp.success=i,Bn.info(508843791,aa.CoreDefault,this.logOp)}),i&&(this.state=this.allStates[e],this.logOp.start(),this.state.onEnter(n))}init(e,t){return this.extensionConfigs=e,this.customInitPromise=t,this.networkWorkerManager.init(this.extensionConfigs,this.customInitPromise,!0)}sendMessage(e,t,n){this.retrySendMessage(e,t,ec.maxRetries,n)}sendBytes(e){this.state.sendBytes(e)}onMessage(e,t){this.messageEndpoint.onMessage(e,t)}getCorrelationVector(){return this.cvParent}getNetworkWorkerManager(){return this.networkWorkerManager}forceReconnect(e){return this.extensionConfigs=e||this.extensionConfigs,this.networkWorkerManager.close(!1),new Promise(e=>setTimeout(()=>{e(this.networkWorkerManager.init(this.extensionConfigs))},100))}closeSession(e){this.sendMessage(new li),this.networkWorkerManager.close(!0);const t=e||new ci({reasonDescription:"ClientRequested"});this.onSessionClose(new li({reconnectAllowed:!1,reason:t}),"ClientRequested")}ingress(e,t){let n;try{n=JSON.parse(e)}catch(e){Bn.error(508843790,aa.CoreDefault,new yn({operationName:"ProcessMessage",resourceId:"Unknown",success:!1,resultSignature:"ParseError",resultDescription:e.message,durationMs:0}))}if(n){if(t&&Ya.typeGuard(n)&&t(n),this.networkWorkerManager.getNetworkMode()===ia.HttpFallback&&si.typeGuard(n)){const e=n;if(e.batch)for(const t of e.batch)this.messageEndpoint.ingress(t,(e,t)=>this.egress(e||t,()=>{}));return}this.messageEndpoint.ingress(n,(e,t)=>this.egress(e||t,()=>{}))}}egress(e,t,n){e&&this.networkWorkerManager.egress(e,n).then(()=>t()).catch(e=>t(e))}onSessionCloseMessage(e,t){e.reconnectAllowed?this.networkWorkerManager.close():this.onSessionClose(e,"CloseMessageReceived"),t()}onSessionClose(e,t){this.setState(xs.Closed,t),this.tokenRefreshManager.clearAllTimeouts(),this.onConnectionClose(void 0),e&&this.emit("sessionClose",e)}onConnectionClose(e){this.state.onConnectionClose(),this.stats.lastConnectionClose=Yo.getCurrentTimeMs(),this.emit("disconnect",e)}retrySendMessage(t,n,a,i,r){const o=ec.maxRetries-a;this.state.sendMessage(t,(s,c)=>{var d,l,u,f,p,m;r&&(s&&0==a?(r.dimension0=(o+1).toString(),r.success=!1,Bn.info(507025311,aa.CoreDefault,r.stop())):s&&a>0?(r.dimension0=(o+1).toString(),r.dimension1=null!==(l=null===(d=s.code)||void 0===d?void 0:d.toString())&&void 0!==l?l:"NoErrorCode",r.resultSignature=null!==(u=s.error)&&void 0!==u?u:"NoErrorMessage"):(r.success=!0,Bn.info(507025310,aa.CoreDefault,r.stop()))),s&&a>0&&this.canBeRetried(t)&&this.isTransientError(s)?(r||((r=new yn({operationName:"RetrySendMessage",success:!0,dimension0:(o+1).toString()}).start()).resourceId=e.getTypeNameFor(t),r.dimension1=null!==(p=null===(f=s.code)||void 0===f?void 0:f.toString())&&void 0!==p?p:"NoErrorCode",r.resultSignature=null!==(m=s.error)&&void 0!==m?m:"NoErrorMessage",r.resultDescription=`Retrying message with messageId: ${t.messageId}${Si.typeGuard(t)?`, seq: ${t.seq}`:""}`),e.matchesTypesFor(s,[ai.getTypeName()])&&this.networkWorkerManager.onRateLimitErrorResponse(s),this.retrySendMessage(t,n,a-1,i,r)):n&&n(s,c)},o,i)}canBeRetried(t){return!e.matchesTypesFor(t,[ii.getTypeName(),Di.getTypeName(),or.getTypeName()])}isTransientError(e){const t=e.error,n=e.code;return n!==Xr.TokenValidationError&&n!==Xr.TokenDecryptError&&n!==Xr.SyncMessageTooLateOrDuplicate&&n!==Xr.Gone&&t!==po.SyncMessageUnsupportedBatch&&t!==po.UnexpectedSeedMessage&&t!==po.UnsupportedSyncMessage&&t!==po.AnnotationTokenNotFound&&t!==Is.ArrivedBeforeReseeding&&t!==Is.DroppedAsOldestInQueue&&t!==Is.DroppedBecauseClientDisconnected}}var tc;ec.maxRetries=2,function(e){e[e.Anonymous=0]="Anonymous",e[e.Host=1]="Host"}(tc||(tc={}));class nc{constructor(){this.timers=new Map}scheduleRefresh(e,t,n,a){let i=this.timers.get(e);i||(i={numberOfAttempts:0},this.timers.set(e,i)),i.refreshTimeoutId&&(clearTimeout(i.refreshTimeoutId),i.refreshTimeoutId=void 0),i.expiredTimeoutId&&(clearTimeout(i.expiredTimeoutId),i.expiredTimeoutId=void 0);let r=1e3*t-nc.tokenRefreshBufferMs,o=1e3*t-nc.tokenExpirationBufferMs;r>0?i.numberOfAttempts=0:(++i.numberOfAttempts,r=nc.tokenRefreshBackoffIntervalMs,o=nc.tokenExpirationBufferMs),i.numberOfAttempts<=nc.tokenRefreshMaximumAttempts&&(i.refreshTimeoutId=setTimeout(()=>{n()},r)),a&&(i.expiredTimeoutId=setTimeout(()=>{a()},o))}clearRefreshTimeouts(){this.clearTimeouts(!1)}clearAllTimeouts(){this.clearTimeouts(!0)}clearTimeouts(e){this.timers.forEach((t,n)=>{t.refreshTimeoutId&&(clearTimeout(t.refreshTimeoutId),t.refreshTimeoutId=void 0),e&&t.expiredTimeoutId&&(clearTimeout(t.expiredTimeoutId),t.expiredTimeoutId=void 0),t.expiredTimeoutId||this.timers.delete(n)})}}nc.tokenRefreshBufferMs=24e4,nc.tokenExpirationBufferMs=12e4,nc.tokenRefreshBackoffIntervalMs=3e4,nc.tokenRefreshMaximumAttempts=3;class ac extends zo.EventEmitter{constructor(e,t,n,a,i){if(super(),this.getSessionStats=e,this.clientMetadata=t,this.tokenRefreshManager=n,this.sendMessage=a,this.options=i||{},this.options.overrideSessionInitMessage=this.options.overrideSessionInitMessage||(e=>e),this.clientMetadata&&!this.clientMetadata.userSystemTimezone)try{this.clientMetadata.userSystemTimezone=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}}initSession(e){e.onResponse=e.onResponse||(()=>{});const t=Yo.getCurrentTimeMs(),n=this.getSessionStats().lastConnectionClose&&t-this.getSessionStats().lastConnectionClose,a=this.getSessionStats().lastSyncMessage&&t-this.getSessionStats().lastSyncMessage,i=new yn({operationName:"SessionInit"}).start(),r={sessionKey:this.sessionKey,sessionId:this.clientMetadata.sessionId,timeSinceLastConnectionClose:n,timeSinceLastSyncMessage:a,isTokenRefresh:e.isTokenRefresh,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification,error:void 0,isSeedingRequired:void 0,enableCreateBlobStorageContainer:this.options.createBlobStorageContainerEnabled};let o;o=this.options.createCopyOfClientMetadataInSessionInit?Object.assign({},this.clientMetadata):this.clientMetadata;const s=this.options.overrideSessionInitMessage(new ii({protocolVersion:2,clientMetadata:o,sessionKey:this.sessionKey,origin:this.origin,authToken:this.anonymousToken,extensionConfigs:e.extensionConfigs,returnWorkflowInputTypes:!0,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification,createBlobStorageContainer:this.options.createBlobStorageContainerEnabled}));this.sendMessage(s,(t,n)=>{if(i.success=!t,i.resultSignature=this.getSessionStats().lastConnectionClose?"Reconnect":"FirstConnect",i.resourceId=Xs(null==n?void 0:n.sliceUrl),i.setClientMetadata(this.clientMetadata),(null==n?void 0:n.sessionKey)&&r.sessionKey!==n.sessionKey&&(r.sessionKey=n.sessionKey),t&&(r.error=t.error),r.isSeedingRequired=this.sessionKey!==(null==n?void 0:n.sessionKey),i.resultDescription=JSON.stringify(r),Bn.info(508843779,aa.CoreDefault,i.stop()),e.onResponse(t,n),t)this.emit("serverAuthenticationStateChange",ja.NotAuthenticated);else if(e.isReconnectOnSameSlice&&n.forceReconnect)this.emit("serverAuthenticationStateChange",ja.NotAuthenticated);else{if(!n.anonymousToken||!n.tokenExpirationSeconds)return this.emit("serverAuthenticationStateChange",ja.NotAuthenticated),void Bn.error(508843778,aa.CoreDefault,"AL Anonymous token was not generated for the session");this.anonymousToken=n.anonymousToken,this.onSuccessfulSessionInitOnServerSide(n)}})}onSuccessfulSessionInitOnServerSide(e){var t,n;this.tokenRefreshManager.scheduleRefresh(tc.Anonymous,e.tokenExpirationSeconds,this.initSession.bind(this,{isTokenRefresh:!0}),()=>{this.anonymousToken=void 0}),this.connectParams={isSeedingRequired:this.sessionKey!==e.sessionKey,sessionUrl:`${e.sessionUrlBase}/${e.sessionKey}`,origin:e.origin,authToken:this.anonymousToken},(null===(t=this.options)||void 0===t?void 0:t.dontSendTokenOnReconnectChangeGate)&&e.existingTokenProvisionResponse&&(null===(n=e.existingTokenProvisionResponse)||void 0===n?void 0:n.tokenType)===Sn.AugLoopLowPrivilege||(this.options.sendTokenFailureMessageChangeGate?this.initHostAuthTokenNew().catch(()=>{}):this.initHostAuthToken());const a=!!this.sessionKey;this.sessionKey=e.sessionKey,this.origin=e.origin,this.emit("connect",this.connectParams.isSeedingRequired,a,this.connectParams.sessionUrl,this.connectParams.origin,this.connectParams.authToken,e.workflowInputTypes,e.downstreamRuntimeWorkflows,e.routingSessionKey,e.blobFileId),a&&this.emit("reconnect")}getAuthToken(){const e={Tickets:[],DocSessionId:this.clientMetadata.docSessionId,TokenType:qr.Augloop,ConnectParams:this.connectParams};return this.options.requestAuthToken(e).then(e=>e).catch(()=>{})}getAuthTokenNew(){const e={Tickets:[],DocSessionId:this.clientMetadata.docSessionId,TokenType:qr.Augloop,ConnectParams:this.connectParams};return this.options.requestAuthToken(e).then(e=>e)}getAuthTokenTimeoutPromise(){const e=this.options.authTokenTimeoutMs;return new Promise((t,n)=>{setTimeout(()=>{n(new Error(`Host auth token provision took longer than ${e} ms`))},e)})}initHostAuthToken(){const e=this.getAuthToken.bind(this);if(this.options.requestAuthToken&&e){const t=new yn({operationName:"RefreshAuthToken",success:!0}).setClientMetadata(this.clientMetadata).start();e().then(e=>{if(e){if(!e.Token)return e.TokenError==Qr.TokenMissingInteractionRequired?(this.emit("serverAuthenticationStateChange",ja.TokenMissingInteractionRequired),t.resultDescription="Host auth token provision failed interaction required"):(this.emit("serverAuthenticationStateChange",ja.NotAuthenticated),t.resultDescription="Host auth token provision failed"),t.success=!1,void Bn.info(508843777,aa.CoreDefault,t.stop());Bn.info(508843776,aa.CoreDefault,t.stop()),this.sendTokenProvisionMessage(e.Token)}else t.resultDescription="TokenResponse is not set"}).catch(e=>{this.emit("serverAuthenticationStateChange",ja.NotAuthenticated),t.success=!1,t.resultDescription=`Error happened while attempting to fetch host token: ${e}`,Bn.error(508843747,aa.CoreDefault,t.stop())})}}initHostAuthTokenNew(){return e=this,void 0,n=function*(){const e=this.getAuthTokenNew.bind(this);if(this.options.requestAuthToken&&e){const t=new yn({operationName:"RefreshAuthToken",success:!0}).setClientMetadata(this.clientMetadata).start();let n,a,i=ja.NotAuthenticated;try{if(n=this.options.authTokenTimeoutMs>0?yield Promise.race([e(),this.getAuthTokenTimeoutPromise()]):yield e(),!n)throw new Error("TokenResponse is not set");if(!n.Token)throw n.TokenError==Qr.TokenMissingInteractionRequired?(i=ja.TokenMissingInteractionRequired,new Error("Host auth token provision failed interaction required")):new Error("Host auth token provision failed")}catch(e){a=e.message,this.emit("serverAuthenticationStateChange",i),t.success=!1,t.resultDescription=`Error happened while attempting to fetch host token: ${e}`}try{a?this.sendMessage(new wi({reason:a,version:ac.initialTokenVersion,clientHandlesResponse:!0})):this.sendTokenProvisionMessage(n.Token)}catch(e){a||(a=e.message,this.emit("serverAuthenticationStateChange",i),t.success=!1,t.resultDescription=`Error happened while attempting to send host token: ${e}`)}finally{a?Bn.error(506074845,aa.CoreDefault,t.stop()):Bn.info(506074846,aa.CoreDefault,t.stop())}}},new((t=void 0)||(t=Promise))(function(a,i){function r(e){try{s(n.next(e))}catch(e){i(e)}}function o(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var n;e.done?a(e.value):(n=e.value,n instanceof t?n:new t(function(e){e(n)})).then(r,o)}s((n=n.apply(e,[])).next())});var e,t,n}sendTokenProvisionMessage(e){const t=new Oi({authToken:e,version:ac.initialTokenVersion});this.emit("serverAuthenticationStateChange",ja.Pending),this.sendMessage(t,this.onTokenProvisionResponse.bind(this),!0)}onTokenProvisionResponse(e,t){!e&&t&&t.tokenExpirationSeconds?(this.emit("serverAuthenticationStateChange",ja.Authenticated),this.tokenRefreshManager.scheduleRefresh(tc.Host,t.tokenExpirationSeconds,this.initHostAuthToken.bind(this))):this.emit("serverAuthenticationStateChange",ja.NotAuthenticated)}}ac.initialTokenVersion=1;var ic=null;"undefined"!=typeof WebSocket?ic=WebSocket:"undefined"!=typeof MozWebSocket?ic=MozWebSocket:void 0!==o.g?ic=o.g.WebSocket||o.g.MozWebSocket:"undefined"!=typeof window?ic=window.WebSocket||window.MozWebSocket:"undefined"!=typeof self&&(ic=self.WebSocket||self.MozWebSocket);const rc=ic,oc="object"==typeof process&&"object"==typeof process.versions&&void 0!==process.versions.node,sc=1e5;class cc{constructor(e,t){this.networkOverrideOptions=e,this.settings=t,this.hadEgressError=!1,this.isClosing=!1,this.pendingEgress=[]}get egressByteCountOp(){return this._egressByteCountOp||(this._egressByteCountOp=new yn({operationName:"WSEgressByteOrderOfMagnitude",success:!0}),this._egressByteCountOp.setClientMetadata(this.clientMetadata,!0)),this._egressByteCountOp}init(e,t,n,a,i){var r,o;if(this.clientMetadata=i,oc&&this.networkOverrideOptions){const t={servername:null===(r=this.networkOverrideOptions)||void 0===r?void 0:r.hostHeader,headers:(null===(o=this.networkOverrideOptions)||void 0===o?void 0:o.hostHeader)?{host:this.networkOverrideOptions.hostHeader}:void 0};this.ws=new rc(e,t)}else this.ws=new rc(e);this.logOp=new yn({operationName:cc.className,success:!0}).start(),this.logOp.setClientMetadata(i,!0),this.ingressByteCountOp=new yn({operationName:"WSIngressByteOrderOfMagnitude",success:!0}),this.ingressByteCountOp.setClientMetadata(i,!0),this.ws.addEventListener("open",e=>{n(),this.logOp.resourceId="OnOpen",this.logOp.resultDescription="",this.logOp.success=!0,this.logOp.dimension0=this.pendingEgress.length.toString(),Bn.info(508843801,aa.CoreDefault,this.logOp.stop())}),this.ws.addEventListener("message",e=>{this.logIngressCount(e.data),t(e.data)}),this.ws.addEventListener("error",e=>{this.errorMessage=e.message,this.logOp.resourceId="OnError",this.logOp.resultDescription=this.errorMessage,this.logOp.success=!1,Bn.info(508843800,aa.CoreDefault,this.logOp.stop()),this.ws?this.ws.close():this.logWsUndefinedError("error event handler")}),this.ws.addEventListener("close",e=>{this.logOp.resourceId="OnClose",this.logOp.resultDescription=e?`code: ${e.code}. reason: ${e.reason}`:"",this.logOp.success=!0,Bn.info(508843799,aa.CoreDefault,this.logOp.stop()),a(this.errorMessage),this.isClosing=!1})}egress(e){var t;const n=e.obj;(null===(t=this.settings)||void 0===t?void 0:t.webSocketWorkerShouldLogEgressCount)&&this.logEgressCount(n),this.ws.send(n,e=>{e&&!this.hadEgressError&&(this.hadEgressError=!0,this.logOp.resourceId="OnEgressError",this.logOp.resultDescription=e.message,this.logOp.success=!1,Bn.info(508843797,aa.CoreDefault,this.logOp.stop()))})}close(){this.isClosing||(this.isClosing=!0,this.ws?this.ws.close():this.logWsUndefinedError("close"))}logIngressCount(e){const t=e.length;t>sc&&(this.ingressByteCountOp.start(),this.ingressByteCountOp.dimension2=t.toString().length.toString(),Bn.info(508843794,aa.CoreDefault,this.ingressByteCountOp.stop()))}logEgressCount(e){const t="string"==typeof e?e.length:e.byteLength;t>sc&&(this.egressByteCountOp.start(),this.egressByteCountOp.dimension2=t.toString().length.toString(),Bn.info(505710625,aa.CoreDefault,this.egressByteCountOp.stop()))}logWsUndefinedError(e){const t=new yn({operationName:cc.className,success:!1}).start();t.setClientMetadata(this.clientMetadata,!0),t.resourceId="webSocketUndefined",t.resultDescription=e+": this.ws null or undefined",Bn.info(506566722,aa.CoreDefault,t.stop())}}cc.className="WebSocketWorker";var dc=function(e,t,n,a){return new(n||(n=Promise))(function(i,r){function o(e){try{c(a.next(e))}catch(e){r(e)}}function s(e){try{c(a.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,s)}c((a=a.apply(e,t||[])).next())})};const lc="CloseSessionsOnRuntimeUninit",uc="ShouldAppendClientFeatureFlights",fc="DontSendNewTokenOnReconnect",pc="WebSocketWorkerShouldLogEgressCount",mc="FixIncorrectInvocationOfClaimsCallbacks",_c="LogExpiredTimeoutTasksInBatchManager";class hc{constructor(e,t,n,a){this.sessionsByDocSessionId=new Map,this.isDeltaGeneratorEnabled=!1,this.disableSyncDeltaSending=!1,this.hasBeenInitialized=!1,this.telemetryLogger=null,this.changeGateList=new Map([["SkipCheckingCachedClaimsChallenge",!0],[lc,!0],[uc,!0],[fc,!0],[pc,!0],[mc,!0],[_c,!0]]),this.settings={annotationsOrderingEnabled:!0,deltaOperationsEnabled:!1,defaultBatchingEnabled:!0,batchingWith20msIntervalEnabled:!0,onAnnotationsSubmittedEnabled:!1,reduceBatchOperationsEnabled:!1,batchMessagesEnabled:!1,removeDuplicateFlights:!0,annotationDoesNotExistOnService:!0,reducedPingPongRetryEnabled:!1,maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled:!1,sendTokenFailureMessage:!0,closeSessionsOnRuntimeUninit:!1,shouldAppendClientFeatureFlights:!0,authTokenTimeoutMs:0,doNotSendNewTokenOnReconnect:!1,webSocketWorkerShouldLogEgressCount:!0,createBlobStorageContainerEnabled:!1,createCopyOfClientMetadataInSessionInit:!0,doNotAddCustomLogger:!1},this.settingToChangeGateName={closeSessionsOnRuntimeUninit:lc,shouldAppendClientFeatureFlights:uc,doNotSendNewTokenOnReconnect:fc,webSocketWorkerShouldLogEgressCount:pc},this.isDownloaderCompatible=()=>"undefined"!=typeof Array&&void 0!==Array.from&&"undefined"!=typeof URL&&void 0!==URL.createObjectURL,a&&(this.settings=a),this.workerFactory=e||(e=>e&&e===ia.HttpFallback?new Ss:new cc(void 0,this.settings));const i=this.createDefaultSessionManagerFactory();this.sessionManagerFactory=(...e)=>(null==t?void 0:t(...e))||i(...e),this.sessionFactory=n||(e=>new as(e))}init(e,t,n,a){var i,r,s,c,d,l,u,f,p,m;const _=new yn({operationName:"InitRuntime",resourceId:Xs(e),dimension1:this.hasBeenInitialized.toString()});_.start(),this.hasBeenInitialized=!0,this.hostCallbacks=n,this.gateUtils=new Ma(this.hostCallbacks,this.changeGateList),this.clientMetadata=t,this.clientMetadata&&(this.clientMetadata.runtimeVersion=o(938).r),this.telemetryLogger=new Zs(this.hostCallbacks),this.settings.doNotAddCustomLogger=this.settings.doNotAddCustomLogger||!!a.doNotAddCustomLogger,this.settings.doNotAddCustomLogger||(this.shouldAddLogger(_)?(Bn.addLogger(this.telemetryLogger),this.addLoggingAggregator(a)):(Bn.clearLoggers(),Bn.addLogger(this.telemetryLogger))),hc.haveCalledInit=!0,this.annotationResultsProcessor=new pa(()=>this.settings.annotationsOrderingEnabled),this.inferenceServiceFactory=a.inferenceServiceFactory,_.dimension2=qn(pn.info).toString();const h=[];e&&(this.defaultServiceUrl=Yo.convertServiceUrlToWebSocket(e),this.serviceProtocol=this.defaultServiceUrl.split(":")[0].toLowerCase()),h.push(this.gateUtils.init().then(()=>dc(this,void 0,void 0,function*(){yield Promise.all(Object.keys(this.settingToChangeGateName).map(e=>dc(this,void 0,void 0,function*(){try{const t=yield this.gateUtils.isChangeGateEnabled(this.settingToChangeGateName[e]);this.settings[e]=t}catch(t){this.settings[e]=!1}})))}))),h.push(this.isFeatureEnabled("AnnotationsOrderingEnabled",!0).then(e=>{this.settings.annotationsOrderingEnabled=e})),h.push(this.isFeatureEnabled("DefaultBatchingDisabled").then(e=>{var t;(t=this.settings).defaultBatchingEnabled&&(t.defaultBatchingEnabled=!e)})),h.push(this.isFeatureEnabled("BatchingWith20msIntervalDisabled").then(e=>{var t;(t=this.settings).batchingWith20msIntervalEnabled&&(t.batchingWith20msIntervalEnabled=!e)})),h.push(this.isFeatureEnabled("OnAnnotationsSubmittedDisabled").then(e=>{var t;(t=this.settings).onAnnotationsSubmittedEnabled&&(t.onAnnotationsSubmittedEnabled=!e)})),h.push(this.isFeatureEnabled("ReduceBatchOperationsEnabled").then(e=>{var t;(t=this.settings).reduceBatchOperationsEnabled||(t.reduceBatchOperationsEnabled=e)})),h.push(this.isFeatureEnabled("BatchMessagesEnabled").then(e=>{var t;(t=this.settings).batchMessagesEnabled||(t.batchMessagesEnabled=e)})),h.push(Yo.isChangeGateEnabled(this.hostCallbacks,"AnnotationDoesNotExistOnService").then(e=>{this.settings.annotationDoesNotExistOnService=e})),h.push(Yo.isFeatureEnabled(this.hostCallbacks,"ReducedPingPongRetryEnabled").then(e=>{var t;(t=this.settings).reducedPingPongRetryEnabled||(t.reducedPingPongRetryEnabled=e)})),h.push(this.isFeatureEnabled("MaxNumberOfDeltaUpdateOpsPerItemPerBatch").then(e=>{var t;(t=this.settings).maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled||(t.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=e)})),h.push(Yo.isChangeGateEnabled(this.hostCallbacks,"SendTokenFailureMessage").then(e=>{this.settings.sendTokenFailureMessage=e})),h.push(this.isFeatureEnabled("CreateBlobStorageContainerEnabled").then(e=>{var t;(t=this.settings).createBlobStorageContainerEnabled||(t.createBlobStorageContainerEnabled=e)})),h.push(Yo.isChangeGateEnabled(this.hostCallbacks,"CreateCopyOfClientMetadataInSessionInit").then(e=>{var t;(t=this.settings).createCopyOfClientMetadataInSessionInit||(t.createCopyOfClientMetadataInSessionInit=e)}));const b={enableDeltas:!1,enableEarlyJoin:!1};h.push(Promise.all([this.isFeatureEnabled("DeltaOperationsEnabled").then(e=>b.enableDeltas=e).catch(()=>b.enableDeltas=!1),this.isFeatureEnabled("EarlyJoinCompletionEnabled").then(e=>b.enableEarlyJoin=e).catch(()=>b.enableEarlyJoin=!1)]).then(()=>{this.localWorkflowManager=new hs(a.modelDownloader&&this.isDownloaderCompatible()?a.modelDownloader:void 0,this.inferenceServiceFactory,b)}));const g=oa(null!==(i=t.flights)&&void 0!==i?i:"");var v;return this.isDeltaGeneratorEnabled=g.getBooleanValue("Microsoft.Office.WordOnline.AugloopDeltas",null!==(r=a.isDeltaGeneratorEnabled)&&void 0!==r&&r),this.disableSyncDeltaSending=g.getBooleanValue("Microsoft.Office.WordOnline.DisableSyncDeltaSending",null!==(s=a.disableSyncDeltaSending)&&void 0!==s&&s),this.syncDeltaTimeout=g.getIntValue("Microsoft.Office.WordOnline.SyncDeltaTimeout",a.syncDeltaTimeout),(c=this.settings).defaultBatchingEnabled&&(c.defaultBatchingEnabled=!g.getBooleanValue("DefaultBatchingDisabled",!1)),(d=this.settings).batchingWith20msIntervalEnabled&&(d.batchingWith20msIntervalEnabled=!g.getBooleanValue("BatchingWith20msIntervalDisabled",!1)),(l=this.settings).reduceBatchOperationsEnabled||(l.reduceBatchOperationsEnabled=g.getBooleanValue("ReduceBatchOperationsEnabled",!1)),(u=this.settings).batchMessagesEnabled||(u.batchMessagesEnabled=g.getBooleanValue("BatchMessagesEnabled",!1)),(f=this.settings).removeDuplicateFlights&&(f.removeDuplicateFlights=g.getBooleanValue("RemoveDuplicateFlights",!0)),(p=this.settings).reducedPingPongRetryEnabled||(p.reducedPingPongRetryEnabled=g.getBooleanValue("ReducedPingPongRetryEnabled",!1)),(m=this.settings).maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled||(m.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=g.getBooleanValue("maxNumberOfDeltaUpdateOpsPerItemPerBatch",!1)),this.settings.authTokenTimeoutMs=g.getIntValue("AuthTokenTimeoutMs",0),_.setDataField("Flights",JSON.stringify(this.settings)),a&&a.loggableUrls&&(v=a.loggableUrls,Ys.push(...v)),Promise.all(h).then(()=>{this.batchOptions=a.batchOptions,!this.batchOptions&&this.settings.defaultBatchingEnabled&&(this.batchOptions={delayMs:1,maxInputSize:1e6,delayMsMax:50},this.settings.batchingWith20msIntervalEnabled&&(this.batchOptions.delayMs=20)),this.batchOptions&&!this.batchOptions.delayMsMax&&(this.batchOptions.delayMsMax=50),a&&a.networkMode&&(this.networkMode=a.networkMode,a.networkMode===ia.LocalWorkflowsOnly&&(this.sessionManagerFactory=()=>new Go)),_.dimension0=JSON.stringify(this.batchOptions),this.logOperation(_,!0)}).catch(e=>{this.logOperation(_,!1,"Error",e?e.message:"(no error)")})}getServiceProtocol(){return this.serviceProtocol}registerLocalWorkflow(e){this.localWorkflowManager.registerLocalWorkflow(e)}flushTelemetry(e){Bn.flushAggregators(e)}createSession(e){var t;const n=e&&e.docSessionId?e.docSessionId:O(),a=e&&e.documentId?e.documentId:void 0,i=this.sessionsByDocSessionId.get(n),r=new yn({operationName:"CreateSession",resourceId:n,dimension1:this.hasBeenInitialized.toString()});if(r.start(),i&&!1===i.isClosed)throw this.logOperation(r,!1,"Error","docSessionId already exists"),new Error("docSessionId already exists");let o=e&&null!==(t=e.serviceUrl)&&void 0!==t?t:this.defaultServiceUrl;o=Yo.convertServiceUrlToWebSocket(o),o||((e=e||{}).networkMode=ia.LocalWorkflowsOnly),!this.networkMode||void 0!==(null==e?void 0:e.networkMode)&&null!==(null==e?void 0:e.networkMode)||((e=e||{}).networkMode=this.networkMode),void 0!==(null==e?void 0:e.networkMode)&&null!==(null==e?void 0:e.networkMode)&&(null==e?void 0:e.networkMode)!==ia.JSWebSockets||!this.hasHttpFallbackSession()||((e=e||{}).networkMode=ia.HttpFallback);const s=Object.assign({},this.clientMetadata);if(s.docSessionId=n,a&&(s.documentId=a),e&&e.tid3pHost&&(s.tid3pHost=e.tid3pHost),e&&e.flights&&(s.flights=s.flights?s.flights+";"+e.flights:e.flights),this.settings.shouldAppendClientFeatureFlights){const e=["_acceptsClaimsChallengeMessages","_acceptsSeedingStatusChangeMessages"].join(";");s.flights=s.flights?`${s.flights};${e}`:e}this.settings.removeDuplicateFlights&&s.flights&&(s.flights=function(e){if(!e)return"";const t=new Set,n=[];for(const a of e.split(";").reverse()){const e=a.split(":")[0],i=sa.normalizeName(e);t.has(i)||(t.add(i),n.push(a))}return n.reverse().join(";")}(s.flights)),r.setDataField("Flights",s.flights||"");const c=this.sessionFactory({hostCallbacks:this.hostCallbacks,sessionManager:this.sessionManagerFactory(s,o,e),batchOptions:this.batchOptions,extensionConfigs:(null==e?void 0:e.extensionConfigs)||[],clientMetadata:s,userContext:e?e.userContext:void 0,localWorkflowManager:this.localWorkflowManager,annotationResultsProcessor:this.annotationResultsProcessor,localRegisteredWorkflows:(null==e?void 0:e.localRegisteredWorkflows)||[],enableRemoteExecutionNotification:(null==e?void 0:e.enableRemoteExecutionNotification)||!1,networkMode:null==e?void 0:e.networkMode,egress:e?e.egress:void 0,isDeltaGeneratorEnabled:this.isDeltaGeneratorEnabled,onAnnotationsSubmittedEnabled:this.settings.onAnnotationsSubmittedEnabled,disableSyncDeltaSending:this.disableSyncDeltaSending,syncDeltaTimeout:this.syncDeltaTimeout,reduceBatchOperationsEnabled:this.settings.reduceBatchOperationsEnabled,batchMessagesEnabled:this.settings.batchMessagesEnabled,annotationDoesNotExistOnServiceEnabled:this.settings.annotationDoesNotExistOnService,maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled:this.settings.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled,gateUtils:this.gateUtils});return this.sessionsByDocSessionId.set(n,c),e&&(e.onSessionConnect&&c.setConnectCallback(e.onSessionConnect),e.onSessionDisconnect&&c.setDisconnectCallback(e.onSessionDisconnect),e.onSessionReconnect&&c.setReconnectCallback(e.onSessionReconnect),e.onSessionClose&&c.setSessionCloseCallback(e.onSessionClose),e.onServerAuthenticationStateChangeCallback&&c.setServerAuthenticationStateChangeCallback(e.onServerAuthenticationStateChangeCallback),e.onClaimsChallengeCallback&&c.setClaimsChallengeCallback(e.onClaimsChallengeCallback),e.onSeedingStatusChangeCallback&&c.setSeedingStatusChangeCallback(e.onSeedingStatusChangeCallback)),this.logOperation(r,!0),c.initialize?c.initialize():Promise.resolve(c)}getSession(e){return this.sessionsByDocSessionId.get(e)}getSessionManagerFactory(){return this.sessionManagerFactory}shouldAddLogger(e){if(hc.haveCalledInit){const t=new Error("Runtime already initialized");return e.dimension3=t.stack,e.dimension2=qn(pn.info).toString(),this.logOperation(e,!1,"Error",t.message),!1}return!0}createDefaultSessionManagerFactory(){return(e,t,n)=>{if(n&&n.networkMode==ia.LocalWorkflowsOnly)return new Go;const a=new nc,i=new Ds;let r=()=>{Bn.error(573321615,aa.CoreDefault,"Unexpectedly not set sendMessage")};const o=new ac(()=>i,e,a,(e,t,n)=>{r(e,t,n)},{requestAuthToken:this.hostCallbacks.requestAuthToken,overrideSessionInitMessage:this.hostCallbacks.overrideSessionInitMessage,enableRemoteExecutionNotification:(null==n?void 0:n.enableRemoteExecutionNotification)||!1,sendTokenFailureMessageChangeGate:this.settings.sendTokenFailureMessage,authTokenTimeoutMs:this.settings.authTokenTimeoutMs,dontSendTokenOnReconnectChangeGate:this.settings.doNotSendNewTokenOnReconnect,createBlobStorageContainerEnabled:this.settings.createBlobStorageContainerEnabled,createCopyOfClientMetadataInSessionInit:this.settings.createCopyOfClientMetadataInSessionInit}),s=new ec(Yo.convertServiceUrlToWebSocket(t),i,this.workerFactory,o,e,a,this.settings,this.gateUtils,null==n?void 0:n.networkMode);return r=s.sendMessage.bind(s),s.on("disconnect",()=>a.clearRefreshTimeouts()),s.on("connect",(e,t,n,a)=>{e&&this.hostCallbacks.setSessionData&&this.hostCallbacks.setSessionData(t,n,a);const i=t.substring(t.lastIndexOf("/")+1);this.telemetryLogger.setServerSessionKey(i)}),s}}isFeatureEnabled(e,t=!1,n="None"){return Yo.isFeatureEnabled(this.hostCallbacks,e,t,n)}hasHttpFallbackSession(){let e=!1;return this.sessionsByDocSessionId.forEach(t=>{t.isHttpFallback()&&(e=!0)}),e}logOperation(e,t,n,a){e.stop(),e.success=t,e.resultSignature=n,e.resultDescription=a,Bn.info(573321622,aa.CoreDefault,e)}addLoggingAggregator(e){var t,n,a,i;"Dogfood"!==this.clientMetadata.releaseAudienceGroup&&"Automation"!==this.clientMetadata.releaseAudienceGroup&&(Bn.addAggregator(Js("Operation","operationName",["ExecuteBatch","ReduceBatchOperations","ProcessResponse","LocalDeltaUpdate","ApplyFormattedTextTileDeltaForLocalWorkflows","ApplyTextTileDeltaForLocalWorkflows","FindRangeForDelta","RunModelForInferencing","GetResource","CreateTextTileDeltaFromItem","NetworkEgressControl","HttpEgress","LongPollNoOp","NetworkRateControllerAbandonedSyncMessage","NetworkRateControllerEgress","NetworkRateControllerQueueItem","NetworkRateControllerOnRateLimitResponse","NetworkRateControllerOnRateLimitError","NetworkRateControllerRateLimitsSet"],null!==(t=e.telemetryAggregationIntervalSec)&&void 0!==t?t:30)),Bn.addAggregator(Js("Operation","operationName",["ExecuteWorkflow","ExecuteLambda","EarlyJoinCompletion","OnLongPollMessage","OnAnnotationResultsEgress"],null!==(n=e.telemetryAggregationIntervalSec)&&void 0!==n?n:60)),Bn.addAggregator(Js("Operation","operationName",["LocalScopeExecutionNotification","RunLocalWorkflows","EarlyJoinCompletion","SetAnnotations","WIS.addItemOnContextIdList","WIS.setScopeItem"],null!==(a=e.telemetryAggregationIntervalSec)&&void 0!==a?a:120)),Bn.addAggregator(Js("SessionHealth","sessionHealthEventName",["SendMessage","ProcessMessage"],null!==(i=e.telemetryAggregationIntervalSec)&&void 0!==i?i:60)))}uninitialize(){this.settings.closeSessionsOnRuntimeUninit&&(this.sessionsByDocSessionId.forEach(e=>{e.close()}),this.sessionsByDocSessionId.clear()),this.flushTelemetry(!0),this.hostCallbacks=null,this.hasBeenInitialized=!1,this.telemetryLogger=null,hc.haveCalledInit=!1,this.settings.doNotAddCustomLogger||(Bn.clearAggregators(),Bn.clearLoggers())}}new hc;class bc{async tryCreateSession(e){const t=await this._getAugloopClient();return await t.createSession(e)}dispose(){this._augloopRuntime&&this._augloopRuntime.flushTelemetry(!0)}async _getAugloopClient(){return this._augloopRuntime||(this._augloopRuntime=await this._createAugloopClient()),this._augloopRuntime}async _createAugloopClient(){this._augloopRuntime=new hc;const e=(t=this._params.env)?un[t]:"";var t;const n={appName:this._params.metadata.appName,appPlatform:"Web",flights:this._params.metadata.flights,releaseAudienceGroup:e,sessionId:`alproxy_${this._params.metadata.aadSessionId}`,uiLanguage:this._params.metadata.uiLanguage},a=function(e,t=!1){if(window.sessionStorage?.getItem("_isRunningTABTest")){const e=fn();if(e)return e}let n;return e===tn&&t&&(n=fn()),n||(n=ln[e??an]),n}(this._params.env,this._params.useAugloopTestUrl);return await this._augloopRuntime.init(a,n,this._params.hostCallbacks,{telemetryAggregationIntervalSec:100}),this._augloopRuntime}constructor(e){this._params=e}}class gc{static getTypeName(){return"AugLoop_SharepointCopilot_SharepointCopilotRequest"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[gc.getTypeName()])}constructor(t){e.assign(gc,this,t)}}gc.H_={T_:gc.getTypeName(),B_:gc.getBaseTypes()};class vc{static typeGuard(t){return e.matchesTypesFor(t,[vc.getTypeName()])}static getTypeName(){return"AugLoop_SharepointCopilot_SharepointCopilotAnswer"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}constructor(t){e.assign(vc,this,t)}}var yc;vc.H_={T_:vc.getTypeName(),B_:vc.getBaseTypes()},function(e){e["FileHandler.getAnswerForFile"]="FileHandler.getAnswerForFile"}(yc||(yc={}));class Sc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Sc,this,t)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPCopilotOutputAnnotation"}static getBaseTypes(){return["AugLoop_Copilot_CopilotOutputAnnotation","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Sc.getTypeName()])}}Sc.H_={T_:Sc.getTypeName(),B_:Sc.getBaseTypes()};class Dc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Dc,this,t)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPCopilotOutputStreamAnnotation"}static getBaseTypes(){return["AugLoop_Copilot_CopilotOutputStreamAnnotation","AugLoop_Core_StreamAnnotation","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Dc.getTypeName()])}}Dc.H_={T_:Dc.getTypeName(),B_:Dc.getBaseTypes()};class Ic{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Ic,this,t)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPCortexIndexingAnnotation"}static getBaseTypes(){return["AugLoop_Copilot_CopilotOutputAnnotation","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Ic.getTypeName()])}}Ic.H_={T_:Ic.getTypeName(),B_:Ic.getBaseTypes()};class xc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(xc,this,t)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPCopilotChatHistoryAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[xc.getTypeName()])}}xc.H_={T_:xc.getTypeName(),B_:xc.getBaseTypes()};class Cc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Cc,this,t)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPCopilotScopeContextAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Cc.getTypeName()])}}Cc.H_={T_:Cc.getTypeName(),B_:Cc.getBaseTypes()};class Oc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Oc,this,t)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPCopilotFileContextAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Oc.getTypeName()])}}Oc.H_={T_:Oc.getTypeName(),B_:Oc.getBaseTypes()};class wc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(wc,this,t)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPCortexFileAnnotation"}static getBaseTypes(){return["AugLoop_OdspCopilot_ODSPCopilotFileContextAnnotation","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[wc.getTypeName()])}}wc.H_={T_:wc.getTypeName(),B_:wc.getBaseTypes()};class Ec{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Ec,this,t)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPValidateGptAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Ec.getTypeName()])}}Ec.H_={T_:Ec.getTypeName(),B_:Ec.getBaseTypes()};class Ac{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Ac,this,t)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPResearchGenerateContentResponseAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Ac.getTypeName()])}}Ac.H_={T_:Ac.getTypeName(),B_:Ac.getBaseTypes()};class Lc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Lc,this,t)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPResearchReportProgressAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Lc.getTypeName()])}}Lc.H_={T_:Lc.getTypeName(),B_:Lc.getBaseTypes()};class kc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(kc,this,t)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPResearchReportResearchFileUpdatedAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[kc.getTypeName()])}}kc.H_={T_:kc.getTypeName(),B_:kc.getBaseTypes()};class Mc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Mc,this,t)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPResearchCacheAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Mc.getTypeName()])}}Mc.H_={T_:Mc.getTypeName(),B_:Mc.getBaseTypes()};class Pc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Pc,this,t)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPResearchGetCitationDataAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Pc.getTypeName()])}}Pc.H_={T_:Pc.getTypeName(),B_:Pc.getBaseTypes()};class Tc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(Tc,this,t)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPCopilotFolderSortAnnotation"}static getBaseTypes(){return["AugLoop_Copilot_CopilotOutputAnnotation","AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[Tc.getTypeName()])}}function Uc(){return $._SPKillSwitch.isActivated("2ca46dd2-a9a8-4e1d-99c4-4ea3fad1a943")}function Fc(){return $._SPKillSwitch.isActivated("0c587983-65df-469b-8dbb-3c5011dffc29")}Tc.H_={T_:Tc.getTypeName(),B_:Tc.getBaseTypes()};const Hc="https://augloop.office.com/v2",Rc=[ke.getTypeName(),Ke.getTypeName(),Ft.getTypeName(),je.getTypeName(),rt.getTypeName(),"AugLoop_LayoutAnalysis_LayoutAnalysisAnnotation",Sc.getTypeName()],Nc=ee._LogSource.create("sp-augloop-component"),Bc={};async function jc(e,t=!0,n="dogfood",a,i,r,o,s,c){const d=new ee._QosMonitor("AugloopSessionModule.initNewAugloopSession");let l;try{const u={docSessionId:$.Guid.newGuid().toString(),flights:o?o.join(";"):["mc-editor-oa","mc-editor-oa-ecc-annotation","honeybee-al-smartCompose","mc-editor-oa-files-flag","mc-editor-oa-client-ecc-files","mc-editor-oa-flags","vivatopics","oaFluid","mc-editor-oa-vivatopics","mc-editor-oa-debug","csi-editor-topicsuggestions","scd-suggestions-toplevel","csi-editor-topicsuggestions","csi-editor-topicsuggestions-kserving","enableTemplatePrompt:true",...$._SPKillSwitch.isActivated("b023eecd-a49a-4c26-84e3-959e80b63e01")?[]:["enableStopRespondingODSP:false","enableDataSourcesWithInputSignal:true","Microsoft.Office.Shared.Augloop.Copilot.UseAvalon:true"],...$._SPKillSwitch.isActivated("fad5aca9-d190-4a0b-bd77-32c18faf2eed")?[]:["disableSydneyGeneratedSuggestions:true"]].join(";"),onSessionConnect:async(e,n)=>{if(e&&function(e){const t=new f({parentPath:["session"],items:[{id:"doc",body:new zt({isReadonly:!1})}]});e.submitSeedOperations([t])}(l),t){const e=Rc.map(e=>l.activateAnnotation(e));await Promise.all(e)}if(r){const e=n.substring(n.lastIndexOf("/")+1);r(e)}},documentId:Vc(e,a)},p=function({env:e,aadSessionId:t,appNameOverride:n,uniqueKey:a,clientMetadataOverride:i}){const r=n??(function(){if($._SPFlight.isDebugFlightEnabled)return new URLSearchParams(window.location.search).get("alTestAppName")||void 0}()||"SharePoint"),o=$._SPKillSwitch.isActivated("7c0ba7be-5de1-44ce-ab7d-ad6a50a0455c")?e:`${e}.${t}.${r}${a?`.${a}`:""}`;let s=Bc[o];return s||(s=new bc({env:e,useAugloopTestUrl:$._SPFlight.isDebugFlightEnabled,metadata:{appName:r,aadSessionId:t,...i},hostCallbacks:{onAnnotationResult:e=>{ee._TraceLogger.logVerbose(Nc,"Workflow annotation result","onAnnotationResult")},isFeatureEnabled:(e,t)=>Promise.resolve(!0),onResult:()=>{},executeLocalLambda:()=>Promise.resolve(),areLicenseFeaturesEnabled:()=>Promise.resolve(!1),requestAuthToken:function(){return new Promise((e,t)=>{(function(){const e=new ee._QosMonitor("AugloopSessionModule.AugLoopAuthCallback.GetToken");return en._AadTokenProviders.configurable._getTokenInternal($._SPKillSwitch.isActivated("5eaf8b7e-6971-454c-9688-543950eea15d")?Hc:function(){const e=function(){if(!$._SPFlight.isDebugFlightEnabled)return;const e=new URLSearchParams(window.location.search).get("alTest")||void 0;try{return new URL(e),e}catch{return e?"https://test.augloop.svc.cloud-dev.microsoft":void 0}}();return e&&(e.includes("int")||e.includes("test"))?"https://augloop-int.officeppe.com/v2":Hc}(),en._AadTokenProviders.preAuthorizedConfiguration).then(t=>(e.writeSuccess(),t)).catch(t=>{throw ee._TraceLogger.logError(Nc,t,"Unable to get augloop token"),e.writeUnexpectedFailure("AugloopSessionModule.AugLoopAuthCallback.GetTokenFailure",t),t})})().then(t=>{e({Token:t})}).catch(e=>{ee._TraceLogger.logError(Nc,e,"Unable to get augloop token"),t(e)})})},sendTelemetryEvent:()=>{}}}),Bc[o]=s),s}({env:"prod"===n?an:e.cloudType??an,aadSessionId:e.aadSessionId||"",appNameOverride:i,uniqueKey:s,clientMetadataOverride:c});return l=await p.tryCreateSession(u),d.writeSuccess(),l}catch(e){throw ee._TraceLogger.logError(Nc,e,"Unable to init augloop session"),d.writeUnexpectedFailure("AugloopSessionModule.initNewAugloopSessionFailure",e),e}}function Vc(e,t){if(!t)return;let{siteId:n,webId:a,listId:i}=e;return[n,a,i]=[n,a,i].map(e=>e.replace(/[{}]/g,"")),`SPO_${btoa(n+","+a+","+i).slice(0,-1)}_${t}`}const zc=(e,t)=>{const n=e.boundingRegions[0].polygon[0].x,a=e.boundingRegions[0].polygon[1].y,i=t.boundingRegions[0].polygon[0].x,r=t.boundingRegions[0].polygon[1].y;return a<r?-1:a===r?n<i?-1:0:1},Gc=(e,t)=>{const n=e.boundingBox.left,a=e.boundingBox.top,i=t.boundingBox.left,r=t.boundingBox.top;return a<r?-1:a===r?n<i?-1:0:1},Kc=(e,t)=>{const n=(Math.min(e.right,t.right)-Math.max(e.left,t.left))*(Math.min(e.bottom,t.bottom)-Math.max(e.top,t.top));return n/(e.width*e.height+t.width*t.height-n)*100},Wc=e=>{const t=e.cells.filter(e=>"columnHeader"===e.kind).reduce((e,t)=>`${e}<th colspan=${t.columnSpan}>${t.content}</th>`,""),n=t?`<thead><tr>${t}</tr></thead>`:"",a=e.cells.filter(e=>"content"===e.kind).reduce((e,t)=>(e.has(t.rowIndex)?e.get(t.rowIndex)?.push(t):e.set(t.rowIndex,[t]),e),new Map);return`<table>${n}<tbody>${Array.from(a.keys()).reduce((e,t)=>`${e}<tr>${a.get(t).reduce((e,t)=>`${e}<td colspan=${t.columnSpan}>${t.content}</td>`,"")}</tr>`,"")}</tbody></table>`};var qc,Qc,Yc,Jc,Xc,Zc,$c,ed;!function(e){e.Document="Document",e.Enterprise="Enterprise"}(qc||(qc={})),(ed=Qc||(Qc={})).GetCurrentChatOperation="GetCurrentChatOperation",ed.GetAllChatsOperation="GetAllChatsOperation",ed.GetChatOperation="GetChatOperation",ed.AddChatOperation="AddChatOperation",ed.AddMessageOperation="AddMessageOperation",ed.GetMessagesOperation="GetMessagesOperation",ed.GetMessagesInCurrentChatSession="GetMessagesInCurrentChatSession",ed.RemoveAllMessagesFromCurrentChatOperation="RemoveAllMessagesFromCurrectChatOperation",ed.DeleteChatOperation="DeleteChatOperation",ed.UpdateMessageOperation="UpdateMessageOperation",ed.UpdateChatOperation="UpdateChatOperation",function(e){e.User="User",e.Copilot="Copilot",e.System="System"}(Yc||(Yc={})),function(e){e.Unknown="Unknown",e.Canvas="Canvas",e.Pane="Pane"}(Jc||(Jc={})),function(e){e.Success="Success",e.Failure="Failure"}(Xc||(Xc={})),function(e){e.PlainText="PlainText",e.RichText="RichText",e.AdaptiveCard="AdaptiveCard"}(Zc||(Zc={})),function(e){e.AIResponse="AIResponse",e.ContentCreation="ContentCreation",e.Python="Python"}($c||($c={}));class td{constructor(t){e.assign(td,this,t)}static getTypeName(){return"AugLoop_CopilotChatHistory_CopilotChatHistorySignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[td.getTypeName()])}}td.H_={T_:td.getTypeName(),B_:td.getBaseTypes()};class nd{constructor(t){e.assign(nd,this,t)}static getTypeName(){return"AugLoop_CopilotChatHistory_Operation"}static getBaseTypes(){return[]}static typeGuard(t){return e.matchesTypesFor(t,[nd.getTypeName()])}}nd.H_={T_:nd.getTypeName(),B_:nd.getBaseTypes()};class ad{constructor(t){e.assign(ad,this,t)}static getTypeName(){return"AugLoop_CopilotChatHistory_GetCurrentChatOperation"}static getBaseTypes(){return["AugLoop_CopilotChatHistory_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[ad.getTypeName()])}}ad.H_={T_:ad.getTypeName(),B_:ad.getBaseTypes()};class id{constructor(t){e.assign(id,this,t)}static getTypeName(){return"AugLoop_CopilotChatHistory_GetAllChatsOperation"}static getBaseTypes(){return["AugLoop_CopilotChatHistory_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[id.getTypeName()])}}id.H_={T_:id.getTypeName(),B_:id.getBaseTypes()};class rd{constructor(t){e.assign(rd,this,t)}static getTypeName(){return"AugLoop_CopilotChatHistory_GetMessagesOperation"}static getBaseTypes(){return["AugLoop_CopilotChatHistory_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[rd.getTypeName()])}}rd.H_={T_:rd.getTypeName(),B_:rd.getBaseTypes()};class od{constructor(t){e.assign(od,this,t)}static getTypeName(){return"AugLoop_CopilotChatHistory_GetMessagesInCurrentChatSession"}static getBaseTypes(){return["AugLoop_CopilotChatHistory_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[od.getTypeName()])}}od.H_={T_:od.getTypeName(),B_:od.getBaseTypes()};class sd{constructor(t){e.assign(sd,this,t)}static getTypeName(){return"AugLoop_CopilotChatHistory_RemoveAllMessagesFromCurrectChatOperation"}static getBaseTypes(){return["AugLoop_CopilotChatHistory_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[sd.getTypeName()])}}sd.H_={T_:sd.getTypeName(),B_:sd.getBaseTypes()};class cd{constructor(t){e.assign(cd,this,t)}static getTypeName(){return"AugLoop_CopilotChatHistory_GetChatOperation"}static getBaseTypes(){return["AugLoop_CopilotChatHistory_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[cd.getTypeName()])}}cd.H_={T_:cd.getTypeName(),B_:cd.getBaseTypes()};class dd{constructor(t){e.assign(dd,this,t)}static getTypeName(){return"AugLoop_CopilotChatHistory_AddChatOperation"}static getBaseTypes(){return["AugLoop_CopilotChatHistory_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[dd.getTypeName()])}}dd.H_={T_:dd.getTypeName(),B_:dd.getBaseTypes()};class ld{constructor(t){e.assign(ld,this,t)}static getTypeName(){return"AugLoop_CopilotChatHistory_AddMessageOperation"}static getBaseTypes(){return["AugLoop_CopilotChatHistory_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[ld.getTypeName()])}}ld.H_={T_:ld.getTypeName(),B_:ld.getBaseTypes()};class ud{constructor(t){e.assign(ud,this,t)}static getTypeName(){return"AugLoop_CopilotChatHistory_DeleteChatOperation"}static getBaseTypes(){return["AugLoop_CopilotChatHistory_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[ud.getTypeName()])}}ud.H_={T_:ud.getTypeName(),B_:ud.getBaseTypes()};class fd{constructor(t){e.assign(fd,this,t)}static getTypeName(){return"AugLoop_CopilotChatHistory_UpdateMessageOperation"}static getBaseTypes(){return["AugLoop_CopilotChatHistory_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[fd.getTypeName()])}}fd.H_={T_:fd.getTypeName(),B_:fd.getBaseTypes()};class pd{constructor(t){e.assign(pd,this,t)}static getTypeName(){return"AugLoop_CopilotChatHistory_UpdateChatOperation"}static getBaseTypes(){return["AugLoop_CopilotChatHistory_Operation"]}static typeGuard(t){return e.matchesTypesFor(t,[pd.getTypeName()])}}pd.H_={T_:pd.getTypeName(),B_:pd.getBaseTypes()};class md{static generateId(){return md._operationId++,"AugLoopChatSharePoint"+md._operationId.toString()}}function _d(e){const t={newChat:{userId:"",documentId:"",sessionId:e,messages:[]},type:Qc.AddChatOperation},n=new td({operation:t,timestamp:Date.now()});return new x({parentPath:["signal",td.getTypeName()],items:[{id:md.generateId(),body:n}]})}md._operationId=0;class hd{async send(e,t){const n=md.generateId(),a=[new f({parentPath:this._messagesPath,items:[{id:n,body:e}]})];return t&&a.push(function(e,t){const n={newMessage:e,type:Qc.AddMessageOperation,chatSessionId:t},a=new td({operation:n,timestamp:Date.now()});return new x({parentPath:["signal",td.getTypeName()],items:[{id:md.generateId(),body:a}]})}({content:t,entry:Jc.Pane,userRole:Yc.User,format:Zc.PlainText,timestamp:(new Date).getTime(),messageId:n},this._chatId)),this._submitOperations(a),this._operationBacklog.set(n,a),new Promise(e=>this._responseCallbacks.set(n,e))}close(){return this._config.session.releaseAnnotation(this._activatedAnnotationToken)}_activateAnnotation(e){return this._config.session.activateAnnotation(e,{callback:e=>{if(f.typeGuard(e)&&this._isUnderSubtree(e.parentPath,this._messagesPath))for(const t of e.items){const n=e.parentPath[e.parentPath.length-1],a=this._responseCallbacks.get(n);a&&(a(t.body),this._responseCallbacks.delete(n)),!Uc()&&this._operationBacklog.has(n)&&this._operationBacklog.delete(n)}}}).then(e=>{this._activatedAnnotationToken=e.token})}_isUnderSubtree(e,t){if(e.length<t.length)return!1;for(let n=0;n<t.length;n++)if(e[n]!==t[n])return!1;return!0}_submitOperations(e){this._config.session.submitOperations(e)}_handleReconnect(){this._config.session.setReconnectCallback(()=>{this._activateAnnotation(this._config.annotation)}),this._config.session.setServerAuthenticationStateChangeCallback(e=>{!Uc()&&e===ja.Authenticated&&this._operationBacklog.size>0&&this._operationBacklog.forEach(e=>{this._submitOperations(e)})})}constructor(e){this._config=e,this._responseCallbacks=new Map,this._operationBacklog=new Map,this._chatId=$.Guid.newGuid().toString();const t=[...e.annotationPath,this._chatId];this._messagesPath=[...t,"messages"],this._activateAnnotation(e.annotation),this._submitOperations([_d(this._chatId)]),this._handleReconnect()}}function bd(){return!$._SPKillSwitch.isActivated("6b3c97ae-c33a-4c1e-9b88-5dc1e87ab20f")&&$._SPFlight.isEnabled(62479)}class gd{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(gd,this,t)}static getTypeName(){return"AugLoop_SharepointSmaRecommendations_SharepointSMAAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[gd.getTypeName()])}}gd.H_={T_:gd.getTypeName(),B_:gd.getBaseTypes()};class vd{constructor(t){e.assign(vd,this,t)}static getTypeName(){return"AugLoop_SharepointSmaRecommendations_SharepointSmaRecommendationsSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[vd.getTypeName()])}}vd.H_={T_:vd.getTypeName(),B_:vd.getBaseTypes()};class yd{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(t){e.assign(yd,this,t)}static getTypeName(){return"AugLoop_SharepointSmaRecommendations_SharepointSmaRecommendationsAnswer"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(t){return e.matchesTypesFor(t,[yd.getTypeName()])}}yd.H_={T_:yd.getTypeName(),B_:yd.getBaseTypes()};class Sd{constructor(t){e.assign(Sd,this,t)}static getTypeName(){return"AugLoop_SharepointSmaRecommendations_SharepointSMABaseSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Sd.getTypeName()])}}Sd.H_={T_:Sd.getTypeName(),B_:Sd.getBaseTypes()};class Dd{constructor(t){e.assign(Dd,this,t)}static getTypeName(){return"AugLoop_SharepointSmaRecommendations_SMABrokenLinksSignal"}static getBaseTypes(){return["AugLoop_SharepointSmaRecommendations_SharepointSMABaseSignal","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Dd.getTypeName()])}}Dd.H_={T_:Dd.getTypeName(),B_:Dd.getBaseTypes()};class Id{constructor(t){e.assign(Id,this,t)}static getTypeName(){return"AugLoop_SharepointSmaRecommendations_SMAContentGapSignal"}static getBaseTypes(){return["AugLoop_SharepointSmaRecommendations_SharepointSMABaseSignal","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Id.getTypeName()])}}Id.H_={T_:Id.getTypeName(),B_:Id.getBaseTypes()};class xd{constructor(t){e.assign(xd,this,t)}static getTypeName(){return"AugLoop_SharepointSmaRecommendations_SharepointSMAContentPageReasonSignal"}static getBaseTypes(){return["AugLoop_SharepointSmaRecommendations_SharepointSMABaseSignal","AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[xd.getTypeName()])}}xd.H_={T_:xd.getTypeName(),B_:xd.getBaseTypes()};const Cd="SPAugmentationLoop.AlWorkflowProxy.",Od=`${Cd}sendGptMessage`;var wd,Ed,Ad,Ld,kd,Md,Pd,Td,Ud,Fd,Hd,Rd,Nd,Bd,jd,Vd,zd,Gd,Kd,Wd,qd,Qd;!function(e){e.Chart="Chart",e.Infographic="Infographic",e.Other="Other"}(wd||(wd={}));class Yd{getAugloopSessionKey(){return this._alSessionKey}async runSingleItemWorkflow(e,t,n=!1,a="dogfood"){return this._runWorkflow(e,n,a,e=>e.submitOperation(t))}async runMultipleItemsWorkflow(e,t,n=!1,a="dogfood"){return this._runWorkflow(e,n,a,e=>e.submitOperations(t))}async generateOdsl(e){const t=new Promise((e,t)=>{setTimeout(()=>{t(new Error("Timeout: ODSL generation took too long"))},12e4)});return Promise.race([t,this._generateOdslInternal(e)])}async getLayoutPageModel(e){const t=new x({parentPath:["Signal"],items:[{id:$.Guid.newGuid().toString(),revId:"0",body:e}]}),n=await this.runSingleItemWorkflow("AugLoop_LayoutAnalysis_LayoutAnalysisAnnotation",t);return function(e,t){if(null===e||null===t)return;const n=e.pages[0].width,a=e.pages[0].height;(e.paragraphs||[]).sort(zc);let i=t.filter(e=>(e.probability||0)>.4&&"ck5wp"!==e.tagName);i.sort(Gc),i=((e,t,n)=>n.map(n=>{const a={height:n.boundingBox.height*t,width:n.boundingBox.width*e,left:n.boundingBox.left*e,top:n.boundingBox.top*t};return{...n,boundingBox:a}}))(n,a,i);const r=((e,t,n,a)=>{const i=new Map,r=e.filter(e=>!e.role);return t.forEach(e=>{const t=e.boundingBox,o={left:t.left,right:t.left+t.width,top:t.top,bottom:t.top+t.height,width:t.width,height:t.height};let s,c=0;for(let e=0;e<r.length;e++){const t=r[e],i={left:0,width:0,height:0,right:n,top:t.boundingRegions[0].polygon[1].y,bottom:e===r.length-1?a:r[e+1].boundingRegions[0].polygon[1].y};i.width=n,i.height=i.bottom-i.top;const d=Kc(i,o);if(!(d<0)&&(d>c&&(c=d,s=t),d<c))break}s&&(i.has(s)?i.get(s).push(e):i.set(s,[e]))}),i})(e.paragraphs||[],i,n,a),o=((e,t,n,a)=>{const i=new Map,r=e.filter(e=>!e.role);return t.forEach(e=>{const t=e.boundingRegions[0],o={left:t.polygon[0].x,top:t.polygon[0].y,right:t.polygon[1].x,bottom:t.polygon[2].y,width:0,height:0};o.width=o.right-o.left,o.height=o.bottom-o.top;let s,c=0;for(let e=0;e<r.length;e++){const t=r[e],i={left:0,width:0,height:0,right:n,top:t.boundingRegions[0].polygon[1].y,bottom:e===r.length-1?a:r[e+1].boundingRegions[0].polygon[1].y};i.width=n,i.height=i.bottom-i.top;const d=Kc(i,o);if(!(d<0)&&(d>c&&(c=d,s=t),d<c))break}s&&(i.has(s)?i.get(s).push(e):i.set(s,[e]))}),i})(e.paragraphs||[],e.tables||[],n,a),s=function(e,t){const n=t.reduce((e,t)=>e.concat(t.cells),[]);return e.filter(e=>{const t=e.boundingRegions[0].polygon;return!!n.find(e=>t.some(t=>!!e.boundingRegions[0].polygon.find(e=>e.x===t.x&&e.y===t.y)))})}(e.paragraphs||[],e.tables||[]);return((e,t,n,a)=>{const i=e.find(e=>"title"===e.role),r=e.filter(e=>"title"!==e.role).map((e,i)=>{const r={index:i+1,sections:[]},o={index:1,webParts:[]};if(r.sections.push(o),t.has(e)){const n=t.get(e)[0],a="imagewp"===(n.tagName||"")?"Image":"Text";if(n.boundingBox.top>=e.boundingRegions[0].polygon[2].y){const t={type:"Text",source:`<p>${e.content}</p>`,ctrlIndex:1},n={ctrlIndex:2,type:a};o.webParts.push(t),o.webParts.push(n)}else{const t={index:2,webParts:[]};r.sections.push(t);const i={type:"Text",source:`<p>${e.content}</p>`,ctrlIndex:1},s={ctrlIndex:1,type:a};n.boundingBox.left>=e.boundingRegions[0].polygon[0].x?(o.webParts.push(i),t.webParts.push(s)):(o.webParts.push(s),t.webParts.push(i))}}else if(n.has(e)){const t=n.get(e)[0];if(a.includes(e)){const e={type:"Table",source:Wc(t),ctrlIndex:1};o.webParts.push(e)}else if(t.boundingRegions[0].polygon[0].y>=e.boundingRegions[0].polygon[2].y){const n={type:"Text",source:`<p>${e.content}</p>`,ctrlIndex:1},a={type:"Table",source:Wc(t),ctrlIndex:2};o.webParts.push(n),o.webParts.push(a)}else{const n={index:2,webParts:[]};r.sections.push(n);const a={type:"Text",source:`<p>${e.content}</p>`,ctrlIndex:1},i={type:"Table",source:Wc(t),ctrlIndex:1};t.boundingRegions[0].polygon[0].y>=e.boundingRegions[0].polygon[1].x?(o.webParts.push(a),n.webParts.push(i)):(o.webParts.push(i),n.webParts.push(a))}}else if(!a.includes(e)){const t=e.role?"SectionHeading":"Text",n={type:t,source:"SectionHeading"===t?`<h2>${e.content}</h2>`:`<p>${e.content}</p>`,ctrlIndex:1};o.webParts.push(n)}return r});return{title:i?.content,zones:r}})(e.paragraphs||[],r,o,s)}(n.layout,n.predictions)}async callSpCopilot(e,t=3){this._spChatClient=this._spChatClient||await this._createSPChatClient();const n=new ee._QosMonitor(`${Cd}sendMessageWithRetry`);if(t<=0)return void n.writeUnexpectedFailure("MaxRetryCountReached");const a=await this._spChatClient.send(e),{status:i}=a,r=H[i],o={alias:r,sessionKey:this._alSessionKey};switch(i){case H.Success:case H.PartialResult:case H.EmptyResponse:return n.writeSuccess(o),a;case H.ResourcesNotAvailable:case H.Overloaded:case H.TooLargeRequest:case H.UserNotAuthenticated:case H.UserNotAuthorized:return n.writeUnexpectedFailure(r,void 0,o),a;case H.OffensiveContentInput:case H.OffensiveContentOutput:case H.RaiUnsupportedLanguageInContentInput:case H.RaiUnsupportedLanguageInContentOutput:case H.InputBlockedByDynamicGuardList:case H.OutputBlockedByDynamicGuardList:case H.InputAttackDetected:case H.OutputAttackDetected:case H.ModelContentFilter:return n.writeExpectedFailure(r,void 0,o),a;default:return n.writeUnexpectedFailure(r,void 0,o),await this.callSpCopilot(e,--t)}}sendGptMessage(e,t){return new Promise((n,a)=>{const i=new ee._QosMonitor(Od);this._getChatHelper().then(a=>{a.send(new r({message:`${e}`,modelPlaceholders:t}),e=>{i.writeSuccess(),n(e)})}).catch(e=>{i.writeUnexpectedFailure(e),ee._TraceLogger.logError(Nc,e,"error in send message"),a(e)})})}async getKeyPhrases(e,t){const n=$.Guid.newGuid().toString(),a=new f({parentPath:["KeyPhrasesSignal"],items:[{id:n,body:$._SPKillSwitch.isActivated("f10394fa-d246-4ebd-8d55-b2f232875375")?new E({content:e}):new me({content:e})}]});return Fc()?await this.runSingleItemWorkflow(Ft.getTypeName(),a,!!t||void 0,t?"prod":void 0):await this.runSingleItemWorkflow(Ft.getTypeName(),a)}async resetChat(){const e=await this._getChatHelper();await e.close(),this._chatHelperPromise=void 0}async dispose(){try{await this.resetChat(),(await this.getAugloopSession()).close()}catch(e){ee._TraceLogger.logError(Nc,e,"error in destroy Augloop Proxy")}}async generateInsights(e){const t=$.Guid.newGuid().toString(),n=new f({parentPath:["session","doc",t],items:[{id:t,contextId:"alproxyinsights",body:new A({content:e})}]});(await this.getAugloopSession()).submitOperations([n])}async generateImageByDallE(e){const t=$.Guid.newGuid().toString(),n=new f({parentPath:["session","doc"],items:[{id:t,revId:"0",body:new Se({caption:e})}]});return await this.runSingleItemWorkflow(ke.getTypeName(),n)}async findProviderContentAnnotationImages(e,t,n,a=20,i=X.Stock,r="0"){const o=t||$.Guid.newGuid().toString(),s=new f({parentPath:["ContentSearchSignal"],items:[{id:o,body:new Te({query:e,contentProviders:[{provider:n||bd()&&i===X.External?Z.TAS:Z.Hubble,contentSource:bd()?i:X.Stock,contentType:J.Image,pageSize:a,pageOffset:r,queryParams:[],pivotIds:[Y.Images]}]})}]});return Fc()?await this.runSingleItemWorkflow(je.getTypeName(),s,!0,"prod"):await this.runSingleItemWorkflow(je.getTypeName(),s)}async translateContent(e,t,n,a,i){const r=a||$.Guid.newGuid().toString(),o=new f({parentPath:["TranslateContentSignal"],items:[{id:r,body:new pt({requestId:r,contentType:0,sourceLanguage:t,targetLanguage:n,text:e})}]});return await this.runSingleItemWorkflow(Dt.getTypeName(),o,i)}async rankSuggestions(e){const t=$.Guid.newGuid().toString(),n=new f({parentPath:["session"],items:[{id:t,contextId:"DesignIdeasPersonalizerContext",body:e}]});return await this.runSingleItemWorkflow(Mt.getTypeName(),n,!0)}async rewardSuggestion(e){const t=$.Guid.newGuid().toString(),n=new f({parentPath:["session"],items:[{id:t,contextId:"DesignIdeasPersonalizerContext",body:e}]});return await this.runSingleItemWorkflow(Pt.getTypeName(),n,!0)}async findHubbleIcon(e){const t=$.Guid.newGuid().toString(),n=new f({parentPath:["TextToIconSignal"],items:[{id:t,body:new Ge({content:e})}]});return await this.runSingleItemWorkflow(Ke.getTypeName(),n)}async generatePageSkeleton(e){const t=$.Guid.newGuid().toString(),n=new f({parentPath:["session"],items:[{id:t,body:new Ye(e)}]});(await this.getAugloopSession()).submitOperations([n])}async generatePageOutline(e){const t=$.Guid.newGuid().toString(),n=new f({parentPath:["session"],items:[{id:t,body:new Je(e)}]});(await this.getAugloopSession()).submitOperations([n])}async generateSections(e){const t=$.Guid.newGuid().toString(),n=new f({parentPath:["session"],items:[{id:t,body:new Xe(e)}]});(await this.getAugloopSession()).submitOperations([n])}async generateBrokenLinksRecommendations(e){const t=$.Guid.newGuid().toString(),n=new x({parentPath:["session",t],items:[{id:t,body:{...e}}]});return await this.runSingleItemWorkflow(gd.getTypeName(),n)}async generateContentGapTopics(e){const t=new vd({contentGapTopics:`[${e.join(", ")}]`}),n=$.Guid.newGuid().toString(),a=new x({parentPath:["session",n],items:[{id:n,body:{...t}}]});return(await this.runSingleItemWorkflow(yd.getTypeName(),a)).answer||""}async generateContentGapReason(e){const t=new xd({contentGapQuery:e.contentGapQuery,siteUrl:e.siteUrl,siteID:e.siteId,webID:e.webId}),n=$.Guid.newGuid().toString(),a=new x({parentPath:["session",n],items:[{id:n,body:{...t}}]});return(await this.runSingleItemWorkflow(gd.getTypeName(),a)).data||""}async generateDataVisualization(e,t){const n=$.Guid.newGuid().toString(),a=new x({parentPath:["Signal"],items:[{id:n,revId:"0",body:new Tt({prompt:e,scenario:t})}]});return await this.runSingleItemWorkflow(Ut.getTypeName(),a)}async generateSubtopics(e){const t=$.Guid.newGuid().toString(),n=new f({parentPath:["session"],items:[{id:t,body:new Qe(e)}]});(await this.getAugloopSession()).submitOperations([n])}async generateWebParts(e){const t=$.Guid.newGuid().toString(),n=new f({parentPath:["session"],items:[{id:t,body:new $e(e)}]});(await this.getAugloopSession()).submitOperations([n])}async composeAnswerRequest(e){const t=$.Guid.newGuid().toString(),n=new f({parentPath:["session"],items:[{id:t,body:new Ze(e)}]});(await this.getAugloopSession()).submitOperations([n])}async subscribeToWorkflows(e,t){const n=await this.getAugloopSession(),a=e.map(e=>n.activateAnnotation(e,{callback:t}));return(await Promise.all(a)).map(e=>e.token)}async unSubscribeFromWorkflows(e){const t=await this.getAugloopSession(),n=e.map(e=>t.releaseAnnotation(e));return 0===(await Promise.all(n)).filter(e=>!e).length}async _createSPChatClient(){const e=new ee._QosMonitor(`${Cd}createSPChatClient`);try{const t=new hd({session:await this.getAugloopSession(),annotation:tt.getTypeName(),annotationPath:["session","chat"]});return e.writeSuccess(),t}catch(t){throw ee._TraceLogger.logError(Nc,t,"Unable to instantiate SPChatClient"),e.writeUnexpectedFailure(void 0,t),t}}async _createOdslChatClient(){const e=new ee._QosMonitor(`${Cd}createOdslChatClient`);try{const t=new hd({session:await this.getAugloopSession(),annotation:it.getTypeName(),annotationPath:["session","doc"]});return e.writeSuccess(),t}catch(t){throw ee._TraceLogger.logError(Nc,t,"Unable to instantiate OdslChatClient"),e.writeUnexpectedFailure(void 0,t),t}}async _generateOdslInternal(e){return this._odslChatClient=this._odslChatClient||await this._createOdslChatClient(),await this._odslChatClient.send(new We(e),e.query)}async _runWorkflow(e,t=!1,n="dogfood",a){const i=t?await jc(this._pageContext,!1,n,this._pageUniqueId,this._appNameOverride,void 0,this._flightsOverride,this._uniqueKey,this._clientMetadataOverride):await this.getAugloopSession();return new Promise((n,r)=>{let o;i.activateAnnotation(e,{callback:a=>{i.releaseAnnotation(o.token).then(async()=>{const e=a.items[0].body;t&&i.close(),n(e)}).catch(t=>{ee._TraceLogger.logError(Nc,t,`error releasing ${e} annotation`),r(t)})}}).then(e=>{o=e,a(i)}).catch(t=>{ee._TraceLogger.logError(Nc,t,`performing ${e} request`),r(t)})})}constructor(e,t,n,a,i,r){this.getAugloopSession=()=>(this._augloopSessionPromise||(this._augloopSessionPromise=jc(this._pageContext,void 0,void 0,this._pageUniqueId,this._appNameOverride,e=>{this._alSessionKey=e},this._flightsOverride,this._uniqueKey,$._SPKillSwitch.isActivated("94551102-6087-4370-a4f6-b9103da51452")?void 0:this._clientMetadataOverride)),this._augloopSessionPromise),this._createChatHelper=(e,t)=>{const n=new ee._QosMonitor(`${Cd}createChatHelper`);return w.create({session:e,chat:new te(t??{modelConfig:new se({model:K.TextDavinci003,parameters:{temperature:.7,stop:["","<|endoftext|>"],maxTokens:1e3}}),context:"The following is a transcript of a conversation between a human and a smart, helpful AI assistant. They take turns making statements. Human statements start with Human and AI assistant statements start with AI. The transcript consists of only these statements from now on.\nHuman\nhi Chat gpt!\nAI\nhello!\n",prefixText:"\nHuman\n",suffixText:"\nAI\n",historyDepth:-1}),responseType:ne.getTypeName()}).then(e=>(n.writeSuccess(),e)).catch(e=>{throw ee._TraceLogger.logError(Nc,e,"Unable to instantiate ChatGPT helper"),n.writeUnexpectedFailure(void 0,e),e})},this._getChatHelper=()=>(this._chatHelperPromise||(this._chatHelperPromise=this.getAugloopSession().then(e=>this._createChatHelper(e))),this._chatHelperPromise),this._pageContext=e,this._pageUniqueId=t,this._appNameOverride=n,this._flightsOverride=a,this._uniqueKey=i,this._clientMetadataOverride=r}}!function(e){e.BrokenLinks="BrokenLinks",e.ContentGap="ContentGap",e.ContentGapReasoning="ContentGapReasoning"}(Ed||(Ed={})),function(e){e.Success="Success",e.Error="Error",e.DataReady="DataReady"}(Ad||(Ad={}));class Jd{constructor(t){e.assign(Jd,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_SharepointCopilotRequest"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Jd.getTypeName()])}}Jd.H_={T_:Jd.getTypeName(),B_:Jd.getBaseTypes()};class Xd{constructor(t){e.assign(Xd,this,t)}static getTypeName(){return"AugLoop_SharepointCopilot_SharepointListCopilotRequest"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(t){return e.matchesTypesFor(t,[Xd.getTypeName()])}}Xd.H_={T_:Xd.getTypeName(),B_:Xd.getBaseTypes()},function(e){e["SiteHandler.describeSiteAndTheme"]="SiteHandler.describeSiteAndTheme",e["SiteHandler.describeHomePage"]="SiteHandler.describeHomePage",e["SiteHandler.describeOtherPages"]="SiteHandler.describeOtherPages",e["SiteHandler.describeInitialPages"]="SiteHandler.describeInitialPages",e["PageHandler.designHomePage"]="PageHandler.designHomePage",e["PageHandler.designPage"]="PageHandler.designPage",e["PageHandler.convertDocToPage"]="PageHandler.convertDocToPage",e["OdslPageHandler.designDocumentPage"]="OdslPageHandler.designDocumentPage",e["SiteIntentHandler.filterIntent"]="SiteIntentHandler.filterIntent",e["FileHandler.getAnswerForFile"]="FileHandler.getAnswerForFile",e["RteHandler.getRewriteSuggestions"]="RteHandler.getRewriteSuggestions"}(Ld||(Ld={})),function(e){e.copilotRewrite="copilotRewrite",e.copilotLonger="copilotLonger",e.copilotToneCasual="copilotToneCasual",e.copilotToneProfessional="copilotToneProfessional",e.copilotToneConcise="copilotToneConcise",e.copilotToneEnthusiastic="copilotToneEnthusiastic",e.copilotToneEngaging="copilotToneEngaging",e.copilotToneCreative="copilotToneCreative"}(kd||(kd={})),function(e){e.copilotUser="CopilotUser",e.people="People",e.topics="Topics",e.topicRelatedPeople="TopicRelatedPeople",e.topicRelatedSites="TopicRelatedSites",e.topicRelatedFiles="TopicRelatedFiles",e.copilotFile="CopilotFile"}(Md||(Md={})),function(e){e.text="text",e.image="image",e.video="video",e.people="people",e.links="links",e.title="title"}(Pd||(Pd={})),function(e){e.Refresh="Refresh"}(Td||(Td={})),function(e){e.Month="Month",e.Day="Day",e.Hour="Hour",e.Minute="Minute",e.Week="Week"}(Ud||(Ud={})),function(e){e[e.Message=0]="Message",e[e.File=1]="File"}(Fd||(Fd={})),function(e){e[e.SharePoint=0]="SharePoint",e[e.OneDriveBusiness=1]="OneDriveBusiness",e[e.Exchange=2]="Exchange"}(Hd||(Hd={})),function(e){e[e.MessageId=0]="MessageId",e[e.ConversationId=1]="ConversationId",e[e.SiteId=2]="SiteId",e[e.WebId=3]="WebId",e[e.UniqueId=4]="UniqueId",e[e.SuggestionEntityId=5]="SuggestionEntityId",e[e.AuthorId=6]="AuthorId",e[e.ImmutableId=7]="ImmutableId",e[e.ListId=8]="ListId",e[e.AADObjectId=9]="AADObjectId",e[e.BookmarkUrl=10]="BookmarkUrl",e[e.AttachmentId=11]="AttachmentId",e[e.RecommendationEntityId=12]="RecommendationEntityId",e[e.ConnectorEntityId=13]="ConnectorEntityId",e[e.EventId=14]="EventId",e[e.TaskId=15]="TaskId",e[e.SharepointDocId=16]="SharepointDocId"}(Rd||(Rd={})),function(e){e.None="None",e.Exchange="Exchange",e.SharePoint="SharePoint",e.OneDriveBusiness="OneDriveBusiness",e.ExchangeArchive="ExchangeArchive",e.Mailbox="Mailbox",e.Directory="Directory",e.Teams="Teams",e.Connectors="Connectors",e.SamsungNotes="SamsungNotes",e.OneNote="OneNote"}(Nd||(Nd={})),function(e){e.None="None",e.Suggestion="Suggestion",e.Modification="Modification",e.NoResultModification="NoResultModification",e.NoRequeryModification="NoRequeryModification",e.NoResultFolderRefinerModification="NoResultFolderRefinerModification",e.Extension="Extension"}(Bd||(Bd={})),function(e){e.None="None",e.Directory="Directory",e.Exchange="Exchange",e.ExchangeArchive="ExchangeArchive",e.Mailbox="Mailbox",e.OneDriveBusiness="OneDriveBusiness",e.SharePoint="SharePoint",e.Teams="Teams",e.Connectors="Connectors"}(jd||(jd={})),function(e){e.Interleaved="Interleaved",e.Blocks="Blocks"}(Vd||(Vd={})),function(e){e.Optimized="Optimized"}(zd||(zd={})),function(e){e.None="None",e.KQLParser="KQLParser",e.AQSParser="AQSParser",e.FQLParser="FQLParser"}(Gd||(Gd={})),function(e){e.Id="Id",e.TenantId="TenantId",e.ConcatenatedId="ConcatenatedId",e.DocumentId="DocumentId",e.ExternalDirectoryObjectId="ExternalDirectoryObjectId",e.HasIrm="HasIrm",e.ADObjectId="ADObjectId",e.UserPrincipalName="UserPrincipalName",e.MRI="MRI",e.Alias="Alias",e.DisplayName="DisplayName",e.GivenName="GivenName",e.Surname="Surname",e.JobTitle="JobTitle",e.ImAddress="ImAddress",e.Phones="Phones",e.CompanyName="CompanyName",e.Department="Department",e.OfficeLocation="OfficeLocation",e.EmailAddresses="EmailAddresses",e.Confidence="Confidence",e.Inferences="Inferences",e.Summary="Summary",e.URL="URL",e.Title="Title",e.Author="Author",e.filename="filename",e.HitHighlightedSummary="HitHighlightedSummary",e.FromTuring="FromTuring",e.spResourceUrl=".spResourceUrl",e.InformationProtectionLabelId="InformationProtectionLabelId",e.FileType="FileType",e.ListID="ListID",e.UniqueID="UniqueID",e.SiteId="SiteId",e.RawContent="RawContent",e.DocId="DocId",e.WebId="WebId",e.DriveId="DriveId",e.DriveItemId="DriveItemId",e.DrmRights="DrmRights",e.AuthorOWSUSER="AuthorOWSUSER",e.EditorOWSUSER="EditorOWSUSER",e.SharingHistory="SharingHistory",e.ModifierUPNs="ModifierUPNs",e.IdentityListItemId="IdentityListItemId"}(Kd||(Kd={})),function(e){e.Text="Text",e.Speech="Speech"}(Wd||(Wd={})),function(e){e.FinalResult="FinalResult",e.Partial="Partial"}(qd||(qd={})),Error,Error,function(e){e.FileEnablePersonMatch="FileEnablePersonMatch",e.FileDisablePersonMatch="FileDisablePersonMatch"}(Qd||(Qd={}));var Zd=o(909);const $d="https://substrate.office.com/search",el=en._AadTokenProviders.configurable,tl=ee._LogSource.create("sp-SubstrateApiCallLogger");function nl(e){return new Promise(t=>{e.whenFinished(()=>t(!0))})}async function al(e,t,n,a){const i=await async function(e,t,n,a){const i=new ee._QosMonitor("ContentDiscoveryApiCall");try{await nl(e);const r=await el._getTokenInternal($d,en._AadTokenProviders.preAuthorizedConfiguration),o=e.consume(Zd.HttpClient.serviceKey),s=new Zd.HttpClientConfiguration(Zd.HttpClient.configurations.v1),c=new Headers;c.set("Authorization","Bearer "+r),c.set("Content-Type","application/json"),c.set("Accept","application/json");const d={credentials:"same-origin",headers:c,body:JSON.stringify({EntityRequests:[{EntityType:"File",ContentSources:[jd.SharePoint,jd.OneDriveBusiness],Query:{QueryString:t,QueryTemplate:n||""},From:a?.from,Size:a?.size,Sort:a?.sort,HitHighlight:a?.hitHighlight,SupportedResultSourceFormats:["EntityData"],PreferredResultSourceFormat:"EntityData"}],Scenario:{Name:"sharepoint_copilot"},Cvid:$.Guid.newGuid().toString()})},l=await o.post(`${$d}/api/v2/query`,s,d),u=await l.json();return i.writeSuccess({apiTraceId:u.Instrumentation.TraceId}),u}catch(e){throw i.writeUnexpectedFailure(e),ee._TraceLogger.logError(tl,e,"error in send message"),e}}(e,t,n,a);return r=i,Array.isArray(r.EntitySets)?r.EntitySets.reduce((e,t)=>{const n=(a=t.ResultSets?.filter(e=>0!==e.Total||e.Results?.length),a?a.reduce((e,t)=>{if(t.Results?.length){const n=t.Results?.map((e,t)=>function(e,t){switch(e.Provenance){case Nd.SharePoint:case Nd.OneDriveBusiness:return{Id:t.toString(),FileSourceType:e.Source?.FileType,text:e.Source?.Title,FileName:e.Source?.Filename,FileExtension:e.Source?.FileExtension,FileSize:0,AccessUrl:e.Source?.DefaultEncodingUrl,DateAccessed:e.Source?.lastAccessDateTime,DateModified:e.Source?.LastModifiedTime,DateCreated:"",ListId:e.Source?.ListId,confidence:0};default:throw new Error("unexpected provenance in response result")}}(e,t));return e.concat(Array.isArray(n)?n:[])}return e.concat([])},[]):[]);var a;return e.concat(Array.isArray(n)?n:[])},[]):[];var r}async function il(e,t){const n=new ee._QosMonitor("ContentDiscoveryApiCall");try{await nl(e);const i=await el._getTokenInternal($d,en._AadTokenProviders.preAuthorizedConfiguration),r=e.consume(Zd.HttpClient.serviceKey),o=new Zd.HttpClientConfiguration(Zd.HttpClient.configurations.v1),s=new Headers;s.set("Authorization","Bearer "+i),s.set("Content-Type","application/json"),s.set("Accept","application/json");const c={credentials:"same-origin",headers:s,body:JSON.stringify({EntityRequests:[{EntityType:"Document",Context:{EntityId:t}}],Scenario:{Name:"FileInsights"},Cvid:$.Guid.newGuid().toString()})},d=await r.post(`${$d}/api/v1/recommendations`,o,c),l=await d.json();return n.writeSuccess({apiTraceId:l.Instrumentation.TraceId}),a=l,Array.isArray(a.EntitySets)?a.EntitySets.reduce((e,t)=>{const n=(a=t.ResultSets?.filter(e=>0!==e.Total||e.Results?.length),a?a.reduce((e,t)=>{if(t.Results?.length){const n=t.Results?.map(e=>function(e){switch(e.Provenance){case Nd.SharePoint:return{itemKind:Fd.File,itemProvenance:Hd.SharePoint,displayTitle:e.Source?.Title,displayPreview:e.Source?.HitHighlightedSummary||e.Source?.Description,displayAuthor:e.Source?.DisplayAuthor?.split(";")||e.Source?.Author?.DisplayName,displayFileType:e.Source?.FileType||e.Source?.FileExtension,redirectUrl:e.Source?.ServerRedirectedURL||e.Source?.Url,previewUrl:e.Source?.ServerRedirectedPreviewURL,embedUrl:e.Source?.ServerRedirectedEmbedURL,contextTimestamp:e.Source?.LastModifiedTime||e.Source?.LastModifiedDateTime,hitHighlightedSummary:e.HitHighlightedSummary||e.Source?.Description,author:e.Source?.Author||e.Source?.Author?.DisplayName,path:e.Source?.Path||e.Source?.Url,originalPath:e.Source?.OriginalPath||e.Source?.Url,spWebUrl:e.Source?.SPWebUrl||e.Source?.WebUrl,guids:{siteId:e.Source?.SiteId,webId:e.Source?.WebId,listId:e.Source?.ListId,itemId:e.Source?.UniqueId}};case Nd.OneDriveBusiness:return{itemKind:Fd.File,itemProvenance:Hd.OneDriveBusiness,displayTitle:e.Source?.Title,displayAuthor:e.Source?.Author||e.Source?.Author?.DisplayName,displayFileType:e.Source?.FileType||e.Source?.FileExtension,redirectUrl:e.Source?.LinkingUrl,contextTimestamp:e.Source?.LastModifiedTime||e.Source?.LastModifiedDateTime,hitHighlightedSummary:e.HitHighlightedSummary||e.Source?.Description,author:e.Source?.Author||e.Source?.Author?.DisplayName,path:e.Source?.Path||e.Source?.Url,originalPath:e.Source?.OriginalPath||e.Source?.Url,spWebUrl:e.Source?.SPWebUrl||e.Source?.WebUrl,guids:{siteId:e.Source?.SiteId,webId:e.Source?.WebId,listId:e.Source?.ListId,itemId:e.Source?.UniqueId}};case Nd.Exchange:return{itemKind:Fd.Message,itemProvenance:Hd.Exchange,displayTitle:e.Source?.NormalizedSubject,displayPreview:e.Source?.Preview,displayAuthor:e.Source?.From.Name,previewUrl:e.Source?.Weblink,contextTimestamp:e.Source?.DateTimeSent};default:throw new Error("unexpected provenance in response result")}}(e));return e.concat(Array.isArray(n)?n:[])}return e.concat([])},[]):[]);var a;return e.concat(Array.isArray(n)?n:[])},[]):[]}catch(e){throw n.writeUnexpectedFailure(e),ee._TraceLogger.logError(tl,e,"error in send message"),e}var a}})(),s})());